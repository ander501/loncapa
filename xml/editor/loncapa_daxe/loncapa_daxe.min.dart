import "dart:html";import "dart:collection";import "dart:async";import "dart:math";import "dart:js";import "dart:typed_data";const CX='mangledGlobalNames';const DX='mangledNames';const EX='metadata';const FX='getIsolateTag';class oS{static const String GX="Chrome";static const String HX="Firefox";static const String IX="Internet Explorer";static const String JX="Opera";static const String KX="Safari";final String EV;final String minimumVersion;const oS(this.EV,[this.minimumVersion]);}class pS{const pS();}class qS{final String name;const qS(this.name);}class rS{const rS();}class sS{const sS();}class VF{static String fP="LocalStrings";static HashMap<String,String> oM=null;static String gJ;static const pM='en';static Future<bool> tS(){Completer<bool> i=new Completer<bool>();bQ().then((String k){if(k!=null)gJ=k;else gJ=pM;String m=gJ.split('_')[0];String o="${fP}_${m}.properties";HttpRequest g=new HttpRequest();g.open("GET",o);g.onLoad.listen((ProgressEvent s){String v=g.responseText;oM=new HashMap<String,String>();List<String> BB=v.split("\n");for(String h in BB){if(h.startsWith('#'))continue;int j=h.indexOf('=');if(j==-1)continue;String EB=h.substring(0,j).trim();String HB=h.substring(j+1).trim();oM[EB]=HB;}i.complete(true);});g.onError.listen((ProgressEvent s){i.completeError("Error when reading the strings in ${fP}");});g.send();});return (i.future);}static String FH(String g){return (oM[g]);}}class hJ{static int gP=0;String YZ;String wK;DD action;String id;bool enabled;bool selected;StreamSubscription<MouseEvent> listener;hJ(this.YZ,this.wK,this.action,{this.enabled: true,this.selected: false}){id="lcdbutton_${gP}";gP++ ;}Element html(){DivElement g=new DivElement();g.id=id;g.classes.add('lcdbutton');if(!enabled)g.classes.add('lcdbutton-disabled');if(selected)g.classes.add('lcdbutton-selected');g.setAttribute('title',YZ);ImageElement h=new ImageElement();h.setAttribute('src','images/'+wK);if(enabled)listener=g.onClick.listen((MouseEvent i)=>action());g.append(h);return (g);}String get title{return (YZ);}void set title(String g){YZ=g;Element h=pB();h.setAttribute('title',YZ);}Element pB(){return (querySelector("#${id}"));}void disable(){if(!enabled)return;enabled=false;Element g=pB();g.classes.add('lcdbutton-disabled');listener.cancel();}void enable(){if(enabled)return;enabled=true;Element g=pB();g.classes.remove('lcdbutton-disabled');listener=g.onClick.listen((MouseEvent h)=>action());}void select(){if(selected)return;selected=true;Element g=pB();g.classes.add('lcdbutton-selected');}void xE(){if(!selected)return;selected=false;Element g=pB();g.classes.remove('lcdbutton-selected');}}class NL extends jJ{static List<String> uS=['if','unless','else','elsif','while','until','for','each','foreach','next','last','break','continue','return','my','our','local','state','BEGIN','END','package','sub','do','given ','when ','default','__END__','__DATA__','__FILE__','__LINE__','__PACKAGE__'];NL.PX(l g):super.QX(g){state=1;}NL.RX(AB g,n h):super.SX(g,h){if(firstChild is OB&&firstChild.nextSibling==null){firstChild.replaceWith(new bG(firstChild.nodeValue));}}Element html(){Element h=super.html();if(firstChild==null||firstChild.nextSibling!=null||firstChild is!bG)return h;if(state!=2&&BI){DivElement i=h.lastChild;i.classes.add('perl-text');DivElement g=PV();i.style.position='relative';g.style.position='absolute';g.style.top='0px';g.style.left='0px';i.append(g);}return h;}Element PV(){final String SB='\$@%&abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_';final String JB='0123456789';DivElement j=new DivElement();j.classes.add('perl-colored');String QB=firstChild.nodeValue;StringBuffer g=new StringBuffer();bool k=false;bool m=false;bool v=false;bool o=false;bool BB=false;String EB;int HB=0;while(HB<QB.length){String i=QB[HB];if(!o&&!m&&(SB.contains(i)||k&&JB.contains(i)||k&&i=='#'&&g.toString()[g.length-1]=='\$')){if(!k){if(g.length>0){j.append(new Text(g.toString()));g.clear();}k=true;}}else if(!o&&!k&&!m&&(JB.contains(i)||(i=='.'&&v))){if(!v){if(g.length>0){j.append(new Text(g.toString()));g.clear();}v=true;}}else{if(k){String s=g.toString();SpanElement h=new SpanElement();if(uS.contains(s))h.classes.add('keyword');else if(s.startsWith('\$')||s.startsWith('@')||s.startsWith('%'))h.classes.add('variable');else if(s.startsWith('&')||i=='(')h.classes.add('function-call');else h.classes.add('name');h.appendText(s);j.append(h);g.clear();k=false;}else if(v){SpanElement h=new SpanElement();h.classes.add('number');h.appendText(g.toString());j.append(h);g.clear();v=false;}else if(m&&(i=='\n'||i=='\r')){SpanElement h=new SpanElement();h.classes.add('comment');h.appendText(g.toString());j.append(h);g.clear();m=false;}if(!m&&(i=='"'||i=="'")&&!BB){if(o){if(i==EB){j.append(new Text(EB));SpanElement h=new SpanElement();h.classes.add('string');h.appendText(g.toString().substring(1));j.append(h);g.clear();o=false;}}else{if(g.length>0){j.append(new Text(g.toString()));g.clear();}EB=i;o=true;}}else if(!o&&i=='#'){if(g.length>0){j.append(new Text(g.toString()));g.clear();}m=true;}}if(o){if(i=='\\')BB=!BB;else if(BB)BB=false;}g.write(i);HB++ ;}if(g.length>0){if(m){SpanElement h=new SpanElement();h.classes.add('comment');h.appendText(g.toString());j.append(h);}else j.append(new Text(g.toString()));}return (j);}bool get PS{return true;}}class OL extends n{static String qM='c, pi, e, hbar, amu';static JsObject rM;static JsObject sM;OL.NX(l g):super.wX(g){}OL.OX(AB g,n h):super.rX(g,h){}Element html(){Element g;if(nodeName=='dlm')g=new DivElement();else g=new SpanElement();g.id="${id}";g.classes.add('dn');g.classes.add('math');if(!valid)g.classes.add('invalid');g.onClick.listen((MouseEvent h)=>KS());JL(g);return (g);}void cM(DD g){g();KS();}q QE(){return (null);}q SF(){return (null);}void TO(){Element g=document.getElementById(id);JL(g);}void JL(Element g){String j='?';if(firstChild!=null&&firstChild.nodeValue.trim()!='')j=firstChild.nodeValue;JsObject h;if(getAttribute('mode')=='units'){if(sM==null)sM=new JsObject(context['LCMATH']['Parser'],[true,true,qM]);h=sM;}else{if(rM==null)rM=new JsObject(context['LCMATH']['Parser'],[true,false,qM]);h=rM;}for(Node m in g.childNodes)m.remove();try {JsObject k=h.callMethod('parse',[j]);if(k!=null){Element i=document.createElement('math');i.setAttribute('display',nodeName=='dlm'?'block':'inline');JsObject o=new JsObject.jsify(['#000000']);i.append(k.callMethod('toMathML',[o]));g.append(i);Timer.run((){JsArray s=new JsObject.jsify(['Typeset',context['MathJax']['Hub'],id]);context['MathJax']['Hub'].callMethod('Queue',[s]);context['MathJax']['Hub'].callMethod('Queue',[()=>IB.cursor.refresh()]);});}}catch (v){g.text='Error: '+v.toString();}}void KS(){Element s=document.getElementById(id);if(s==null)return;Element h;if(nodeName=='dlm')h=new DivElement();else h=new SpanElement();h.id=id;TextInputElement g=new TextInputElement();g.classes.add('math');g.setAttribute('data-unit_mode',getAttribute('mode')=='units'?'true':'false');g.setAttribute('data-constants',qM);g.setAttribute('data-implicit_operators','true');g.setAttribute('spellcheck','false');if(firstChild!=null){g.value=firstChild.nodeValue;if(g.value.length>20)g.size=g.value.length;}h.append(g);SelectElement i=new SelectElement();OptionElement m=new OptionElement();m.value='symbols';m.appendText(VF.FH('lm_symbols'));if(getAttribute('mode')!='units')m.setAttribute('selected','selected');i.append(m);OptionElement o=new OptionElement();o.value='units';o.appendText(VF.FH('lm_units'));if(getAttribute('mode')=='units')o.setAttribute('selected','selected');i.append(o);i.onInput.listen((Event k){if(i.value=='symbols'&&getAttribute('mode')=='units'){setAttribute('mode','symbols');g.setAttribute('data-unit_mode','false');context['LCMATH'].callMethod('initEditors');}else if(i.value=='units'&&getAttribute('mode')!='units'){setAttribute('mode','units');g.setAttribute('data-unit_mode','true');context['LCMATH'].callMethod('initEditors');}g.focus();});h.append(i);s.replaceWith(h);g.focus();context['LCMATH'].callMethod('initEditors');var v=(){String j=g.value;if(j!=''){if(firstChild!=null)firstChild.nodeValue=j;else jB(new OB(j));}else{if(firstChild!=null)gC(firstChild);}h.replaceWith(html());};g.onBlur.listen((Event k){Timer.run((){if(document.activeElement==i)return;v();});});i.onBlur.listen((Event k){Timer.run((){if(document.activeElement==g)return;v();});});if(h is DivElement){h.onClick.listen((MouseEvent k){if(k.target!=g&&k.target!=i){IB.KD(new q(parent,parent.ZB(this)+1));}});}g.onKeyDown.listen((KeyboardEvent k){String j=g.value;int BB=g.size;if(j!=null&&j.length>BB)g.size=j.length;});}}class iJ extends n{iJ.LX(l g):super.wX(g){}iJ.MX(AB g,n h):super.rX(g,h){}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.classes.add('tex');g.onClick.listen((MouseEvent h)=>bR(()=>JL()));return (g);}void cM(DD g){bR(()=>g());}q QE(){return (null);}q SF(){return (null);}void TO(){JL();}void JL(){String g='?';if(firstChild!=null&&firstChild.nodeValue.trim()!='')g=firstChild.nodeValue;JsObject j=context['MathJax']['Hub']['Queue'];SpanElement h=document.getElementById(id);h.text=WR(g);JsArray i=new JsObject.jsify(['Typeset',context['MathJax']['Hub'],id]);context['MathJax']['Hub'].callMethod('Queue',[i]);}void bR([DD g]){tM h=new tM(this,g);h.show();}String WR(String g){bool i=false;JsObject j=context['MathJax']['Hub']['Queue'];if(nodeName=='dtm')g="\\[${g}\\]";else g="\\(${g}\\)";g=g.replaceAllMapped(new RegExp(r'\$[a-zA-Z]*[0-9]*(\[[^\]]*\])?'),(h){return "\\mathtt{${h.group(0)}}";});return (g);}}class jJ extends n{List<l> IE;int state;HashMap<String,SD> sH;HashMap<aB,TextInputElement> UG;bool BI;hJ iK;hJ jK;hJ hK;jJ.QX(l g):super.wX(g){state=0;yE();}jJ.SX(AB j,n k):super.rX(j,k){n g=firstChild;while(g!=null){n i=g.nextSibling;if(g is qF){if(g.previousSibling is OB&&g.previousSibling.nodeValue=='\n')gC(g.previousSibling);if(g.nextSibling is OB&&g.nextSibling.nodeValue=='\n'){i=g.nextSibling.nextSibling;gC(g.nextSibling);}String h;if(g.firstChild!=null)h=g.firstChild.nodeValue;else h=null;if(h!=null)insertBefore(new OB(h),g);gC(g);}g=i;}normalize();state=1;yE();NG();}void yE(){IE=t.CB.fE(DB);if(IE!=null&&IE.length>0)sH=new HashMap<String,SD>();UG=null;BI=t.CB.PE(DB)||t.CB.XC(DB).length>0;}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.classes.add('lcdblock');DivElement k=new DivElement();k.classes.add('lcdblock-header');DivElement o=new DivElement();DivElement m=new DivElement();m.classes.add('lcd-button-box');hK=new hJ(VF.FH('lcdblock_collapsed'),'block_collapsed.png',(){KV();},selected:(state==2));m.append(hK.html());jK=new hJ(VF.FH('lcdblock_normal'),'block_normal.png',(){KW();},selected:(state==1));m.append(jK.html());iK=new hJ(VF.FH('lcdblock_editable'),'block_editable.png',(){cR();},enabled:IE!=null&&IE.length>0,selected:(state==0));m.append(iK.html());o.append(m);SpanElement s=new SpanElement();s.classes.add('lcdblock-title');String EB=t.CB.OD(DB);if(EB==null)EB=nodeName;s.append(new Text(EB));s.onDoubleClick.listen((MouseEvent cB){IB.selectNode(this);});o.append(s);o.append(iP(DB,null));k.append(o);if(state==0){TableElement v=new TableElement();v.classes.add('expand');for(l hB in IE){v.append(UO(hB));}for(aB j in attributes){bool QB=false;for(l SB in IE){if(j.localName==t.CB.attributeName(SB)&&j.qB==t.CB.attributeNamespace(SB)){QB=true;break;}}if(!QB){v.append(tW(j));}}k.append(v);}else if(state==1){DivElement h=new DivElement();h.classes.add('lcdblock-attributes');for(aB j in attributes){h.append(new Text(" "));Element HB=new SpanElement();HB.attributes['class']='attribute_name';HB.text=j.localName;h.append(HB);h.append(new Text("="));Element JB=new SpanElement();JB.attributes['class']='attribute_value';JB.text=j.value;h.append(JB);}h.onClick.listen((MouseEvent cB){cR();});k.append(h);}g.append(k);if(state!=2&&BI){DivElement i=new DivElement();i.id='contents-'+id;i.classes.add('indent');i.classes.add('lcdblock-content');iM(i);n BB=firstChild;while(BB!=null){i.append(BB.html());BB=BB.nextSibling;}if(lastChild==null||lastChild.nodeType==n.nB)i.appendText('\n');g.append(i);}return (g);}void BF(List<n> i){super.BF(i);if(BI&&state!=2){DivElement h=dD();if(h.nodes.length>0){Node g=h.nodes.first;while(g!=null){Node j=g.nextNode;if(g is Text||g is BRElement)g.remove();g=j;}}if(lastChild==null||lastChild.nodeType==n.nB)h.appendText('\n');}}void vI(){if(state==0){DivElement m=pB();TableElement o=querySelector("#${id}>table");int k=0;for(l h in IE){String i=t.CB.PH(DB,h);String g=getAttribute(i);String j=t.CB.dF(h);if(g==null){if(j!=null)g=j;else g='';}sH[i].jM(g);k++ ;}lF();}}Element dD(){if(state==2||!BI)return (null);return (document.getElementById('contents-'+id));}bool RE(){return (true);}bool RG(){return (BI);}void cM(DD g){g();}void JE([DD g]){state=0;if(dD()!=null)sD();if(g!=null)g();}q QE(){if(BI)return (new q(this,0));else return (null);}q SF(){if(BI)return (new q(this,PB));else return (null);}void cR(){iK.select();jK.xE();hK.xE();state=0;sD();if(IE.length>0){String g=t.CB.PH(DB,IE.first);sH[g].focus();}}void KW(){iK.xE();jK.select();hK.xE();state=1;sD();}void KV(){iK.xE();jK.xE();hK.select();state=2;sD();}TableRowElement UO(l h){String o=t.CB.PH(DB,h);TableRowElement j=new TableRowElement();TableCellElement g=new TableCellElement();g.classes.add('shrink');if(t.CB.vG(DB,h)!=null){ButtonElement v=iP(DB,h);g.append(v);}j.append(g);g=new TableCellElement();g.classes.add('shrink');g.text=t.CB.fK(DB,h);if(t.CB.BL(DB,h))g.classes.add('required');else g.classes.add('optional');j.append(g);g=new TableCellElement();g.classes.add('expand');String k=getAttribute(o);String s=t.CB.dF(h);if(k==null){if(s!=null)k=s;else k='';}SD m;m=new SD.zY(DB,h,k,valueChanged:()=>aO(h,m),catchUndo:true);sH[o]=m;Element i=m.html();if(i.firstChild is TextInputElement)(i.firstChild as TextInputElement).classes.add('form_field');else if(i.firstChild is DataListElement&&i.firstChild.nextNode is TextInputElement)(i.firstChild.nextNode as TextInputElement).classes.add('form_field');g.append(i);j.append(g);g=new TableCellElement();g.classes.add('shrink');j.append(g);return (j);}TableRowElement tW(aB i){if(UG==null)UG=new HashMap<aB,TextInputElement>();TextInputElement h=new TextInputElement();h.spellcheck=false;h.size=40;h.value=i.value;h.classes.add('invalid');h.onInput.listen((Event k)=>RR(i,h));h.onKeyUp.listen((KeyboardEvent k)=>RR(i,h));UG[i]=h;TableRowElement j=new TableRowElement();TableCellElement g=new TableCellElement();g.classes.add('shrink');j.append(g);g=new TableCellElement();g.classes.add('shrink');g.appendText(i.name);j.append(g);g=new TableCellElement();g.classes.add('expand');g.append(h);j.append(g);g=new TableCellElement();g.classes.add('shrink');j.append(g);return (j);}void aO(l j,SD m){String h=m.hF();String k=t.CB.PH(DB,j);String i=t.CB.dF(j);aB g;if((h==''&&i==null)||h==i)g=new aB(k,null);else if(h!=''||i!=null)g=new aB(k,h);else g=null;if(g!=null)t.DC(new GB.uX(this,g,updateDisplay:false));lF();}void RR(aB g,TextInputElement k){String h=k.value;if(getAttributeNS(g.qB,g.localName)!=h){String j=g.name;aB i;if(h=='')i=new aB(j,null);else i=new aB(j,h);t.DC(new GB.uX(this,i,updateDisplay:false));lF();}}static ButtonElement iP(final l i,final l j){ButtonElement g=new ButtonElement();g.attributes['type']='button';g.classes.add('help');g.value='?';g.text='?';if(j==null){String h=t.CB.wH(i);if(h!=null)g.title=h;g.onClick.listen((Event k)=>(new XG.VX(i)).show());}else{String h=t.CB.vG(i,j);if(h!=null)g.title=h;g.onClick.listen((Event k)=>(new XG.XX(j,i)).show());}return (g);}}void main(){ND.bT();SL('lcdblock',(l g)=>new jJ.QX(g),(AB h,n i)=>new jJ.SX(h,i));SL('texmathjax',(l g)=>new iJ.LX(g),(AB h,n i)=>new iJ.MX(h,i));SL('lm',(l g)=>new OL.NX(g),(AB h,n i)=>new OL.OX(h,i));SL('perl',(l g)=>new NL.PX(g),(AB h,n i)=>new NL.RX(h,i));Future.wait([LB.MU(),VF.tS(),zS('templates.xml')]).then((List k){vS().then((QB){WF m=yS();if(m!=null)IB.toolbar.add(m);l j=t.CB.iG('m');if(j!=null){jD o=new jD();MC EB=new MC(VF.FH('tex_equation'),'images/tex.png',()=>t.CI(j,'element'),OI.DN,data:new wC([j],null,null));o.add(EB);IB.toolbar.add(o);}Element HB=querySelector('.toolbar');HB.replaceWith(IB.toolbar.html());IB.SO();IB.LC();if(k[2] is sB){Element s=document.getElementsByClassName('menubar')[0];if(t.SH.indexOf('&url=')!=-1){uB JB=new uB(LB.MB('menu.save'),()=>wS(),shortcut:'S');WB v=IB.yF.VH[0];v.add(JB);s.firstChild.replaceWith(IB.yF.OM(v));}WB BB=AT(k[2]);IB.yF.add(BB);s.append(IB.yF.OM(BB));IB.LC();}else print("Error reading templates file, could not build the menu.");});});}class tM{iJ u;DD ZZ;tM(this.u,[this.ZZ]){}void show(){DivElement h=new DivElement();h.id='dlg1';h.classes.add('dlg1');DivElement o=new DivElement();o.classes.add('dlg2');DivElement s=new DivElement();s.classes.add('dlg3');FormElement i=new FormElement();TextAreaElement g=new TextAreaElement();g.id='eqtext';if(u.firstChild!=null)g.value=u.firstChild.nodeValue.trim();g.style.width='100%';g.style.height='4em';g.attributes['spellcheck']='false';g.onInput.listen((Event v)=>input());i.append(g);DivElement BB=new DivElement();BB.id='preview';i.append(BB);DivElement j=new DivElement();j.classes.add('buttons');ButtonElement k=new ButtonElement();k.attributes['type']='button';k.appendText(LB.MB("button.Cancel"));k.onClick.listen((MouseEvent v)=>h.remove());j.append(k);ButtonElement m=new ButtonElement();m.attributes['type']='submit';m.appendText(LB.MB("button.OK"));m.onClick.listen((MouseEvent v)=>iF(v));j.append(m);i.append(j);s.append(i);o.append(s);h.append(o);document.body.append(h);g.focus();input();}void iF(MouseEvent h){TextAreaElement i=querySelector('textarea#eqtext');String g=i.value;if(g!=''){if(u.firstChild!=null)u.firstChild.nodeValue=g;else u.jB(new OB(g));}else{if(u.firstChild!=null)u.gC(u.firstChild);}querySelector('div#dlg1').remove();if(h!=null)h.preventDefault();if(ZZ!=null)ZZ();}void input(){TextAreaElement g=querySelector('textarea#eqtext');String h=g.value;DivElement i=document.getElementById('preview');i.text=u.WR(h);JsArray j=new JsObject.jsify(['Typeset',context['MathJax']['Hub'],'preview']);context['MathJax']['Hub'].callMethod('Queue',[j]);}}Future vS(){Completer i=new Completer();t=new PL();IB=new AN();String k=null;String h=null;String m=null;Location o=window.location;String j=o.search;if(j.startsWith('?'))j=j.substring(1);List<String> s=j.split('&');for(String v in s){List<String> g=v.split('=');if(g.length!=2)continue;if(g[0]=='config')h=g[1];else if(g[0]=='file')k=Uri.decodeComponent(g[1]);else if(g[0]=='save')m=g[1];}if(m!=null)t.CL=m;if(h!=null&&k!=null)IB.KP(k,h).then((BB)=>i.complete());else if(h!=null)IB.GP(h).then((BB)=>i.complete());else{window.alert(LB.MB('daxe.missing_config'));i.completeError(LB.MB('daxe.missing_config'));}return (i.future);}void wS(){xS().then((h){window.alert(LB.MB('save.success'));},onError:(CD g){window.alert(LB.MB('save.error')+': '+g.message);});}Future xS(){int i=t.SH.indexOf('&url=');if(i==-1)return (new Future.error(new CD('bad URL')));String h=t.SH.substring(i+5);h=Uri.decodeQueryComponent(h);i=h.lastIndexOf('/');String m;if(i==-1)m=h;else{m=h.substring(i+1);h=h.substring(0,i+1);}Completer o=new Completer();String k='AaB03x';HttpRequest j=new HttpRequest();j.onLoad.listen((ProgressEvent s){o.complete();});j.onError.listen((ProgressEvent s){o.completeError(new CD(j.status.toString()));});j.open('POST','/upload_file');j.setRequestHeader('Content-Type',"multipart/form-data; boundary=${k}");StringBuffer g=new StringBuffer();g.write("--${k}\r\n");g.write('Content-Disposition: form-data; name="uploads_path"\r\n');g.write('Content-type: text/plain; charset=UTF-8\r\n');g.write('Content-transfer-encoding: 8bit\r\n\r\n');g.write(h);g.write("\r\n--${k}\r\n");g.write('Content-Disposition: form-data; name="uploads"; filename="${m}"\r\n');g.write('Content-Type: application/octet-stream\r\n\r\n');t.rC.nF='UTF-8';g.write(t.toString());g.write('\r\n--${k}--\r\n\r\n');j.send(g.toString());return (o.future);}WF yS(){WB j=new WB(VF.FH('Section'));List<l> g=t.CB.nK('section');if(g==null||g.length==0)return (null);l o=t.CB.iG('h1');for(String k in ['introduction','conclusion','prerequisites','objectives','reminder','definition','demonstration','example','advise','remark','warning','more_information','method','activity','bibliography','citation']){uB h=new uB(VF.FH(k),null,data:new wC(g,null,null));h.action=(){wC s=h.data;l v=s.cH;n i=ND.NF(v);i.setAttribute('class','role-'+k);n m=ND.NF(o);if(t.BS(i,IB.vC())){t.insertNode(m,new q(i,0));IB.cursor.moveTo(new q(m,0));IB.LC();}};j.add(h);}WF BB=new WF(j,OI.lT,IB.toolbar);return (BB);}Future<sB> zS(String g){EG h=new EG();return (h.AL(g));}WB AT(sB i){WB h=new WB(VF.FH('Templates'));l j=i.documentElement;for(AB g in j.childNodes){if(g.nodeType==AB.FE&&g.nodeName=='menu'){h.add(hP(g));}}return (h);}WB hP(l j){String k=VF.gJ;String m=VF.pM;String h;for(AB g in j.childNodes){if(g.nodeType==AB.FE&&g.nodeName=='title'){if(g.firstChild!=null&&g.firstChild.nodeType==AB.kE){if((g as l).getAttribute('lang')==k){h=g.firstChild.nodeValue;break;}else if((g as l).getAttribute('lang')==m){h=g.firstChild.nodeValue;}}}}if(h==null)h='?';WB i=new WB(h);for(AB g in j.childNodes){if(g.nodeType==AB.FE){if(g.nodeName=='menu'){i.add(hP(g));}else if(g.nodeName=='item'){i.add(BT(g));}}}return (i);}uB BT(l v){String k=VF.gJ;String m=VF.pM;String o,j,h,i;for(AB g in v.childNodes){if(g.nodeType==AB.FE){if(g.nodeName=='title'){if(g.firstChild!=null&&g.firstChild.nodeType==AB.kE){if((g as l).getAttribute('lang')==k){h=g.firstChild.nodeValue;}else if(h==null&&(g as l).getAttribute('lang')==m){h=g.firstChild.nodeValue;}}}else if(g.nodeName=='path'&&g.firstChild!=null&&g.firstChild.nodeType==AB.kE){o=g.firstChild.nodeValue;}else if(g.nodeName=='type'&&g.firstChild!=null&&g.firstChild.nodeType==AB.kE){j=g.firstChild.nodeValue;}else if(g.nodeName=='help'){if(g.firstChild!=null&&g.firstChild.nodeType==AB.kE){if((g as l).getAttribute('lang')==k){i=g.firstChild.nodeValue;}else if(i==null&&(g as l).getAttribute('lang')==m){i=g.firstChild.nodeValue;}}}}}if(j==null){print("Warning: missing type for template ${h}\n");j='problem';}l BB=t.CB.iG(j);uB s=new uB(h,()=>CT(o),data:BB);if(i!=null)s.KI=i;return s;}void CT(String k){try {EG m=new EG();m.AL(k).then((sB o){l g=o.documentElement;if(g==null)return;t.WS(g);n h=ND.fH(g,null);GB i;q j=IB.vC();if(h.nodeName=='loncapa'&&t.nI()!=null)i=t.LE(h,j,checkValidity:true);else i=new GB.pX(j,h);t.DC(i);IB.LC();});}on UD catch (s){window.alert(s.toString());}}abstract class DT{static const int uM=61;static const int ET=13;static const int FT=10;static const int GT=76;static const String HT="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";static const String IT="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";static String LT(List<int> k,[bool JB=false,bool BB=false]){int o=k.length;if(o==0){return "";}final String j=JB?IT:HT;final int s=o.remainder(3);final int QB=o-s;int v=((o~/3)*4)+((s>0)?4:0);if(BB){v+= ((v-1)~/GT)<<1;}List<int> g=new List<int>(v);int h=0,m=0,EB=0;while(m<QB){int i=((k[m++ ]<<16)&0xFFFFFF)|((k[m++ ]<<8)&0xFFFFFF)|k[m++ ];g[h++ ]=j.codeUnitAt(i>>18);g[h++ ]=j.codeUnitAt((i>>12)&0x3F);g[h++ ]=j.codeUnitAt((i>>6)&0x3F);g[h++ ]=j.codeUnitAt(i&0x3f);if(BB&& ++EB==19&&h<v-2){g[h++ ]=ET;g[h++ ]=FT;EB=0;}}if(s==1){int i=k[m];g[h++ ]=j.codeUnitAt(i>>2);g[h++ ]=j.codeUnitAt((i<<4)&0x3F);g[h++ ]=uM;g[h++ ]=uM;}else if(s==2){int i=k[m];int HB=k[m+1];g[h++ ]=j.codeUnitAt(i>>2);g[h++ ]=j.codeUnitAt(((i<<4)|(HB>>4))&0x3F);g[h++ ]=j.codeUnitAt((HB<<2)&0x3F);g[h++ ]=uM;}return new String.fromCharCodes(g);}}class JT{static String KT(List<int> g,{bool urlSafe: false,bool addLineSeparator: false}){return DT.LT(g,urlSafe,addLineSeparator);}}class uD extends MapBase<String,String>{LinkedHashMap<String,String> map;uD(String h){map=new LinkedHashMap<String,String>();if(h!=null){for(String k in h.split(';')){List<String> g=k.split(':');if(g.length==2){String i=g[0].trim().toLowerCase();String j=g[1].trim().toLowerCase();if(i!=''&&j!='')map[i]=j;}}}}String operator[](String g)=>map[g];void operator[]=(String g,String h){map[g]=h;}String remove(String g){return (map.remove(g));}Iterable<String> get keys{return (map.keys);}void clear(){map.clear;}String toString(){List<String> g=new List<String>();map.forEach((String h,String i)=>g.add(h+': '+i));return (g.join('; '));}bool VV(uD g){List<String> j=keys;List<String> k=g.map.keys;return (j.every((String h)=>map[h]==g.map[h])&&k.every((String i)=>map[i]==g.map[i]));}}class OI{List<mG> items;List<l> XO=null;static final String MD='packages/daxe/images/toolbar/';OI([HH g]){items=new List<mG>();if(t.CL!=null){jD cB=new jD();cB.add(new MC(LB.MB('menu.save'),MD+'document_save.png',()=>IB.save(),null));items.add(cB);}jD QB=new jD();QB.add(new MC(LB.MB('undo.undo'),MD+'history_undo.png',()=>t.aH(),null,data:"undo",enabled:false));QB.add(new MC(LB.MB('undo.redo'),MD+'history_redo.png',()=>t.dM(),null,data:"redo",enabled:false));items.add(QB);jD hB=new jD();hB.add(new MC(LB.MB('find.find_replace'),MD+'find.png',()=>(new jP()).show(),null));items.add(hB);if(g!=null){jD m=new jD();List<l> h=g.yG('fichier');if(h!=null&&h.length>0){cK(g,m,h,MD+'insert_image.png');}h=g.yG('equationmem');if(h!=null&&h.length>0){cK(g,m,h,MD+'equation.png');}h=g.yG('symbole2');if(h!=null&&h.length>0){cK(g,m,h,MD+'insert_symbol.png');}h=g.yG('tabletexte');if(h!=null&&h.length>0){cK(g,m,h,MD+'insert_table.png');}h=g.yG('liste');if(h!=null&&h.length>0){cK(g,m,h,MD+'ul.png');}items.add(m);List<l> o=iC.IU();List<l> s=iC.JU();if(o.length>0||s.length>0){jD BB=new jD();if(o.length>0){MC i=new MC(aZ(o[0]),MD+'ul.png',null,oP,data:new wC(o,null,null));i.action=(){if(i.selected)iC.RN();else iC.FQ((i.data as wC).cH);};BB.add(i);}if(s.length>0){MC i=new MC(aZ(s[0]),MD+'ol.png',null,oP,data:new wC(s,null,null));i.action=(){if(i.selected)iC.RN();else iC.FQ((i.data as wC).cH);};BB.add(i);}BB.add(new MC(LB.MB('toolbar.rise_list_level'),MD+'list_rise_level.png',()=>iC.RN(),fT,data:'rise_list_level'));bool SB=true;for(l IC in o)if(t.CB.fF(iC.cL(IC),o)==null)SB=false;for(l QD in s)if(t.CB.fF(iC.cL(QD),s)==null)SB=false;if(SB)BB.add(new MC(LB.MB('toolbar.lower_list_level'),MD+'list_lower_level.png',()=>iC.GU(),gT,data:'lower_list_level'));items.add(BB);}List<l> EB=pG.vT();if(EB!=null&&EB.length>0){jD JB=new jD();MC i=new MC(LB.MB('toolbar.insert_link'),MD+'add_link.png',null,hT,data:new wC(EB,null,null));i.action=()=>pG.wT((i.data as wC).cH);JB.add(i);i=new MC(LB.MB('toolbar.remove_link'),MD+'remove_link.png',()=>pG.BU(),iT,data:new wC(EB,null,null));JB.add(i);i=new MC(LB.MB('toolbar.insert_anchor'),MD+'anchor.png',null,DN,data:new wC(EB,null,null));i.action=()=>pG.AU((i.data as wC).cH);JB.add(i);items.add(JB);}jD j=new jD();List<l> tD=g.vU();for(l k in tD){String qE=g.gO(k);if(qE=='style'){String v=g.bC(k,'style',null);if(v=='GRAS'){OJ(g,j,k,MD+'style_bold.png','B');}else if(v=='ITALIQUE'){OJ(g,j,k,MD+'style_italic.png','I');}else if(v=='EXPOSANT'){OJ(g,j,k,MD+'style_superscript.png');}else if(v=='INDICE'){OJ(g,j,k,MD+'style_subscript.png');}else if(v=='BARRE'){OJ(g,j,k,MD+'style_strikethrough.png');}else if(v=='SOULIGNE'){OJ(g,j,k,MD+'style_underline.png');}}}if(j.length>0){j.add(new MC(LB.MB('toolbar.remove_styles'),MD+'remove_styles.png',()=>zB.eL(),null,data:"remove_styles"));items.add(j);}if(t.ZC!=null){String MF=t.CB.bC(t.ZC[0],'styleAtt','style');List<l> WG=t.CB.fE(t.ZC[0]);bool CC=false;for(l NI in WG){if(t.CB.attributeName(NI)==MF){CC=true;break;}}if(CC){jD HB=new jD();NM(HB,'text-align','left',LB.MB('toolbar.align_left'),MD+'align_left.png');NM(HB,'text-align','right',LB.MB('toolbar.align_right'),MD+'align_right.png');NM(HB,'text-align','center',LB.MB('toolbar.align_center'),MD+'align_center.png');NM(HB,'text-align','justify',LB.MB('toolbar.align_justify'),MD+'align_justify.png');items.add(HB);}}l eJ=YE.EQ();if(eJ!=null){List<String> fJ=['serif','sans-serif','cursive','fantasy','monospace'];WF ML=bZ(LB.MB('toolbar.font'),"font-family",fJ);items.add(ML);}}}WF bZ(String BB,String h,List<String> EB,[String s]){WB k=new WB(BB);k.parent=this;l i=YE.EQ();for(String v in EB){String j=v;if(s!=null)j+= s;uB m=new uB(v,null,data:new wC([i],h,j));m.action=(){if(m.checked){q g=IB.vC();q HB=IB.GF();if(g==HB&&g.u is OB&&g.u.parent.DB==i&&(g.u.parent as zB).CH(h,j)&&g.KB==g.u.PB&&g.u.nextSibling==null){n o=g.u.parent;IB.KD(new q(o.parent,o.parent.ZB(o)+1));IB.LC();}else zB.eL(i,h);}else{zB.KU(i,h,j);}};k.add(m);}WF JB=new WF(k,jT,this);return (JB);}add(mG g){items.add(g);}insert(mG g,int h){items.insert(h,g);}remove(int g){items.remove(g);}List<MC> get HG{List<MC> g=new List<MC>();for(mG h in items){if(h is jD)g.addAll(h.HG);}return (g);}List<l> dR(){if(XO!=null)return (XO);List<l> h=new List<l>();for(mG i in items){if(i is jD){for(MC j in i.HG){if(j.data is wC){wC g=j.data;if(g.kF!=null)h.addAll(g.kF);}}}else if(i is WF){WB m=i.pI;for(uB k in m.items){if(k.data is wC){wC g=k.data;if(g.kF!=null)h.addAll(g.kF);}}}}XO=h;return (h);}Element html(){DivElement g=new DivElement();g.classes.add('toolbar');for(mG h in items){g.append(h.html());}return (g);}String aZ(l h){String g=t.CB.wH(h);if(g==null)g=t.CB.OD(h);return (g);}cK(HH k,jD i,List<l> h,String j){MC g=new MC(aZ(h[0]),j,null,DN,data:new wC(h,null,null));g.action=()=>t.CI((g.data as wC).cH,'element');i.add(g);}static void DN(MC g,n j,n k,List<l> i,List<l> m){wC h=g.data;List<l> o=h.kF;if(h.rK(i))g.enable();else g.disable();}OJ(HH v,jD k,l h,String m,[String o=null]){MC i=new MC(aZ(h),m,null,dT,data:new wC([h],null,null),shortcut:o);i.action=(){if(i.selected){q g=IB.vC();q s=IB.GF();if(g==s&&g.u is OB&&g.u.parent.DB==h&&g.KB==g.u.PB&&g.u.nextSibling==null){n j=g.u.parent;IB.KD(new q(j.parent,j.parent.ZB(j)+1));IB.LC();}else zB.eL(h);}else{zB.KQ(h);}};k.add(i);}static void dT(MC g,n v,n h,List<l> m,List<l> o){wC i=g.data;List<l> j=i.kF;bool k=false;for(l s in j){if(o.contains(s)){k=true;break;}}if(k){g.enable();g.select();}else{if(h!=null&&j.contains(h.DB))g.select();else g.xE();if(i.rK(m))g.enable();else g.disable();}}NM(jD j,String g,String i,String k,String m){MC h=new MC(k,m,null,eT,data:new wC(t.ZC,g,i));h.action=(){if(h.selected){kB.uT(g);}else{kB.zT(g,i);}};j.add(h);}static void eT(MC g,n m,n j,List<l> o,List<l> s){wC i=g.data;bool k=false;for(n h=m;h!=null;h=h.parent){if(t.ZC.contains(h.DB)){if((h as kB).CH(i.jI,i.RJ)){k=true;break;}}}if(k){g.enable();g.select();}else{if(j!=null&&t.ZC.contains(j.DB)&&(j as kB).CH(i.jI,i.RJ)){g.select();}else{g.xE();}if(kB.dL().length>0)g.enable();else g.disable();}}static void oP(MC g,n k,n s,List<l> m,List<l> v){wC i=g.data;List<l> o=i.kF;bool j=false;for(n h=k;h!=null;h=h.parent){if(o.contains(h.DB)){j=true;break;}}if(j){g.enable();g.select();}else{g.xE();if(i.rK(m))g.enable();else g.disable();}}static void fT(MC h,n j,n k,List<l> m,List<l> o){q i=IB.vC();n g=i.u;while(g!=null&&g is!xD)g=g.parent;if(g!=null)h.enable();else h.disable();}static void gT(MC h,n j,n k,List<l> m,List<l> o){q i=IB.vC();n g=i.u;while(g!=null&&g is!xD)g=g.parent;if(g==null||g.previousSibling==null)h.disable();else h.enable();}static void hT(MC g,n j,n k,List<l> h,List<l> m){wC i=g.data;if(IB.vC().u is OB&&i.rK(h))g.enable();else g.disable();}static void iT(MC g,n o,n s,List<l> v,List<l> i){wC j=g.data;List<l> k=j.kF;bool h=false;for(l m in k){if(i.contains(m)){h=true;break;}}if(h)g.enable();else g.disable();}static void jT(WF HB,n JB,n j,List<l> v,List<l> QB){WB BB=HB.pI;uB k=null;for(uB g in BB.items){if(g.data is wC){wC EB=g.data;l h=EB.kF[0];String o=EB.jI;String s=EB.RJ;if(t.ZC.contains(h)){bool m=false;for(n i=JB;i!=null;i=i.parent){if(t.ZC.contains(i.DB)&&(i as kB).CH(o,s)){m=true;break;}}if(m){g.enable();k=g;g.check();}else{if(j!=null&&t.ZC.contains(j.DB)&&(j as kB).CH(o,s)){k=g;g.check();}else{g.eS();}if(kB.dL().length>0)g.enable();else g.disable();}}else if(t.CB.gO(h)=='style'){if(QB.contains(h)){g.enable();k=g;}else{if(j!=null&&h==j.DB)k=g;if(v.contains(h))g.enable();else g.disable();}}else if(t.CB.gO(h)=='stylespan'){bool m=false;for(n i=JB;i!=null;i=i.parent){if(i.DB==h&&(i as YE).CH(o,s)){m=true;break;}}if(m){g.enable();k=g;g.check();}else{if(j!=null&&h==j.DB&&(j as YE).CH(o,s)){k=g;g.check();}else{g.eS();}if(v.contains(h))g.enable();else g.disable();}}else if(h!=null){if(v.contains(h))g.enable();else g.disable();}}}if(k==null)BB.title=HB.title;else BB.title=k.title;}static void lT(WF j,n o,n s,List<l> k,List<l> v){WB m=j.pI;for(uB g in m.items){if(g.data is wC){wC h=g.data;List<l> i=h.kF;if(i!=null&&i.length>0){if(h.rK(k))g.enable();else g.disable();}}}}void update(n i,List<l> s){List<l> j=new List<l>();for(n h=i;h!=null;h=h.parent)j.add(h.DB);n k=null;q g=IB.vC();q v=IB.GF();if(g.u is!OB&&g.u.PB>g.KB){if(v==new q(g.u,g.KB+1))k=g.u.eB(g.KB);}for(MC m in HG){if(m.update!=null)m.update(m,i,k,s,j);}for(mG o in items){if(o is WF){o.update(o,i,k,s,j);}}}}abstract class mG{Element html();}class wC{List<l> kF;l cH;String jI;String RJ;wC(this.kF,this.jI,this.RJ){assert(kF!=null&&kF.length>0&&(jI==null||RJ!=null));cH=null;}String get css{if(jI==null)return (null);return ("${jI}: ${RJ}");}bool rK(List<l> h){for(l g in kF){if(h.contains(g)){cH=g;return (true);}}cH=null;return (false);}}class vM{n RF;l DB;List<l> IE;HashMap<l,SD> controls;HashMap<aB,TextInputElement> UG;DD okfct;vM(this.RF,[this.okfct]){DB=RF.DB;controls=new HashMap<l,SD>();UG=null;}void show(){DivElement s=new DivElement();s.id='attributes_dlg';s.classes.add('dlg1');DivElement SB=new DivElement();SB.classes.add('dlg2');DivElement v=new DivElement();v.classes.add('dlg3');DivElement m=new DivElement();m.classes.add('dlgtitle');m.text=t.CB.OD(DB);v.append(m);FormElement cB=new FormElement();TableElement hB=new TableElement();IE=t.CB.fE(DB);SD BB=null;for(l h in IE){TableRowElement i=new TableRowElement();TableCellElement g=new TableCellElement();String QD=t.CB.vG(DB,h);if(QD!=null){ButtonElement j=new ButtonElement();j.attributes['type']='button';j.classes.add('help');j.value='?';j.text='?';j.title=QD;j.onClick.listen((Event CC)=>uO(h,DB));g.append(j);}i.append(g);g=new TableCellElement();String WG=t.CB.PH(DB,h);String m=t.CB.fK(DB,h);g.appendText(m);if(t.CB.BL(DB,h))g.classes.add('required');else g.classes.add('optional');i.append(g);g=new TableCellElement();String EB=RF.getAttribute(WG);String tD=t.CB.dF(h);if(EB==null){if(tD!=null)EB=tD;else EB='';}SD IC=new SD.zY(DB,h,EB);controls[h]=IC;List<String> qE=t.CB.hI(h);if(qE==null||qE.length==0)if(BB==null)BB=IC;g.append(IC.html());i.append(g);hB.append(i);}for(aB o in RF.attributes){bool MF=false;for(l h in controls.keys){if(o.localName==t.CB.attributeName(h)&&o.qB==t.CB.attributeNamespace(h)){MF=true;break;}}if(!MF){if(UG==null)UG=new HashMap<aB,TextInputElement>();TextInputElement k=new TextInputElement();k.spellcheck=false;k.size=40;k.value=o.value;k.classes.add('invalid');UG[o]=k;TableRowElement i=new TableRowElement();TableCellElement g=new TableCellElement();i.append(g);g=new TableCellElement();g.appendText(o.name);i.append(g);g=new TableCellElement();g.append(k);i.append(g);hB.append(i);}}cB.append(hB);DivElement HB=new DivElement();HB.classes.add('buttons');ButtonElement JB=new ButtonElement();JB.attributes['type']='button';JB.appendText(LB.MB("button.Cancel"));JB.onClick.listen((MouseEvent CC)=>cancel());HB.append(JB);ButtonElement QB=new ButtonElement();QB.attributes['type']='submit';QB.appendText(LB.MB("button.OK"));QB.onClick.listen((MouseEvent CC)=>iF(CC));HB.append(QB);cB.append(HB);v.append(cB);SB.append(v);s.append(SB);document.body.append(s);if(BB!=null)BB.focus();}void iF(MouseEvent v){for(l h in controls.keys){SD k=controls[h];String g=k.hF();bool EB=t.CB.BL(DB,h);if(g==''&&EB){v.preventDefault();window.alert(LB.MB('attribute.missing_required'));return;}}LinkedHashMap<String,aB> j=RF.gR();for(l h in controls.keys){SD k=controls[h];String i=t.CB.PH(DB,h);String g=k.hF();String m=t.CB.attributeNamespace(h);String o=t.CB.dF(h);if((g==''&&o==null)||g==o)j.remove(i);else if(g!=''||o!=null)j[i]=new aB.dX(m,i,g);}if(UG!=null){for(aB s in UG.keys){TextInputElement HB=UG[s];String i=s.name;String g=HB.value;String m=s.qB;if(g=='')j.remove(i);else j[i]=new aB.dX(m,i,g);}}querySelector('div#attributes_dlg').remove();v.preventDefault();List<aB> BB=new List.from(j.values);if(RF.pB()!=null){GB JB=new GB.tX(RF,BB);t.DC(JB);}else{RF.attributes=BB;}IB.AH();if(okfct!=null)okfct();}void cancel(){querySelector('div#attributes_dlg').remove();IB.AH();}void uO(l g,l h){XG i=new XG.XX(g,h);i.show();}}class WB extends uB{List<uB> items;String DP;WB(String g):super(g,null){items=new List<uB>();this.DP="menu_${uB.wM-1}";}add(uB g){g.parent=this;items.add(g);}Element AS(){TableRowElement g=new TableRowElement();g.id=jG;g.setAttribute('tabindex','-1');g.onKeyDown.listen((KeyboardEvent k){if(document.activeElement!=g)return;int i=k.keyCode;if(i==KeyCode.ENTER){select();}else if(i==KeyCode.UP){(parent as WB).YJ(this);}else if(i==KeyCode.DOWN){(parent as WB).DL(this);}else if(i==KeyCode.LEFT){if(parent is WB){if((parent as WB).parent is WB)(parent as WB).select();else if((parent as WB).parent is zF)((parent as WB).parent as zF).YJ(parent as WB);}}else if(i==KeyCode.RIGHT){for(uB m in items){if(m.enabled){m.select();break;}}}else if(i==KeyCode.TAB){Timer.run(dO);}});TableCellElement h=new TableCellElement();h.text=cZ;h.onMouseOver.listen((MouseEvent k){if(enabled){select();show();}});g.append(h);h=new TableCellElement();h.text=">";DivElement j=VM();j.classes.remove('dropdown_menu');j.classes.add('submenu');j.style.display='none';h.append(j);h.onMouseOver.listen((MouseEvent k){if(enabled){select();show();}});g.append(h);if(!enabled)g.classes.add('disabled');if(KI!=null)g.title=KI;return (g);}Element VM(){DivElement g=new DivElement();g.classes.add('dropdown_menu');g.id=DP;TableElement h=new TableElement();h.classes.add('menu');for(uB i in items){h.append(i.AS());}g.append(h);return (g);}Element vK(){return (querySelector("#${DP}"));}void show(){DivElement g=vK();g.style.display='block';}void UH(){for(uB g in items){if(g is WB)g.UH();g.xE();}DivElement h=vK();h.style.display='none';}bool GS(){DivElement g=vK();return (g.style.display!='none');}void RO(){items.add(new uB.fX());}void RV(uB h){for(uB g in items){if(g!=h)g.xE();}}void set title(String h){cZ=h;Element g=querySelector("#${jG}");if(g is TableRowElement){TableRowElement j=g;TableCellElement k=j.nodes.first;k.text=h;}else if(g is DivElement){Node i=g.firstChild;if(i is Text)i.text=h;}}void cO(){bool g=false;for(uB i in items){if(i.enabled){g=true;break;}}if(g==enabled)return;Element h=querySelector("#${jG}");if(g)h.classes.remove('disabled');else h.classes.add('disabled');enabled=g;if(parent is WB)(parent as WB).cO();}void eW(){for(uB g in items){if(g.enabled){g.select();return;}}}void YJ(uB h){bool i=false;for(uB g in items.reversed){if(g==h){i=true;}else if(i&&g.enabled){h.xE();g.select();break;}}}void DL(uB h){bool i=false;for(uB g in items){if(g==h){i=true;}else if(i&&g.enabled){h.xE();g.select();break;}}}}class uB{static int wM=0;String jG;String cZ;Object parent;DD action;String shortcut;Object data;bool enabled;bool selected;bool zO;String KI;bool checked;uB(this.cZ,this.action,{this.shortcut,this.data}){this.jG="item_${wM}";wM++ ;parent=null;enabled=true;selected=false;zO=false;checked=false;}uB.fX(){zO=true;enabled=false;checked=false;selected=false;}Element AS(){TableRowElement h=new TableRowElement();if(zO){TableCellElement g=new TableCellElement();g.append(new HRElement());h.append(g);}else{h.id=jG;h.setAttribute('tabindex','-1');h.onKeyDown.listen((KeyboardEvent i){int j=i.keyCode;if(j==KeyCode.ENTER){i.preventDefault();dO();OO();}else if(j==KeyCode.UP){(parent as WB).YJ(this);}else if(j==KeyCode.DOWN){(parent as WB).DL(this);}else if(j==KeyCode.LEFT){if((parent as WB).parent is WB){(parent as WB).UH();(parent as WB).zH().focus();i.preventDefault();i.stopPropagation();}else if((parent as WB).parent is zF)((parent as WB).parent as zF).YJ(parent as WB);}else if(j==KeyCode.RIGHT){Object k=parent;while(k is WB)k=(k as WB).parent;if(k is zF)k.DL(null);}else if(j==KeyCode.TAB){Timer.run(dO);}});TableCellElement g=new TableCellElement();g.text=cZ;g.onMouseUp.listen((MouseEvent i)=>OO());g.onMouseOver.listen((MouseEvent i){if(enabled)select();});g.onMouseOut.listen((MouseEvent i)=>xE());h.append(g);g=new TableCellElement();if(this.shortcut!=null)g.text="Ctrl+${shortcut}";g.onMouseUp.listen((MouseEvent i)=>OO());g.onMouseOver.listen((MouseEvent i){if(enabled)select();});g.onMouseOut.listen((MouseEvent i)=>xE());if(checked)h.classes.add('checked');h.append(g);if(!enabled)h.classes.add('disabled');}if(KI!=null)h.title=KI;return (h);}Element zH(){return (querySelector("#${jG}"));}void OO(){if(!enabled)return;IB.AH();action();}void select(){if(selected)return;selected=true;Element g=zH();g.classes.add('selected');if(this is WB){(this as WB).show();}if(parent is WB)(parent as WB).RV(this);g.focus();}void xE(){if(!selected)return;selected=false;Element g=zH();if(g!=null){g.classes.remove('selected');g.blur();}if(this is WB){(this as WB).UH();}}void disable(){if(!enabled)return;enabled=false;Element g=zH();g.classes.remove('selected');g.classes.add('disabled');if(parent is WB)(parent as WB).cO();}void enable(){if(enabled)return;enabled=true;Element g=zH();g.classes.remove('disabled');if(parent is WB)(parent as WB).cO();}void check(){if(checked)return;checked=true;Element g=zH();g.classes.add('checked');}void eS(){if(!checked)return;checked=false;Element g=zH();g.classes.remove('checked');}String get title{return (cZ);}void set title(String g){cZ=g;TableRowElement h=querySelector("#${jG}");TableCellElement i=h.nodes.first;i.text=g;}void dO(){if(parent is!WB)return;WB g=parent;while(g.parent is WB)g=g.parent;if(g.parent is zF)(g.parent as zF).zR();else g.UH();}}class jD extends mG{List<MC> HG;jD(){HG=new List<MC>();}add(MC g){HG.add(g);}insert(MC g,int h){HG.insert(h,g);}remove(int g){HG.remove(g);}get length{return (HG.length);}Element html(){DivElement g=new DivElement();g.classes.add('toolbar-box');for(MC h in HG){g.append(h.html());}return (g);}}class CD implements Exception{final String message;final Exception parentException;const CD([this.message,this.parentException]);String toString(){String g;if(message==null)g='DaxeException';else g=message;if(parentException!=null)g="${g} (parent exception: ${parentException})";return (g);}}class zF{List<WB> VH;bool xK;WB mF;zF(){VH=new List<WB>();xK=false;mF=null;}add(WB g){VH.add(g);}insert(WB g,int h){VH.insert(h,g);}Element html(){DivElement g=new DivElement();g.classes.add('menubar');bool h=false;for(WB i in VH){DivElement j=OM(i);g.append(j);if(!h&&i.enabled){j.setAttribute('tabindex','0');h=true;}}document.onMouseUp.listen((MouseEvent k)=>SV(k));return (g);}DivElement OM(WB g){DivElement h=new DivElement();h.text=g.title;h.id=g.jG;h.classes.add('menu_title');if(g.parent is OI)h.setAttribute('tabindex','0');else h.setAttribute('tabindex','-1');h.onMouseDown.listen((MouseEvent i)=>GW(i,g));h.onMouseOver.listen((MouseEvent i)=>HW(i,g));h.onClick.listen((MouseEvent i)=>click(g));h.onKeyDown.listen((KeyboardEvent i){if(document.activeElement!=h)return;int j=i.keyCode;if(j==KeyCode.ENTER||j==KeyCode.DOWN){i.preventDefault();if(g==mF)g.eW();else aJ(g);}else if(j==KeyCode.LEFT){YJ(g);}else if(j==KeyCode.RIGHT){DL(g);}else if(j==KeyCode.TAB){Timer.run(zR);}});Element k=g.VM();k.style.display='none';h.append(k);return (h);}void GW(MouseEvent h,WB g){h.preventDefault();if(!g.GS()){aJ(g);xK=true;}else{xK=false;}}void HW(MouseEvent h,WB g){if(mF==null||mF==g)return;VJ(mF);aJ(g);}void click(WB g){if(xK){return;}if(!g.GS()){aJ(g);}else{VJ(g);}}void SV(MouseEvent g){if(mF==null)return;DivElement i=querySelector("#${mF.jG}");Rectangle h=i.getBoundingClientRect();if(g.client.x<h.left||g.client.x>h.right||g.client.y<h.top||g.client.y>h.bottom){VJ(mF);xK=true;}}void aJ(WB g){mF=g;DivElement h=querySelector("#${g.jG}");h.classes.add('selected');g.show();g.zH().focus();}void VJ(WB g){mF=null;DivElement h=querySelector("#${g.jG}");h.classes.remove('selected');g.UH();}void zR(){if(mF!=null)VJ(mF);}void YJ(WB g){if(g==null)g=mF;if(g==null)return;bool i=false;for(WB h in VH.reversed){if(h==g){i=true;}else if(i&&h.enabled){VJ(g);aJ(h);return;}}}void DL(WB g){if(g==null)g=mF;if(g==null)return;bool i=false;for(WB h in VH){if(h==g){i=true;}else if(i&&h.enabled){VJ(g);aJ(h);return;}}}}class WE{String language;String uH;WE(){List<String> g=LB.hL.split('_');language=g[0];if(g.length>1)uH=g[1];else uH=null;}WE.WX(String g){this.language=g;this.uH=null;}WE.bX(String g,String h){this.language=g;this.uH=h;}int get hashCode{int g=17;g=37*g+language.hashCode;g=37*g+uH.hashCode;return g;}bool operator==(WE g){return (language==g.language&&uH==g.uH);}}typedef void NT(WF tbmenu,n parent,n selectedNode,List<l> validRefs,List<l> ancestorRefs);typedef void MT(MC button,n parent,n selectedNode,List<l> validRefs,List<l> ancestorRefs);typedef n kJ(AB node,n parent);class aB{String qB;String EC;String localName;String value;aB.TX(lC g){qB=g.qB;EC=g.EC;if(g.EC!=null)localName=g.localName;else localName=g.name;value=g.nodeValue;}aB(String g,String h){qB=null;EC=null;localName=g;this.value=h;}aB.dX(String i,String g,String j){qB=i;int h=g.indexOf(':');if(h==-1){EC=null;localName=g;}else{EC=g.substring(0,h);localName=g.substring(h+1);}this.value=j;}aB.jX(aB g){qB=g.qB;EC=g.EC;localName=g.localName;value=g.value;}String get name{if(EC==null)return (localName);else return ("${EC}:${localName}");}String toString(){StringBuffer g=new StringBuffer();if(EC!=null){g.write(EC);g.write(':');}g.write(localName);g.write('="');g.write(n.kT(value));g.write('"');return (g.toString());}}class jP{static bool QL=false;static bool BN=false;static String AG='';void show(){DivElement h=document.getElementById('find_dlg');if(h!=null){TextInputElement o=document.getElementById('find_dlg_find_field');o.focus();return;}Element QD=querySelector("#doc1");QD.style.bottom='10.5em';h=new DivElement();h.id='find_dlg';h.classes.add('find');FormElement s=new FormElement();TableElement v=new TableElement();TableRowElement j=new TableRowElement();TableCellElement g=new TableCellElement();g.text=LB.MB('find.find');j.append(g);g=new TableCellElement();TextInputElement o=new TextInputElement();o..id='find_dlg_find_field'..name='find'..size=40..value=AG;g.append(o);j.append(g);v.append(j);j=new TableRowElement();g=new TableCellElement();g.text=LB.MB('find.replace_by');j.append(g);g=new TableCellElement();TextInputElement HB=new TextInputElement();HB..id='find_dlg_replace_field'..name='replace_by'..size=40;g.append(HB);j.append(g);v.append(j);h.append(v);DivElement m=new DivElement();m.classes.add('options');CheckboxInputElement BB=new CheckboxInputElement();BB..id='find_cb_ignore_case'..checked=QL..onChange.listen((Event i)=>QL=BB.checked);m.append(BB);LabelElement JB=new LabelElement();JB..htmlFor='find_cb_ignore_case'..text=LB.MB("find.case_sensitive");m.append(JB);CheckboxInputElement EB=new CheckboxInputElement();EB..id='find_cb_backwards'..checked=BN..onChange.listen((Event i)=>BN=EB.checked);m.append(EB);LabelElement QB=new LabelElement();QB..htmlFor='find_cb_backwards'..text=LB.MB("find.backwards");m.append(QB);s.append(m);DivElement k=new DivElement();k.classes.add('buttons');ButtonElement SB=new ButtonElement();SB..attributes['type']='button'..appendText(LB.MB("button.Close"))..onClick.listen((MouseEvent i)=>close());k.append(SB);ButtonElement cB=new ButtonElement();cB..attributes['type']='button'..appendText(LB.MB("find.replace"))..onClick.listen((MouseEvent i)=>replace());k.append(cB);ButtonElement hB=new ButtonElement();hB..attributes['type']='button'..appendText(LB.MB("find.replace_find"))..onClick.listen((MouseEvent i)=>WW());k.append(hB);ButtonElement CC=new ButtonElement();CC..attributes['type']='button'..appendText(LB.MB("find.replace_all"))..onClick.listen((MouseEvent i)=>replaceAll());k.append(CC);ButtonElement IC=new ButtonElement();IC..attributes['type']='button'..appendText(LB.MB("find.next"))..onClick.listen((MouseEvent i)=>next());k.append(IC);s.append(k);h.append(s);document.body.append(h);h.onKeyDown.listen((KeyboardEvent i){if(i.keyCode==KeyCode.ESC){close();}});o.focus();}void next(){AG=((document.getElementById('find_dlg_find_field')) as TextInputElement).value;if(AG=='')return;q g;if(!BN){q h=IB.GF();if(h==null)h=new q(t.rC,0);g=JW(h);}else{q i=IB.vC();if(i==null)i=new q(t.rC,t.rC.PB);g=NP(i);}if(g!=null){IB.KD(g);IB.cursor.gE(g,new q(g.u,g.KB+AG.length));}}q JW(q j){n g=j.u;int h=j.KB;if(g is!OB){g=g.eB(h);h=0;}while(g!=null){if(g is OB){int i;if(!QL)i=g.nodeValue.toLowerCase().indexOf(AG.toLowerCase(),h);else i=g.nodeValue.indexOf(AG,h);if(i!=-1)return (new q(g,i));}g=g.nextNode();h=0;}return (null);}q NP(q k){n g=k.u;int h=k.KB;if(g is!OB){if(h>0)g=g.eB(h-1);else{n i=g;g=null;while(i!=null){if(i.previousSibling!=null){g=i.previousSibling;break;}i=i.parent;}}if(g!=null)h=g.PB;}while(g!=null){if(g is OB){int j;if(!QL)j=g.nodeValue.toLowerCase().substring(0,h).lastIndexOf(AG.toLowerCase());else j=g.nodeValue.substring(0,h).lastIndexOf(AG);if(j!=-1)return (new q(g,j));}g=g.previousNode();if(g!=null)h=g.PB;}return (null);}void replace(){q g=new q.qX(IB.vC());q h=new q.qX(IB.GF());if(g==null||g.u is!OB)return;String i=((document.getElementById('find_dlg_replace_field')) as TextInputElement).value;GB j=new GB.vX(LB.MB('find.replace'));if(i!='')j.TB(new GB.eX(h,i));if(g!=h&&g.u==h.u)j.TB(new GB.lX(g,h.KB-g.KB));t.DC(j);IB.cursor.gE(g,new q(g.u,g.KB+i.length));}void WW(){replace();next();}void replaceAll(){AG=((document.getElementById('find_dlg_find_field')) as TextInputElement).value;if(AG=='')return;String i=((document.getElementById('find_dlg_replace_field')) as TextInputElement).value;q g=NP(new q(t.rC,t.rC.PB));GB h=new GB.vX(LB.MB('find.replace_all'));while(g!=null){if(i!='')h.TB(new GB.eX(new q(g.u,g.KB+AG.length),i));h.TB(new GB.lX(g,AG.length));g=NP(g);}t.DC(h);}void close(){DivElement g=document.getElementById('find_dlg');g.remove();Element h=querySelector("#doc1");h.style.bottom='1.5em';IB.AH();}}abstract class q{factory q(n g,int h){return (new dC(g,h));}factory q.UX(int g){return (new CE(g));}factory q.aX(int g){return (new vD(g));}factory q.hX(q g){if(g is dC)return (new CE.YX(g));else if(g is CE)return (new CE.nX(g));else if(g is vD)return (new CE.iX(g));}factory q.mX(q g){if(g is dC)return (new vD.ZX(g));else if(g is CE)return (new vD.kX(g));else if(g is vD)return (new vD.oX(g));}factory q.qX(q g){if(g is dC)return (new dC(g.u,g.KB));else if(g is CE)return (new CE(g.HF));else if(g is vD)return (new vD(g.UF));}n get u;int get KB;int get HF;int get UF;bool operator==(q g);bool operator<(q g);bool operator<=(q g);bool operator>(q g);bool operator>=(q g);void PG(int g);void zE();HD jF();String MI({bool titles: false});String toString();}class PL{int dZ=0;Map<String,n> eZ=new Map<String,n>();oG rC;HH CB;List<GB> WD=new List<GB>();int hE=-1;String SH;String CL;List<l> ZC;l vO;Future GP(String j){Completer g=new Completer();CB=new HH();CB.load(j).then((m){ZC=CB.yG('hiddenp');if(ZC.length==0)ZC=null;vO=CB.nO('hiddendiv');SH=null;rC=new oG();List<l> i=CB.II();if(i.length==1){n h=ND.NF(i[0]);CB.PO(h);rC.jB(h);h.lF();}g.complete();},onError:(CD k){g.completeError(k);});return (g.future);}Future KP(String i,String k,{bool removeIndents: true}){Completer g=new Completer();CB=new HH();CB.load(k).then((v){ZC=CB.yG('hiddenp');if(ZC.length==0)ZC=null;vO=CB.nO('hiddendiv');this.SH=i;EG s=new EG();s.AL(i).then((sB m){if(removeIndents)WS(m.documentElement);rC=ND.fH(m,null);if(CB!=null&&ZC!=null)QP(rC);g.complete();},onError:(UD h){if(h.errorCode==404){rC=new oG();List<l> o=CB.II();if(o.length==1){n j=ND.NF(o[0]);CB.PO(j);rC.jB(j);j.lF();}g.complete();}else g.completeError(new CD("Opening ${i}: ${h}"));});},onError:(CD h){g.completeError(new CD("Reading config ${k}: ${h}"));});return (g.future);}Future cW(){assert(CL!=null);Completer i=new Completer();String j='AaB03x';HttpRequest h=new HttpRequest();h.onLoad.listen((ProgressEvent o){String k=h.responseText;if(k.startsWith('ok'))i.complete();else{String m;if(k.startsWith('erreur\n'))m=k.substring('erreur\n'.length);else m=k;i.completeError(new CD(m));}});h.onError.listen((ProgressEvent o){i.completeError(new CD(h.status.toString()));});h.open('POST',CL);h.setRequestHeader('Content-Type',"multipart/form-data; boundary=${j}");StringBuffer g=new StringBuffer();g.write("--${j}\r\n");g.write('Content-Disposition: form-data; name="chemin"\r\n');g.write('Content-type: text/plain; charset=UTF-8\r\n');g.write('Content-transfer-encoding: 8bit\r\n\r\n');g.write(SH);g.write("\r\n--${j}\r\n");g.write('Content-Disposition: form-data; name="contenu"; filename="${SH}"\r\n');g.write('Content-Type: application/octet-stream\r\n\r\n');rC.nF='UTF-8';g.write(toString());g.write('\r\n--${j}--\r\n\r\n');h.send(g.toString());return (i.future);}String bM(n h){dZ++ ;String g="a${dZ}";eZ[g]=h;return (g);}Element html(){return (rC.html());}n nI(){for(n g=rC.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==n.tC)return (g);}return (null);}void insertNode(n g,q h){GB i=new GB.pX(h,g);DC(i);}void eM(n g){GB h=new GB.sX(g);DC(h);}void XM(q g,String h){GB i=new GB.eX(g,h);DC(i);}void VW(q g,int h){GB i=new GB.lX(g,h);DC(i);}void OP(q g,q h){GB i=GI(g,h);DC(i);}GB GI(q h,q i){assert(h<i);GB j=new GB.vX(LB.MB('undo.remove'));if(h.u==i.u){n o=h.u;if(o.nodeType==n.nB){j.TB(new GB.lX(new q(o,h.KB),i.KB-h.KB));}else{for(int k=h.KB;k<i.KB;k++ ){if(o.eB(k) is OB)j.TB(new GB.sX(o.eB(k)));}for(int k=h.KB;k<i.KB;k++ ){if(o.eB(k) is!OB)j.TB(new GB.sX(o.eB(k)));}}}else{bool v=false;n m;if(h.u.nodeType==n.tC){m=h.u.eB(h.KB);q BB=new q(h.u,h.KB+1);if(i>=BB)v=true;}else{m=h.u;if(m.PB-h.KB>0){j.TB(new GB.lX(new q(m,h.KB),m.PB-h.KB));}}if(i.u.nodeType==n.nB&&i.KB>0){j.TB(new GB.lX(new q(i.u,0),i.KB));}for(n g=m.nextSibling;g!=null;g=g.nextSibling){q s=new q(g.parent,g.parent.ZB(g));if(s<i){if(g.nodeType==n.nB&&i>=new q(g.parent,g.parent.ZB(g)+1)){j.TB(new GB.sX(g));}}else break;}if(v)j.TB(new GB.sX(m));for(n g=m.nextSibling;g!=null;g=g.nextSibling){q s=new q(g.parent,g.parent.ZB(g));if(s<i){if(g.nodeType!=n.nB){j.TB(new GB.sX(g));}}else break;}}return (j);}n iI(q g,q i){assert(g<i);n m=g.u;if(m is OB)m=m.parent;n j=ND.NF(m.DB);if(g.u==i.u){n o=g.u;if(o.nodeType==n.nB){j.jB(new OB(o.nodeValue.substring(g.KB,i.KB)));}else{for(int s=g.KB;s<i.KB;s++ ){j.jB(new n.zX(o.eB(s)));}}}else{n k;if(g.u.nodeType==n.tC){k=g.u.eB(g.KB);q v=new q(g.u,g.KB+1);if(i>=v){j.jB(new n.zX(k));}}else{k=g.u;if(k.PB-g.KB>0){j.jB(new OB(k.nodeValue.substring(g.KB,k.PB)));}}for(n h=k.nextSibling;h!=null;h=h.nextSibling){q BB=new q(h.parent,h.parent.ZB(h));if(BB<i){if(h.nodeType!=n.nB||(h.nodeType==n.nB&&i>=new q(h.parent,h.parent.ZB(h)+1))){j.jB(new n.zX(h));}}else break;}if(i.u.nodeType==n.nB&&i.KB>0){j.jB(new OB(i.u.nodeValue.substring(0,i.KB)));}}return (j);}n IG(n k,q h,q i){while(h.KB==h.u.PB&&h<i){h=new q(h.u.parent,h.u.parent.ZB(h.u)+1);}while(i.KB==0&&i>h){i=new q(i.u.parent,i.u.parent.ZB(i.u));}n j=new n.zX(k);for(n g=j.firstChild;g!=null;g=j.firstChild)j.gC(g);int BB=0;for(n g=k.firstChild;g!=null;g=g.nextSibling){q m=new q(k,BB);q o=new q(k,BB+1);if(m>=h&&o<=i){n EB=new n.zX(g);j.jB(EB);}else if(o<=h||m>=i){}else{if(g is OB){if(m>h&&o>i){assert(g==i.u);if(0<i.KB)j.jB(new OB(g.nodeValue.substring(0,i.KB)));}else if(m<h&&o<i){assert(g==h.u);if(h.KB<g.PB)j.jB(new OB(g.nodeValue.substring(h.KB,g.PB)));}else{int s;if(h.u==g)s=h.KB;else s=0;int v;if(i.u==g)v=i.KB;else v=g.PB;if(s<v)j.jB(new OB(g.nodeValue.substring(s,v)));}}else{n EB=IG(g,h,i);j.jB(EB);}}BB++ ;}return (j);}GB LE(n BB,q i,{bool checkValidity: true}){if(i.u is OB&&i.KB==0)i=new q(i.u.parent,i.u.parent.ZB(i.u));n h=i.u;int o=i.KB;if(h is OB){o=h.parent.ZB(h);h=h.parent;}GB EB=new GB.vX('insertChildren');List<n> s=new List<n>();while(BB.firstChild!=null){s.add(BB.firstChild);BB.gC(BB.firstChild);}q j=new q.qX(i);for(n g in s){if(g is!OB){if(checkValidity&&(h is BG||h is qF||h is IH)){String m;if(g.DB==null)m=g.nodeName;else m=CB.OD(g.DB);throw new CD(m+' '+LB.MB('insert.not_authorized_here'));}if(g is qF){if(checkValidity&&h.nodeType==n.YG)throw new CD(LB.MB('insert.text_not_allowed'));String k=null;if(g.firstChild!=null)k=g.firstChild.nodeValue;if(k==null)k='';if(checkValidity&&k.trim()!=''&&!CB.PE(h.DB)){throw new CD(LB.MB('insert.text_not_allowed'));}EB.TB(new GB.pX(j,g));}else{if(checkValidity){if(h.nodeType==n.YG){if(!CB.II().contains(g.DB))throw new CD(CB.OD(g.DB)+' '+LB.MB('insert.not_authorized_here'));}else if(g is!BG&&g is!IH){if(g.DB==null||!CB.fD(h.DB,g.DB)){String m;if(g.DB==null)m=g.nodeName;else m=CB.OD(g.DB);String QB=CB.OD(h.DB);throw new CD(m+' '+LB.MB('insert.not_authorized_inside')+' '+QB);}if(!CB.WM(h,o,o,g.DB)){throw new CD(CB.OD(g.DB)+' '+LB.MB('insert.not_authorized_here'));}}}EB.TB(new GB.pX(j,g));}if(j.u is OB)j=new q(h,o+2);else j=new q(h,j.KB+1);}}bool HB=false;bool JB=true;for(n g in s){if(g is OB){if(checkValidity&&h.nodeType==n.YG)throw new CD(LB.MB('insert.text_not_allowed'));String k=g.nodeValue;if(k==null)k='';if(checkValidity&&k.trim()!=''&&!CB.PE(h.DB)){throw new CD(LB.MB('insert.text_not_allowed'));}int v=o+s.indexOf(g);if(i.u is OB)v++ ;if(HB)v-- ;if(s.length==1)j=i;else j=new q(h,v);if(JB){if(v>0&&(i.u is OB||h.eB(v-1) is OB))HB=true;JB=false;}EB.TB(new GB.eX(j,g.nodeValue));}}return (EB);}String toString(){return (rC.toString());}sB rW(){kH h=new yJ();sB g=h.createDocument(null,null,null);rC.KF(g);return (g);}void DC(GB g){g.fO();if(hE<WD.length-1)WD.removeRange(hE+1,WD.length);if(hE<0||!WD[hE].pU(g)){WD.add(g);hE++ ;}IB.KL();}void aH(){if(hE<0)return;GB g=WD[hE];g.aH();hE-- ;IB.KL();IB.LC();}void dM(){if(hE>=WD.length-1)return;GB g=WD[hE+1];g.fO();hE++ ;IB.KL();IB.LC();}bool FS(){return (hE>=0);}bool ES(){return (hE<WD.length-1);}String xR(){String g;if(hE>=0)g=WD[hE].title;else g=null;if(g==null)return (LB.MB('undo.undo'));else return ("${LB.MB('undo.undo')} ${g}");}String vR(){String g;if(hE<WD.length-1)g=WD[hE+1].title;else g=null;if(g==null)return (LB.MB('undo.redo'));else return ("${LB.MB('undo.redo')} ${g}");}void lK(String j,int g){GB i=new GB.vX(j);for(int h=WD.length-g;h<WD.length;h++ )i.TB(WD[h]);WD.removeRange(WD.length-g,WD.length);WD.add(i);hE-= (g-1);}void CS(String j,bool EB){q g=IB.vC();q k=IB.GF();if(j=='\n'&&!EB){if(((g.u is JH)||(g.u.nextSibling==null&&g.u.parent is JH))&&g.KB==g.u.PB){UI.yT(g);return;}else{n i=g.u;while(i is OB||i is kB||i is zB||i is YE)i=i.parent;if(i is xD){iC.HU(g);return;}}}if(j=='\n'&&ZC!=null){if(kB.DU())return;}bool m=false;n h=g.u;if(h.nodeType==n.nB)h=h.parent;if(h.nM)m=true;else if(j.trim()!=''){if(h.nodeType==n.YG)m=true;else if(h.DB!=null&&!t.CB.PE(h.DB)){if(ZC!=null){l v=CB.fF(h.DB,ZC);if(v!=null&&g==k){kB o=new kB.XY(v);o.jB(new OB(j));insertNode(o,g);IB.KD(new q(o,o.PB));IB.LC();return;}else m=true;}else m=true;}}if(m){window.alert(LB.MB('insert.text_not_allowed'));IB.cursor.JV();return;}bool BB=false;if(g!=k){g=new q.qX(g);k=new q.qX(k);IB.cursor.xG();OP(g,k);BB=true;if(g.u.parent==null)g=IB.vC();}t.XM(g,j);if(BB){GB s=new GB.vX(LB.MB('undo.insert_text'));s.TB(WD.removeAt(WD.length-2));s.TB(WD.removeLast());WD.add(s);hE-= 1;}}void CI(l j,String h){q i=IB.vC();if(i==null)return;n g=ND.NF(j,h);if(h=='element'&&nI()==null){CB.PO(g);}g.cM(()=>BS(g,i));}bool BS(n i,q g){n k=null;if(IB.vC()!=IB.GF()){q EB=IB.vC();q HB=IB.GF();k=iI(EB,HB);IB.cursor.xG();if(g.u is!OB&&g.KB>0&&g.u.eB(g.KB-1) is OB){n JB=g.u.eB(g.KB-1);g=new q(JB,JB.PB);}OP(EB,HB);if(g.u.parent==null)g=IB.vC();}bool v=false;n j=g.u;if(j is OB)j=j.parent;if(j is kB){kB h=j;if(!CB.fD(h.DB,i.DB)){GB m=new GB.vX(LB.MB('undo.insert_text'));q s=new q(h,h.PB);s.zE();if(g<s){n SB=iI(g,s);m.TB(GI(g,s));kB QB=ND.NF(h.DB);m.TB(new GB.pX(new q(h.parent,h.parent.ZB(h)+1),QB));m.TB(LE(SB,new q(QB,0)));}m.TB(new GB.pX(new q(h.parent,h.parent.ZB(h)+1),i));DC(m);v=true;}}else if(ZC!=null&&j.DB!=null&&!CB.fD(j.DB,i.DB)){l BB=CB.fF(j.DB,ZC);if(BB!=null&&CB.fD(BB,i.DB)){kB h=new kB.XY(BB);h.jB(i);insertNode(h,g);v=true;}}if(!v)insertNode(i,g);q o=i.QE();if(o==null)o=new q(i.parent,i.parent.ZB(i)+1);IB.KD(o);IB.LC();if(k!=null){try {if(o==null)throw new CD(k.toString()+LB.MB('insert.not_authorized_here'));if(t.ZC!=null){kB.SN(i,k);}DC(LE(k,o,checkValidity:true));lK(LB.MB('undo.insert_element'),3);IB.KL();return (true);}on CD catch (cB){window.alert(cB.toString());aH();aH();WD.removeRange(WD.length-2,WD.length);IB.KL();return (false);}}return (true);}void WV(String g,l h){if(g=='jaxe.FonctionNormal'){zB.eL();}else if(nP[g]!=null)nP[g]();}List<l> lO(n i){List<l> g;if(i.nodeType==n.YG){g=t.CB.II();}else if(i.DB==null){g=new List<l>();}else{n h;if(i.nodeType==n.nB)h=i.parent;else h=i;g=CB.XC(h.DB);if(h is kB&&h.parent.DB!=null){LinkedHashSet j=new LinkedHashSet.from(g);j.addAll(CB.XC(h.parent.DB));g=new List.from(j);}else if(ZC!=null){l k=CB.fF(h.DB,ZC);if(k!=null){LinkedHashSet j=new LinkedHashSet.from(g);j.addAll(CB.XC(k));g=new List.from(j);}}}return (g);}List<l> dP(List<l> m){List<l> i=new List<l>();q s=IB.vC();q v=IB.GF();n h=s.u;int BB=s.KB;n k=v.u;int EB=v.KB;if(h.nodeType==n.nB){BB=h.parent.ZB(h);h=h.parent;}if(k.nodeType==n.nB){EB=k.parent.ZB(k);k=k.parent;}if(h!=k)return (i);for(l g in m){if(t.CB.WM(h,BB,EB,g))i.add(g);}if(h is kB&&h.parent.DB!=null){int HB=h.parent.ZB(h)+1;LinkedHashSet j=new LinkedHashSet.from(i);for(l g in m){if(!j.contains(g)){if(t.CB.WM(h.parent,HB,HB,g))j.add(g);}}i=new List.from(j);}else if(ZC!=null){l o=null;for(l g in ZC)if(i.contains(g)){o=g;break;}if(o!=null){LinkedHashSet j=new LinkedHashSet.from(i);for(l g in m){if(!j.contains(g)){if(t.CB.fD(o,g))j.add(g);}}i=new List.from(j);}}return (i);}q zG(num g,num h){return (rC.zG(g,h));}void WS(final l g){fZ(g,null,false,true);}void fZ(final l m,final l s,final bool HB,final bool JB){l o;if(CB!=null)o=CB.UM(m,s);else o=null;bool v=gZ(m,o,s,HB);final bool BB=hZ(m,o,s,JB);AB EB;for(AB j=m.firstChild;j!=null;j=EB){EB=j.nextSibling;if(j.nodeType==AB.FE)fZ(j as l,o,v,BB);else if(!v&&j.nodeType==AB.kE){String g=j.nodeValue;if(BB&&j.parentNode.firstChild==j&&s!=null){int h=0;while(h<g.length&&(g[h]==' '||g[h]=='\t'))h++ ;if(h>0)g=g.substring(h);}int i=g.indexOf("\n ");int k=g.indexOf("\n\t");if(k!=-1&&(i==-1||k<i))i=k;while(i!=-1){int h=i;while(h+1<g.length&&(g[h+1]==' '||g[h+1]=='\t'))h++ ;g=g.substring(0,i+1)+g.substring(h+1);i=g.indexOf("\n ");k=g.indexOf("\n\t");if(k!=-1&&(i==-1||k<i))i=k;}i=g.indexOf("  ");while(i!=-1){int h=i;while(h+1<g.length&&g[h+1]==' ')h++ ;g=g.substring(0,i)+g.substring(h);i=g.indexOf("  ");}if(g.length==0)m.gC(j);else j.nodeValue=g;}}}bool gZ(final l m,final l j,final l v,final bool o){bool g;final String h=m.getAttribute("xml:space");if(h=="preserve")g=true;else if(h=="default")g=false;else g=o;if(j!=null&&h==""){final List<l> s=CB.fE(j);for(l i in s){if(CB.attributeName(i)=="space"&&CB.attributeNamespace(i)=="http://www.w3.org/XML/1998/namespace"){final String k=CB.dF(i);if(k=="preserve")g=true;else if(k=="default")g=false;break;}}}return (g);}bool hZ(final l m,final l j,final l k,final bool o){if(j==null)return true;if(k==null||!CB.PE(j)||!CB.PE(k))return true;AB g=m.previousSibling;while(g!=null){if(g.nodeType==AB.kE){final String h=g.nodeValue;if(!(h.endsWith(" ")||h.endsWith("\n")))return false;return true;}else if(g.nodeType==AB.FE){final AB i=g.lastChild;if(i!=null&&i.nodeType==AB.kE){final String h=i.nodeValue;if(!(h.endsWith(" ")||h.endsWith("\n")))return false;}return true;}g=g.previousSibling;}if(g==null)return o;return true;}void QP(n i){l j;if(i.DB!=null)j=CB.fF(i.DB,ZC);else j=null;bool k=(j!=null);bool m=i is kB;bool s=i is zB;n o;for(n g=i.firstChild;g!=null;g=o){o=g.nextSibling;if(g is OB){if(k||m||s){String h=g.nodeValue;if(g.previousSibling==null||g.previousSibling is!BG||g.nextSibling==null||g.nextSibling is!BG){h=h.replaceAll('\n',' ');}h=h.replaceAll('  ',' ');if(k){if(g.previousSibling!=null&&g.previousSibling.DB!=null&&!CB.fD(j,g.previousSibling.DB)){h=h.trimLeft();}if(g.nextSibling!=null&&g.nextSibling.DB!=null&&!CB.fD(j,g.nextSibling.DB)){h=h.trimRight();}}else if(m){if(g.previousSibling==null)h=h.trimLeft();if(g.nextSibling==null)h=h.trimRight();}if(h.length==0)i.gC(g);else g.nodeValue=h;}}else if(g.firstChild!=null)QP(g);}}void uV(sB g){if(g.documentElement!=null)iZ(g.documentElement,null,false,1);}void iZ(final l i,final l j,final bool BB,final int k){l h;if(CB!=null)h=CB.UM(i,j);else h=null;bool m=gZ(i,h,j,BB);for(AB g=i.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE)iZ(g as l,h,m,k+1);else if(!m&&g.nodeType==AB.kE&&g.nodeValue.contains("\n")){StringBuffer o=new StringBuffer("\n");int s=k;if(g.nextSibling==null)s-- ;for(int v=0;v<s;v++ )o.write('  ');String EB=o.toString();g.nodeValue=g.nodeValue.replaceAll("\n",EB);}}}}class RD{n u;RD parent;RD firstChild;RD nextSibling;bool MG;DivElement div;SpanElement YH;SpanElement oE;RD(this.u,this.parent){MG=false;MV();if(u.parent==t.rC){cJ();}}void LV(){for(n g=u.firstChild;g!=null;g=g.nextSibling){if(g is!OB){jB(new RD(g,this));}}}void VS(){if(firstChild!=null)PP(firstChild);}void PP(RD h){RD g=h;while(g!=null){if(g.div!=null)g.div.remove();g=g.nextSibling;}if(firstChild==h)firstChild=null;else h.previousSibling.nextSibling=null;}RD get lastChild{if(firstChild==null)return null;RD g=firstChild;while(g.nextSibling!=null){g=g.nextSibling;}return g;}RD get previousSibling{if(parent==null)return null;for(RD g=parent.firstChild;g!=null;g=g.nextSibling){if(g.nextSibling==this)return g;}return null;}List<RD> get children{List<RD> h=new List<RD>();for(RD g=firstChild;g!=null;g=g.nextSibling)h.add(g);return (h);}void jB(RD g){RD h=lastChild;if(h==null){firstChild=g;}else{h.nextSibling=g;}g.nextSibling=null;g.parent=this;div.append(g.div);}bool get ZO{return TL(u);}MV(){div=new DivElement();div.classes.add('tree_div');YH=new SpanElement();YH.classes.add('tree_node_title');YH.setAttribute('tabindex','-1');YH.onKeyDown.listen((KeyboardEvent i){int h=i.keyCode;if(h==KeyCode.DOWN){if(firstChild!=null)firstChild.focus();else if(nextSibling!=null)nextSibling.focus();else if(parent!=null){RD g=parent;while(g.nextSibling==null&&g.parent!=null)g=g.parent;if(g.nextSibling!=null)g.nextSibling.focus();}}else if(h==KeyCode.UP){if(previousSibling!=null){RD g=previousSibling;while(g.lastChild!=null)g=g.lastChild;g.focus();}else if(parent!=null)parent.focus();else document.getElementById('tree_tab_button').focus();}else if(h==KeyCode.ENTER){IB.YS(u);}else if(h==KeyCode.RIGHT&&ZO){if(!MG)cJ();firstChild.focus();}else if(h==KeyCode.LEFT&&MG){cJ();}else if(h==KeyCode.LEFT&&parent!=null){parent.focus();}});if(u.DB!=null)YH.appendText(t.CB.OD(u.DB));else YH.appendText(u.nodeName);YH.onClick.listen((MouseEvent i)=>IB.YS(u));if(TL(u)&&u.parent!=t.rC){LR();}div.append(YH);}void LR(){oE=new SpanElement();oE.classes.add('expand_button');ImageElement g=new ImageElement(width:9,height:9);if(MG){oE.classes.add('expanded');g.src='packages/daxe/images/expanded_tree.png';}else{oE.classes.add('collapsed');g.src='packages/daxe/images/collapsed_tree.png';}oE.append(g);oE.onClick.listen((MouseEvent h)=>cJ());div.append(oE);}void cJ(){if(!MG){LV();if(oE!=null){oE.classes.remove('collapsed');oE.classes.add('expanded');ImageElement g=oE.firstChild;g.src='packages/daxe/images/expanded_tree.png';}}else{VS();if(oE!=null){oE.classes.remove('expanded');oE.classes.add('collapsed');ImageElement g=oE.firstChild;g.src='packages/daxe/images/collapsed_tree.png';}}MG=!MG;}void update(){if(oE==null&&TL(u)&&u.parent!=t.rC){LR();MG=true;}else if(oE!=null&&!TL(u)){VS();MG=false;oE.remove();}if(!MG)return;RD g=firstChild;for(n h=u.firstChild;h!=null;h=h.nextSibling){if(h is!OB){if(g==null){g=new RD(h,this);jB(g);}else if(g.u!=h){PP(g);g=new RD(h,this);jB(g);}else{g.update();}}if(g!=null)g=g.nextSibling;}if(g!=null)PP(g);}void focus(){YH.focus();}static bool TL(n h){for(n g=h.firstChild;g!=null;g=g.nextSibling){if(g is!OB){return (true);}}return (false);}}class xM{RD JF;xM(){}void update(){if(JF==null&&t.nI()!=null){JF=new RD(t.nI(),null);jZ();DivElement g=document.getElementById('tree');g.append(JF.div);}else{if(JF==null){if(t.nI()!=null){JF=new RD(t.nI(),null);DivElement g=document.getElementById('tree');g.append(JF.div);}}else{if(t.nI()==null){JF.div.remove();JF=null;}else JF.update();}}}void jZ(){if(!JF.ZO)return;if(!JF.MG)JF.cJ();if(JF.children.length<10){for(RD g=JF.firstChild;g!=null;g=g.nextSibling){if(g.ZO&&!g.MG)g.cJ();}}}}class GB{static const int dH=0;static const int eH=1;static const int mJ=2;static const int nJ=3;int gD;String title;q mB;String text;int length;n u;n xF;List<aB> attributes;List<GB> EH;bool LF;GB.eX(q h,String g,{bool updateDisplay: true}){assert(g!=null&&g!='');gD=dH;title=LB.MB('undo.insert_text');this.mB=new q.qX(h);this.text=g;u=null;xF=null;attributes=null;EH=null;this.LF=updateDisplay;}GB.lX(q g,int h,{bool updateDisplay: true}){assert(h>0);assert(g.u.nodeType==n.nB);gD=eH;title=LB.MB('undo.remove_text');this.mB=new q.qX(g);text=null;this.length=h;u=null;xF=null;attributes=null;EH=null;this.LF=updateDisplay;}GB.pX(q g,n h,{bool updateDisplay: true}){gD=dH;title=LB.MB('undo.insert_element');this.mB=new q.qX(g);text=null;this.u=h;xF=null;attributes=null;EH=null;this.LF=updateDisplay;}GB.sX(n g,{bool updateDisplay: true}){gD=eH;title=LB.MB('undo.remove_element');mB=null;text=null;this.u=g;xF=null;attributes=null;EH=null;this.LF=updateDisplay;}GB.tX(n g,List<aB> h,{bool updateDisplay: true}){gD=mJ;title=LB.MB('undo.attributes');mB=null;text=null;this.u=g;xF=null;this.attributes=h;EH=null;this.LF=updateDisplay;}GB.uX(n i,aB g,{bool updateDisplay: true}){gD=mJ;title=LB.MB('undo.attributes');mB=null;text=null;this.u=i;xF=null;LinkedHashMap<String,aB> h=i.gR();if(g.value==null){if(h[g.name]!=null)h.remove(g.name);}else h[g.name]=g;this.attributes=new List.from(h.values);EH=null;this.LF=updateDisplay;}GB.vX(String g){gD=nJ;this.title=g;mB=null;text=null;u=null;xF=null;attributes=null;EH=new List<GB>();LF=true;}bool pU(GB g){if(gD!=g.gD)return (false);if(gD==dH&&u is OB&&g.text!=null&&g.mB.u==u&&g.mB.KB+1==u.PB){return (true);}if(text==null||g.text==null)return (false);if(u!=g.u)return (false);if((gD==dH&&g.mB.KB==mB.KB+text.length)||(gD==eH&&g.mB.KB==mB.KB)){text="${text}${g.text}";return (true);}if((gD==dH&&g.mB.KB==mB.KB)||(gD==eH&&mB.KB==g.mB.KB+g.text.length)){text="${g.text}${text}";if(gD==eH)mB=new q(mB.u,mB.KB-g.text.length);return (true);}return (false);}void TB(GB g){assert(gD==nJ);EH.add(g);}void fO(){if(gD==dH)kZ(LF);else if(gD==eH)lZ(LF);else if(gD==mJ)mZ(LF);else if(gD==nJ){for(GB g in EH){g.fO();}}LF=true;}void aH(){if(gD==dH)lZ(LF);else if(gD==eH)kZ(LF);else if(gD==mJ)mZ(LF);else if(gD==nJ){for(GB g in EH.reversed){g.aH();}}}void kZ(bool j){if(text!=null){mB.zE();if(mB.u.nodeType==n.tC){if(mB.u.PS)u=new bG(text);else u=new OB(text);text=null;}}if(text!=null){assert(mB.u.nodeType==n.nB);(mB.u as OB).XM(mB,text);if(j){mB.u.sD();IB.KD(new q(mB.u,mB.KB+text.length));if(mB.u.previousSibling==null&&mB.u.nextSibling==null){mB.u.parent.lF();}}}else{n g=mB.u;n h;List<n> i=new List<n>();i.add(u);if(g.nodeType==n.nB&&u.nodeType==n.nB){String k=g.nodeValue.substring(0,mB.KB);String m=g.nodeValue.substring(mB.KB);g.nodeValue="${k}${u.nodeValue}${m}";h=g;}else if(mB.KB==0){if(g.nodeType==n.nB){g.parent.insertBefore(u,g);h=g.parent;}else{g.insertBefore(u,g.firstChild);h=g;}}else if(g.PB==mB.KB){if(g.nodeType==n.nB){g.parent.insertBefore(u,g.nextSibling);h=g.parent;}else{g.jB(u);h=g;}}else if(g.nodeType==n.nB){if(xF==null)xF=(g as OB).QV(mB.KB);else{g.nodeValue=g.nodeValue.substring(0,mB.KB);g.parent.insertAfter(xF,g);}g.parent.insertBefore(u,xF);i.add(g);i.add(xF);h=g.parent;}else{n o=g.eB(mB.KB);g.insertBefore(u,o);h=g;}if(j){if(u.nodeType==n.tC)u.lF();h.lF();h.BF(i);if(u is OB)IB.KD(new q(u,u.nodeValue.length));else IB.KD(new q(u.parent,u.parent.ZB(u)+1));}u.YO();}}void lZ(bool k){if(u==null&&text==null){if(mB.KB==0&&mB.u.PB==length){u=mB.u;mB=new q(u.parent,u.parent.ZB(u));}else{text=mB.u.nodeValue.substring(mB.KB,mB.KB+length);}}if(text!=null){assert(mB.u.nodeType==n.nB);mB.u.remove(mB,text.length);if(k){mB.u.sD();IB.KD(mB);if(mB.u.previousSibling==null&&mB.u.nextSibling==null){mB.u.parent.lF();}}}else{u.PR();n h=u.parent;assert(h!=null);if(mB==null){if(u.previousSibling!=null&&u.previousSibling.nodeType==n.nB)mB=new q(u.previousSibling,u.previousSibling.PB);else mB=new q(h,h.ZB(u));}n i=u.previousSibling;n g=u.nextSibling;h.gC(u);List<n> j=new List<n>();if(i!=null&&i.nodeType==n.nB&&g!=null&&g.nodeType==n.nB){xF=g;i.nodeValue="${i.nodeValue}${g.nodeValue}";g.parent.gC(g);j.add(i);j.add(u);j.add(g);}else j.add(u);if(k){h.lF();h.BF(j);IB.KD(mB);}}}void mZ(bool g){List<aB> h=u.attributes;u.attributes=attributes;attributes=h;if(g){u.lF();u.vI();}}String toString(){StringBuffer g=new StringBuffer();switch (gD){case dH:g.write("Insert ");break;case eH:g.write("Remove ");break;case mJ:g.write("Attributes ");break;case nJ:g.write("Compound ");break;}if(text!=null)g.write("text '${text}'");else if(u!=null)g.write("node ${u.nodeName}");else if(mB!=null)g.write("${length} chars at ${mB}");return (g.toString());}}class OT{void show(){sB o=t.rW();t.uV(o);DivElement h=new DivElement();h.id='dlg1';h.classes.add('dlg1');DivElement i=new DivElement();i.classes.add('source_window');DivElement m=new DivElement();m.classes.add('source_content');QO(o,m);i.append(m);DivElement j=new DivElement();j.classes.add('source_bottom');ButtonElement k=new ButtonElement();k.attributes['type']='button';k.appendText(LB.MB("source.select_all"));k.onClick.listen((MouseEvent s)=>RP());j.append(k);ButtonElement g=new ButtonElement();g.attributes['type']='submit';g.appendText(LB.MB("button.Close"));g.onClick.listen((MouseEvent s)=>close());j.append(g);i.append(j);h.append(i);document.body.append(h);g.focus();}void QO(AB i,Element g){switch (i.nodeType){case AB.FK:SpanElement m=new SpanElement();m.classes.add('source_pi');String BB=(i as sB).VG;String EB=(i as sB).nF;m.appendText('<?xml version="${BB}" encoding="${EB}"?>');g.append(m);g.appendText('\n');for(AB k=i.firstChild;k!=null;k=k.nextSibling){QO(k,g);}break;case AB.FE:g.appendText('<');SpanElement j=new SpanElement();j.classes.add('source_element_name');j.appendText(i.nodeName);g.append(j);if(i.attributes!=null){for(lC v in i.attributes.values){g.appendText(' ');SpanElement o=new SpanElement();o.classes.add('source_attribute_name');o.appendText(v.nodeName);g.append(o);g.appendText('="');SpanElement s=new SpanElement();s.classes.add('source_attribute_value');nZ(s,v.nodeValue);g.append(s);g.appendText('"');}}if(i.firstChild!=null){g.appendText('>');if(i.childNodes!=null){for(AB k in i.childNodes){QO(k,g);}}g.appendText('</');j=new SpanElement();j.classes.add('source_element_name');j.appendText(i.nodeName);g.append(j);g.appendText('>');}else{g.appendText('/>');}break;case AB.kE:nZ(g,i.nodeValue);break;case AB.DK:SpanElement h=new SpanElement();h.classes.add('source_comment');h.appendText(i.toString());g.append(h);break;case AB.TQ:SpanElement h=new SpanElement();h.classes.add('source_entity');h.appendText(i.toString());g.append(h);break;case AB.BK:SpanElement h=new SpanElement();h.classes.add('source_cdata');h.appendText(i.toString());g.append(h);break;case AB.CK:SpanElement h=new SpanElement();h.classes.add('source_pi');h.appendText(i.toString());g.append(h);break;case AB.qL:SpanElement h=new SpanElement();h.classes.add('source_doctype');h.appendText(i.toString());g.append(h);break;default:g.appendText(i.toString());break;}}void nZ(Element i,String g){Map<String,String> k=<String,String>{'&':'&amp;','"':'&quot;','<':'&lt;','>':'&gt;'};Iterable<String> o=k.keys;int h=0;while(h<g.length){String m=g[h];if(o.contains(m)){if(h>0)i.appendText(g.substring(0,h));SpanElement j=new SpanElement();j.classes.add('source_entity');j.appendText(k[m]);i.append(j);g=g.substring(h+1);h=0;}else h++ ;}if(g.length>0)i.appendText(g);}void close(){DivElement g=document.getElementById('dlg1');g.remove();IB.AH();}void RP(){Selection g=window.getSelection();Range h=new Range();h.selectNodeContents(querySelector('.source_content'));g.removeAllRanges();g.addRange(h);}}class yM{int oZ;lP pZ;xM qZ;yM(){oZ=0;pZ=new lP();qZ=new xM();}DivElement html(){DivElement k=new DivElement();k.id='left_panel';DivElement m=new DivElement();m.id='tab_buttons';SpanElement h=new SpanElement();h.id='insert_tab_button';h.classes.add('tab_button');h.classes.add('selected');h.setAttribute('tabindex','-1');h.appendText(LB.MB('left.insert'));h.onClick.listen((MouseEvent j)=>SP());h.onKeyDown.listen((KeyboardEvent j){int g=j.keyCode;if(g==KeyCode.ENTER||g==KeyCode.DOWN){Element s=document.getElementById('insert');if(s.firstChild is ButtonElement){j.preventDefault();(s.firstChild as ButtonElement).focus();}}else if(g==KeyCode.RIGHT){VP();}else if(g==KeyCode.TAB){Timer.run((){IB.cursor.show();IB.cursor.focus();});}});m.append(h);SpanElement i=new SpanElement();i.id='tree_tab_button';i.classes.add('tab_button');i.setAttribute('tabindex','-1');i.appendText(LB.MB('left.tree'));i.onClick.listen((MouseEvent j)=>VP());i.onKeyDown.listen((KeyboardEvent j){int g=j.keyCode;if(g==KeyCode.ENTER||g==KeyCode.DOWN){if(qZ.JF!=null)qZ.JF.focus();}else if(g==KeyCode.LEFT){SP();}else if(g==KeyCode.TAB){Timer.run((){IB.cursor.show();IB.cursor.focus();});}});m.append(i);k.append(m);DivElement v=new DivElement();v.id='insert';k.append(v);DivElement o=new DivElement();o.id='tree';o.style.display='none';k.append(o);return (k);}void SP(){document.getElementById('insert').style.display='block';document.getElementById('tree').style.display='none';document.getElementById('insert_tab_button').classes.add('selected');document.getElementById('tree_tab_button').classes.remove('selected');document.getElementById('insert_tab_button').setAttribute('tabindex','0');document.getElementById('tree_tab_button').setAttribute('tabindex','-1');document.getElementById('insert_tab_button').focus();oZ=0;if(IB.vC()==null)return;n g=IB.vC().u;if(g is OB)g=g.parent;List<l> h=t.lO(g);List<l> i=t.dP(h);pZ.update(g,h,i);}void VP(){document.getElementById('tree').style.display='block';document.getElementById('insert').style.display='none';document.getElementById('tree_tab_button').classes.add('selected');document.getElementById('insert_tab_button').classes.remove('selected');document.getElementById('tree_tab_button').setAttribute('tabindex','0');document.getElementById('insert_tab_button').setAttribute('tabindex','-1');document.getElementById('tree_tab_button').focus();oZ=1;qZ.update();}void update(n g,List<l> h,List<l> i){if(oZ==0)pZ.update(g,h,i);else qZ.update();}}class XG{l eF;l QH;StreamSubscription<KeyboardEvent> AP;XG.VX(this.eF){}XG.XX(this.QH,this.eF){}void show(){DivElement m=new DivElement();m.id='dlg1';m.classes.add('dlg1');DivElement HB=new DivElement();HB.classes.add('dlg2');DivElement g=new DivElement();g.classes.add('dlg3');DivElement h=new DivElement();h.style.position='absolute';h.style.top='0px';h.style.right='0px';h.style.width='16px';h.style.height='16px';ImageElement i=new ImageElement();i.src='packages/daxe/images/close_dialog.png';i.width=16;i.height=16;i.style.position='fixed';i.onClick.listen((MouseEvent j)=>close());h.append(i);g.append(h);DivElement JB=new DivElement();JB.classes.add('dlgtitle');if(QH==null)JB.text=t.CB.OD(eF);else JB.text=t.CB.fK(eF,QH);g.append(JB);if(QH==null){ParagraphElement o=new ParagraphElement();o.appendText(LB.MB('help.element_name')+' ');SpanElement QB=new SpanElement();QB.classes.add('help_element_name');QB.text=t.CB.cD(eF);o.append(QB);g.append(o);}String k;if(QH==null)k=t.CB.wH(eF);else k=t.CB.vG(eF,QH);if(k!=null){k=HH.mT(k);ParagraphElement o=new Element.html("<p>${k}</p>");g.append(o);}if(QH==null){String CC=t.CB.ZD(eF);if(CC!=null){DivElement SB=new DivElement();SB.classes.add('help_regexp');SB.text=CC;g.append(SB);}SpanElement s=new SpanElement();s.id='help_parents';s.classes.add('help_list_title');s.text=LB.MB('help.parents');s.onClick.listen((MouseEvent j)=>YV());g.append(s);SpanElement v=new SpanElement();v.id='help_children';v.classes.add('help_list_title');v.text=LB.MB('help.children');v.onClick.listen((MouseEvent j)=>fR());g.append(v);SpanElement BB=new SpanElement();BB.id='help_attributes';BB.classes.add('help_list_title');BB.text=LB.MB('help.attributes');BB.onClick.listen((MouseEvent j)=>XV());g.append(BB);DivElement cB=new DivElement();cB.classes.add('help_list_div');UListElement IC=new UListElement();IC.id='help_list';cB.append(IC);g.append(cB);}DivElement hB=new DivElement();hB.classes.add('buttons');ButtonElement EB=new ButtonElement();EB.attributes['type']='submit';EB.appendText(LB.MB("button.Close"));EB.onClick.listen((MouseEvent j)=>close());hB.append(EB);g.append(hB);HB.append(g);m.append(HB);document.body.append(m);if(g.clientHeight>m.clientHeight*3/4){HB.style.left="33%";g.style.left="-25%";}if(QH==null)fR();AP=document.onKeyDown.listen(null);AP.onData((KeyboardEvent j){if(j.keyCode==KeyCode.ESC){close();}});EB.focus();}void YV(){SpanElement o=document.getElementById('help_parents');o.classes.add('selected_tab');SpanElement s=document.getElementById('help_children');s.classes.remove('selected_tab');SpanElement v=document.getElementById('help_attributes');v.classes.remove('selected_tab');UListElement k=document.getElementById('help_list');k.nodes.clear();List<l> g=t.CB.fC(eF);if(g==null||g.length==0)return;HashMap<l,String> i=OR(g.toSet());g.sort((BB,EB)=>i[BB].toLowerCase().compareTo(i[EB].toLowerCase()));for(l j in g){LIElement h=new LIElement();h.text=i[j];String m=t.CB.wH(j);if(m!=null)h.title=m;h.onClick.listen((MouseEvent HB)=>dS(j));h.classes.add('help_selectable');k.append(h);}}HashMap<l,String> OR(Set<l> EB,[int k=0]){HashMap<String,Set<l>> m=new HashMap<String,Set<l>>();for(l g in EB){Set<l> s=wU(g,k);String o=t.CB.OD(s.first);if(o!=null){bool v=true;for(l HB in s){if(t.CB.OD(HB)!=o){v=false;break;}}if(v){String h;if(k==0)h=t.CB.OD(g);else h=t.CB.OD(g)+" ("+o+")";Set i=m[h];if(i==null){i=new HashSet<l>();m[h]=i;}i.add(g);}}}HashMap<l,String> j=new HashMap<l,String>();for(String h in m.keys){Set<l> i=m[h];if(i.length>1&&k<10){HashMap<l,String> BB=OR(i,k+1);j.addAll(BB);for(l g in i)if(BB[g]==null){if(h.indexOf('(')==-1&&g.getAttribute('type')!='')j[g]=h+" ("+g.getAttribute('type')+")";else j[g]=h;}}else{for(l g in i)j[g]=h;}}return (j);}Set<l> wU(l k,int m){Set<l> g=new Set<l>();g.add(k);for(int h=0;h<m;h++ ){Set<l> i=new Set<l>();for(l o in g){List<l> j=t.CB.fC(o);if(j!=null)i.addAll(j);}g=i;}return (g);}void fR(){SpanElement o=document.getElementById('help_parents');o.classes.remove('selected_tab');SpanElement s=document.getElementById('help_children');s.classes.add('selected_tab');SpanElement v=document.getElementById('help_attributes');v.classes.remove('selected_tab');UListElement k=document.getElementById('help_list');k.nodes.clear();List<l> g=t.CB.XC(eF);if(g==null||g.length==0)return;HashMap<l,String> i=new HashMap.fromIterable(g,value:(l BB)=>t.CB.OD(BB));g.sort((EB,HB)=>i[EB].toLowerCase().compareTo(i[HB].toLowerCase()));for(l j in g){LIElement h=new LIElement();h.text=i[j];String m=t.CB.wH(j);if(m!=null)h.title=m;h.onClick.listen((MouseEvent JB)=>dS(j));h.classes.add('help_selectable');k.append(h);}}void XV(){SpanElement o=document.getElementById('help_parents');o.classes.remove('selected_tab');SpanElement s=document.getElementById('help_children');s.classes.remove('selected_tab');SpanElement v=document.getElementById('help_attributes');v.classes.add('selected_tab');UListElement k=document.getElementById('help_list');k.nodes.clear();List<l> g=t.CB.fE(eF);if(g==null||g.length==0)return;HashMap<l,String> i=new HashMap.fromIterable(g,value:(l h)=>t.CB.fK(eF,h));g.sort((BB,EB)=>i[BB].toLowerCase().compareTo(i[EB].toLowerCase()));for(l h in g){LIElement j=new LIElement();j.text=i[h];String m=t.CB.vG(eF,h);if(m!=null)j.title=m;k.append(j);}}void dS(l g){this.eF=g;QH=null;close();show();}void close(){AP.cancel();DivElement g=document.getElementById('dlg1');g.remove();IB.AH();}}class GH{TextAreaElement iD;SpanElement QF;q selectionStart;q selectionEnd;List<SpanElement> YP=new List<SpanElement>();List<n> EL=new List<n>();bool visible;static const Duration RT=const Duration(milliseconds:700);Timer bP;HashMap<int,DD> GL;GH(){iD=querySelector("#tacursor");QF=querySelector("#caret");visible=true;GL=new HashMap<int,DD>();iD.onKeyUp.listen((KeyboardEvent g)=>zV(g));iD.onKeyDown.listen((KeyboardEvent g)=>yV(g));iD.onBlur.listen((Event g)=>blur(g));IP();}void kW(HashMap<String,DD> h){HashMap<String,int> g=new HashMap<String,int>();g['A']=KeyCode.A;g['B']=KeyCode.B;g['C']=KeyCode.C;g['D']=KeyCode.D;g['E']=KeyCode.E;g['F']=KeyCode.F;g['G']=KeyCode.G;g['H']=KeyCode.H;g['I']=KeyCode.I;g['J']=KeyCode.J;g['K']=KeyCode.K;g['L']=KeyCode.L;g['M']=KeyCode.M;g['N']=KeyCode.N;g['O']=KeyCode.O;g['P']=KeyCode.P;g['Q']=KeyCode.Q;g['R']=KeyCode.R;g['S']=KeyCode.S;g['T']=KeyCode.T;g['U']=KeyCode.U;g['V']=KeyCode.V;g['W']=KeyCode.W;g['X']=KeyCode.X;g['Y']=KeyCode.Y;g['Z']=KeyCode.Z;for(String i in h.keys){String j=i.toUpperCase();if(g[j]!=null)GL[g[j]]=h[i];}}static q oJ(MouseEvent h){q g=t.zG(h.client.x,h.client.y);if(g==null)return (null);g.zE();assert(g.u!=null);return (g);}void yV(KeyboardEvent h){if(selectionStart==null)return;bool i=h.ctrlKey||h.metaKey;bool j=h.shiftKey;int g=h.keyCode;if(i&&g==KeyCode.X){iD.value=copy();iD.select();}else if(i&&g==KeyCode.C){iD.value=copy();iD.select();}else if(g==KeyCode.PAGE_DOWN){LW();}else if(g==KeyCode.PAGE_UP){MW();}else if(g==KeyCode.END){AW();}else if(g==KeyCode.HOME){BW();}else if(g==KeyCode.LEFT){if(j)lW();else left();}else if(g==KeyCode.UP){uW();}else if(g==KeyCode.RIGHT){if(j)mW();else right();}else if(g==KeyCode.DOWN){TV();}else if(g==KeyCode.BACKSPACE){BV();}else if(g==KeyCode.DELETE){qW();}else if(i&&GL[g]!=null){h.preventDefault();return;}else if(iD.value!=''){String k=iD.value;iD.value='';t.CS(k,j);}else{return;}IP();}void zV(KeyboardEvent j){bool i=j.ctrlKey||j.metaKey;bool h=j.shiftKey;int g=j.keyCode;if(selectionStart==null)return;if(i&&!h&&g==KeyCode.Z){t.aH();iD.value='';}else if(i&&((!h&&g==KeyCode.Y)||(h&&g==KeyCode.Z))){t.dM();iD.value='';}else if(i&&!h&&g==KeyCode.X){fM();iD.value='';IB.LC();}else if(i&&!h&&g==KeyCode.C){iD.value='';}else if(i&&!h&&g==KeyCode.V){if(selectionStart!=selectionEnd){fM();}PW(iD.value);iD.value='';IB.LC();}else if(i&&GL[g]!=null){j.preventDefault();GL[g]();IB.LC();}else if(iD.value!=''){String k=iD.value;iD.value='';t.CS(k,h);}else{return;}IP();}void blur(Event g){UH();}void BW(){HD h=selectionStart.jF();n g=selectionStart.u;if(g==null)return;while(!g.eC&&g.parent!=null)g=g.parent;Element j=g.pB();Rectangle k=j.getBoundingClientRect();h.x=k.left+1;h.y+= 5;q i=t.zG(h.x,h.y);if(i==null)return;if(i!=null){moveTo(i);IB.LC();}}void AW(){HD h=selectionStart.jF();n g=selectionStart.u;if(g==null)return;while(!g.eC&&g.parent!=null)g=g.parent;Element j=g.pB();Rectangle k=j.getBoundingClientRect();h.x=k.right-1;h.y+= 5;q i=t.zG(h.x,h.y);if(i==null)return;if(i!=null){moveTo(i);IB.LC();}}void left(){xG();selectionStart=US(selectionStart);selectionEnd=new q.qX(selectionStart);bH(true);IB.LC();}void right(){q g=new q.qX(selectionEnd);g=QS(g);xG();selectionStart=new q.qX(g);selectionEnd=new q.qX(g);bH(true);IB.LC();}void uW(){xG();HD g=selectionStart.jF();if(g==null)return;q h=selectionStart;while(h==selectionStart){g.y=g.y-7;h=t.zG(g.x,g.y);h.zE();}if(h!=null){selectionStart=h;selectionEnd=new q.qX(selectionStart);}bH(true);IB.LC();}void TV(){xG();HD g=selectionStart.jF();if(g==null)return;q h=selectionStart;while(h==selectionStart){g.y=g.y+14;h=t.zG(g.x,g.y);h.zE();}if(h!=null){selectionStart=h;selectionEnd=new q.qX(selectionStart);}bH(true);IB.LC();}void lW(){q g=new q.qX(selectionStart);g=US(g);gE(g,selectionEnd);}void mW(){q g=new q.qX(selectionEnd);g=QS(g);gE(selectionStart,g);}void MW(){HD g=selectionStart.jF();if(g==null)return;DivElement h=document.getElementById('doc1');g.y-= h.offsetHeight;q i=t.zG(g.x,g.y);if(i!=null){int j=h.scrollTop;moveTo(i);h.scrollTop=j-h.offsetHeight;IB.LC();}}void LW(){HD g=selectionStart.jF();if(g==null)return;DivElement h=document.getElementById('doc1');g.y+= h.offsetHeight;q i=t.zG(g.x,g.y);if(i!=null){int j=h.scrollTop;moveTo(i);h.scrollTop=j+h.offsetHeight;IB.LC();}}void BV(){if(selectionStart==selectionEnd){n g=selectionStart.u;int h=selectionStart.KB;if(g is oG&&h==0)return;if(g is OB&&h==0&&g.nodeValue[0]=='\n'&&g.previousSibling!=null&&g.previousSibling.RE()){WJ(selectionStart);return;}if(g is OB&&h==0&&g.nodeValue[0]=='\n'&&g.previousSibling==null&&g.parent.RG()){WJ(selectionStart);return;}bool k=false;while(g!=null&&g.FD&&h==0&&g.PB>0){if(g.FD&&g.eC)k=true;else k=false;h=g.parent.ZB(g);g=g.parent;}if(g is!OB&&h>0){n i=g.eB(h-1);if(k){n j=g.eB(h);assert(j.FD&&j.eC);if(i.DB!=j.DB&&!i.eC&&((i is OB&&t.CB.PE(j.DB))||(i.DB!=null&&t.CB.fD(j.DB,i.DB)))){OS(j);return;}}if(i.FD&&i.eC&&h<g.PB){n j=g.eB(h);if(i.DB!=j.DB&&!j.eC&&((j is OB&&t.CB.PE(i.DB))||(j.DB!=null&&t.CB.fD(i.DB,j.DB)))){NS(i);return;}}if(i.FD&&(!i.eC||(h==g.PB||g.eB(h).DB!=i.DB))){g=g.eB(h-1);h=g.PB;if(g is!OB&&h>0)i=g.eB(h-1);else i=null;}}while((g is!OB&&g.FD)&&g.PB==h&&g.firstChild!=null){g=g.lastChild;h=g.PB;}selectionStart=new q(g,h);selectionEnd=new q.qX(selectionStart);selectionStart.PG(-1);WJ(selectionStart);}else{fM();}IB.LC();}void qW(){if(selectionStart==selectionEnd){if(selectionStart.u is oG&&selectionStart.KB==selectionStart.u.PB)return;n g=selectionStart.u;int i=selectionStart.KB;while(g.FD&&i==g.PB&&g.PB>0){i=g.parent.ZB(g)+1;g=g.parent;}if(g is!OB&&i>0&&i<g.PB){n h=g.eB(i);n j=g.eB(i-1);if(j.FD&&j.eC&&h.DB!=j.DB&&!h.eC&&((h is OB&&t.CB.PE(j.DB))||(h.DB!=null&&t.CB.fD(j.DB,h.DB)))){NS(j);return;}if(h.FD&&h.eC&&h.DB!=j.DB&&!j.eC){if((j is OB&&t.CB.PE(h.DB))||(j.DB!=null&&t.CB.fD(h.DB,j.DB))){OS(h);return;}}}if(g is!OB&&i<g.PB){n h=g.eB(i);while(h!=null&&h.FD&&(!h.eC||(i==0||g.eB(i-1).DB!=h.DB))){g=h;i=0;if(g is!OB&&i<g.PB)h=g.eB(i);else h=null;}}selectionStart=new q(g,i);selectionEnd=new q.qX(selectionStart);WJ(selectionStart);}else{fM();}IB.LC();}q QS(q j){if(j.u is oG&&j.KB==j.u.PB)return (j);n g=j.u;int h=j.KB;while(g!=null&&g.FD&&h==g.PB&&!g.eC){h=g.parent.ZB(g)+1;g=g.parent;}n i;if(g.firstChild!=null&&h<g.PB)i=g.eB(h);else i=null;while(i!=null&&i.FD&&!i.eC){g=i;h=0;if(g.firstChild!=null&&h<g.PB)i=g.eB(h);else i=null;}bool k=false;if(h==g.PB){k=(g.FD&&g.eC);h=g.parent.ZB(g)+1;g=g.parent;while(k&&g.FD&&g.eC&&h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}}else if(g is OB){h++ ;}else{g=g.eB(h);q m=g.QE();if(m!=null){g=m.u;h=m.KB;k=(g.FD&&g.eC);}else{h=g.parent.ZB(g)+1;g=g.parent;}}if(g.firstChild!=null&&h<g.PB)i=g.eB(h);else i=null;while(i!=null&&i.FD&&(!i.eC||k)){g=i;h=0;if(g.firstChild!=null&&h<g.PB)i=g.eB(h);else i=null;}return (new q(g,h));}q US(q j){if(j.u is oG&&j.KB==0)return (j);n g=j.u;int h=j.KB;while(g!=null&&g.FD&&h==0&&!g.eC){h=g.parent.ZB(g);g=g.parent;}n i;if(g.firstChild!=null&&h>0)i=g.eB(h-1);else i=null;while(i!=null&&i.FD&&!i.eC){g=i;h=g.PB;if(g.firstChild!=null&&h>0)i=g.eB(h-1);else i=null;}bool k=false;if(h==0){k=(g.FD&&g.eC);h=g.parent.ZB(g);g=g.parent;while(k&&g.FD&&g.eC&&h==0){h=g.parent.ZB(g);g=g.parent;}}else if(g is OB){h-- ;}else{g=g.eB(h-1);h=g.PB;q m=g.SF();if(m!=null){g=m.u;h=m.KB;k=(g.FD&&g.eC);}else{h=g.parent.ZB(g);g=g.parent;}}if(g.firstChild!=null&&h>0)i=g.eB(h-1);else i=null;while(i!=null&&i.FD&&(!i.eC||k)){g=i;h=g.PB;if(g.firstChild!=null&&h>0)i=g.eB(h-1);else i=null;}return (new q(g,h));}void bH(bool j){if(selectionEnd!=selectionStart)return;HD g=selectionStart.jF();if(g==null){visible=false;}else{visible=true;DivElement h=document.getElementById('doc1');int i=h.offset.top;int k=h.offset.height;if(g.y-i<0||g.y-i>k){if(j){h.scrollTop+= g.y.toInt()-i;g=selectionStart.jF();}else{visible=false;}}}if(visible){QF.style.visibility='visible';QF.style.top="${g.y}px";QF.style.left="${g.x}px";fW();iD.style.top="${g.y}px";iD.style.left="${g.x}px";iD.focus();}else{QF.style.visibility='hidden';}}void fW(){bool i;Element k=selectionStart.u.pB();bool m=rZ(k);if(m&&selectionStart.u.PB>0){bool g;if(selectionStart.KB>0){n o=selectionStart.u.eB(selectionStart.KB-1);Element s=o.pB();g=rZ(s);}else{if(selectionStart.u is xD)g=false;else g=true;}bool h;if(selectionStart.KB<selectionStart.u.PB){n j=selectionStart.u.eB(selectionStart.KB);Element v=j.pB();if(j is xD&&selectionStart.KB==0)h=false;else h=rZ(v);}else h=true;i=g&&h;}else i=false;if(i)QF.classes.add('horizontal');else if(QF.classes.contains('horizontal'))QF.classes.remove('horizontal');}bool rZ(Element g){return (g is DivElement||g is TableElement||g is UListElement||g is LIElement);}void moveTo(q g){xG();selectionStart=new q.qX(g);selectionStart.zE();selectionEnd=new q.qX(selectionStart);bH(true);}void UH(){visible=false;QF.style.visibility='hidden';}void show(){if(selectionStart!=null&&selectionStart==selectionEnd){visible=true;QF.style.visibility='visible';}}void focus(){if(visible)show();iD.focus();}void JV(){iD.value='';}gE(q o,q s){if(selectionStart==o&&selectionEnd==s){if(o==s){bH(false);}return;}xG();q HB=selectionStart;selectionStart=new q.qX(o);selectionEnd=new q.qX(s);if(selectionStart==selectionEnd){bH(false);IB.LC();return;}if(selectionStart>selectionEnd){q JB=selectionStart;selectionStart=selectionEnd;selectionEnd=JB;}while((selectionStart.u is OB||selectionStart.u is zB||selectionStart.u is kB)&&selectionStart.KB==0){selectionStart=new q(selectionStart.u.parent,selectionStart.u.parent.ZB(selectionStart.u));}while((selectionStart.u is OB||selectionStart.u is zB||selectionStart.u is kB)&&selectionStart.KB==selectionStart.u.PB){selectionStart=new q(selectionStart.u.parent,selectionStart.u.parent.ZB(selectionStart.u)+1);}while((selectionEnd.u is OB||selectionEnd.u is zB||selectionEnd.u is kB)&&selectionEnd.KB==selectionEnd.u.PB){selectionEnd=new q(selectionEnd.u.parent,selectionEnd.u.parent.ZB(selectionEnd.u)+1);}while((selectionEnd.u is OB||selectionEnd.u is zB||selectionEnd.u is kB)&&selectionEnd.KB==0){selectionEnd=new q(selectionEnd.u.parent,selectionEnd.u.parent.ZB(selectionEnd.u));}if(selectionStart!=selectionEnd){if((selectionStart.u is OB||selectionStart.u is zB||selectionStart.u is kB)&&selectionStart.KB==selectionStart.u.PB){n g=selectionStart.u.nextNode();selectionStart=new q(g.parent,g.parent.ZB(g));}if((selectionEnd.u is OB||selectionEnd.u is zB||selectionEnd.u is kB)&&selectionEnd.KB==0){n j=selectionEnd.u.previousNode();selectionEnd=new q(j.parent,j.parent.ZB(j)+1);}bool m;do{m=false;if(selectionStart.u is!OB&&selectionStart.KB<selectionStart.u.PB){n g=selectionStart.u.eB(selectionStart.KB);if(new q(selectionStart.u,selectionStart.KB+1)>selectionEnd&&new q(g,0)<selectionEnd){selectionStart=new q(g,0);m=true;}}}while(m);do{m=false;if(selectionEnd.u is!OB&&selectionEnd.KB>0){n j=selectionEnd.u.eB(selectionEnd.KB-1);if(new q(selectionEnd.u,selectionEnd.KB-1)<selectionStart&&new q(j,j.PB)>selectionStart){selectionEnd=new q(j,j.PB);m=true;}}}while(m);}if(selectionStart.u==selectionEnd.u){n v=selectionStart.u;if(v.nodeType==n.nB){TP(v,selectionStart.KB,selectionEnd.KB);}else{for(int BB=selectionStart.KB;BB<selectionEnd.KB;BB++ ){n EB=v.eB(BB);EB.FL(true);EL.add(EB);}}}else{n h=selectionStart.u;if(h.nodeType==n.nB)h=h.parent;if(selectionEnd>new q(h,h.PB))selectionEnd=new q(h,h.PB);else{n k=selectionEnd.u;if(k.nodeType==n.nB)k=k.parent;if(k!=h){while(k.parent!=h){k=k.parent;}selectionEnd=new q(h,h.ZB(k));}}n i;if(selectionStart.u.nodeType==n.tC||selectionStart.u.nodeType==n.YG){i=selectionStart.u.eB(selectionStart.KB);if(i!=null){q QB=new q(selectionStart.u,selectionStart.KB+1);if(selectionEnd>=QB){i.FL(true);EL.add(i);}}}else{i=selectionStart.u;TP(i,selectionStart.KB,i.PB);}if(i!=null){for(n g=i.nextSibling;g!=null;g=g.nextSibling){q SB=new q(g.parent,g.parent.ZB(g));if(SB<selectionEnd){if(g.nodeType!=n.nB||selectionEnd>=new q(g.parent,g.parent.ZB(g)+1)){g.FL(true);EL.add(g);}}else break;}}if(selectionEnd.u.nodeType==n.nB){TP(selectionEnd.u,0,selectionEnd.KB);}}if(selectionEnd!=selectionStart)UH();if(selectionStart!=HB)IB.LC();}void TP(n o,int j,int k){Element h=o.pB();if(h==null)return;Text m=h.nodes.first;Node s=m.nextNode;UH();String i=o.nodeValue;if(j==0){m.remove();}else{m.text=i.substring(0,j);}SpanElement g=new SpanElement();YP.add(g);g.classes.add('selection');g.append(new Text(i.substring(j,k)));if(s==null)h.append(g);else h.insertBefore(g,s);if(k!=i.length){Text v=new Text(i.substring(k));if(g.nextNode==null)h.append(v);else h.insertBefore(v,g.nextNode);}}void xG(){for(SpanElement i in YP){Element g=i.parent;StringBuffer h=new StringBuffer();for(Node j in g.nodes){h.write(j.text);}g.nodes.clear();g.append(new Text(h.toString()));selectionEnd=new q.qX(selectionStart);visible=true;}YP.clear();for(n k in EL){k.FL(false);}EL.clear();}void IP(){if(!visible)return;if(bP!=null)bP.cancel();QF.style.visibility="visible";bP=new Timer.periodic(RT,(Timer g)=>FV());}void FV(){if(!visible)return;if(QF.style.visibility=="hidden")QF.style.visibility="visible";else if(QF.style.visibility=="visible")QF.style.visibility="hidden";}void WJ(q h){n g;if(h.u.nodeType==n.nB&&h.u.PB<h.KB+1&&h.u.nextSibling!=null){n j=h.u;n k=j.nextSibling;while(k==null&&j.parent!=null){j=j.parent;k=j.nextSibling;}g=k;if(g.nodeType==n.nB&&g.parent!=null&&g.PB==1)g=g.parent;}else if(h.u.nodeType==n.nB&&h.u.PB<h.KB+1&&h.u.nextSibling==null){g=h.u;if(g.parent!=null)g=g.parent;if(g.FD&&g.eC){if(g.nextSibling.DB==g.DB){EP(g,g.nextSibling);}else{q m=new q.qX(h);m.PG(1);if(m>h)WJ(m);}return;}}else if(h.u.nodeType==n.tC&&h.u.PB<h.KB+1){g=h.u;if(g.FD&&g.eC){if(g.nextSibling!=null&&g.nextSibling.DB==g.DB){EP(g,g.nextSibling);return;}}}else if(h.u.nodeType==n.tC||h.u.nodeType==n.YG){g=h.u.eB(h.KB);if(g.FD&&g.eC){if(g.previousSibling!=null&&g.previousSibling.DB==g.DB){EP(g.previousSibling,g);return;}else if(g.PB>0){q o=new q.qX(h);o.PG(-1);if(o<h)WJ(o);return;}}if(g==null){window.alert("I'm sorry Dave, I'm afraid I can't do that.");return;}}else if(h.u.nodeType==n.nB&&h.KB==0&&h.u.PB==1&&h.u.parent is zB&&h.u.parent.PB==1){g=h.u.parent;while(g.parent is zB&&g.parent.PB==1)g=g.parent;}else{t.VW(h,1);sE i=zB.WN(selectionStart);if(i!=null){t.DC(i.xH);t.lK(LB.MB('undo.remove_text'),2);gE(i.start,i.end);}return;}if(g is xD&&g.parent.PB==1){g=g.parent;}if(!g.dJ){t.eM(g);sE i=zB.WN(selectionStart);if(i!=null){t.DC(i.xH);t.lK(LB.MB('undo.remove_element'),2);gE(i.start,i.end);}}}void fM(){if(selectionStart==selectionEnd)return;q g=new q.qX(selectionStart);q h=new q.qX(selectionEnd);xG();if(g.u is iC&&g.u==h.u&&g.KB==0&&h.KB==h.u.PB){t.eM(g.u);}else{t.OP(g,h);sE i=zB.WN(g);if(i!=null){t.DC(i.xH);t.lK(LB.MB('undo.remove'),2);gE(i.start,i.end);}}}void refresh(){q g=selectionStart;q h=selectionEnd;selectionStart=null;selectionEnd=null;gE(g,h);}String copy(){StringBuffer h=new StringBuffer();if(selectionStart.u==selectionEnd.u){n j=selectionStart.u;if(j.nodeType==n.nB){h.write(j.nodeValue.substring(selectionStart.KB,selectionEnd.KB));}else{for(int k=selectionStart.KB;k<selectionEnd.KB;k++ ){n m=j.eB(k);h.write(m);}}}else{n i;if(selectionStart.u.nodeType==n.tC){i=selectionStart.u.eB(selectionStart.KB);q o=new q(selectionStart.u,selectionStart.KB+1);if(selectionEnd>=o){h.write(i);}}else{i=selectionStart.u;h.write(i.nodeValue.substring(selectionStart.KB));}for(n g=i.nextSibling;g!=null;g=g.nextSibling){q s=new q(g.parent,g.parent.ZB(g));if(s<selectionEnd){if(g.nodeType!=n.nB||selectionEnd>=new q(g.parent,g.parent.ZB(g)+1)){h.write(g);g.FL(true);}}else break;}if(selectionEnd.u.nodeType==n.nB){h.write(selectionEnd.u.nodeValue.substring(0,selectionEnd.KB));}}return (h.toString());}bool PW(String i){sB k;try {EG v=new EG();k=v.parseFromString("<root>${i}</root>");}on UD catch (m){bool j=false;if(i.trim()!=''){n g=selectionStart.u;if(g.nodeType==n.nB)g=g.parent;if(g.nodeType==n.YG)j=true;else if(g.DB!=null&&!t.CB.PE(g.DB))j=true;}if(j){window.alert(LB.MB('insert.text_not_allowed'));return (false);}t.XM(selectionStart,i);return (true);}n g=selectionStart.u;if(g is OB)g=g.parent;l o=k.documentElement;n h=ND.NF(g.DB);if(o.childNodes!=null){for(AB BB in o.childNodes){n EB=ND.fH(BB,h);h.jB(EB);}}h.NG();if(t.ZC!=null){kB.SN(g,h);t.QP(h);}GB s=new GB.vX(LB.MB('undo.paste'));try {s.TB(t.LE(h,selectionStart,checkValidity:true));}on CD catch (m){window.alert(m.toString());return (false);}t.DC(s);return (true);}void EP(n g,n h){GB j=new GB.vX(LB.MB('undo.remove_text'));n i;q m=new q(h,0);q o=new q(h,h.PB);if(o>m)i=t.iI(m,o);else i=null;j.TB(new GB.sX(h));if(i!=null)j.TB(t.LE(i,new q(g,g.PB)));q k;if(g.lastChild is OB)k=new q(g.lastChild,g.lastChild.PB);else k=new q(g,g.PB);t.DC(j);IB.KD(k);}void OS(n g){assert(g.previousSibling!=null);int s=g.parent.ZB(g);GB k=new GB.vX(LB.MB('undo.remove_text'));int h=s;bool v=t.CB.PE(g.DB);while(h>0){n i=g.parent.eB(h-1);if(i.eC||(i is OB&&!v)||(i.DB!=null&&!t.CB.fD(g.DB,i.DB)))break;h-- ;}q m=new q(g.parent,h);q o=new q(g.parent,s);assert(m<o);n BB=t.IG(g.parent,m,o);k.TB(t.GI(m,o));k.TB(t.LE(BB,new q(g,0)));q j=new q(g,0);j.zE();j=new q.mX(j);t.DC(k);moveTo(j);IB.LC();return;}void NS(n g){assert(g.nextSibling!=null);int s=g.parent.ZB(g.nextSibling);GB k=new GB.vX(LB.MB('undo.remove_text'));int h=s;bool v=t.CB.PE(g.DB);while(h<g.parent.PB){n i=g.parent.eB(h);if(i.eC||(i is OB&&!v)||(i.DB!=null&&!t.CB.fD(g.DB,i.DB)))break;h++ ;}q m=new q(g.parent,h);q o=new q(g.parent,s);assert(o<m);n BB=t.IG(g.parent,o,m);k.TB(t.GI(o,m));k.TB(t.LE(BB,new q(g,g.PB)));q j=new q(g,g.PB);j.zE();j=new q.hX(j);t.DC(k);moveTo(j);IB.LC();return;}}class bB{static const int ME=0;static const int iE=1;static const int CN=2;n sZ;int tZ;bool uZ;bB(n h,int i,[bool g]){sZ=h;tZ=i;if(g!=null)uZ=g;else uZ=false;}Element html(){Element h=new SpanElement();String i;if(tZ==ME)i="start_tag";else if(tZ==iE)i="end_tag";else if(tZ==CN)i="empty_tag";h.classes.add(i);if(uZ)h.classes.add('long');if(tZ!=iE){bool k;if(sZ.DB!=null){List<l> v=t.CB.fE(sZ.DB);k=(v!=null&&v.length>0);}else{k=(sZ is!BG&&sZ is!qF);}if(k){ImageElement BB=new ImageElement(src:'packages/daxe/images/attributes.png',width:16,height:16);BB.onClick.listen((MouseEvent j)=>yU(j));h.append(BB);}}String g;if(sZ.DB!=null){g=t.CB.OD(sZ.DB);if(g==null)g=sZ.nodeName;}else if(sZ is BG){if(tZ==ME)g="(";else g=")";}else if(sZ is IH){if(tZ==ME)g="PI ${sZ.nodeName}";else g="PI";}else if(sZ is qF)g="CDATA";else if(sZ.nodeName!=null)g=sZ.nodeName;else g="?";if(tZ!=iE){bool JB=(t.CB.bC(sZ.DB,'attributsVisibles','false')=='true');if(JB){h.append(new Text(g));for(aB EB in sZ.attributes){h.append(new Text(" "));Element m=new SpanElement();m.attributes['class']='attribute_name';m.text=EB.localName;h.append(m);h.append(new Text("="));Element o=new SpanElement();o.attributes['class']='attribute_value';o.text=EB.value;h.append(o);}}else{List<String> HB=t.CB.eV(sZ.DB)['titreAtt'];if(HB!=null){for(String QB in HB){String s=sZ.getAttribute(QB);if(s!=null&&s!=''){g+= " '${s}'";break;}}}h.append(new Text(g));}}else h.append(new Text(g));h.onDoubleClick.listen((MouseEvent j){IB.selectNode(sZ);j.preventDefault();j.stopPropagation();});return (h);}void yU(MouseEvent g){sZ.JE();}}class zM{n RF;List<InputElement> EI;List<InputElement> LL;DD okfct;zM(this.RF,[this.okfct]){EI=new List<InputElement>();LL=new List<InputElement>();}void show(){DivElement i=new DivElement();i.id='attributes_dlg';i.classes.add('dlg1');DivElement v=new DivElement();v.classes.add('dlg2');DivElement j=new DivElement();j.classes.add('dlg3');DivElement BB=new DivElement();BB.classes.add('dlgtitle');BB.text=RF.nodeName;j.append(BB);FormElement EB=new FormElement();TableElement QB=new TableElement();SD SB=null;for(aB cB in RF.attributes){TableRowElement k=new TableRowElement();TableCellElement g=new TableCellElement();InputElement HB=vZ(cB.name);EI.add(HB);g.append(HB);k.append(g);g=new TableCellElement();InputElement hB=wZ(cB.value);LL.add(hB);g.append(hB);k.append(g);xZ(k,HB);QB.append(k);}EB.append(QB);DivElement h=new DivElement();h.classes.add('buttons');ButtonElement m=new ButtonElement();m.attributes['type']='button';m.appendText(LB.MB("attribute.add"));m.onClick.listen((MouseEvent JB)=>yZ());h.append(m);ButtonElement o=new ButtonElement();o.attributes['type']='button';o.appendText(LB.MB("button.Cancel"));o.onClick.listen((MouseEvent JB)=>cancel());h.append(o);ButtonElement s=new ButtonElement();s.attributes['type']='submit';s.appendText(LB.MB("button.OK"));s.onClick.listen((MouseEvent JB)=>iF(JB));h.append(s);EB.append(h);j.append(EB);v.append(j);i.append(v);document.body.append(i);if(SB!=null)SB.focus();}void iF(MouseEvent k){List<aB> j=new List<aB>();for(int h=0;h<EI.length;h++ ){TextInputElement g=EI[h];String i=g.value;if(!zZ(i)){k.preventDefault();g.select();g.selectionStart=g.selectionEnd=g.value.length;window.alert(LB.MB('attribute.invalid_attribute_name'));return;}String o=LL[h].value;int BB=i.indexOf(':');aB m;String s=t.CB!=null?t.CB.eK(i):null;m=new aB.dX(s,i,o);j.add(m);}querySelector('div#attributes_dlg').remove();k.preventDefault();if(RF.pB()!=null){GB v=new GB.tX(RF,j);t.DC(v);}else{RF.attributes=j;}IB.AH();if(okfct!=null)okfct();}void cancel(){querySelector('div#attributes_dlg').remove();IB.AH();}void xZ(i,j){TableCellElement h=new TableCellElement();ButtonElement g=new ButtonElement();g.attributes['type']='button';g.value='-';g.text='-';g.onClick.listen((Event k)=>Aa(j));h.append(g);i.append(h);}TextInputElement vZ([String h]){TextInputElement g=new TextInputElement();g.spellcheck=false;g.value=h!=null?h:"";g.size=20;g.onInput.listen((Event i)=>Ba(g));g.onKeyUp.listen((KeyboardEvent i)=>Ba(g));return (g);}bool zZ(String g){final RegExp h=new RegExp("^[^<>&#!/?'\",0-9.\\-\\s][^<>&#!/?'\",\\s]*\$");return (h.hasMatch(g));}void Ba(TextInputElement g){String h=g.value;if(zZ(h)){g.classes.add('valid');g.classes.remove('invalid');}else{g.classes.add('invalid');g.classes.remove('valid');}}TextInputElement wZ([String h]){TextInputElement g=new TextInputElement();g.spellcheck=false;g.value=h!=null?h:"";g.size=40;return (g);}yZ(){TableElement k=document.querySelector("#attributes_dlg table");TextInputElement i=vZ();TextInputElement j=wZ();EI.add(i);LL.add(j);TableRowElement h=new TableRowElement();TableCellElement g=new TableCellElement();g.append(i);h.append(g);g=new TableCellElement();g.append(j);h.append(g);xZ(h,i);k.append(h);}void Aa(InputElement h){for(int g=0;g<EI.length;g++ ){if(EI[g]==h){EI.removeAt(g);LL.removeAt(g);TableRowElement i=document.querySelector("#attributes_dlg table tr:nth-child(${g+1})");i.remove();}}}}typedef n lJ(l elementRef);class vD implements q{int Ca;vD(int g){assert(g>=0);Ca=g;}vD.ZX(dC i){n j=i.u;int k=i.KB;Ca=0;n g=t.rC;int h=g.PB;while(g!=j||h!=k){if(h==0){h=g.parent.ZB(g);g=g.parent;}else if(g is OB){h-- ;}else{g=g.eB(h-1);h=g.PB;}Ca++ ;}}vD.kX(CE k){n i=t.rC;int m=i.PB;int j=0;n g=t.rC;int h=0;while(g!=i||h!=m){if(h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}else if(g is OB){h++ ;}else{g=g.eB(h);h=0;}j++ ;}Ca=j-k.HF;}vD.oX(vD g){Ca=g.UF;}n get u{dC g=new dC.gX(this);return (g.u);}int get KB{dC g=new dC.gX(this);return (g.KB);}int get HF{CE g=new CE.iX(this);return (g.HF);}int get UF{return (Ca);}bool operator==(q g){return (Ca==g.UF);}bool operator<(q g){return (Ca>g.UF);}bool operator<=(q g){return (Ca>=g.UF);}bool operator>(q g){return (Ca<g.UF);}bool operator>=(q g){return (Ca<=g.UF);}void PG(int g){Ca-= g;}void zE(){dC g=new dC.gX(this);g.zE();Ca=(new vD.ZX(g)).Ca;}HD jF(){dC g=new dC.gX(this);return (g.jF());}String MI({bool titles: false}){dC g=new dC.gX(this);return (g.MI(titles:titles));}String toString(){return ("[RightOffsetPosition ${Ca}]");}}class CE implements q{int Da;CE(int g){assert(g>=0);Da=g;}CE.YX(dC i){n j=i.u;int k=i.KB;Da=0;n g=t.rC;int h=0;while(g!=j||h!=k){if(h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}else if(g is OB){h++ ;}else{g=g.eB(h);h=0;}Da++ ;}}CE.iX(vD k){n i=t.rC;int m=i.PB;int j=0;n g=t.rC;int h=0;while(g!=i||h!=m){if(h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}else if(g is OB){h++ ;}else{g=g.eB(h);h=0;}j++ ;}Da=j-k.UF;}CE.nX(CE g){Da=g.HF;}n get u{dC g=new dC.cX(this);return (g.u);}int get KB{dC g=new dC.cX(this);return (g.KB);}int get HF{return (Da);}int get UF{vD g=new vD.kX(this);return (g.UF);}bool operator==(q g){return (Da==g.HF);}bool operator<(q g){return (Da<g.HF);}bool operator<=(q g){return (Da<=g.HF);}bool operator>(q g){return (Da>g.HF);}bool operator>=(q g){return (Da>=g.HF);}void PG(int g){Da+= g;}void zE(){dC g=new dC.cX(this);g.zE();Da=g.HF;}HD jF(){dC g=new dC.cX(this);return (g.jF());}String MI({bool titles: false}){dC g=new dC.cX(this);return (g.MI(titles:titles));}String toString(){return ("[LeftOffsetPosition ${Da}]");}}class HH{static final String kP="string";l Ea;String gM;String Fa;HashMap<String,l> Ga;HashMap<l,String> Ha;HashMap<l,String> Ia;HashMap<l,Pattern> Ja=null;HashMap<l,Pattern> Ka=null;HashMap<l,HashMap<String,List<String>>> La=null;List<String> Ma=null;XL Na;l Oa;l Pa;l Qa;l Ra;l Sa;List<l> Ta;HH(){}Future load(final String h){Completer g=new Completer();if(h==null){Ea=null;return (new Future.error(new CD("Config.load: null path")));}EG s=new EG();s.AL(h).then((sB i){String m;if(i.documentElement.nodeName=="CONFIG_JAXE")m=null;else m=Ua(i.documentElement);Fa=cT(h);Ea=i.documentElement;Va();Ia=new HashMap<l,String>();final String j=dW();if(j==null){final l o=RC(Wa(),"SCHEMA_SIMPLE");if(o==null){g.completeError(new CD("Error: no XML schema is defined in the config file ${h}"));return;}Na=new gL(o,Xa());gM=null;Ya();g.complete();return;}if(Fa!=null)gM="${Fa}/${j}";else gM=j;Na=new wB(Xa());(Na as wB).load(gM).then((v){Ya();g.complete();},onError:(rF k){g.completeError(new CD("Error reading schemaURL: ${k}"));});},onError:(UD k){g.completeError(new CD("Error reading ${h}: ${k}"));});return (g.future);}static String cT(final String g){final int h=g.lastIndexOf("/");if(h>=0){return (g.substring(0,h));}return (null);}List<l> II(){final List<l> h=new List<l>();final List<l> j=Na.II();l g=RC(Wa(),"RACINE");while(g!=null){final String k=g.getAttribute("element");for(final l i in j)if(k==Na.cD(i))h.add(i);g=kD(g,"RACINE");}return (h);}void PO(final n g){final List<String> o=Za();for(final String h in o){if(h!=""){final String i=kG(h);String j;if(i!=null&&i!="")j="xmlns:${i}";else j="xmlns";g.setAttributeNS("http://www.w3.org/2000/xmlns/",j,h);}}final String k=oV();final String m=lV();if(k!=null||m!=null){g.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi","http://www.w3.org/2001/XMLSchema-instance");if(k!=null)g.setAttributeNS("http://www.w3.org/2001/XMLSchema-instance","xsi:schemaLocation",k);if(m!=null)g.setAttributeNS("http://www.w3.org/2001/XMLSchema-instance","xsi:noNamespaceSchemaLocation",m);}}String dW(){final l h=RC(Wa(),"FICHIER_SCHEMA");if(h==null)return (null);String g=h.getAttribute("nom");if(g=="")g=null;return (g);}HashMap<String,l> Va(){Ga=new HashMap<String,l>();if(Ea==null)return (Ga);l g=RC(aa(),"AFFICHAGE_ELEMENT");while(g!=null){final String h=g.getAttribute("element");Ga[h]=g;g=kD(g,"AFFICHAGE_ELEMENT");}return (Ga);}l tK(String g){return Ga[g];}void Ya(){Ha=new HashMap<l,String>();if(Ea==null)return;final List<l> i=Na.JD();for(final l g in i){final String h=Na.cD(g);if(h!=null)Ha[g]=h;}}String Ua(final l h){final l g=RC(h,"FICHIERTITRES");if(g==null)return (null);return (g.getAttribute("nom"));}String oV(){final l g=RC(ba(),"SCHEMALOCATION");if(g!=null){final String h=g.getAttribute("schemaLocation");if(h!="")return (h);}return (null);}String lV(){final l g=RC(ba(),"SCHEMALOCATION");if(g!=null){final String h=g.getAttribute("noNamespaceSchemaLocation");if(h!="")return (h);}return (null);}String kG(final String h){if(h=="http://www.w3.org/XML/1998/namespace")return ("xml");l g=RC(ba(),"PREFIXE_ESPACE");while(g!=null){if(h==g.getAttribute("uri"))return (g.getAttribute("prefixe"));g=kD(g,"PREFIXE_ESPACE");}return (Na.kG(h));}WB ca(final PL v,final l QB){final String SB=QB.getAttribute("nom");String CC=DI(SB);final WB i=new WB(CC);String cB=MS(SB);if(cB!=null){i.KI=cB;}AB g=QB.firstChild;while(g!=null){uB h=null;final String o=g.nodeName;String BB=null;if(g is l){final String EB=(g as l).getAttribute("raccourci");if(EB!=null&&EB!=""){BB=EB.toUpperCase()[0];}}if(o=="MENU_INSERTION"){final l hB=g as l;final String j=hB.getAttribute("nom");final String HB=DI(j);String s=hB.getAttribute("type_noeud");if(s=="")s="element";l k;if(s=="element"){k=iG(j);if(k==null)pJ("Erreur: MENU_INSERTION: pas de référence pour '${j}' dans le schéma");}else k=null;h=new uB(HB,()=>v.CI(k,s),shortcut:BB,data:k);i.add(h);String m=wH(k);if(m!=null){h.KI=m;}}else if(o=="MENU_FONCTION"){final l JB=g as l;final String IC=JB.getAttribute("classe");final String j=JB.getAttribute("nom");final String HB=DI(j);h=new uB(HB,()=>v.WV(IC,JB),shortcut:BB);i.add(h);String m=MS(j);if(m!=null){h.KI=m;}}else if(o=="MENU"){h=ca(v,g as l);i.add(h);}else if(o=="SEPARATEUR")i.RO();g=g.nextSibling;}return (i);}zF DW(final PL k){final zF h=new zF();final l i=da();if(i!=null){l g=RC(i,"MENU");while(g!=null){final WB j=ca(k,g);j.parent=h;h.add(j);g=kD(g,"MENU");}}return (h);}XL nV(){return (Na);}List<l> vU(){final List<l> g=Na.JD();return (g);}String cD(final l g){return (Ha[g]);}l UM(final l g,final l h){return (Na.iG(g,h));}l iG(final String g){final l h=Na.QM(EN(g));return (h);}List<l> nK(final String g){return (Na.jO(EN(g)));}String kI(final l g){return (Na.kI(g));}String PM(final l h){final String g=kI(h);if(g==null)return (null);return (kG(g));}List<String> pK(final l g){final List<String> h=Na.pK(g);return (h);}bool xO(final l g,final String h){return (Na.kO(g,h));}List<String> Za(){if(Ma!=null)return (Ma);final List<String> g=new List<String>();final List<String> h=Na.FP();if(h!=null)g.addAll(h);Ma=g;return (g);}bool HI(final l g,final l h){return (Na.HI(g,h));}bool fD(final l h,final l i){final List<l> g=XC(h);if(g==null)return (false);return (g.contains(i));}l fF(final l i,final List<l> j){final List<l> g=XC(i);if(g==null)return (null);for(l h in j)if(g.contains(h))return (h);return (null);}List<l> XC(final l g){return (Na.XC(g));}String ea(final l g,final bool h,final bool i){return (Na.ZD(g,h,i));}String ZD(final l g){return (Na.ZD(g,true,false));}bool WM(n h,final int m,final int o,final l s){if(h.nodeType==n.YG){for(n g in h.childNodes){if(g.nodeType==n.tC)return (false);}return (true);}assert(h.nodeType==n.tC);if(Na is gL)return (true);if(m<0){pJ("Config.insertionPossible: debutSelection < parent.debut");return (false);}if(Na is wB){final List<l> i=new List<l>();bool j=false;for(n g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==n.tC){int k=h.ZB(g);if(k<m||k>=o){if(!j&&k>=o){i.add(s);j=true;}i.add(g.DB);}}}if(!j)i.add(s);final bool v=(Na as wB).gS(h.DB,i,true);return (v);}return (false);}bool iO(final n g){if(g is BG||g is IH||g is qF)return (true);if(g.DB==null)return (false);if(!AV(g))return (false);if(g.firstChild==null&&!xO(g.DB,''))return (false);else if(g.childNodes.length==1&&g.firstChild is OB&&g.firstChild.nodeValue!=null&&!xO(g.DB,g.firstChild.nodeValue))return (false);if(Na is gL)return (true);if(Na is wB){final List<l> v=new List<l>();bool j=false;for(n i=g.firstChild;i!=null;i=i.nextSibling){if(i.nodeType==n.tC&&i.DB!=null){v.add(i.DB);}else if(i.nodeType==n.nB){if(i.nodeValue.trim()!="")j=true;}else if(i is qF){if(i.firstChild!=null&&i.firstChild.nodeValue.trim()!='')j=true;}}if(j&&!Na.PE(g.DB))return (false);final wB BB=Na as wB;return (BB.gS(g.DB,v,false));}final l k=g.DB;final StringBuffer o=new StringBuffer();if(Ka==null)Ka=new HashMap<l,Pattern>();bool j=false;n h=g.firstChild;while(h!=null){if(h is qF){if(h.firstChild!=null&&h.firstChild.nodeValue.trim()!='')j=true;}else if(h.nodeType==n.tC&&h is!BG&&h is!IH){o.write(h.localName);o.write(",");}else if(h.nodeType==n.nB){if(h.nodeValue.trim()!='')j=true;}h=h.nextSibling;}if(j&&!Na.PE(k))return (false);RegExp m=Ka[k];if(m==null){final String s=ea(k,false,true);if(s==null||s=="")return (true);try {m=new RegExp(r"^$expr$");}on Exception catch (EB){pJ("elementValide(JaxeElement, bool, List<String>) - Malformed Pattern: ^${s}\$:",EB);return (true);}Ka[k]=m;}final bool HB=m.hasMatch(o.toString());return (HB);}bool AV(final n h){if(h.nodeType!=n.tC){pJ("Config.attributsValides : ce n'est pas un élément: ${h}");return (false);}final List<l> m=fE(h.DB);List<String> i=new List<String>(m.length);List<String> BB=new List<String>(i.length);for(int g=0;g<m.length;g++ ){final l j=m[g];i[g]=attributeName(j);BB[g]=attributeNamespace(j);final String o=h.getAttribute(i[g]);if(o==null||o==''){if(BL(h.DB,j))return (false);}else if(!fS(j,o))return (false);}final List<aB> EB=h.attributes;for(int g=0;g<EB.length;g++ ){aB s=EB[g];final String v=s.EC;if(v=="xml"||v=="xmlns")continue;final String HB=s.localName;if(v==null&&HB=="xmlns")continue;final String JB=s.qB;if(JB=="http://www.w3.org/2001/XMLSchema-instance")continue;bool QB=false;for(int k=0;k<i.length;k++ ){if(i[k]==HB&&BB[k]==JB){QB=true;break;}}if(!QB)return (false);}return (true);}List<l> fC(final l g){return (Na.fC(g));}bool PE(final l g){if(g==null)return (true);return (Na.PE(g));}List<l> fE(final l g){return (Na.fE(g));}String attributeName(final l g){return (Na.attributeName(g));}String PH(final l j,final l g){String h=Na.attributeName(g);String k=Na.attributeNamespace(g);if(k!=null){String i=NR(j,g);if(i!=null)h="${i}:${h}";}return (h);}String attributeNamespace(final l g){return (Na.attributeNamespace(g));}String NR(final l i,final l j){final String g=attributeNamespace(j);if(g==null)return (null);if(g=="http://www.w3.org/XML/1998/namespace")return ("xml");if(g=="http://www.w3.org/2000/xmlns/"&&attributeName(j)!="xmlns")return ("xmlns");String h=i.CP(g);if(h==null){if(i.ownerDocument.documentElement!=null)h=i.ownerDocument.CP(g);else h=kG(g);}return (h);}String eK(final String g){return (Na.eK(g));}bool BL(final l g,final l h){return (Na.VO(g,h));}List<String> hI(final l g){final List<String> h=Na.hI(g);return (h);}String dF(final l g){return (Na.dF(g));}bool fS(final l g,final String h){return (Na.WO(g,h));}static String EN(final String g){if(g==null)return (null);final int h=g.indexOf(':');if(h==-1)return (g);return (g.substring(h+1));}String RS(final l k,final String i,final int h){if(h==AB.FE){final l j=tK(EN(i));if(j==null)return (kP);return (j.getAttribute("type"));}else if(h==AB.CK){l g=RC(aa(),"PLUGIN_INSTRUCTION");while(g!=null){if(i!=null&&i==g.getAttribute("cible"))return ("plugin");g=kD(g,"PLUGIN_INSTRUCTION");}return ("instruction");}else if(h==AB.DK){final l g=RC(aa(),"PLUGIN_COMMENTAIRE");if(g!=null)return ("plugin");return ("commentaire");}else if(h==AB.BK){final l g=RC(aa(),"PLUGIN_CDATA");if(g!=null)return ("plugin");return ("cdata");}else if(h==AB.kE){return ("texte");}return (null);}String gO(final l h){final l g=tK(cD(h));if(g==null)return (kP);return (g.getAttribute("type"));}l nO(final String h){if(Ea==null)return (null);l g=RC(aa(),"AFFICHAGE_ELEMENT");while(g!=null){if(h==g.getAttribute("type"))return (iG(g.getAttribute("element")));g=kD(g,"AFFICHAGE_ELEMENT");}return (null);}List<l> yG(final String i){if(Ea==null)return (null);List<l> h=new List<l>();l g=RC(aa(),"AFFICHAGE_ELEMENT");while(g!=null){if(i==g.getAttribute("type"))h.addAll(nK(g.getAttribute("element")));g=kD(g,"AFFICHAGE_ELEMENT");}return (h);}String bC(final l g,final String h,final String i){return JP(g,"element",null,h,i);}String JP(final l i,final String j,final String k,final String m,final String o){final HashMap<String,List<String>> s=tR(i,j,k);final List<String> g=s[m];String h;if(g!=null&&g.length>0)h=g[0];else h=o;return h;}HashMap<String,List<String>> fa(final l j){final HashMap<String,List<String>> i=new HashMap<String,List<String>>();l g=RC(j,"PARAMETRE");while(g!=null){final String k=g.getAttribute("nom");final String m=g.getAttribute("valeur");List<String> h=i[k];if(h==null){h=new List<String>();h.add(m);i[k]=h;}else h.add(m);g=kD(g,"PARAMETRE");}La[j]=i;return (i);}HashMap<String,List<String>> eV(final l g){return (tR(g,"element",null));}HashMap<String,List<String>> tR(final l m,final String i,final String k){l g;if(i=="element")g=tK(cD(m));else if(i=="instruction"){g=null;l h=RC(aa(),"PLUGIN_INSTRUCTION");while(h!=null){if(k!=null&&k==h.getAttribute("cible")){g=h;break;}h=kD(h,"PLUGIN_INSTRUCTION");}}else if(i=="commentaire"){final l h=RC(aa(),"PLUGIN_COMMENTAIRE");if(h==null){g=null;}else{g=h;}}else g=null;if(g==null)return (new HashMap<String,List<String>>());if(La==null)La=new HashMap<l,HashMap<String,List<String>>>();HashMap<String,List<String>> j=La[g];if(j==null)j=fa(g);return (j);}List<String> UV(final l i){final Set<String> g=new LinkedHashSet<String>();List<String> m=Na.lM(i);if(m!=null)g.addAll(Na.lM(i));final l j=tK(cD(i));if(j!=null){l h=RC(j,"VALEUR_SUGGEREE");while(h!=null){final String k=ZG(h);if(k!=null)g.add(k);h=kD(h,"VALEUR_SUGGEREE");}}if(g.length==0)return (null);else return (g.toList());}List<String> zU(final l s,final l j){final Set<String> h=new LinkedHashSet<String>();List<String> k=Na.aP(j);if(k!=null)h.addAll(k);final l m=tK(cD(s));if(m!=null){final String v=attributeName(j);l g=RC(m,"AFFICHAGE_ATTRIBUT");while(g!=null){if(g.getAttribute("attribut")==v){l i=RC(g,"VALEUR_SUGGEREE");while(i!=null){final String o=ZG(i);if(o!=null)h.add(o);i=kD(i,"VALEUR_SUGGEREE");}}g=kD(g,"AFFICHAGE_ATTRIBUT");}}if(h.length==0)return (null);else return (h.toList());}List<l> ga(){final WE k=new WE();final List<l> i=new List<l>();final List<l> m=ha();for(final l g in m){final String h=g.getAttribute("langue");if(h!=""){WE j;if(g.getAttribute("pays")=="")j=new WE.WX(h);else j=new WE.bX(h,g.getAttribute("pays"));if(k==j&&!i.contains(g))i.add(g);}}for(final l g in m){final String h=g.getAttribute("langue");if(h!=""){final WE o=new WE.bX(k.language,k.uH);WE j;if(g.getAttribute("pays")=="")j=new WE.WX(h);else j=new WE.bX(h,g.getAttribute("pays"));if(o==j&&!i.contains(g))i.add(g);}}for(final l g in m){final String h=g.getAttribute("langue");if(h!=""){final WE o=new WE.WX(k.language);if(o==new WE.WX(h)&&!i.contains(g))i.add(g);}}for(final l g in m){if(!i.contains(g))i.add(g);}return (i);}String DI(final String h){final List<l> m=ga();for(final l j in m){l g=qP(j,"STRINGS_MENU");while(g!=null){if(h==g.getAttribute("menu")){final l i=RC(g,"TITRE");if(i!=null&&i.firstChild!=null){return (ZG(i));}break;}g=GN(j,g,"STRINGS_MENU");}}final l k=iG(h);if(k!=null)return (OD(k));return (h);}String MS(final String j){final List<l> k=ga();for(final l i in k){l g=qP(i,"STRINGS_MENU");while(g!=null){if(j==g.getAttribute("menu")){final l h=RC(g,"DOCUMENTATION");if(h!=null&&h.firstChild!=null){return (ZG(h));}break;}g=GN(i,g,"STRINGS_MENU");}}return (null);}HashMap<String,String> Xa(){HashMap<String,String> h=new HashMap<String,String>();final List<l> m=ga();for(final l o in m){l g=RC(o,"STRINGS_ELEMENT");while(g!=null){String i=g.getAttribute("element");if(h[i]==null){String k=i;final l j=RC(g,"TITRE");if(j!=null&&j.firstChild!=null)k=ZG(j);h[i]=k;}g=kD(g,"STRINGS_ELEMENT");}}return (h);}String OD(final l i){String g=null;g=Ia[i];if(g!=null)return (g);final String j=cD(i);if(j==null){pJ("Config.elementTitle : no name for ${i}");return (null);}final List<l> m=ga();for(final l o in m){if(g==null){l h=RC(o,"STRINGS_ELEMENT");while(h!=null){if(h.getAttribute("element")==j){final l k=RC(h,"TITRE");if(k!=null&&k.firstChild!=null){g=ZG(k);break;}break;}h=kD(h,"STRINGS_ELEMENT");}}}if(g==null||g=="")g=j;Ia[i]=g;return (g);}String wH(final l h){if(h==null)return (null);final String j=cD(h);final List<l> k=ga();for(final l m in k){l g=RC(m,"STRINGS_ELEMENT");while(g!=null){if(j==g.getAttribute("element")){final l i=RC(g,"DOCUMENTATION");if(i!=null&&i.firstChild!=null)return (ZG(i));break;}g=kD(g,"STRINGS_ELEMENT");}}return (Na.hO(h));}static String mT(final String h){String g=h;g=g.replaceAll("&","&amp;");g=g.replaceAll("<","&lt;");g=g.replaceAll(">","&gt;");g=g.replaceAll("\n","<br>");return (g);}String oK(final l k,final String i){final String m=cD(k);final List<l> o=ga();final String s=(new WE()).language;for(final l j in o){l h=RC(j,"STRINGS_ELEMENT");while(h!=null){if(h.getAttribute("element")==m){l g=RC(h,"TITRE_VALEUR");while(g!=null){if(g.getAttribute("valeur")==i&&g.firstChild!=null)return (ZG(g));g=kD(g,"TITRE_VALEUR");}break;}h=kD(h,"STRINGS_ELEMENT");}final String v=j.getAttribute("langue");if(v==s)return (i);}return (i);}String fK(final l k,final l m){final String s=cD(k);final String i=attributeName(m);final List<l> v=ga();for(final l BB in v){l g=RC(BB,"STRINGS_ELEMENT");while(g!=null){if(g.getAttribute("element")==s){l h=RC(g,"STRINGS_ATTRIBUT");while(h!=null){if(h.getAttribute("attribut")==i){final l j=RC(h,"TITRE");if(j!=null&&j.firstChild!=null)return (ZG(j));break;}h=kD(h,"STRINGS_ATTRIBUT");}}g=kD(g,"STRINGS_ELEMENT");}}final String o=NR(k,m);if(o!=null)return ("${o}:${i}");return (i);}String gK(final l m,final l o,final String j){final String s=cD(m);final String v=attributeName(o);final List<l> BB=ga();final String EB=(new WE()).language;for(final l k in BB){l h=RC(k,"STRINGS_ELEMENT");while(h!=null){if(h.getAttribute("element")==s){l i=RC(h,"STRINGS_ATTRIBUT");while(i!=null){if(i.getAttribute("attribut")==v){l g=RC(i,"TITRE_VALEUR");while(g!=null){if(g.getAttribute("valeur")==j&&g.firstChild!=null)return (ZG(g));g=kD(g,"TITRE_VALEUR");}break;}i=kD(i,"STRINGS_ATTRIBUT");}}h=kD(h,"STRINGS_ELEMENT");}final String HB=k.getAttribute("langue");if(HB==EB)return (j);}return (j);}String vG(final l k,final l j){final String m=cD(k);final String o=attributeName(j);final List<l> s=ga();for(final l v in s){l g=RC(v,"STRINGS_ELEMENT");while(g!=null){if(g.getAttribute("element")==m){l h=RC(g,"STRINGS_ATTRIBUT");while(h!=null){if(h.getAttribute("attribut")==o){final l i=RC(h,"DOCUMENTATION");if(i!=null&&i.firstChild!=null)return (ZG(i));break;}h=kD(h,"STRINGS_ATTRIBUT");}}g=kD(g,"STRINGS_ELEMENT");}}return (Na.vG(j));}static String ZG(final AB i){final AB g=i.firstChild;if(g==null)return (null);final String h=g.nodeValue;if(h==null)return (null);return (h.trim());}l Wa(){if(Oa==null){Oa=RC(Ea,"LANGAGE");}return Oa;}l ba(){if(Pa==null){Pa=RC(Ea,"ENREGISTREMENT");if(Pa==null){Pa=Ea.ownerDocument.createElement("ENREGISTREMENT");}}return Pa;}l da(){if(Qa==null){Qa=RC(Ea,"MENUS");if(Qa==null){Qa=Ea.ownerDocument.createElement("MENUS");}}return Qa;}l aa(){if(Ra==null){Ra=RC(Ea,"AFFICHAGE_NOEUDS");if(Ra==null){Ra=Ea.ownerDocument.createElement("AFFICHAGE_NOEUDS");}}return Ra;}List<l> ha(){if(Ta==null){Ta=new List<l>();AB g=Ea.firstChild;while(g!=null){if(g.nodeType==AB.FE&&g.nodeName=="STRINGS"){Ta.add(g as l);}g=g.nextSibling;}}return Ta;}static l RC(final AB g,final String h){final AB i=g.firstChild;return pP(i,h);}static l kD(final AB g,final String h){final AB i=g.nextSibling;return pP(i,h);}static l pP(AB g,final String h){if(h==null)return null;while(g!=null){if(g.nodeType==AB.FE&&h==g.nodeName){return g as l;}g=g.nextSibling;}return null;}static l qP(final AB g,final String h){return GN(g,g,h);}static l GN(final AB i,final AB j,final String k){AB g=j;AB h;while(g!=null){if(g.hasChildNodes()){g=(g.firstChild);}else if(g!=i&&null!=(h=g.nextSibling)){g=h;}else{h=null;while(g!=i){h=g.nextSibling;if(h!=null)break;g=g.parentNode;}g=h;}if(g!=i&&g!=null&&g.nodeType==AB.FE&&g.nodeName==k){return g as l;}}return null;}static void pJ(String g,[Exception h]){if(h!=null)print("Config: ${g}: ${h}");else print("Config: ${g}");}}class AN{static const int QT=400;GH ia;q selectionStart;q selectionEnd;zF yF;uB LI;uB FI;WB FF;Point eO;OI toolbar;yM ja;q ZM;DateTime BP;bool sI;AN(){ia=new GH();ja=new yM();ZM=null;BP=null;sI=false;}Future GP(String i){Completer g=new Completer();t.GP(i).then((m){ka();yE();ja.SP();document.title=LB.MB('page.new_document');g.complete();},onError:(CD j){Element k=document.getElementById('doc2');String h="Error creating the new document: ${j}";k.text=h;g.completeError(h);});return (g.future);}Future KP(String h,String j,{bool removeIndents: true}){Completer g=new Completer();t.KP(h,j).then((o){ka();yE();ja.VP();t.rC.YO();document.title=h.split('/').last;g.complete();},onError:(CD k){Element m=document.getElementById('doc2');String i="Error reading the document: ${k}";m.text=i;g.completeError(i);});return (g.future);}void yE(){Element h=document.getElementById('doc2');h.children.clear();document.body.insertBefore(ja.html(),document.getElementById('doc1'));SO();window.onResize.listen((Event g)=>SO());Element j=t.html();h.append(j);q k=new q(t.rC,0);ia.moveTo(k);LC();h.onMouseDown.listen((MouseEvent g)=>onMouseDown(g));h.onMouseMove.listen((MouseEvent g)=>onMouseMove(g));h.onMouseUp.listen((MouseEvent g)=>onMouseUp(g));h.onContextMenu.listen((MouseEvent g)=>onContextMenu(g));document.getElementById('doc1').onScroll.listen((Event g)=>onScroll(g));document.onMouseUp.listen((MouseEvent g){if(FF!=null){Element i=FF.vK();if(i.scrollHeight>i.clientHeight&&g.target==i&&g.client.x>i.offsetLeft+i.clientWidth)return;if(g.client!=eO)TR();g.preventDefault();}});}void SO(){Element h=document.getElementById('headers');num i=h.getBoundingClientRect().bottom;String g=(i.round()+2).toString()+"px";document.getElementById('left_panel').style.top=g;document.getElementById('doc1').style.top=g;}void ka(){yF=t.CB.DW(t);WB i=new WB(LB.MB('menu.file'));i.parent=yF;uB g;if(t.CL!=null){g=new uB(LB.MB('menu.save'),()=>save(),shortcut:'S');i.add(g);}g=new uB(LB.MB('menu.source'),()=>oW());i.add(g);g=new uB(LB.MB('menu.validation'),()=>(new PT()).show());i.add(g);yF.insert(i,0);WB h=new WB(LB.MB('menu.edit'));h.parent=yF;LI=new uB(LB.MB('undo.undo'),()=>t.aH(),shortcut:'Z');LI.enabled=false;h.add(LI);FI=new uB(LB.MB('undo.redo'),()=>t.dM(),shortcut:'Y');FI.enabled=false;h.add(FI);h.add(new uB(LB.MB('menu.select_all'),()=>RP(),shortcut:'A'));uB o=new uB(LB.MB('find.find_replace'),()=>(new jP()).show(),shortcut:'F');h.add(o);yF.insert(h,1);Element m=document.getElementById('headers');m.append(yF.html());toolbar=new OI(t.CB);m.append(toolbar.html());HashMap<String,DD> j=new HashMap<String,DD>();for(MC k in toolbar.HG)if(k.shortcut!=null)j[k.shortcut]=k.action;for(WB s in yF.VH){MR(s,j);}ia.kW(j);}MR(WB i,HashMap<String,DD> h){for(uB g in i.items){if(g.shortcut!=null&&g.action!=null)h[g.shortcut]=g.action;if(g is WB)MR(g,h);}}void onMouseDown(MouseEvent g){if(FF!=null)TR();if(g.target is ImageElement||g.target is ButtonElement||g.target is TextInputElement||g.target is SelectElement)return;Element h=g.target;while(h is Element&&!h.classes.contains('dn')){h=h.parent;}if(h!=null&&h.attributes['contenteditable']=='true')return;if(g.button==1)return;g.preventDefault();if(g.button==2){return;}if(g.shiftKey){selectionStart=new q.qX(ia.selectionStart);selectionEnd=GH.oJ(g);if(selectionEnd!=null)ia.gE(selectionStart,selectionEnd);}else{selectionStart=GH.oJ(g);if(selectionStart!=null&&ZM==selectionStart&&BP.difference(new DateTime.now()).inMilliseconds.abs()<QT&&selectionStart.u.nodeType!=n.tC){List<q> i=la(selectionStart);selectionStart=i[0];selectionEnd=i[1];ia.gE(selectionStart,selectionEnd);sI=true;}}}void onMouseMove(MouseEvent h){if(selectionStart==null)return;if(FF!=null)return;q g=GH.oJ(h);if(sI){if(selectionEnd>selectionStart&&g<=selectionStart)selectionStart=selectionEnd;else if(selectionEnd<selectionStart&&g>=selectionStart)selectionStart=selectionEnd;}selectionEnd=g;if(selectionStart!=null&&selectionEnd!=null){if(sI&&selectionEnd.u.nodeType!=n.tC){List<q> i=la(selectionEnd);if(selectionEnd>selectionStart)selectionEnd=i[1];else selectionEnd=i[0];}ia.gE(selectionStart,selectionEnd);}h.preventDefault();}List<q> la(q g){List<q> j=new List<q>();String k=g.u.nodeValue;int h=g.KB;int i=g.KB;String m=' \n,;:.?!/()[]{}';while(h>0&&m.indexOf(k[h-1])==-1)h-- ;while(i<k.length&&m.indexOf(k[i])==-1)i++ ;j.add(new q(g.u,h));j.add(new q(g.u,i));return (j);}void onMouseUp(MouseEvent g){if(!sI)selectionEnd=GH.oJ(g);ZM=null;if(selectionStart!=null&&selectionEnd!=null){if(!sI)ia.gE(selectionStart,selectionEnd);if(selectionStart==selectionEnd){ZM=selectionStart;BP=new DateTime.now();}}selectionStart=null;selectionEnd=null;sI=false;g.preventDefault();}void onContextMenu(MouseEvent h){if(h.shiftKey)return;q g=GH.oJ(h);if(g!=null){h.preventDefault();if(ia.selectionStart==null||ia.selectionEnd==null||(g<ia.selectionStart&&g<ia.selectionEnd)||(g>ia.selectionStart&&g>ia.selectionEnd)){ia.gE(g,g);}if(ia.selectionStart!=null)nW(h);}}void onScroll(Event g){ia.bH(false);}void nW(MouseEvent EB){if(t.CB==null||ia.selectionStart.u==null)return;eO=EB.client;n h;if(ia.selectionStart.u is OB)h=ia.selectionStart.u.parent;else h=ia.selectionStart.u;List<l> QB=t.lO(h);List<l> SB=t.dP(QB);FF=new WB(null);bool o=false;if(h.DB!=null){String k=t.CB.DI(h.nodeName);String i="${LB.MB('contextual.select_element')} ${k}";FF.add(new uB(i,()=>selectNode(h)));List<l> m=t.CB.fE(h.DB);if(m!=null&&m.length>0){i="${LB.MB('contextual.edit_attributes')} ${k}";FF.add(new uB(i,()=>h.JE()));}i="${LB.MB('contextual.help_about_element')} ${k}";FF.add(new uB(i,()=>(new XG.VX(h.DB)).show()));o=true;}if(t.vO!=null){n j=h;while(j!=null&&j is!xI)j=j.parent;if(j!=null){if(o)FF.RO();String k=t.CB.DI(j.nodeName);List<l> m=t.CB.fE(j.DB);if(m!=null&&m.length>0){String i="${LB.MB('contextual.edit_attributes')} ${k}";FF.add(new uB(i,()=>j.JE()));}FF.add(new uB(LB.MB('div.remove'),()=>(j as xI).TW()));o=true;}}List<l> s;if(toolbar!=null)s=toolbar.dR();else s=null;bool HB=true;for(l v in SB){if(s!=null&&s.contains(v))continue;if(t.ZC!=null&&t.ZC.contains(v))continue;if(HB&&o)FF.RO();HB=false;String cB=t.CB.cD(v);String i=t.CB.DI(cB);uB hB=new uB(i,()=>t.CI(v,'element'));FF.add(hB);}DivElement g=FF.VM();g.style.position='fixed';g.style.display='block';int BB=EB.client.x;int JB=EB.client.y;g.style.left="${BB}px";g.style.top="${JB}px";g.style.maxHeight="${window.innerHeight-JB}px";g.style.overflowY='auto';document.body.append(g);if(g.scrollHeight>g.clientHeight)g.style.paddingRight="${g.offsetWidth-g.clientWidth}px";if(BB+g.offsetWidth>window.innerWidth){BB=window.innerWidth-g.offsetWidth;g.style.left="${BB}px";}}void TR(){DivElement g=FF.vK();g.remove();FF=null;eO=null;}GH get cursor{return (ia);}q vC(){return (ia.selectionStart);}q GF(){return (ia.selectionEnd);}void KD(q g){ia.moveTo(g);}void AH(){ia.focus();}void YS(n g){q j=new q(g.parent,g.parent.ZB(g));HD h=j.jF();if(h==null)return;DivElement i=document.getElementById('doc1');int k=i.offset.top;i.scrollTop+= h.y.toInt()-k-10;}void selectNode(n g){int h=g.parent.ZB(g);q i=new q(g.parent,h);q j=new q(g.parent,h+1);ia.moveTo(i);ia.gE(i,j);LC();}void RP(){ia.gE(new q(t.rC,0),new q(t.rC,t.rC.PB));}void LC(){if(ia.selectionStart==null)return;n g=ia.selectionStart.u;if(g is OB)g=g.parent;List<l> h=t.lO(g);List<l> i=t.dP(h);ja.update(g,h,i);wW(g,i);xW();}void wW(n h,List<l> g){List<WB> i=yF.VH;for(WB j in i){ma(j,g);}if(toolbar!=null)toolbar.update(h,g);}void ma(WB m,List<l> i){for(uB g in m.items){if(g is WB){ma(g,i);}else if(g.data is l){l j=g.data;String o=t.CB.cD(j);bool k=false;for(l h in i){if(t.CB.cD(h)==o){k=true;if(h!=j){g.data=h;g.action=()=>t.CI(h,'element');}break;}}if(k)g.enable();else g.disable();}}}void xW(){Element g=document.getElementById('path');if(ia.selectionStart==null)g.text="";else g.text=ia.selectionStart.MI(titles:true);}void KL(){if(t.FS()){if(!LI.enabled)LI.enable();}else{if(LI.enabled)LI.disable();}if(t.ES()){if(!FI.enabled)FI.enable();}else{if(FI.enabled)FI.disable();}LI.title=t.xR();FI.title=t.vR();if(toolbar!=null){for(MC g in toolbar.HG){if(g.data=="undo"){if(t.FS())g.enable();else g.disable();g.title=t.xR();}else if(g.data=="redo"){if(t.ES())g.enable();else g.disable();g.title=t.vR();}}}}void save(){t.cW().then((h){window.alert(LB.MB('save.success'));},onError:(CD g){window.alert(LB.MB('save.error')+': '+g.message);});}void oW(){(new OT()).show();}}abstract class n{static const int tC=1;static const int nB=3;static const int YG=9;static const String ST='GRAS';static const String TT='ITALIQUE';static const String UT='EXPOSANT';static const String VT='INDICE';static const String WT='SOULIGNE';static const String XT='BARRE';static const String YT='FCOULEUR';static const String ZT='PCOULEUR';static const String aT="^.*\\[(x[0-9a-fA-F]{2}|[0-9]{1,3}),(x[0-9a-fA-F]{2}|[0-9]{1,3}),(x[0-9a-fA-F]{2}|[0-9]{1,3})\\]\$";l DB;String na;n parent;int nodeType;String oa;String EC;String localName;String nodeValue;n firstChild;n nextSibling;List<aB> attributes;bool dJ=false;bool nM=false;bool valid;n.rX(AB g,n h,{bool createChildren: true}){na=t.bM(this);this.parent=h;if(g.nodeType==AB.FE||g.nodeType==AB.kE||g.nodeType==AB.FK)nodeType=g.nodeType;else nodeType=tC;oa=g.qB;EC=g.EC;if(g.nodeType==AB.CK)localName=g.nodeName;else if(g.nodeType==AB.BK)localName='#cdata-section';else if(g.nodeType==AB.DK)localName='#comment';else if(g.nodeType==AB.FK)localName='#document';else localName=g.localName;if(nodeType==n.nB)nodeValue=g.nodeValue;attributes=new List<aB>();LinkedHashMap<String,lC> m=g.attributes;if(m!=null){for(AB i in m.values){attributes.add(new aB.TX(i));}}if(g is l){DB=t.CB.UM(g,h==null?null:h.DB);if(DB==null&&h!=null){DB=t.CB.iG(localName);}}if(createChildren){if(g.childNodes!=null){n j=null;for(AB i in g.childNodes){n k=ND.fH(i,this);if(j==null)firstChild=k;else j.nextSibling=k;j=k;}}else if((g.nodeType==AB.BK||g.nodeType==AB.CK||g.nodeType==AB.DK)&&g.nodeValue!=null&&g.nodeValue!=''){jB(new OB(g.nodeValue));}}if(nodeType==n.tC)valid=t.CB.iO(this);else valid=true;}n.wX(l g){DB=g;na=t.bM(this);parent=null;nodeType=tC;oa=t.CB.kI(DB);EC=t.CB.PM(DB);localName=t.CB.cD(DB);nodeValue=null;firstChild=null;nextSibling=null;attributes=new List<aB>();valid=true;}n.xX(int g){DB=null;na=t.bM(this);parent=null;this.nodeType=g;oa=null;EC=null;localName=null;nodeValue=null;firstChild=null;nextSibling=null;attributes=new List<aB>();valid=true;}n.yX(String g){na=t.bM(this);parent=null;nodeType=n.nB;oa=null;this.EC=null;this.localName=null;nodeValue=g;firstChild=null;nextSibling=null;attributes=null;valid=true;}factory n.zX(n g){kH i=new yJ();sB j=i.createDocument(null,null,null);AB k=g.KF(j);n h=ND.fH(k,g.parent);h.parent=null;return (h);}String get id{return (na);}Element pB(){return (document.getElementById(na));}Element dD(){Element g=pB();if(g!=null&&!g.nodes.isEmpty&&g.firstChild is Element)g=g.firstChild;return (g);}String get nodeName{if(nodeType==nB)return ('#text');StringBuffer g=new StringBuffer();if(EC!=null){g.write(EC);g.write(":");}g.write(localName);return (g.toString());}String get qB{return (oa);}int get PB{if(nodeType==nB)return (nodeValue.length);int h=0;for(n g=firstChild;g!=null;g=g.nextSibling)h++ ;return (h);}bool get FD{return (false);}bool get eC{if(RE())return (true);Element g=pB();return (g is DivElement||g is TableElement||g is UListElement);}List<n> get childNodes{List<n> h=new List<n>();for(n g=firstChild;g!=null;g=g.nextSibling){h.add(g);}return (h);}n get previousSibling{if(parent==null)return (null);for(n g=parent.firstChild;g!=null;g=g.nextSibling){if(g.nextSibling==this)return (g);}return (null);}n get lastChild{for(n g=firstChild;g!=null;g=g.nextSibling){if(g.nextSibling==null)return (g);}return (null);}n eB(int i){assert(nodeType!=nB);int h=0;for(n g=firstChild;g!=null;g=g.nextSibling){if(h==i)return (g);h++ ;}return (null);}n nextNode(){if(firstChild!=null)return (firstChild);if(nextSibling!=null)return (nextSibling);n g=parent;while(g!=null){if(g.nextSibling!=null)return (g.nextSibling);g=g.parent;}return (null);}n previousNode(){if(firstChild!=null)return (lastChild);if(previousSibling!=null)return (previousSibling);n g=parent;while(g!=null){if(g.previousSibling!=null)return (g.previousSibling);g=g.parent;}return (null);}int ZB(n i){int h=0;for(n g=firstChild;g!=null;g=g.nextSibling){if(g==i)return (h);h++ ;}assert(false);return (-1);}String getAttribute(String h){for(aB g in attributes){if(g.localName==h)return (g.value);}return (null);}String getAttributeNS(String h,String i){if(attributes==null)return (null);for(aB g in attributes){if(g.qB==h&&g.localName==i)return (g.value);}return (null);}void setAttribute(String g,String h){for(aB i in attributes){if(i.localName==g){i.value=h;return;}}attributes.add(new aB(g,h));return;}void setAttributeNS(String m,String g,String o){String i,j;int k=g.indexOf(":");if(k!=-1){i=g.substring(0,k);j=g.substring(k+1);}else{i=null;j=g;}aB h=SM(m,j);if(h!=null){h.EC=i;h.value=o;return;}h=new aB.dX(m,g,o);attributes.add(h);}aB RM(String h){for(aB g in attributes){if(g.localName==h)return (g);}return (null);}aB SM(String h,String i){if(attributes==null)return (null);for(aB g in attributes){if(g.qB==h&&g.localName==i){return (g);}}return (null);}LinkedHashMap<String,aB> gR(){LinkedHashMap<String,aB> g=new LinkedHashMap<String,aB>();for(aB h in attributes)g[h.name]=new aB.jX(h);return (g);}Element html();void sD(){Element g=pB();if(g==null)return;Element h=html();g.replaceWith(h);}void BF(List<n> o){List<n> s=childNodes;for(n g in o){Element m=g.pB();if(!s.contains(g)){if(m!=null)m.remove();else{sD();return;}}else if(m==null){n j=g.nextSibling;Node i=null;while(i==null&&j!=null){i=j.pB();if(i==null)j=j.nextSibling;}n k=g.previousSibling;Node h=null;while(h==null&&k!=null){h=k.pB();if(h==null)k=k.previousSibling;}if(i!=null){i.parent.insertBefore(g.html(),i);}else if(h!=null){if(h.nextNode!=null)h.parent.insertBefore(g.html(),h.nextNode);else h.parent.append(g.html());}else{sD();return;}}else{g.sD();}}}void vI(){sD();}void FL(bool h){Element g=pB();if(g==null)return;if(h)g.classes.add('selected');else g.classes.remove('selected');}void jB(n g){n h=lastChild;if(h!=null)h.nextSibling=g;else firstChild=g;g.parent=this;}void insertBefore(n h,n i){assert(i==null||this==i.parent);h.parent=this;n g=firstChild;if(g==i){n j=firstChild;firstChild=h;h.nextSibling=j;}else{while(g!=null&&g.nextSibling!=i){g=g.nextSibling;}assert(g!=null);assert(g.nextSibling==i);n j=g.nextSibling;g.nextSibling=h;h.nextSibling=j;}}void insertAfter(n h,n g){assert(this==g.parent);if(g.nextSibling==null)jB(h);else insertBefore(h,g.nextSibling);}void gC(n g){if(g.previousSibling!=null)g.previousSibling.nextSibling=g.nextSibling;if(g==firstChild)firstChild=g.nextSibling;g.parent=null;g.nextSibling=null;}void replaceWith(n g){if(parent.firstChild==this)parent.firstChild=g;else previousSibling.nextSibling=g;g.parent=parent;g.nextSibling=nextSibling;parent=null;nextSibling=null;}void normalize(){for(n g=firstChild;g!=null;g=g.nextSibling){while(g.nodeType==nB&&g.nextSibling!=null&&g.nextSibling.nodeType==nB){g.nodeValue="${g.nodeValue}${g.nextSibling.nodeValue}";gC(g.nextSibling);}}}void remove(q g,int h){if(nodeType==tC){for(int i=g.KB;i<h;i++ ){gC(eB(g.KB));}}else{String j=nodeValue;String k=j.substring(0,g.KB);String m=j.substring(g.KB+h);nodeValue="${k}${m}";}}bool RE(){return (false);}bool RG(){return (false);}void NG(){if(RG()&&firstChild!=null&&firstChild is OB){String g=firstChild.nodeValue;if(g.startsWith('\n')){if(g.length==1)gC(firstChild);else firstChild.nodeValue=g.substring(1);}}n i=lastChild;while(i!=null&&i is OB)i=i.previousSibling;if(RG()&&lastChild is OB&&(i==null||!i.RE())){String g=lastChild.nodeValue;if(g.endsWith('\n')){if(g.length==1)gC(lastChild);else lastChild.nodeValue=g.substring(0,g.length-1);}}for(n h=firstChild;h!=null;h=h.nextSibling){if(h.RE()&&h.nextSibling is OB){String g=h.nextSibling.nodeValue;if(g.startsWith('\n')){if(g.length==1)gC(h.nextSibling);else h.nextSibling.nodeValue=g.substring(1);}}}}AB KF(sB i){assert(nodeType==tC);l g=i.createElementNS(qB,nodeName);for(aB k in attributes)g.setAttributeNS(k.qB,k.name,k.value);if(RG()||firstChild!=null){if(RG())g.jB(i.wG('\n'));for(n j=firstChild;j!=null;j=j.nextSibling){g.jB(j.KF(i));if(j.RE())g.jB(i.wG('\n'));}n h=lastChild;while(h!=null&&h is OB)h=h.previousSibling;if(RG()&&lastChild!=null&&(h==null||!h.RE()))g.jB(i.wG('\n'));}return (g);}String toString(){kH g=new yJ();sB h=g.createDocument(null,null,null);AB i=KF(h);return (i.toString());}static String kT(String g){g=g.replaceAll('&','&amp;');g=g.replaceAll('"','&quot;');g=g.replaceAll('<','&lt;');g=g.replaceAll('>','&gt;');return (g);}void lF(){valid=t.CB.iO(this);Element g=pB();if(g==null)return;if(valid&&g.classes.contains('invalid'))g.classes.remove('invalid');else if(!valid&&!g.classes.contains('invalid'))g.classes.add('invalid');}void cM(DD g){if(DB!=null&&t.CB.fE(DB).length>0)JE(()=>g());else g();}void JE([DD h]){if(DB!=null){vM g=new vM(this,h);g.show();}else{zM g=new zM(this,h);g.show();}}q zG(num CC,num BB){q QD=new q(this,0);if(nodeType==tC||nodeType==YG){for(n QB=firstChild;QB!=null;QB=QB.nextSibling){Element g=QB.pB();if(g==null)continue;double SB,EB,HB,JB;double cB,hB;if(g is DivElement&&g.nodes.length>0&&g.firstChild is SpanElement&&(g.firstChild as SpanElement).classes.contains('start_tag')&&g.lastChild is SpanElement&&(g.lastChild as SpanElement).classes.contains('end_tag')){Element i=g.firstChild;Rectangle h=i.getBoundingClientRect();SB=h.left;EB=h.top;cB=i.offset.height.toDouble();i=g.lastChild;h=i.getBoundingClientRect();HB=h.right;JB=h.bottom;hB=i.offset.height.toDouble();}else if(g is DivElement||g is TableCellElement||g is TableRowElement||g is TableElement||g is ImageElement||g.classes.contains('form')){Rectangle h=g.getBoundingClientRect();SB=h.left;EB=h.top;if(g.classes.contains('form'))HB=g.querySelector('table').getBoundingClientRect().right;else HB=h.right;JB=h.bottom;cB=hB=h.height;}else if(g is SpanElement&&g.nodes.length==1&&g.firstChild is Text&&!g.firstChild.nodeValue.endsWith('\n')){List<Rectangle> k=g.getClientRects();if(k.length==0)return (null);Rectangle h=k.first;SB=h.left;EB=h.top;cB=h.height*1.4;h=k.last;HB=h.right;JB=h.bottom;hB=h.height*1.4;}else if(g.firstChild is Element&&g.lastChild is SpanElement&&g.lastChild.lastChild is Text&&!g.lastChild.lastChild.nodeValue.endsWith('\n')){Element i=g.firstChild;List<Rectangle> k=i.getClientRects();if(k.length==0)return (null);Rectangle h=k.first;SB=h.left;EB=h.top;cB=h.height*1.3;i=g.lastChild;k=i.getClientRects();if(k.length==0)return (null);h=k.last;HB=h.right;JB=h.bottom;hB=h.height*1.3;}else{Element i=new Element.tag('span');i.append(new Text("|"));if(g.nodes.length==1&&g.firstChild is BRElement){g.append(i);Rectangle h=i.getBoundingClientRect();SB=-1.0;EB=h.top;cB=hB=i.offset.height.toDouble()*1.4;HB=-1.0;JB=h.bottom;i.remove();}else{if(g.nodes.isEmpty)g.append(i);else g.insertBefore(i,g.firstChild);Rectangle h=i.getBoundingClientRect();SB=h.left;EB=h.top;cB=i.offset.height.toDouble()*1.4;i.remove();if(g is LIElement){Node m=g;while(m.firstChild!=null&&(m.lastChild is!Text||(m.lastChild.nodeValue=='\n'&&m.lastChild.previousNode!=null))&&m.lastChild is!ImageElement){if(m.lastChild is Text&&m.lastChild.nodeValue=='\n'&&m.lastChild.previousNode!=null)m=m.lastChild.previousNode;else m=m.lastChild;}m.append(i);}else g.append(i);h=i.getBoundingClientRect();HB=h.left;JB=h.bottom;hB=i.offset.height.toDouble()*1.4;i.remove();}}if((BB<EB+cB&&(BB<EB-1||(CC<SB+1&&g is!LIElement&&QB is!kB)))){return (QD);}if(BB>JB-hB&&(BB>JB+1||(CC>HB-1&&g is!LIElement))){QD=new q(this,ZB(QB)+1);}else{QD=QB.zG(CC,BB);return (QD);}}}else if(nodeType==nB){int o=0;for(Node g in pB().nodes){Text v;if(g is Text)v=g;else if(g is Element)v=g.firstChild;else continue;Range IC=new Range();for(int j=0;j<v.length;j++ ){if(nodeValue[o+j]!='\n'){IC.setStart(v,j);IC.setEnd(v,j+1);List<Rectangle> k=IC.getClientRects();for(Rectangle s in k){if(window.navigator.appVersion.contains("Trident")&&o+j+1<nodeValue.length&&nodeValue[o+j+1]=='\n'&&s.width==0){continue;}if(j<nodeValue.length-1&&s.left==s.right&&CC<s.left&&BB<s.bottom){return (new q(this,o+j+1));}if(CC<s.right&&BB<=s.bottom){if(CC<(s.left+s.right)/2)return (new q(this,o+j));else return (new q(this,o+j+1));}else if(BB<s.top-5){if(o+j==0||nodeValue[o+j]==' ')return (new q(this,o+j));else return (new q(this,o+j-1));}}}else{String tD=v.text;v.text="${tD.substring(0,j)}|${tD.substring(j)}";IC.setStart(v,j);IC.setEnd(v,j+1);List<Rectangle> k=IC.getClientRects();v.text=tD;if(window.navigator.appVersion.contains("Trident")){if(BB<=k.first.bottom){return (new q(this,o+j));}}else{for(Rectangle s in k){if(BB<=s.bottom){return (new q(this,o+j));}}}}}o+= v.length;}}return (new q(this,PB));}q QE(){return (new q(this,0));}q SF(){return (new q(this,PB));}void iM(Element g){String j=t.CB.bC(DB,'style',null);if(j!=null){List<String> m=j.split(';');for(String h in m){if(h==ST){g.style.fontWeight='bold';}else if(h==TT){g.style.fontStyle='italic';}else if(h==UT){g.style.verticalAlign='super';g.style.fontSize='80%';}else if(h==VT){g.style.verticalAlign='sub';g.style.fontSize='80%';}else if(h==WT){g.style.textDecoration='underline';}else if(h==XT){g.style.textDecoration='line-through';}else if(h.startsWith(YT)){g.style.background=pa(h);}else if(h.startsWith(ZT)){g.style.color=pa(h);}}}String i=t.CB.bC(DB,'police',null);if(i!=null){if(i=='Monospaced')i='monospace';g.style.fontFamily=i;}String k=t.CB.bC(DB,'taille',null);if(k!=null){g.style.fontSize=k;}}String pa(String j){Iterable<Match> k=aT.allMatches(j);for(Match m in k){final List<int> g=new List<int>();for(int h=0;h<3;h++ ){String i=m.group(h+1);if(i.startsWith("x"))g[h]=int.parse(i.substring(1),radix:16);else g[h]=int.parse(i);}return ("rgb(${g[0]}, ${g[1]}, ${g[2]})");}return (null);}void YO(){TO();for(n g=firstChild;g!=null;g=g.nextSibling){g.YO();}}void PR(){DV();for(n g=firstChild;g!=null;g=g.nextSibling){g.PR();}}void TO(){}void DV(){}bool get PS{return false;}}class dC implements q{n sZ;int qa;dC(n g,int h){assert(g!=null);assert(h>=0);sZ=g;qa=h;}dC.cX(CE g){sZ=t.rC;qa=0;PG(g.HF);}dC.gX(vD g){sZ=t.rC;qa=sZ.PB;PG(-g.UF);}n get u{return (sZ);}int get KB{return (qa);}int get HF{CE g=new CE.YX(this);return (g.HF);}int get UF{vD g=new vD.ZX(this);return (g.UF);}bool operator==(q g){dC h;if(g is dC)h=g;else if(g is CE)h=new dC.cX(g);else if(g is vD)h=new dC.gX(g);return (sZ==h.sZ&&qa==h.qa);}bool operator<(q i){dC j;if(i is dC)j=i;else if(i is CE)j=new dC.cX(i);else if(i is vD)j=new dC.gX(i);n o=null;n g=sZ;double k=qa.toDouble();while(g!=null){n h=j.sZ;double m=j.qa.toDouble();while(h!=null){if(g==h){return (k<m);}if(h.parent==null)break;m=h.parent.ZB(h)+0.5;h=h.parent;}if(g.parent==null)break;k=g.parent.ZB(g)+0.5;g=g.parent;}assert(false);return (false);}bool operator<=(q g){return (this<g||this==g);}bool operator>(q g){return (!(this==g||this<g));}bool operator>=(q g){return (this>g||this==g);}void PG(int h){if(h>0){int g=h;while(g>0){if(qa==sZ.PB){qa=sZ.parent.ZB(sZ)+1;sZ=sZ.parent;}else if(sZ is OB){qa++ ;}else{sZ=sZ.eB(qa);qa=0;}g-- ;}}else if(h<0){int g=h;while(g<0){if(qa==0){qa=sZ.parent.ZB(sZ);sZ=sZ.parent;}else if(sZ is OB){qa-- ;}else{sZ=sZ.eB(qa-1);qa=sZ.PB;}g++ ;}}}void zE(){if(sZ.nodeType==n.tC&&qa>0&&sZ.eB(qa-1).nodeType==n.nB){sZ=sZ.eB(qa-1);qa=sZ.PB;}else if(sZ.nodeType==n.tC&&qa<sZ.PB&&sZ.eB(qa).nodeType==n.nB){sZ=sZ.eB(qa);qa=0;}else if(qa==0&&sZ.firstChild!=null&&sZ.firstChild.nodeType==n.nB){sZ=sZ.firstChild;}}HD jF(){if(sZ.nodeType==n.nB){Element o=sZ.dD();if(o==null||o.nodes.length==0)return (null);assert(o.nodes.first is Text);Text h=o.nodes.first;int i=qa;String k=h.text;assert(k.length!=0);Range j=new Range();HD v;if(i==0){j.setStart(h,i);j.setEnd(h,k.length);Rectangle g=j.getClientRects().first;v=new HD(g.left,g.top);}else if(k[i-1]=='\n'||k[i-1]==' '){if(i==k.length){if(sZ.nextSibling!=null&&sZ.nextSibling.nodeType==n.tC&&(k[i-1]=='\n'||!sZ.nextSibling.eC)){Rectangle g=(sZ.nextSibling.pB()).getClientRects()[0];v=new HD(g.left,g.top);}else if(k[i-1]==' '){j.setStart(h,0);j.setEnd(h,i);Rectangle g=j.getClientRects().last;v=new HD(g.right,g.top);}else{SpanElement BB=new SpanElement();BB.appendText("|");if(h.nextNode==null)o.append(BB);else o.insertBefore(BB,h.nextNode);Rectangle g=BB.getClientRects()[0];v=new HD(g.left,g.top);BB.remove();}}else{j.setStart(h,i);j.setEnd(h,i+1);List<Rectangle> m=j.getClientRects();Rectangle g;if(k[i-1]==' '&&i<k.length&&k[i]=='\n'){if(window.navigator.appVersion.contains("Trident")){j.setStart(h,i-1);j.setEnd(h,i);m=j.getClientRects();g=m.first;g=new Rectangle(g.left+7,g.top,g.width,g.height);}else g=m.first;}else if(k[i]=='\n'&&m.length==3)g=m[1];else if((window.navigator.userAgent.toLowerCase().indexOf('msie')>=0||window.navigator.appVersion.contains("Trident"))&&k[i-1]=='\n'&&k[i]=='\n'&&m.length==2)g=m.first;else{g=m.last;for(Rectangle QB in m)if(QB.width>1){g=QB;break;}}v=new HD(g.left,g.top);}}else{Rectangle g;if(window.navigator.appVersion.contains("Trident")&&i<k.length&&k[i]=='\n'){j.setStart(h,i-1);j.setEnd(h,i);g=j.getClientRects().first;}else{j.setStart(h,0);j.setEnd(h,i);g=j.getClientRects().last;}v=new HD(g.right,g.top);}return (v);}else{List<n> s=sZ.childNodes;if(s!=null&&qa>0&&qa==s.length){Element h=s[qa-1].pB();if(h==null)return (null);Rectangle g;if(h is ImageElement||h is TableRowElement){g=h.getBoundingClientRect();return (new HD(g.right,g.top));}else if(h is DivElement||h is TableElement||h is UListElement||h is LIElement){g=h.getBoundingClientRect();return (new HD(g.left,g.bottom));}else{List<Rectangle> m=h.getClientRects();if(m.length==0)return (null);Rectangle g=m.last;return (new HD(g.right,g.top));}}else if(s!=null&&qa<s.length){Element o=s[qa].pB();if(o==null)return (null);if(qa>0){n JB=s[qa-1];n SB=s[qa];Element cB=JB.pB();Element hB=o;if(JB.eC&&!SB.eC){List<Rectangle> CC=hB.getClientRects();if(CC.length==0)return (null);Rectangle EB=CC.first;return (new HD(EB.left,EB.top));}else if(JB.eC&&SB.eC){Rectangle HB=cB.getBoundingClientRect();Rectangle EB=hB.getBoundingClientRect();return (new HD(EB.left,(HB.bottom+EB.top)/2));}else{List<Rectangle> IC=cB.getClientRects();if(IC.length==0)return (null);Rectangle HB=IC.last;return (new HD(HB.right,HB.top));}}if(s[qa] is xD){Rectangle g=o.getClientRects()[0];return (new HD(g.left-21,g.top+2));}Rectangle g=o.getClientRects()[0];return (new HD(g.left,g.top));}else{assert(qa==0);Element o=sZ.dD();if(o==null)return (null);List<Rectangle> m=o.getClientRects();if(m.length==0)return (null);Rectangle g=m[0];return (new HD(g.left,g.top));}}}String MI({bool titles: false}){String i="";n g=sZ;while(g!=null){String k="";if(g.parent!=null){int m=1;for(n h=g.parent.firstChild;h!=null;h=h.nextSibling){if(h==g)break;if(h.nodeType==n.tC&&h.nodeName==g.nodeName)m++ ;}k="[${m}]";}if(g.nodeType==n.tC){String j;if(titles&&t.CB!=null&&g.DB!=null)j=t.CB.OD(g.DB);else j=g.nodeName;i="${j}${k}/${i}";}else if(g.nodeType==n.nB)i="#text";g=g.parent;}return ("/${i}");}String toString(){return ("[NodeOffsetPosition ${sZ.nodeName} ${qa}]");}}class PT{void show(){DivElement k=new DivElement();k.id='dlg1';k.classes.add('dlg1');DivElement s=new DivElement();s.classes.add('dlg2');DivElement h=new DivElement();h.classes.add('dlg3');DivElement g=new DivElement();g.classes.add('dlgtitle');g.text=LB.MB('validation.validation');h.append(g);List<n> EB=DS(t.rC);if(EB.length==0){h.appendText(LB.MB('validation.no_error'));}else{DivElement i=new DivElement();i.style.maxHeight='30em';i.style.overflow='auto';i.appendText(LB.MB('validation.errors'));UListElement HB=new UListElement();for(n m in EB){LIElement o=new LIElement();String g;if(m.DB!=null)g=t.CB.OD(m.DB);else g=null;q JB=new q(m,0);String v;if(g!=null)v="${g} ${JB.MI()}";else v=JB.MI();o.appendText(v);o.onClick.listen((MouseEvent QB)=>select(m));o.style.cursor='default';HB.append(o);}i.append(HB);h.append(i);}DivElement BB=new DivElement();BB.classes.add('buttons');ButtonElement j=new ButtonElement();j.attributes['type']='submit';j.appendText(LB.MB("button.Close"));j.onClick.listen((MouseEvent QB)=>close());BB.append(j);h.append(BB);s.append(h);k.append(s);document.body.append(k);j.focus();}List<n> DS(n g){List<n> h=new List<n>();if(g.nodeType==n.tC&&g is!qF){if(g.parent is jE){bool j=t.CB.HI(g.parent.DB,g.DB);if(j&&g.firstChild==null){h.add(g);return (h);}else if(!j&&g.firstChild==null&&(g.attributes==null||g.attributes.length==0)){return (h);}}if(!t.CB.iO(g))h.add(g);}for(n i=g.firstChild;i!=null;i=i.nextSibling)h.addAll(DS(i));return (h);}void select(n g){DivElement h=document.getElementById('dlg1');h.remove();IB.selectNode(g);}void close(){DivElement g=document.getElementById('dlg1');g.remove();IB.AH();}}ND RL=new ND();class lP{void update(n k,List<l> BB,List<l> EB){Element h=document.getElementById('insert');for(Element HB in h.children)HB.remove();HH j=t.CB;if(j==null)return;if(k.nodeType==n.tC&&k.DB!=null){h.append(ra(k.DB));String m=j.cD(k.DB);SpanElement v=new SpanElement();v.appendText(j.DI(m));h.append(v);h.append(new HRElement());}List<l> o;if(IB.toolbar!=null)o=IB.toolbar.dR();else o=null;for(l i in BB){if(o!=null&&o.contains(i))continue;if(t.ZC!=null&&t.ZC.contains(i))continue;h.append(ra(i));ButtonElement g=new ButtonElement();g.attributes['type']='button';g.classes.add('insertb');String m=j.cD(i);g.value=m;g.text=j.DI(m);if(!EB.contains(i))g.disabled=true;g.onClick.listen((Event s)=>insert(i));g.onKeyDown.listen((KeyboardEvent s){int JB=s.keyCode;if(JB==KeyCode.ENTER){s.preventDefault();insert(i);}});h.append(g);h.append(new BRElement());}}ButtonElement ra(l h){ButtonElement g=new ButtonElement();g.attributes['type']='button';g.classes.add('help');g.value='?';g.text='?';String i=t.CB.wH(h);if(i!=null)g.title=i;g.onClick.listen((Event j)=>uO(h));return (g);}void insert(l g){t.CI(g,'element');}void uO(l g){XG h=new XG.VX(g);h.show();}}class WF extends mG{WB pI;String title;NT update;WF(this.pI,this.update,OI g){title=pI.title;pI.parent=g;}Element html(){DivElement g=new DivElement();g.classes.add('toolbar-menu');g.append(IB.yF.OM(pI));return (g);}}class MC{static int mP=0;String cZ;String wK;DD action;MT update;Object data;String id;bool enabled;bool selected;StreamSubscription<MouseEvent> listener;String shortcut;int iconWidth;int iconHeight;MC(this.cZ,this.wK,this.action,this.update,{this.data,this.enabled: true,this.shortcut,this.iconWidth: 16,this.iconHeight: 16}){selected=false;id="button_${mP}";mP++ ;}Element html(){DivElement g=new DivElement();g.id=id;g.classes.add('toolbar-button');if(!enabled)g.classes.add('button-disabled');else g.setAttribute('tabindex','0');if(selected)g.classes.add('button-selected');g.setAttribute('title',cZ);ImageElement h=new ImageElement();h.src=wK;h.width=iconWidth;h.height=iconHeight;if(enabled)listener=g.onClick.listen((MouseEvent i)=>action());g.append(h);g.onKeyDown.listen((KeyboardEvent i){int j=i.keyCode;if(j==KeyCode.ENTER){i.preventDefault();action();}});return (g);}String get title{return (cZ);}void set title(String g){cZ=g;Element h=pB();h.setAttribute('title',cZ);}Element pB(){return (querySelector("#${id}"));}void disable(){if(!enabled)return;enabled=false;Element g=pB();g.classes.add('button-disabled');listener.cancel();g.setAttribute('tabindex','-1');}void enable(){if(enabled)return;enabled=true;Element g=pB();g.classes.remove('button-disabled');listener=g.onClick.listen((MouseEvent h)=>action());g.setAttribute('tabindex','0');}void select(){if(selected)return;selected=true;Element g=pB();g.classes.add('button-selected');}void xE(){if(!selected)return;selected=false;Element g=pB();g.classes.remove('button-selected');}}class ND{HashMap<String,lJ> VR=new HashMap<String,lJ>();HashMap<String,kJ> UR=new HashMap<String,kJ>();static void bT(){hC('anchor',(l i)=>new pG.HY(i),(AB g,n h)=>new pG.kY(g,h));hC('area',(l i)=>new CJ.WY(i),(AB g,n h)=>new CJ.lY(g,h));hC('br',(l i)=>new ZL.EY(i),(AB g,n h)=>new ZL.SY(g,h));hC('champ',(l i)=>new wI.IY(i),(AB g,n h)=>new wI.jY(g,h));hC('division',(l i)=>new bL.ZY(i),(AB g,n h)=>new bL.nY(g,h));hC('empty',(l i)=>new yI.GY(i),(AB g,n h)=>new yI.aY(g,h));hC('equationmem',(l i)=>new DJ.rY(i),(AB g,n h)=>new DJ.wY(g,h));hC('equatexmem',(l i)=>new EJ.xY(i),(AB g,n h)=>new EJ.BZ(g,h));hC('field',(l i)=>new wI.IY(i),(AB g,n h)=>new wI.jY(g,h));hC('hr',(l i)=>new YL.BY(i),(AB g,n h)=>new YL.JY(g,h));hC('item',(l i)=>new JH.DY(i),(AB g,n h)=>new JH.PY(g,h));hC('list',(l i)=>new UI.KY(i),(AB g,n h)=>new UI.pY(g,h));hC('liste',(l i)=>new UI.KY(i),(AB g,n h)=>new UI.pY(g,h));hC('fichier',(l i)=>new jH.iY(i),(AB g,n h)=>new jH.sY(g,h));hC('file',(l i)=>new jH.iY(i),(AB g,n h)=>new jH.sY(g,h));hC('form',(l i)=>new jE.fY(i),(AB g,n h)=>new jE.uY(g,h));hC('formulaire',(l i)=>new jE.fY(i),(AB g,n h)=>new jE.uY(g,h));hC('hiddendiv',(l i)=>new xI.FY(i),(AB g,n h)=>new xI.dY(g,h));hC('hiddenp',(l i)=>new kB.XY(i),(AB g,n h)=>new kB.mY(g,h));hC('simpletype',(l i)=>new BJ.TY(i),(AB g,n h)=>new BJ.eY(g,h));hC('string',(l i)=>new AJ.MY(i),(AB g,n h)=>new AJ.gY(g,h));hC('style',(l i)=>new zB.tY(i),(AB g,n h)=>new zB.vY(g,h));hC('stylespan',(l i)=>new YE.OY(i),(AB g,n h)=>new YE.hY(g,h));hC('symbol2',(l i)=>new zI.NY(i),(AB g,n h)=>new zI.bY(g,h));hC('symbole2',(l i)=>new zI.NY(i),(AB g,n h)=>new zI.bY(g,h));hC('table',(l i)=>new cG.yY(i),(AB g,n h)=>new cG.AZ(g,h));hC('texttable',(l i)=>new cG.yY(i),(AB g,n h)=>new cG.AZ(g,h));hC('tabletexte',(l i)=>new cG.yY(i),(AB g,n h)=>new cG.AZ(g,h));hC('text',null,(AB g,n h)=>new OB.AY(g,h));hC('texte',null,(AB g,n h)=>new OB.AY(g,h));hC('typesimple',(l i)=>new BJ.TY(i),(AB g,n h)=>new BJ.eY(g,h));hC('vide',(l i)=>new yI.GY(i),(AB g,n h)=>new yI.aY(g,h));hC('zone',(l i)=>new CJ.WY(i),(AB g,n h)=>new CJ.lY(g,h));hC('witem',(l i)=>new xD.CY(i),(AB g,n h)=>new xD.LY(g,h));hC('wlist',(l i)=>new iC.VY(i),(AB g,n h)=>new iC.qY(g,h));}static void hC(String g,lJ h,kJ i){if(h!=null)RL.VR[g]=h;if(i!=null)RL.UR[g]=i;}static n fH(AB g,n h){l j;if(g is sB){return (new oG.UY(g));}else if(g is nL){return (new BG.RY(g,h));}else if(g is pL){return (new IH.YY(g,h));}else if(g is mL){return (new qF.QY(g,h));}if(g is l){j=t.CB.UM(g,h!=null?h.DB:null);}else{j=null;}String m=t.CB.RS(j,g.nodeName,g.nodeType);kJ o=RL.UR[m];n i;if(o!=null)i=o(g,h);else if(m=='plugin'){String k=t.CB.JP(j,'element',g.nodeName,"classe",null);if(k=='xpages.JEEquationMemoire')i=new DJ.wY(g,h);else if(k=='xpages.JEEquaTeXMemoire')i=new EJ.BZ(g,h);else if(k=='xpages.jeimage.JEImage')i=new jH.sY(g,h);}else i=new AJ.gY(g,h);return (i);}static n NF(l g,[String i='element']){if(i=='commentaire'){return (new BG());}else if(i=='instruction'){return (new IH());}else if(i=='cdata'){return (new qF());}String k=t.CB.RS(g,t.CB.cD(g),AB.FE);lJ m=RL.VR[k];n h;if(m!=null)h=m(g);else if(k=='plugin'){String j=t.CB.JP(g,'element',t.CB.cD(g),"classe",null);if(j=='xpages.JEEquationMemoire')h=new DJ.rY(g);else if(j=='xpages.JEEquaTeXMemoire')h=new EJ.xY(g);else if(j=='xpages.jeimage.JEImage')h=new jH.iY(g);}else h=new AJ.MY(g);return (h);}}typedef void DD();AN IB;PL t;Map<String,DD> nP=new Map<String,DD>();class HD{num x;num y;HD(num this.x,num this.y);}void SL(String g,lJ h,kJ i){ND.hC(g,h,i);}class HN{String sa;String ta;String ua;AQ va;oD wa;HN(String g,{String labelName,String labelValue,AQ okfct}){sa=g;ta=labelName;ua=labelValue;va=okfct;}void show(){DivElement h=new DivElement();h.id='dlg1';h.classes.add('dlg1');DivElement v=new DivElement();v.classes.add('dlg2');DivElement BB=new DivElement();BB.classes.add('dlg3');FormElement i=new FormElement();CanvasElement j=new CanvasElement(width:500,height:300);j.id='eqcanvas';lB QB=new lB(sa);wa=new oD(element:QB.uK(),context:j.context2D);wa.GC(j.context2D);i.append(j);TextAreaElement g=new TextAreaElement();g.id='eqtext';g.value=sa;g.style.width='100%';g.style.height='4em';g.attributes['spellcheck']='false';g.onInput.listen((Event EB)=>LF());i.append(g);if(ta!=null){DivElement k=new DivElement();SpanElement JB=new SpanElement();JB.text=ta;k.append(JB);k.appendText(' ');TextInputElement HB=new TextInputElement();HB.id='eqlabel';if(ua!=null)HB.value=ua;k.append(HB);i.append(k);}DivElement m=new DivElement();m.classes.add('buttons');ButtonElement o=new ButtonElement();o.attributes['type']='button';o.appendText(LB.MB("button.Cancel"));o.onClick.listen((MouseEvent EB)=>h.remove());m.append(o);ButtonElement s=new ButtonElement();s.attributes['type']='submit';s.appendText(LB.MB("button.OK"));s.onClick.listen((MouseEvent EB)=>iF(EB));m.append(s);i.append(m);BB.append(i);v.append(BB);h.append(v);document.body.append(h);g.focus();}void iF(MouseEvent g){TextAreaElement h=querySelector('textarea#eqtext');sa=h.value;if(ta!=null){TextInputElement i=querySelector('input#eqlabel');ua=i.value;}querySelector('div#dlg1').remove();if(g!=null)g.preventDefault();if(va!=null)va();}String fB(){return (sa);}String getData(){if(sa=='')return (null);CanvasElement g=new CanvasElement(width:wa.dB(),height:wa.OC());lB h=new lB(sa);oD i=new oD(element:h.uK(),context:g.context2D);i.GC(g.context2D);String j=g.toDataUrl('image/png');String k=j.substring('data:image/png;base64,'.length);return (k);}String kR(){return (ua);}void LF(){TextAreaElement g=querySelector('textarea#eqtext');sa=g.value;if(sa.length>0&&sa.contains('\n')){g.value=sa.replaceAll('\n','');iF(null);return;}CanvasElement h=querySelector('canvas#eqcanvas');lB i=new lB(sa);wa.bS(i.uK());wa.GC(h.context2D);}}class YC extends XB{YC():super();}class qJ extends XB{qJ():super();void GC(final CanvasRenderingContext2D o,final double QB,final double s){int g,h;final List<double> v=new List<double>(PC());final List<double> EB=new List<double>(PC());for(g=0;g<PC();g++ ){v[g]=qR(g);EB[g]=rR(g);}final int BB=oR();final List<double> m=new List<double>(BB);for(g=0;g<BB;g++ )m[g]=pR(g);final double HB=QB;final double SB=-OC(true)/2+v[0]-rD();double j=HB;double k=SB;for(g=0;g<PC();g++ ){final XB JB=NB(g);j=HB;for(h=0;(h<BB)&&(h<JB.PC());h++ ){final QI i=JB.NB(h) as QI;if(i.hR()=="left")i.GC(o,j+1,s+k);else if(i.hR()=="right")i.GC(o,j+m[h]-i.dB(true),s+k);else i.GC(o,j+m[h]/2-i.dB(true)/2,s+k);j+= m[h];}k+= EB[g];if(g<PC()-1)k+= v[g+1];}}double qR(final int i){if(i>=PC())return 0.0;final XB j=NB(i);double g=0.0;for(int h=0;h<j.PC();h++ )g=max(g,j.NB(h).rB(true));return g;}double rR(final int i){if(i>=PC())return 0.0;final XB j=NB(i);double g=0.0;for(int h=0;h<j.PC();h++ )g=max(g,j.NB(h).yB(true));return g;}double pR(final int i){double g=0.0;for(int h=0;h<PC();h++ ){final XB j=NB(h);if(i<j.PC())g=max(g,j.NB(i).dB(true));}return g+2;}int oR(){int g=0;for(int h=0;h<PC();h++ ){final XB i=NB(h);g=max(g,i.PC());}return g;}double dB(final bool j){double h=0.0;final int i=oR();for(int g=0;g<i;g++ )h+= pR(g);return h;}double OC(final bool i){double h=0.0;for(int g=0;g<PC();g++ )h+= qR(g)+rR(g);return h;}double rB(final bool g){return OC(true)/2+rD();}double yB(final bool g){return OC(true)/2-rD();}}class QI extends XB{String xa="center";QI():super();void gW(final String g){xa=g;}String hR(){return xa;}}class rP extends XB{rP():super();void GC(final CanvasRenderingContext2D h,final double i,final double j){if(TJ().YM())debug(h,i,j);final double m=ya();double k=i;for(int g=0;g<PC();g++ ){NB(g).GC(h,k,j);k+= m;}}double ya(){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).dB(true));return g;}double dB(final bool g){return ya()*PC();}double OC(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).OC(i));return g;}double rB(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).rB(i));return g;}double yB(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).yB(i));return g;}}class aG extends XB{aG():super();void GC(final CanvasRenderingContext2D g,final double h,final double i){g.font=zC();g.fillText(fB(),h,i);}double dB(final bool g){return JI(fB().replaceAll(' ','A'));}double OC(final bool g){return AD().mE+AD().vH;}double uR(){wD g=qV(fB());return (g.actualBoundingBoxAscent);}double rB(final bool g){return AD().mE;}double yB(final bool g){return AD().vH;}}class sP extends XB{sP():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D g,final double h,final double i){if(PC()<2)return;final XB m=NB(0);final XB o=NB(1);final double BB=dB(true);final double EB=m.dB(true);final double k=8.0;final double j=o.dB(true);final double HB=o.OC(true);final double s=m.rB(true);final double v=m.yB(true);g.beginPath();g.moveTo(h,i);g.lineTo(h+j,i);g.moveTo(h+j,i);g.lineTo(h+k/2+j,i+v);g.moveTo(h+j-1,i);g.lineTo(h+k/2+j,i+v);g.moveTo(h+k/2+j,i+v);g.lineTo(h+k+j,i-(s+2));g.moveTo(h+k+j,i-(s+2));g.lineTo(h+BB,i-(s+2));g.stroke();m.GC(g,h+k+j,i);o.GC(g,h,i-o.yB(true));}double dB(final bool g){if(PC()<2)return 0.0;return NB(0).dB(g)+8+NB(1).dB(g);}double OC(final bool g){if(PC()<2)return 0.0;return yB(true)+max(NB(0).rB(true)+4,NB(1).OC(true));}double rB(final bool g){if(PC()<2)return 0.0;return max(NB(0).rB(true)+4,NB(1).OC(true));}double yB(final bool g){if(PC()<2)return 0.0;return NB(0).yB(true);}}class tP extends aG{}class uP extends XB{uP():super();void GC(final CanvasRenderingContext2D g,final double h,final double i){final double BB=dB(true);final double EB=nR();final double j=8.0;final double k=lR(true);final double m=mR(true);g.beginPath();g.moveTo(h,i);g.lineTo(h+3,i-1);g.moveTo(h+3,i);g.lineTo(h+j/2+1,i+m);g.moveTo(h+2,i-1);g.lineTo(h+j/2+1,i+m);g.moveTo(h+j/2+1,i+m);g.lineTo(h+j+3,i-(k+1));g.moveTo(h+j+3,i-(k+1));g.lineTo(h+BB,i-(k+1));g.stroke();double v=h+j+3;XB o;for(int s=0;s<PC();s++ ){o=NB(s);o.GC(g,v,i);v+= o.dB(true);}}double nR(){double h=0.0;for(int g=0;g<PC();g++ )h+= NB(g).dB(true);return h;}double dB(final bool g){return nR()+8+3;}double hV(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).OC(true));return g;}double OC(final bool g){return hV(true)+4;}double lR(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).rB(true));return g;}double rB(final bool g){return lR(true)+2;}double mR(final bool i){double g=0.0;for(int h=0;h<PC();h++ )g=max(g,NB(h).yB(true));return g;}double yB(final bool g){return mR(true)+2;}}class oB extends XB{bool za=true;double Ab=0.0;double Bb=0.0;oB():super();void ZJ(final bool g){this.za=g;}void hW(final double g){this.Ab=g;}void jW(final double g){this.Bb=g;}void zK(final CanvasRenderingContext2D g,final double h,final double i,final String EB,final String HB,final String JB){g.font=zC();final double j=yH();final double k=iR();wD m=new wD(EB,zC());wD o=new wD(HB,zC());wD s=new wD(JB,zC());double v=m.actualBoundingBoxAscent+m.actualBoundingBoxDescent;double SB=m.actualBoundingBoxAscent;double cB=o.actualBoundingBoxAscent+o.actualBoundingBoxDescent;double hB=o.actualBoundingBoxAscent;double BB=s.actualBoundingBoxAscent+s.actualBoundingBoxDescent;double CC=s.actualBoundingBoxAscent;if(j-v-BB>0){final double IC=j-v-BB+2;double QB=IC/cB;g.save();g.scale(1,QB);g.fillText(HB,h,(i-k+v)/QB+hB);g.restore();}g.fillText(EB,h,i-k+SB);g.fillText(JB,h,i+j-k-(BB-CC).round());}void SS(final CanvasRenderingContext2D g,final double h,final double i,final String v,final String BB,final String m,final String EB){final double HB=yH();g.fillStyle='black';g.font=zC();wD s=new wD(m,zC());final double j=s.actualBoundingBoxAscent+s.actualBoundingBoxDescent;final int o=((HB/j)/2).floor();for(int k=1;k<o;k++ ){g.fillText(m,h,i-j*k);g.fillText(m,h,i+j*k);}g.fillText(BB,h,i);g.fillText(v,h,i-j*o);g.fillText(EB,h,i+j*o);}void TS(final CanvasRenderingContext2D g,final double h,final double i,final String s,final String v,final String o,final String BB){final double EB=getParent().dB(true);final double HB=i-rD();g.save();g.fillStyle='black';g.font=zC();g.translate(h,i);g.rotate(PI/2.0);g.translate(-h,-HB);final double j=AD().mE-1;int JB=(EB/j).floor();final int m=JB~/2;for(int k=1;k<m;k++ ){g.fillText(o,h,i-j*k);g.fillText(o,h,i+j*k);}g.fillText(v,h,i);g.fillText(s,h,i-j*m);g.fillText(BB,h,i+j*m);g.restore();}void GC(final CanvasRenderingContext2D g,double h,final double i){if(Ab!=0){final double s=JI('A');h+= Ab*s;}if(fB().length==1&&"[{(|)}]\u222B".indexOf(fB()[0])>=0&&za){final double m=getParent().rB(false);final double o=getParent().yB(false);final double j=m+o-1;if(fB()=="("){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else zK(g,h,i,'\u239B','\u239C','\u239D');}else if(fB()==")"){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else zK(g,h,i,'\u239E','\u239F','\u23A0');}else if(fB()=="["){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else zK(g,h,i,'\u23A1','\u23A2','\u23A3');}else if(fB()=="]"){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else zK(g,h,i,'\u23A4','\u23A5','\u23A6');}else if(fB()=="{"){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else SS(g,h,i,'\u23A7','\u23A8','\u23AA','\u23A9');}else if(fB()=="}"){if(j<AD().height){g.font=zC();g.fillText(fB(),h,i);}else SS(g,h,i,'\u23AB','\u23AC','\u23AA','\u23AD');}else if(fB()=="|"){g.beginPath();g.moveTo(h+2,i-m);g.lineTo(h+2,i+o);g.stroke();}else if(fB()=="\u222B"){zK(g,h,i,'\u2320','\u23AE','\u2321');}}else if(fB().length==1&&"\uFE37\uFE38".indexOf(fB()[0])>=0){if(fB()=="\uFE37")TS(g,h,i,'\u23A7','\u23A8','\u23AA','\u23A9');else if(fB()=="\uFE38")TS(g,h,i,'\u23AB','\u23AC','\u23AA','\u23AD');}else if(fB().length==1&&"\u2211\u220F".indexOf(fB()[0])>=0&&za){g.strokeStyle='black';g.fillStyle='black';if(yH()>AD().height){final String v=TJ().zC(ID()*2);g.font=v;}else g.font=zC();if("\u2211".indexOf(fB()[0])>=0)g.fillText("\u2211",h,i);else g.fillText("\u220F",h,i);g.font=zC();}else if(fB()=="\u00AF"&&za){final double k=getParent().dB(false)-2;g.beginPath();g.moveTo(h,i);g.lineTo(h+k,i);g.stroke();}else if(fB()=="^"&&za){final double k=getParent().dB(false)-3;g.beginPath();g.moveTo(h,i);g.lineTo(h+k/2,i-3);g.moveTo(h+k/2,i-3);g.lineTo(h+k,i);g.stroke();}else if(fB()=="."||fB()==".."||fB()=="..."){g.font=zC();g.fillText(fB(),h+1,i);}else{g.font=zC();g.fillText(fB(),h,i);}}XB qO(){if(fB()=="\u222B"||"\u2211\u220F".contains(fB())){YC k;if(getParent() is YC)k=getParent() as YC;else k=getParent().getParent() as YC;final XB h=k.NB(1);if(!(h is YC&&h.PC()>0))return (h);final XB i=h.NB(0);if(!(i is YC&&i.PC()>0))return (h);final XB g=i.NB(0);if(!(g is SI||g is sJ||g is pF||g is oB))return (h);XB j;if(g is SI||g is sJ||g is pF)j=g.NB(0);else j=g;if(!(j.fB()=="\u222B"||"\u2211\u220F".contains(j.fB())))return (h);return (i.NB(1));}else return (getParent());}double yH(){return (qO().OC(false));}double iR(){return (qO().rB(false));}double fV(){return (qO().yB(false));}double dB(final bool k){double g=0.0;if(Ab!=0||Bb!=0){final double j=JI('A');final double m=Ab*j;final double o=Bb*j;g=m+o;}if(fB().length==1){final String h=fB()[0];if("|".indexOf(h)>=0)return 5+g;else if("\uFE37\uFE38".indexOf(h)>=0)return 1+g;else if("\u222B".indexOf(h)>=0){wD i=new wD(fB(),TJ().zC(ID()*2));return i.width+g;}else if("\u2211\u220F".indexOf(h)>=0){if(yH()>AD().height){wD i=new wD(fB(),TJ().zC(ID()*2));return i.width+g;}else return JI(fB()).round()+g;}else if("^\u00AF".indexOf(h)>=0&&za&&k)return getParent().dB(false)-2;}return JI(fB()).round()+g;}double OC(final bool g){return rB(g)+yB(g);}double rB(final bool i){if(fB().length==1&&"[()]\u222B".indexOf(fB()[0])>=0){if(!i||!za)return AD().mE;return (iR()+1);}else if(fB().length==1&&"{}".indexOf(fB()[0])>=0){if(!i||!za)return AD().mE;final double g=AD().mE;final int h=(yH()/g).floor()+1;if("{}".indexOf(fB()[0])>=0)if(h%2==0)return (h+1)*g*0.5+rD();return h*g*0.5+rD();}else if(fB().length==1&&"\u2211\u220F".indexOf(fB()[0])>=0&&za){if(yH()>AD().height)return TJ().AD(ID()*2).mE;else return AD().mE;}else if(fB().length==1&&"\uFE37\uFE38".indexOf(fB()[0])>=0)return 0.0;else if(fB()=="\u00AF"&&za)return (3.0);else if(fB()=="\u223C"&&za)return ((AD().mE~/2).toDouble());else if(fB()=="."||fB()==".."||fB()=="...")return ((AD().mE~/2).toDouble());else return AD().mE;}double yB(final bool i){if(fB().length==1&&"[()]\u222B".indexOf(fB()[0])>=0){if(!i||!za)return AD().vH;return (fV()+1);}else if(fB().length==1&&"{}".indexOf(fB()[0])>=0){if(!i||!za)return AD().vH;final double g=AD().mE;final int h=(yH()/g).floor()+1;if("{}".indexOf(fB()[0])>=0)if(h%2==0)return (h+1)*g*0.5-rD();return h*g*0.5-rD();}else if(fB().length==1&&"\u2211\u220F".indexOf(fB()[0])>=0&&za){if(yH()>AD().height)return TJ().AD(ID()*2).vH;else return AD().vH;}else if(fB().length==1&&"\uFE37\uFE38".indexOf(fB()[0])>=0)return JI("}");else return AD().vH;}}class gH extends XB{static final int oT=0;static final int WL=1;int Cb=oT;bool Db=false;gH():super();int kV(){return Cb;}void XP(final bool g){this.Db=g;}bool YM(){return Db;}void NW(final CanvasRenderingContext2D g){if(Db){g.strokeStyle='blue';g.beginPath();g.moveTo(0,0);g.lineTo(SJ()-1,0);g.moveTo(SJ()-1,0);g.lineTo(SJ()-1,mI()-1);g.moveTo(0,0);g.lineTo(0,mI()-1);g.moveTo(0,mI()-1);g.lineTo(SJ()-1,mI()-1);g.stroke();g.strokeStyle='cyan';g.moveTo(0,mI()/2);g.lineTo(SJ()-1,mI()/2);g.stroke();g.strokeStyle='black';}if(NB(0)!=null){final double i=NB(0).rB(true)-rD();final double h=NB(0).yB(true)+rD();if(i>=h)GC(g,0.0,rB(true));else GC(g,0.0,h+rD());}}int SJ(){return dB(true).ceil();}int mI(){return OC(true).ceil();}void GC(final CanvasRenderingContext2D g,final double h,final double i){if(NB(0)!=null)NB(0).GC(g,h,i);}double dB(final bool g){if(NB(0)==null)return 0.0;return NB(0).dB(true)+1;}double OC(final bool i){if(NB(0)==null)return 0.0;if(Cb==WL)return NB(0).OC(true)+2;final double g=NB(0).rB(true)-rD();final double h=NB(0).yB(true)+rD();return max(g,h)*2;}double rB(final bool g){if(NB(0)==null)return 0.0;if(Cb==WL)return NB(0).rB(true);return max(NB(0).rB(true),NB(0).yB(true));}double yB(final bool g){if(NB(0)==null)return 0.0;if(Cb==WL)return NB(0).yB(true);return max(NB(0).rB(true),NB(0).yB(true));}}class rJ extends XB{int Eb=1;rJ():super();void GC(final CanvasRenderingContext2D g,final double h,final double s){final XB j=NB(0);final XB k=NB(1);final double m=s-rD();final double o=dB(true);j.GC(g,h+(o-j.dB(true))/2,m-j.yB(true)-1);g.lineWidth=Eb;g.beginPath();double i=m-Eb/2;if(Eb==1)i=i.floorToDouble()+0.5;g.moveTo(h+1,i);g.lineTo(h+o-1,i);g.stroke();g.lineWidth=1;k.GC(g,h+(o-k.dB(true))/2,m+k.rB(true)+1);}double dB(final bool g){return max(NB(0).dB(g),NB(1).dB(g))+4;}double OC(final bool g){return rB(true)+yB(true);}double rB(final bool g){return NB(0).OC(true)+1+Eb/2+rD();}double yB(final bool g){return max(0,NB(1).OC(true)+1+Eb/2-rD());}}class pF extends XB{bool Fb=false;pF():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2&&!Fb)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null&&!Fb)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D i,final double j,final double k){final XB g=NB(0);final XB h=NB(1);final double m=dB(true);g.GC(i,j+(m-g.dB(true))/2,k);if(Fb){double o;if(g is aG||g is RI)o=g.uR()+3;else o=g.rB(true);h.GC(i,j+(m-h.dB(true))/2,k-o);}else h.GC(i,j+(m-h.dB(true))/2,k-(g.rB(true)+h.yB(true)));}double dB(final bool g){return max(NB(0).dB(g),NB(1).dB(g));}double OC(final bool g){if(Fb)return NB(0).OC(g)+NB(1).rB(g)+1;else return NB(0).OC(g)+NB(1).OC(g);}double rB(final bool g){if(Fb)return NB(0).rB(true)+NB(1).rB(true);else return NB(0).rB(true)+NB(1).OC(true);}double yB(final bool g){return NB(0).yB(true);}void WP(final bool g){this.Fb=g;}}class sJ extends XB{sJ():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D i,final double j,final double k){final XB g=NB(0);final XB h=NB(1);final double m=dB(true);g.GC(i,j+(m-g.dB(true))/2,k);h.GC(i,j+(m-h.dB(true))/2,k+g.yB(true)+h.rB(true));}double dB(final bool g){return max(NB(0).dB(g),NB(1).dB(g));}double OC(final bool g){return NB(0).OC(g)+NB(1).OC(g);}double rB(final bool g){return NB(0).rB(true);}double yB(final bool g){return NB(0).yB(true)+NB(1).OC(true);}}class RI extends aG{String Gb="italic";void aS(final String g){this.Gb=g;}void GC(final CanvasRenderingContext2D h,final double i,final double j){final String k=fB();String g;if(Gb=='italic')g=gV();else if(Gb=='bold')g=aV();else if(Gb=='bold-italic')g=bV();else g=zC();h.font=g;h.fillText(k,i,j);}String zC(){if(base!=null)return base.zC(BH,oD.LN);return null;}}class VL extends XB{VL():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D g,final double h,final double i){final XB j=NB(0);final XB k=NB(1);j.GC(g,h,i);k.GC(g,h+j.dB(true),i+k.rB(true)-rD());}double dB(final bool g){return NB(0).dB(g)+NB(1).dB(g);}double OC(final bool g){return rB(true)+yB(true);}double rB(final bool g){return NB(0).rB(true);}double yB(final bool g){return max(NB(0).yB(true),NB(1).OC(true)-rD());}}class UL extends XB{UL():super();void RB(final XB g){super.RB(g);if(g!=null){if(PC()==2)g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);}void GC(final CanvasRenderingContext2D i,final double j,final double k){final XB g=NB(0);final XB h=NB(1);g.GC(i,j,k);h.GC(i,j+g.dB(true),k-max(h.yB(true)+rD(),g.rB(true)-h.yB(true)));}double dB(final bool g){return NB(0).dB(g)+NB(1).dB(g);}double OC(final bool g){return rB(true)+yB(true);}double rB(final bool i){final XB h=NB(0);final XB g=NB(1);return (g.rB(true)+max(g.yB(true)+rD(),h.rB(true)-g.yB(true)));}double yB(final bool g){return NB(0).yB(true);}}class oD{static String vP='STIXSubset-Regular';static String wP='STIXSubset-Italic';static String KN='STIXSubset-Bold';static bool xP=false;static const int nT=0;static const int yP=1;static const int LN=2;static const int zP=3;int Hb;int Ib;final int aM=8;final int yK=60;List<wD> Jb=null;bool Db=false;static final int qT=0;final int Cb=qT;gH Kb;CanvasRenderingContext2D Lb;oD({final gH element,final int inlinefontsize: 15,final int displayfontsize: 16,final CanvasRenderingContext2D context}){this.Hb=inlinefontsize;this.Ib=displayfontsize;if(context!=null)Jb=new List<wD>(yK);if(element!=null)bS(element);if(context!=null)this.Lb=context;}static void CQ(){if(xP)return;CanvasElement h=new CanvasElement(width:10,height:10);CanvasRenderingContext2D g=h.context2D;g.font="15px ${vP}";g.fillText('.',0,0);g.font="15px ${wP}";g.fillText('.',0,0);g.font="15px ${KN}";g.fillText('.',0,0);xP=true;}void bS(final gH g){if(g==null)return;Kb=g;Kb.hM(this);if(g.kV()==gH.WL)Kb.WC(Ib);else Kb.WC(Hb);Kb.XP(YM());}void XP(final bool g){this.Db=g;if(Kb!=null)Kb.XP(g);}bool YM(){return Db;}String zC(final int j,[int k=oD.nT]){int i;if(j<aM)i=aM;else if(j>yK)i=yK;else i=j;String g,h;if(k==oD.LN){g='';h=wP;}else if(k==oD.yP){g='';h=KN;}else if(k==oD.zP){g='italic';h=KN;}else{g='';h=vP;}return ("${g} ${i}px ${h}");}wD AD(final int h){int g;if(h<aM)g=aM;else if(h>yK)g=yK;else g=h;if(Jb[g]==null)Jb[g]=NV(zC(h));return Jb[g];}wD NV(String g){return (new wD('Hg',g));}double JI(String g,String h){String i=Lb.font;Lb.font=h;double j=Lb.measureText(g).width;Lb.font=i;return (j);}void GC(final CanvasRenderingContext2D g){g.clearRect(0,0,g.canvas.width,g.canvas.height);if(Kb!=null)Kb.NW(g);}int dB(){if(Kb!=null&&Jb!=null)return Kb.SJ();return 0;}int OC(){if(Kb!=null&&Jb!=null)return Kb.mI();return 0;}}class XB{oD base;XB parent;int BH=14;final List<XB> children=new List<XB>();final StringBuffer text=new StringBuffer();XB([final oD g,final int h]){if(g!=null)hM(g);if(h!=null)WC(h);}void RB(final XB g){if(g!=null){children.add(g);g.hM(base);g.iW(this);g.WC(BH);}}XB NB(final int g){if((g>=0)&&(g<children.length))return children[g];return null;}int PC(){return children.length;}void VC(final String h){for(int g=0;g<h.length;g++ )if(" \t\n\r".indexOf(h[g])<0)this.text.write(h[g]);else if((' '==h[g])&&(g>0)&&(' '!=h[g-1]))this.text.write(h[g]);}String fB(){return text.toString().trim();}void hM(final oD g){this.base=g;for(final XB h in children)h.hM(g);}oD TJ(){return base;}void iW(final XB g){this.parent=g;}XB getParent(){return parent;}void WC(final int g){this.BH=max(g,8);for(final XB h in children)h.WC(this.BH);}int ID(){return BH;}String zC(){if(base!=null)return base.zC(BH);return null;}String gV(){if(base!=null)return base.zC(BH,oD.LN);return null;}String aV(){if(base!=null)return base.zC(BH,oD.yP);return null;}String bV(){if(base!=null)return base.zC(BH,oD.zP);return null;}wD AD(){if(base!=null)return base.AD(BH);return null;}double JI(g){return (base.JI(g,zC()));}wD qV(String g){return (new wD(g,zC()));}void debug(final CanvasRenderingContext2D g,final double h,final double i){g.strokeStyle='blue';g.beginPath();g.moveTo(h,i-rB(true));g.lineTo(h+dB(true),i-rB(true));g.moveTo(h+dB(true),i-rB(true));g.lineTo(h+dB(true),i+yB(true));g.moveTo(h,i+yB(true));g.lineTo(h+dB(true),i+yB(true));g.moveTo(h,i-rB(true));g.lineTo(h,i+yB(true));g.stroke();g.strokeStyle='red';g.beginPath();g.moveTo(h,i);g.lineTo(h+dB(true),i);g.stroke();g.strokeStyle='black';}void GC(final CanvasRenderingContext2D i,final double j,final double k){if(base.YM())debug(i,j,k);double m=j;XB g;for(int h=0;h<PC();h++ ){g=NB(h);g.GC(i,m,k);m+= g.dB(true)+2;}}double dB(final bool h){double g=0.0;for(final XB i in children)g+= i.dB(h)+2;return g-2;}double OC(final bool g){return rB(g)+yB(g);}double uR(){return rB(true);}double rB(final bool h){double g=0.0;for(final XB i in children)g=max(g,i.rB(h));return g;}double yB(final bool h){double g=0.0;for(final XB i in children)g=max(g,i.yB(h));return g;}double rD(){return base.AD(ID()).mE*0.30;}}class SI extends XB{SI():super();void RB(final XB g){super.RB(g);if(g!=null){if((PC()==2)||(PC()==3))g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);if(NB(2)!=null)NB(2).WC(ID()-2);}void GC(final CanvasRenderingContext2D h,final double i,final double j){final XB g=NB(0);final XB k=NB(1);final XB m=NB(2);final double o=dB(true);g.GC(h,i+(o-g.dB(true))/2,j);k.GC(h,i+(o-k.dB(true))/2,j+g.yB(true)+k.rB(true));m.GC(h,i+(o-m.dB(true))/2,j-(g.rB(true)+m.yB(true)));}double dB(final bool g){return max(NB(0).dB(g),max(NB(1).dB(g),NB(2).dB(g)));}double OC(final bool g){return NB(0).OC(g)+NB(1).OC(g)+NB(2).OC(g);}double rB(final bool g){return NB(0).rB(true)+NB(1).OC(true);}double yB(final bool g){return NB(0).yB(true)+NB(2).OC(true);}}class IN extends XB{IN():super();void RB(final XB g){super.RB(g);if(g!=null){if((PC()==2)||(PC()==3))g.WC(ID()-2);else g.WC(ID());}}void WC(final int g){super.WC(g);if(NB(1)!=null)NB(1).WC(ID()-2);if(NB(2)!=null)NB(2).WC(ID()-2);}void GC(final CanvasRenderingContext2D h,final double i,final double j){final XB g=NB(0);final XB k=NB(1);final XB o=NB(2);final double m=k.rD();final double s=j+g.yB(true)+m/2;final double v=j-g.rB(true)+m;g.GC(h,i,j);k.GC(h,i+g.dB(true),s);o.GC(h,i+g.dB(true),v);}double dB(final bool g){return NB(0).dB(g)+max(NB(1).dB(g),NB(2).dB(g));}double OC(final bool g){return rB(true)+yB(true);}double rB(final bool g){return max(NB(0).rB(true),NB(2).OC(true)+rD());}double yB(final bool g){return max(NB(0).yB(true),NB(1).OC(true)-rD());}}class wD{static final JN=new CanvasElement(width:500,height:300);double width;double height;double mE;double vH;double actualBoundingBoxAscent;double actualBoundingBoxDescent;wD(final String JB,final String QB){SpanElement i=new SpanElement();i.setAttribute('style',"font: ${QB}");i.text=JB;DivElement j=new DivElement();j.setAttribute('style','display: inline-block; width: 1px; height: 0px;');DivElement m=new DivElement();m.append(i);m.append(j);document.body.append(m);width=i.offset.width.toDouble();j.style.verticalAlign='bottom';height=(j.offset.top-i.offset.top).toDouble();j.style.verticalAlign='baseline';mE=(j.offset.top-i.offset.top).toDouble();vH=height-mE;m.remove();CanvasRenderingContext2D k=JN.context2D;k.font=QB;k.fillStyle='white';k.fillRect(0,0,JN.width,JN.height);k.fillStyle='black';k.fillText(JB,0,mE);int h=width.ceil();int o=height.ceil();List<int> s=k.getImageData(0,0,h,o).data;int v=0;bool SB=false;int EB=v;int BB=o-1;bool cB=false;int HB=BB;for(int g=0;g<h*o;g++ ){if(!SB&&s[g*4]!=0xFF){v=g~/h;EB=v;SB=true;}if(s[g*4]<0x90){EB=g~/h;break;}}double hB=(v+EB)/2;for(int g=h*o-1;g>=0;g-- ){if(!cB&&s[g*4]!=0xFF){BB=g~/h;HB=BB;cB=true;}if(s[g*4]<0x90){HB=g~/h;break;}}double CC=(BB+HB)/2;actualBoundingBoxAscent=mE-hB;actualBoundingBoxDescent=CC-mE;}}class lB{gH Kb;static final List<List<String>> pT=[["<==","\u21D0"],["==>","\u21D2"],["<=>","\u21D4"],["!=","\u2260"],["~=","\u2248"],["~","\u223C"],["<=","\u2264"],[">=","\u2265"],["<<","\u226A"],[">>","\u226B"],["-->","\u2192"],["<->","\u2194"],["->","\u2192"],["<--","\u2190"],["equiv","\u2261"],["forall","\u2200"],["quelquesoit","\u2200"],["exists","\u2203"],["ilexiste","\u2203"],["part","\u2202"],["drond","\u2202"],["nabla","\u2207"],["prop","\u221D"],["times","×"],["cross","×"],["croix","×"],["wedge","\u2227"],["pvec","\u2227"],["plusmn","±"],["plusoumoins","±"],["plusminus","±"],["cap","\u2229"],["cup","\u222A"],["...","\u2026"]];static final String MN="_^#*/\u2207±\u2213\u2227-+\u2200\u2203\u2202×=\u2260\u2248\u223C\u2261<>\u2264\u2265\u226A\u226B\u221D"+"|\u2229\u222A\u2190\u2192\u2194\u21D0\u21D2\u21D4";static final List<List<String>> BQ=[["alpha","\u03B1"],["beta","\u03B2"],["gamma","\u03B3"],["delta","\u03B4"],["epsilon","\u03B5"],["zeta","\u03B6"],["eta","\u03B7"],["theta","\u03B8"],["iota","\u03B9"],["kappa","\u03BA"],["lambda","\u03BB"],["mu","\u03BC"],["nu","\u03BD"],["xi","\u03BE"],["omicron","\u03BF"],["rho","\u03C1"],["sigma","\u03C3"],["tau","\u03C4"],["upsilon","\u03C5"],["phi","\u03C6"],["chi","\u03C7"],["psi","\u03C8"],["omega","\u03C9"],["Alpha","\u0391"],["Beta","\u0392"],["Gamma","\u0393"],["Delta","\u0394"],["Epsilon","\u0395"],["Zeta","\u0396"],["Eta","\u0397"],["Theta","\u0398"],["Iota","\u0399"],["Kappa","\u039A"],["Lambda","\u039B"],["Mu","\u039C"],["Nu","\u039D"],["Xi","\u039E"],["Omicron","\u039F"],["Pi","\u03A0"],["Rho","\u03A1"],["Sigma","\u03A3"],["Tau","\u03A4"],["Upsilon","\u03A5"],["Phi","\u03A6"],["Chi","\u03A7"],["Psi","\u03A8"],["Omega","\u03A9"],["thetasym","\u03D1"],["upsih","\u03D2"],["piv","\u03D6"],["phiv","\u03D5"],["phi1","\u03D5"]];static final List<List<String>> DQ=[["pi","\u03C0"],["infin","\u221E"],["infty","\u221E"],["infini","\u221E"],["parallel","\u2225"],["parallèle","\u2225"],["sun","\u2609"],["soleil","\u2609"],["star","\u2605"],["étoile","\u2605"],["mercury","\u263F"],["mercure","\u263F"],["venus","\u2640"],["vénus","\u2640"],["earth","\u2295"],["terre","\u2295"],["mars","\u2642"],["jupiter","\u2643"],["saturn","\u2644"],["saturne","\u2644"],["uranus","\u26E2"],["neptun","\u2646"],["neptune","\u2646"],["planck","\u210F"],["angstrom","\u212B"],["angström","\u212B"],["asterisk","*"],["astérisque","*"],["ell","\u2113"],["smalll","\u2113"],["petitl","\u2113"],["Ascr","\u{1D49C}"],["biga","\u{1D49C}"],["granda","\u{1D49C}"],["Bscr","\u212C"],["bigb","\u212C"],["grandb","\u212C"],["Cscr","\u{1D49E}"],["bigc","\u{1D49E}"],["grandc","\u{1D49E}"],["Dscr","\u{1D49F}"],["bigd","\u{1D49F}"],["grandd","\u{1D49F}"],["Escr","\u2130"],["bige","\u2130"],["grande","\u2130"],["Fscr","\u2131"],["bigf","\u2131"],["grandf","\u2131"],["Gscr","\u{1D4A2}"],["bigg","\u{1D4A2}"],["grandg","\u{1D4A2}"],["Hscr","\u210B"],["bigh","\u210B"],["grandh","\u210B"],["Iscr","\u2110"],["bigi","\u2110"],["grandi","\u2110"],["Jscr","\u{1D4A5}"],["bigj","\u{1D4A5}"],["grandj","\u{1D4A5}"],["Kscr","\u{1D4A6}"],["bigk","\u{1D4A6}"],["grandk","\u{1D4A6}"],["Lscr","\u2112"],["bigl","\u2112"],["grandl","\u2112"],["Mscr","\u2133"],["bigm","\u2133"],["grandm","\u2133"],["Nscr","\u{1D4A9}"],["bign","\u{1D4A9}"],["grandn","\u{1D4A9}"],["Oscr","\u{1D4AA}"],["bigo","\u{1D4AA}"],["grando","\u{1D4AA}"],["Pscr","\u{1D4AB}"],["bigp","\u{1D4AB}"],["grandp","\u{1D4AB}"],["Qscr","\u{1D4AC}"],["bigq","\u{1D4AC}"],["grandq","\u{1D4AC}"],["Rscr","\u211B"],["bigr","\u211B"],["grandr","\u211B"],["Sscr","\u{1D4AE}"],["bigs","\u{1D4AE}"],["grands","\u{1D4AE}"],["Tscr","\u{1D4AF}"],["bigt","\u{1D4AF}"],["grandt","\u{1D4AF}"],["Uscr","\u{1D4B0}"],["bigu","\u{1D4B0}"],["grandu","\u{1D4B0}"],["Vscr","\u{1D4B1}"],["bigv","\u{1D4B1}"],["grandv","\u{1D4B1}"],["Wscr","\u{1D4B2}"],["bigw","\u{1D4B2}"],["grandw","\u{1D4B2}"],["Xscr","\u{1D4B3}"],["bigx","\u{1D4B3}"],["grandx","\u{1D4B3}"],["Yscr","\u{1D4B4}"],["bigy","\u{1D4B4}"],["grandy","\u{1D4B4}"],["Zscr","\u{1D4B5}"],["bigz","\u{1D4B5}"],["grandz","\u{1D4B5}"]];static final List<String> rT=["sin","cos","tan","acos","asin","atan"];static final RegExp sT=new RegExp("^\\s?([0-9]+([\\.,][0-9]+)?|[\\.,][0-9]+)([Ee][+-]?[0-9]+)?\\s?\$");lB(final String h){Kb=new gH();final String j=tT(XW(h));if(h!=''){final aD i=qI(j);XB g;if(i==null)g=null;else g=i.CF();Kb.RB(g);}}gH uK(){return Kb;}String XW(String g){for(final List<String> h in pT){int i=g.indexOf(h[0]);while(i!=-1){g=g.substring(0,i)+h[1]+g.substring(i+h[0].length);i=g.indexOf(h[0]);}}return g;}static bool hH(String i,int h){String g=i[h];if(MN.indexOf(g)==-1)return (false);if(g!='+'&&g!='-')return (true);if(h<2)return (true);g=i[h-1];if(g!='E'&&g!='e')return (true);g=i[h-2];if("0123456789".indexOf(g)!=-1)return (false);return (true);}static String tT(String g){int h=g.indexOf(';');while(h!=-1){int i=0;bool s=false;String o;for(int j=h-1;j>=0&&i>=0;j-- ){o=g[j];if(o==';'&&i==0)break;if(o=='(')i-- ;else if(o==')')i++ ;else if(hH(g,j))s=true;if(i<0&&s){g=g.substring(0,j)+'('+g.substring(j,h)+')'+g.substring(h);h+= 2;}}i=0;s=false;for(int j=h+1;j<g.length&&i>=0;j++ ){o=g[j];if(o=='(')i++ ;else if(o==')')i-- ;else if(hH(g,j))s=true;if((i<0||i==0&&o==';')&&s)g=g.substring(0,h+1)+'('+g.substring(h+1,j)+')'+g.substring(j);if(o==';'&&i==0)break;}final int HB=g.substring(h+1).indexOf(';');if(HB==-1)h=HB;else h+= HB+1;}for(int JB=0;JB<MN.length;JB++ ){final String QB=MN[JB];h=g.indexOf(QB);while(h!=-1&&!hH(g,h))h=g.indexOf(QB,h+1);int SB=h;int m,k;String v=' ',BB=' ';int i;bool EB;while(SB!=-1){EB=false;m=h-1;if(m>=0)v=g[m];i=0;while(m>=0&&(i!=0||v!='(')&&(i!=0||!hH(g,m))){if(v==')')i++ ;else if(v=='(')i-- ;m-- ;if(m>=0)v=g[m];}if(m<0||hH(g,m))EB=true;k=h+1;if(k>=0&&k<=g.length-1)BB=g[k];i=0;while(k<g.length&&(i!=0||BB!=')')&&(i!=0||!hH(g,k))){if(BB=='(')i++ ;else if(BB==')')i-- ;k++ ;if(k<g.length)BB=g[k];}if(k>=g.length||hH(g,k))EB=true;if(EB){g=g.substring(0,m+1)+"("+g.substring(m+1,k)+")"+g.substring(k);h++ ;}SB=g.substring(h+1).indexOf(QB);h=SB+h+1;}}return g;}aD qI(String g){if(g==null||g=='')return null;if(g[0]=='('&&g[g.length-1]==')'){int i=0;for(int h=1;h<g.length-1;h++ ){if(g[h]=='(')i++ ;else if(g[h]==')')i-- ;if(i==-1)break;}if(i!=-1)g=g.substring(1,g.length-1);}int m=-1;int i=0;for(int h=0;h<g.length;h++ ){if(i==0&&hH(g,h)){m=h;break;}else if(g[h]=='(')i++ ;else if(g[h]==')')i-- ;}if(m==-1){bool BB;try {BB=sT.hasMatch(g);}on FormatException catch (hB){BB=false;}if(BB)return (new TI(g));final int o=g.indexOf('(');if(o!=-1&&g[g.length-1]==')'){int s=-1;i=0;for(int h=0;h<g.length;h++ ){final String j=g[h];if(j=='('&&i==0&&h!=o){s=h;break;}else if(j=='(')i++ ;else if(j==')')i-- ;}String CC=null;aD EB=null;if(s==-1){EB=new nG(g.substring(0,o));g=g.substring(o+1,g.length-1);}else{EB=qI(g.substring(0,s));g=g.substring(s+1,g.length-1);}final List<aD> v=new List<aD>();int k=-1;i=0;for(int h=0;h<g.length;h++ ){final String j=g[h];if(j==';'&&i==0){k=h;break;}else if(j=='(')i++ ;else if(j==')')i-- ;}if(k==-1)v.add(qI(g.trim()));else while(k!=-1){v.add(qI(g.substring(0,k).trim()));g=g.substring(k+1);k=-1;i=0;for(int h=0;h<g.length;h++ ){final String j=g[h];if(j==';'&&i==0){k=h;break;}else if(j=='(')i++ ;else if(j==')')i-- ;}if(k==-1)v.add(qI(g.trim()));}return (new iH(EB,v));}else return (new nG(g));}final String cB=g[m];final String QB=g.substring(0,m).trim();aD HB;if(QB=='')HB=null;else HB=qI(QB);final String SB=g.substring(m+1).trim();aD JB;if(SB=='')JB=null;else JB=qI(SB);return (new XE(cB,HB,JB));}static XB HC(final aD g){if(g!=null)return g.CF();final aG h=new aG();h.VC("?");return h;}}typedef void AQ();abstract class aD{XB CF();void XH();}class iH implements aD{aD TF;List<aD> pE;final RegExp IW=new RegExp("^[0-9]+.*\$");iH(final aD g,final List<aD> h){this.TF=g;if(g is nG&&IW.hasMatch(g.TF)){g.TF="?";}pE=h;if((UJ()=="unité"||UJ()=="unit")&&pE.length>1&&pE[1]!=null)pE[1].XH();}void XH(){for(aD g in pE)if(g!=null)g.XH();}String UJ(){if(TF is nG)return ((TF as nG).TF);else return (null);}XB CF(){aD j,o,v,EB;if(pE.length>0)j=pE[0];else j=null;if(pE.length>1)o=pE[1];else o=null;if(pE.length>2)v=pE[2];else v=null;if(pE.length>3)EB=pE[3];else EB=null;String i=UJ();XB h;if(i=="sqrt"||(i=="racine"&&(j==null||o==null))){h=new uP();h.RB(lB.HC(j));}else if(i=="racine"||i=="root"){h=new sP();h.RB(lB.HC(j));h.RB(lB.HC(o));}else if(i=="exp"){h=new UL();final RI MF=new RI();MF.VC("e");h.RB(MF);h.RB(lB.HC(j));}else if(i=="abs"){h=new YC();oB g=new oB();g.VC("|");h.RB(g);h.RB(lB.HC(j));g=new oB();g.VC("|");h.RB(g);}else if(i=="norm"||i=="norme"){h=new YC();oB g=new oB();g.VC("\u2016");h.RB(g);h.RB(lB.HC(j));g=new oB();g.VC("\u2016");h.RB(g);}else if(i=="fact"||i=="factorielle"||i=="factorial"){h=new YC();oB g;if(!(j is nG||j is TI)){g=new oB();g.VC("(");h.RB(g);}h.RB(j.CF());if(!(j is nG||j is TI)){g=new oB();g.VC(")");h.RB(g);}g=new oB();g.VC("!");h.RB(g);}else if(i=="int"||i=="intégrale"){h=new YC();oB g=new oB();g.VC("\u222B");g.ZJ(true);if(v!=null&&EB!=null){final SI s=new SI();s.RB(g);s.RB(lB.HC(v));s.RB(lB.HC(EB));h.RB(s);}else if(v!=null){final sJ IC=new sJ();IC.RB(g);IC.RB(lB.HC(v));h.RB(IC);}else if(EB!=null){final pF k=new pF();k.RB(g);k.RB(lB.HC(EB));h.RB(k);}else h.RB(g);final YC m=new YC();m.RB(lB.HC(j));if(o!=null){g=new oB();g.VC("d");m.RB(g);m.RB(o.CF());}h.RB(m);}else if(i=="prod"||i=="sum"||i=="produit"||i=="somme"){h=new YC();final SI s=new SI();final oB g=new oB();if(i=="prod"||i=="produit")g.VC("\u220F");else if(i=="sum"||i=="somme")g.VC("\u2211");g.ZJ(true);s.RB(g);s.RB(lB.HC(o));s.RB(lB.HC(v));h.RB(s);final YC m=new YC();m.RB(lB.HC(j));h.RB(m);}else if(i=="over"||i=="dessus"){final pF k=new pF();k.RB(lB.HC(j));k.RB(lB.HC(o));h=k;}else if(i=="subsup"){final IN hB=new IN();hB.RB(lB.HC(j));hB.RB(lB.HC(o));hB.RB(lB.HC(v));h=hB;}else if(i=="accent"){final pF k=new pF();k.WP(true);k.RB(lB.HC(j));if(o is XE&&(o as XE).SE=='\u223C'){final oB g=new oB();g.ZJ(true);g.VC("\u223C");k.RB(g);}else k.RB(lB.HC(o));h=k;}else if(i=="matrix"||i=="matrice"){h=new YC();oB g=new oB();g.VC("(");h.RB(g);final qJ QB=new qJ();for(final aD SB in pE)QB.RB(lB.HC(SB));h.RB(QB);g=new oB();g.VC(")");h.RB(g);}else if(i=="system"||i=="système"){h=new YC();final oB g=new oB();g.VC("{");h.RB(g);final qJ QB=new qJ();for(final aD SB in pE){final YC m=new YC();final QI HB=new QI();HB.gW("left");HB.RB(lB.HC(SB));m.RB(HB);QB.RB(m);}h.RB(QB);}else if(i=="line"||i=="ligne"){h=new rP();for(final aD SB in pE){final QI HB=new QI();HB.RB(lB.HC(SB));h.RB(HB);}}else if(i=="slash"){h=new YC();h.RB(lB.HC(j));final oB g=new oB();g.VC("/");h.RB(g);h.RB(lB.HC(o));}else if(i=="frac"||i=="fraction"){final rJ QD=new rJ();QD.RB(lB.HC(j));QD.RB(lB.HC(o));h=QD;}else if(i=="pscalaire"||i=="scalarp"){final YC m=new YC();m.RB(lB.HC(j));final oB g=new oB();g.VC(".");m.RB(g);m.RB(lB.HC(o));return m;}else if(i=="dtemps"||i=="timed"){final pF k=new pF();k.WP(true);k.RB(lB.HC(j));oB CC=new oB();if(o is TI){try {final int eJ=int.parse((o as TI).cP);String tD="";for(int JB=0;JB<eJ;JB++ )tD=tD+'.';CC.VC(tD);}on FormatException catch (ML){CC.VC("?");}}else CC.VC("?");k.RB(CC);h=k;}else if(i=="unité"||i=="unit"){final YC m=new YC();m.RB(lB.HC(j));final oB g=new oB();g.VC(" ");m.RB(g);m.RB(lB.HC(o));return m;}else if(i=="moyenne"||i=="mean"){h=new YC();oB g=new oB();g.VC("\u2329");h.RB(g);h.RB(lB.HC(j));g=new oB();g.VC("\u232A");h.RB(g);}else if(i=="vecteur"||i=="vector"){final XB BB=lB.HC(j);if(BB is RI){BB.aS("bold");h=BB;}else if(BB is VL&&BB.NB(0) is RI){(BB.NB(0) as RI).aS("bold");h=BB;}else{final pF k=new pF();k.WP(true);k.RB(lB.HC(j));final oB g=new oB();g.ZJ(true);g.VC("\u2192");k.RB(g);h=k;}}else{h=new YC();bool qE=true;if(TF is nG){aG WG=new aG();for(final List<String> cB in lB.BQ)if(i==cB[0]){i=cB[1];break;}for(final List<String> cB in lB.DQ)if(i==cB[0]){i=cB[1];break;}WG.VC(i);if(o==null&&j is nG)for(final String fJ in lB.rT)if(i==fJ){qE=false;break;}h.RB(WG);}else h.RB(TF.CF());if(qE){final oB g=new oB();g.VC("(");h.RB(g);}h.RB(lB.HC(j));for(int JB=1;JB<pE.length;JB++ ){final oB g=new oB();g.VC(";");h.RB(g);h.RB(pE[JB].CF());}if(qE){final oB g=new oB();g.VC(")");h.RB(g);}else{final aG NI=new aG();NI.VC("\u00A0");h.RB(NI);}}return h;}}class XE implements aD{String SE;aD PD;aD nD;bool uI;XE(final String h,final aD i,final aD g){SE=h;this.PD=i;this.nD=g;uI=false;if(SE=='#'&&g!=null)g.XH();}void XH(){uI=true;if(PD!=null)PD.XH();if(nD!=null)nD.XH();}XB CF(){if(SE=='/'){final rJ v=new rJ();v.RB(lB.HC(PD));v.RB(lB.HC(nD));return v;}else if(SE=='^'){final UL BB=new UL();bool m;if(PD is iH){String j=(PD as iH).UJ();if(j=="sqrt"||j=="racine")m=false;else if(j=="abs")m=false;else if(j=="matrice")m=false;else if(j=="dtemps"||j=="timed")m=false;else m=true;}else if(PD is XE){String QB=(PD as XE).SE;if(QB=='_')m=false;else m=true;}else m=false;XB k;if(m)k=gI(PD.CF());else k=lB.HC(PD);BB.RB(k);BB.RB(lB.HC(nD));return BB;}else if(SE=='_'){final VL EB=new VL();EB.RB(lB.HC(PD));EB.RB(lB.HC(nD));return EB;}else if(SE=='#'){final YC g=new YC();g.RB(lB.HC(PD));g.RB(lB.HC(nD));return g;}else if(SE=='*'){final YC g=new YC();XB k=lB.HC(PD);if(PD is XE&&"+-".indexOf((PD as XE).SE)!=-1)k=gI(k);g.RB(k);aD o=nD;if(nD!=null)while(o is XE&&(o as XE).PD!=null){o=(o as XE).PD;}final bool SB=o is TI;bool HB=false;if(PD is iH){final String j=(PD as iH).UJ();if(j=="pscalaire"||j=="scalarp")HB=true;}bool JB=false;if(nD is iH){final String j=(nD as iH).UJ();if(j=="pscalaire"||j=="scalarp")JB=true;}if((SB)||(HB&&JB)){final oB i=new oB();i.VC("×");g.RB(i);}else{if(uI){final oB i=new oB();i.VC(".");g.RB(i);}}XB h=lB.HC(nD);if(nD is XE&&"+-".indexOf((nD as XE).SE)!=-1)h=gI(h);g.RB(h);return g;}else if(SE=='-'){final YC g=new YC();if(PD!=null)g.RB(PD.CF());final oB i=new oB();i.VC("-");g.RB(i);if(nD!=null){XB h=nD.CF();if(nD is XE&&"+-".indexOf((nD as XE).SE)!=-1)h=gI(h);g.RB(h);}return g;}else if(SE=='+'){final YC g=new YC();if(PD!=null)g.RB(PD.CF());final oB i=new oB();i.VC("+");g.RB(i);if(nD!=null){XB h=nD.CF();if(h is YC&&h.PC()>0){XB s=h;while(s is YC&&s.PC()>0)s=s.NB(0);if(s.fB()=="-")h=gI(h);}g.RB(h);}return g;}else{final YC g=new YC();if(PD!=null){XB k=PD.CF();if(SE=='\u2227'&&PD is XE&&"+-".indexOf((PD as XE).SE)!=-1)k=gI(k);g.RB(k);}final oB i=new oB();i.VC(SE);if("=\u2260\u2248\u223C\u2261\u2264\u2265\u226A\u226B\u221D".indexOf(SE)!=-1){i.hW(0.5);i.jW(0.5);}g.RB(i);if(nD!=null){XB h=nD.CF();if(SE=='\u2227'&&nD is XE&&"+-".indexOf((nD as XE).SE)!=-1)h=gI(h);g.RB(h);}return g;}}XB gI(final XB i){final YC h=new YC();oB g=new oB();g.VC("(");h.RB(g);h.RB(i);g=new oB();g.VC(")");h.RB(g);return h;}}class TI implements aD{String cP;TI(final String g){this.cP=g;}void XH(){}XB CF(){final tP g=new tP();g.VC(cP);return g;}}class nG implements aD{String TF;bool uI;final RegExp CV=new RegExp("^[0-9]+[a-zA-Z]+\$");nG(final String g){this.TF=g.trim();uI=false;}void XH(){uI=true;}XB CF(){if(TF=="hat"||TF=="chapeau"){final oB h=new oB();h.ZJ(true);h.VC("^");return h;}else if(TF=="bar"||TF=="barre"){final oB h=new oB();h.ZJ(true);h.VC("\u00AF");return h;}else{String g=TF;bool k=uI;for(final List<String> i in lB.BQ)if(g==i[0]){g=i[1];break;}for(final List<String> i in lB.DQ)if(g==i[0]){g=i[1];k=true;break;}if(g.indexOf(',')!=-1||g.indexOf('.')!=-1||g.indexOf('(')!=-1||g.indexOf(')')!=-1)g="?";if(g.indexOf(' ')!=-1)g=g.replaceAll(" ","?");if(g.indexOf('\u00A0')!=-1)g=g.replaceAll("\u00A0","?");if(CV.hasMatch(g))g="?";XB j;if(k)j=new aG();else j=new RI();j.VC(g);return j;}}}abstract class XL{l QM(final String g);List<l> jO(final String g);l iG(final l g,final l h);String cD(final l g);String kI(final l g);String PM(final l g);String hO(final l g);List<String> pK(final l g);List<String> lM(final l g);bool kO(final l g,final String h);List<String> FP();String kG(final String g);String KE();List<l> JD();List<l> II();bool HI(final l g,final l h);bool mD(final l g,final l h);List<l> XC(final l g);String ZD(final l g,final bool h,final bool i);List<l> fC(final l g);List<l> fE(final l g);String attributeName(final l g);String attributeNamespace(final l g);String vG(final l g);String eK(final String g);bool VO(final l g,final l h);List<String> hI(final l g);List<String> aP(final l g);String dF(final l g);WO(final l g,final String h);bool PE(final l g);}class BG extends n{bB Mb;bB Nb;BG():super.xX(n.tC){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);}BG.RY(AB g,n h):super.rX(g,h){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');g.append(Mb.html());SpanElement i=new SpanElement();n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}g.append(i);g.append(Nb.html());g.style.color="#808080";return (g);}Element dD(){return (pB().nodes[1]);}AB KF(sB h){String g=null;if(firstChild!=null)g=firstChild.nodeValue;return (h.YR(g));}}class qF extends n{bB Mb;bB Nb;qF():super.xX(n.tC){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);}qF.QY(AB g,n h):super.rX(g,h){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');g.append(Mb.html());SpanElement i=new SpanElement();n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}g.append(i);g.append(Nb.html());return (g);}Element dD(){return (pB().nodes[1]);}AB KF(sB h){String g=null;if(firstChild!=null)g=firstChild.nodeValue;return (h.XR(g));}void lF(){super.lF();parent.lF();}}class oG extends n{String VG;String nF;oG():super.xX(n.YG){VG='1.0';nF='UTF-8';}oG.UY(AB g):super.rX(g,null){VG=(g as sB).VG;nF=(g as sB).nF;}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');n h=firstChild;while(h!=null){g.append(h.html());h=h.nextSibling;}if(lastChild==null||lastChild.nodeType==n.nB)g.appendText('\n');return (g);}AB KF(sB g){g.VG=VG;g.nF=nF;for(n h=firstChild;h!=null;h=h.nextSibling){g.jB(h.KF(g));}return (g);}}class OB extends n{OB(String g):super.yX(g){}OB.AY(AB g,n h):super.rX(g,h){}Element html(){Element g;g=new SpanElement();g.attributes['id']="${id}";g.attributes['class']='dn';if(nodeValue!=null){g.append(new Text(nodeValue));}return (g);}void XM(q h,String i){assert(h.u==this);String g=nodeValue;if(g==null)g='';nodeValue="${g.substring(0,h.KB)}${i}${g.substring(h.KB)}";}OB QV(int g){String i=nodeValue.substring(0,g);String j=nodeValue.substring(g);nodeValue=i;n h=new OB(j);parent.insertBefore(h,nextSibling);return (h);}AB KF(sB g){return (g.wG(nodeValue));}bool get FD{return (true);}}class IH extends n{bB Mb;bB Nb;IH():super.xX(n.tC){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);}IH.YY(AB g,n h):super.rX(g,h){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');g.append(Mb.html());SpanElement i=new SpanElement();n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}g.append(i);g.append(Nb.html());return (g);}Element dD(){return (pB().nodes[1]);}AB KF(sB h){String g=null;if(firstChild!=null)g=firstChild.nodeValue;return (h.ZR(nodeName,g));}}class wI extends n{bool TG;SD control;wI.IY(l g):super.wX(g){List<l> h=t.CB.XC(DB);TG=(h.length==0);}wI.jY(AB h,n k):super.rX(h,k,createChildren:false){List<l> m=t.CB.XC(DB);TG=(m.length==0);if(h.childNodes!=null){n i=null;for(AB j in h.childNodes){n g;if(TG&&j.nodeType==AB.kE)g=new bG.cY(j,this);else g=ND.fH(j,this);if(i==null)firstChild=g;else i.nextSibling=g;i=g;}}}Element html(){ButtonElement s=jE.fL(DB,null);TableRowElement h=new TableRowElement();h.id="${id}";h.classes.add('dn');TableCellElement g=new TableCellElement();g.classes.add('shrink');g.append(s);h.append(g);g=new TableCellElement();g.classes.add('shrink');g.text=t.CB.OD(DB);if(t.CB.HI(parent.DB,DB))g.classes.add('required');else g.classes.add('optional');h.append(g);g=new TableCellElement();g.classes.add('expand');if(TG){String k;if(firstChild!=null)k=firstChild.nodeValue;else k='';control=new SD.oY(DB,k,valueChanged:()=>bO());Element m=control.html();m.id="content_${id}";TextInputElement o=m.querySelector('input');if(o!=null)o.classes.add('form_field');g.append(m);}else{DivElement i=new DivElement();i.id="content_${id}";i.classes.add('form_field');n j=firstChild;while(j!=null){i.append(j.html());j=j.nextSibling;}g.append(i);}h.append(g);if(parent is jE)(parent as jE).dK(h,this);return (h);}Element dD(){return (document.getElementById("content_${id}"));}void bO(){String h=control.hF();GB g=new GB.vX(LB.MB('form.text_edition'));if(firstChild is OB)g.TB(new GB.sX(firstChild,updateDisplay:false));if(h!='')g.TB(new GB.pX(new q(this,0),new bG(h),updateDisplay:false));t.DC(g);mM();}void BF(List<n> g){sD();}void mM(){if(parent is jE){TableRowElement g=pB();g.nodes.last.remove();(parent as jE).dK(g,this);}}}class xI extends n{String Ob;xI.FY(l g):super.wX(g){Ob=t.CB.bC(DB,'styleAtt','style');}xI.dY(AB g,n h):super.rX(g,h){Ob=t.CB.bC(DB,'styleAtt','style');NG();}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');if(css!=null)g.setAttribute('style',css);for(n h=firstChild;h!=null;){g.append(h.html());h=h.nextSibling;}if(lastChild==null||lastChild.nodeType==n.nB)g.appendText('\n');return (g);}Element dD(){return (pB());}void BF(List<n> i){super.BF(i);DivElement h=dD();if(h.nodes.length>0){Node g=h.nodes.first;while(g!=null){Node j=g.nextNode;if(g is Text||g is BRElement)g.remove();g=j;}}if(lastChild==null||lastChild.nodeType==n.nB)h.appendText('\n');}bool RE(){return (true);}bool get FD{return (true);}void set css(String g){setAttribute(Ob,g);}String get css{return (getAttribute(Ob));}void TW(){GB g=new GB.vX(LB.MB('undo.remove_element'));n h=t.iI(new q(this,0),new q(this,PB));if(t.ZC!=null){kB.SN(parent,h);}g.TB(new GB.sX(this));g.TB(t.LE(h,new q(parent,parent.ZB(this)),checkValidity:false));t.DC(g);}}class xD extends n{xD.CY(l g):super.wX(g){}xD.LY(AB g,n h):super.rX(g,h){NG();}Element html(){LIElement g=new LIElement();g.id="${id}";g.classes.add('dn');n h=firstChild;while(h!=null){g.append(h.html());h=h.nextSibling;}return (g);}Element dD(){return (pB());}bool RE(){return (true);}}class YL extends n{YL.BY(l g):super.wX(g){}YL.JY(AB g,n h):super.rX(g,h){}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');g.classes.add('hr');List<l> h=t.CB.fE(DB);if(h!=null&&h.length>0){g.onClick.listen((MouseEvent i)=>JE());}g.append(new HRElement());return (g);}q QE(){return (null);}q SF(){return (null);}}class ZL extends n{bB Mb;ZL.EY(l g):super.wX(g){}ZL.SY(AB g,n h):super.rX(g,h){}Element html(){Element g;g=new SpanElement();g.id="${id}";g.classes.add('dn');g.append(new BRElement());return (g);}q QE(){return (null);}q SF(){return (null);}}class JH extends n{JH.DY(l g):super.wX(g){}JH.PY(AB g,n h):super.rX(g,h){NG();}Element html(){LIElement h=new LIElement();h.id="${id}";h.classes.add('dn');ImageElement i=new ImageElement(src:'packages/daxe/images/bullet1.png',width:13,height:13);i.classes.add('bullet');List<l> j=t.CB.fE(DB);if(j!=null&&j.length>0)i.onClick.listen((MouseEvent g)=>JE());else{i.onDoubleClick.listen((MouseEvent g){IB.selectNode(this);g.preventDefault();g.stopPropagation();});}h.append(i);SpanElement o=new SpanElement();n k=firstChild;while(k!=null){o.append(k.html());k=k.nextSibling;}h.append(o);ImageElement m=new ImageElement(src:'packages/daxe/images/bullet2.png',width:13,height:13);m.classes.add('bullet');if(j!=null&&j.length>0)m.onClick.listen((MouseEvent g)=>JE());else{m.onDoubleClick.listen((MouseEvent g){IB.selectNode(this);g.preventDefault();g.stopPropagation();});}h.append(m);return (h);}Element dD(){return (pB().nodes[1]);}bool RE(){return (true);}}class pG extends n{String Pb;String Qb;pG.HY(l g):super.wX(g){Pb=t.CB.bC(DB,'nameAtt','name');Qb=t.CB.bC(DB,'hrefAtt','href');}pG.kY(AB g,n h):super.rX(g,h){Pb=t.CB.bC(DB,'nameAtt','name');Qb=t.CB.bC(DB,'hrefAtt','href');}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');g.classes.add('anchor');if(!valid)g.classes.add('invalid');if(firstChild==null){ImageElement h=new ImageElement();h.src='packages/daxe/images/toolbar/anchor.png';h.width=16;h.height=16;if(getAttribute(Pb)!=null)h.title=getAttribute(Pb);h.onClick.listen((MouseEvent j)=>JE());g.append(h);}else{if(getAttribute(Qb)!=null)g.title=getAttribute(Qb);n i=firstChild;while(i!=null){g.append(i.html());i=i.nextSibling;}g.onDoubleClick.listen((MouseEvent j)=>JE());}return (g);}void BF(List<n> g){super.sD();}bool get FD{return (true);}static List<l> vT(){return (t.CB.yG('anchor'));}static void wT(l m){q g=IB.vC();if(g==IB.GF()){if(g.u is OB){String j=g.u.nodeValue;int k=g.KB;int h=k;if(h>0)h-- ;int i=k;while(h>0&&j[h]!=' ')h-- ;while(i<j.length&&j[i]!=' ')i++ ;IB.cursor.gE(new q(g.u,h),new q(g.u,i));}}t.CI(m,'element');}static void AU(l g){t.CI(g,'element');}static void BU(){q k=IB.vC();n h=k.u;while(h!=null){if(h is pG)break;h=h.parent;}if(h==null)return;pG g=h;if(g.firstChild==null){t.eM(g);IB.LC();return;}h=g.parent;GB i=new GB.vX(LB.MB('undo.remove_element'));n m=t.iI(new q(g,0),new q(g,g.PB));i.TB(new GB.sX(g));q j;if(g.previousSibling is OB)j=new q(g.previousSibling,g.previousSibling.PB);else j=new q(h,h.ZB(g));i.TB(t.LE(m,j,checkValidity:false));t.DC(i);IB.LC();}}class SD{static int aL=0;l IF;l AF;String value;String Rb;List<String> UE;List<String> LD;HashMap<String,String> tI;Element BD;DD valueChanged;bool catchUndo;WB MP;SD.oY(this.IF,this.value,{this.valueChanged}){AF=null;Rb="control${aL}";aL++ ;UE=t.CB.pK(IF);if(UE==null||UE.length==0)LD=t.CB.UV(IF);else{if(!UE.contains(''))UE.add('');}catchUndo=true;}SD.zY(this.IF,this.AF,this.value,{this.valueChanged,this.catchUndo: false}){Rb="control${aL}";aL++ ;UE=t.CB.hI(AF);if(UE==null||UE.length==0)LD=t.CB.zU(IF,AF);else{String g=t.CB.dF(AF);if(!UE.contains('')&&g==null)UE.add('');}}Element html(){SpanElement BB=new SpanElement();bool HB;final List<String> SB=['true','false','1','0'];if(UE==null||UE.length!=SB.length||(value!=null&&!SB.contains(value))){HB=false;}else{HB=true;for(int JB=0;JB<UE.length;JB++ ){if(UE[JB]!=SB[JB]){HB=false;break;}}}if(HB){CheckboxInputElement QB=new CheckboxInputElement();BD=QB;if(value==null)value='false';QB.checked=(value=='true'||value=='1');QB.onChange.listen((Event g)=>PJ(true));BB.append(QB);}else if(UE==null||UE.length==0){TextInputElement i=new TextInputElement();i.spellcheck=false;BD=i;i.size=40;if(value==null)value="";i.value=value;PJ(false);i.onInput.listen((Event g)=>PJ(true));i.onKeyUp.listen((KeyboardEvent g){bool v=g.ctrlKey||g.metaKey;bool k=g.shiftKey;int m=g.keyCode;if(catchUndo&&v&&((!k&&m==KeyCode.Z)||(!k&&m==KeyCode.Y)||(k&&m==KeyCode.Z))){}else PJ(true);});if(LD!=null&&LD.length>0){String h;if(AF!=null)h=t.CB.gK(IF,AF,value);else h=t.CB.oK(IF,value);i.value=h;DataListElement cB=new DataListElement();cB.id='datalist_${Rb}';tI=new HashMap<String,String>();MP=new WB('');for(String o in LD){OptionElement j=new OptionElement();String h;if(AF!=null)h=t.CB.gK(IF,AF,o);else h=t.CB.oK(IF,o);j.value=h;tI[h]=o;cB.append(j);MP.add(new uB(h,(){i.value=h;PJ(true);}));}i.attributes['list']='datalist_${Rb}';BB.append(cB);}BB.append(i);if(LD!=null&&LD.length>0){i.style.width="90%";SpanElement s=new SpanElement();s.text='▼';s.style.cursor='default';s.onClick.listen((Event g)=>pW(i));s.onMouseOver.listen((Event g)=>s.style.background='#E0E0E0');s.onMouseOut.listen((Event g)=>s.style.background=null);BB.append(s);}}else{SelectElement EB=new SelectElement();BD=EB;if(value==null)value='';tI=new HashMap<String,String>();for(String o in UE){OptionElement j=new OptionElement();String h;if(AF!=null)h=t.CB.gK(IF,AF,o);else h=t.CB.oK(IF,o);j.text=h;j.value=o;tI[h]=o;if(o==value){j.defaultSelected=true;j.selected=true;}EB.append(j);}if(!UE.contains(value)){OptionElement j=new OptionElement();j.text=value;j.selected=true;EB.append(j);BD.classes.add('invalid');}EB.onChange.listen((Event g)=>PJ(true));BB.append(EB);}if(catchUndo){BD.onKeyDown.listen((KeyboardEvent g){bool v=g.ctrlKey||g.metaKey;bool k=g.shiftKey;int m=g.keyCode;if(v&&!k&&m==KeyCode.Z){g.preventDefault();}else if(v&&((!k&&m==KeyCode.Y)||(k&&m==KeyCode.Z))){g.preventDefault();}});BD.onKeyUp.listen((KeyboardEvent g){bool v=g.ctrlKey||g.metaKey;bool k=g.shiftKey;int m=g.keyCode;if(v&&!k&&m==KeyCode.Z){g.preventDefault();t.aH();}else if(v&&((!k&&m==KeyCode.Y)||(k&&m==KeyCode.Z))){g.preventDefault();t.dM();}});}return (BB);}void PJ(bool i){String j=value;if(BD is InputElement&&(BD as InputElement).type=='text'){String g=(BD as TextInputElement).value;if(tI!=null&&tI[g]!=null)value=tI[g];else value=g;}else if(BD is SelectElement){value=(BD as SelectElement).value;}else if(BD is InputElement&&(BD as InputElement).type=='checkbox'){bool k=(BD as CheckboxInputElement).checked;if(k)value='true';else value='false';}bool h;if(AF!=null)h=t.CB.fS(AF,value);else h=(value==''||t.CB.xO(IF,value));if(h){BD.classes.add('valid');BD.classes.remove('invalid');}else{BD.classes.add('invalid');BD.classes.remove('valid');}if(i&&value!=j&&valueChanged!=null)valueChanged();}String hF()=>value;void jM(String g){this.value=g;if(BD is InputElement&&(BD as InputElement).type=='text'){TextInputElement k=BD as TextInputElement;if(AF!=null)k.value=t.CB.gK(IF,AF,g);else k.value=t.CB.oK(IF,g);}else if(BD is SelectElement){SelectElement i=BD as SelectElement;while(i.options.length>0)i.options[0].remove();for(String j in UE){OptionElement h=new OptionElement();if(AF!=null)h.text=t.CB.gK(IF,AF,j);else h.text=t.CB.oK(IF,j);if(j==g)h.selected=true;i.append(h);}if(!UE.contains(g)){OptionElement h=new OptionElement();h.text=g;h.selected=true;i.append(h);BD.classes.add('invalid');}i.value=g;}else if(BD is InputElement&&(BD as InputElement).type=='checkbox')(BD as CheckboxInputElement).checked=(g=='true'||g=='1');}void focus(){if(BD is TextInputElement){TextInputElement g=BD as TextInputElement;g.select();g.selectionStart=g.selectionEnd=g.value.length;}else if(BD!=null){BD.focus();}}void pW(TextInputElement j){DivElement g=MP.VM();g.style.position='absolute';g.style.display='block';Rectangle h=j.getBoundingClientRect();g.style.left="${h.left}px";g.style.top="${h.bottom}px";g.style.width="${h.width}px";((g.firstChild) as Element).style.width="${h.width}px";document.body.append(g);StreamSubscription<MouseEvent> i=document.onMouseUp.listen(null);i.onData((MouseEvent k){i.cancel();g.remove();k.preventDefault();});}}class jE extends n{List<l> tH;List<l> IE;HashMap<String,SD> sH;bool TG;SD control;jE.fY(l g):super.wX(g){tH=t.CB.XC(DB);IE=t.CB.fE(DB);TG=(tH.length==0&&IE.length==0);yE();}jE.uY(AB h,n k):super.rX(h,k,createChildren:false){tH=t.CB.XC(DB);IE=t.CB.fE(DB);TG=(tH.length==0&&IE.length==0);if(h.childNodes!=null){n i=null;for(AB j in h.childNodes){n g;if(TG&&j.nodeType==AB.kE)g=new bG.cY(j,this);else g=ND.fH(j,this);if(i==null)firstChild=g;else i.nextSibling=g;i=g;}}if(!TG){List<n> m=childNodes;for(n g in m){if(g is OB)gC(g);}}yE();}void yE(){if(IE.length>0)sH=new HashMap<String,SD>();sU();}void sU(){n h=null;for(l i in tH){bool j=false;for(n g in childNodes){if(g.DB==i){j=true;h=g;}}if(!j){n g=ND.NF(i);if(h!=null)insertAfter(g,h);else if(firstChild!=null)insertBefore(g,firstChild);else jB(g);h=g;}}}Element html(){ButtonElement s=fL(DB,null);if(TG){TableRowElement h=new TableRowElement();h.id="${id}";h.classes.add('dn');TableCellElement g=new TableCellElement();g.classes.add('shrink');g.append(s);h.append(g);g=new TableCellElement();g.classes.add('shrink');g.text=t.CB.OD(DB);if(t.CB.HI(parent.DB,DB))g.classes.add('required');else g.classes.add('optional');h.append(g);g=new TableCellElement();String m;if(firstChild!=null)m=firstChild.nodeValue;else m='';control=new SD.oY(DB,m,valueChanged:()=>bO());g.append(control.html());h.append(g);if(parent is jE)(parent as jE).dK(h,this);return (h);}else{DivElement j=new DivElement();j.id="${id}";j.classes.add('dn');j.classes.add('form');SpanElement i=new SpanElement();i.classes.add('form_title');i.append(s);i.appendText(' ');i.appendText(t.CB.OD(DB));if(t.CB.HI(parent.DB,DB))i.classes.add('required');else i.classes.add('optional');j.append(i);TableElement k=new TableElement();k.classes.add('expand');for(l v in IE){k.append(UO(v));}for(l BB in tH){for(n o in childNodes){if(o.DB==BB){o.dJ=true;oU(k,o);}}}j.append(k);return (j);}}void bO(){String h=control.hF();GB g=new GB.vX(LB.MB('form.text_edition'));if(firstChild is OB)g.TB(new GB.sX(firstChild,updateDisplay:false));if(h!='')g.TB(new GB.pX(new q(this,0),new bG(h),updateDisplay:false));t.DC(g);mM();}Element dD(){if(TG){return (pB().nodes[2]);}else{return (pB().nodes[1]);}}TableRowElement UO(l h){String o=t.CB.PH(DB,h);TableRowElement i=new TableRowElement();TableCellElement g=new TableCellElement();g.classes.add('shrink');ButtonElement v=fL(DB,h);g.append(v);i.append(g);g=new TableCellElement();g.classes.add('shrink');g.text=t.CB.fK(DB,h);if(t.CB.BL(DB,h))g.classes.add('required');else g.classes.add('optional');i.append(g);g=new TableCellElement();g.classes.add('expand');String j=getAttribute(o);String s=t.CB.dF(h);if(j==null){if(s!=null)j=s;else j='';}SD k;k=new SD.zY(DB,h,j,valueChanged:()=>aO(h,k),catchUndo:true);sH[o]=k;Element m=k.html();if(m.firstChild is TextInputElement)(m.firstChild as TextInputElement).classes.add('form_field');g.append(m);i.append(g);g=new TableCellElement();g.classes.add('shrink');i.append(g);return (i);}void aO(l j,SD m){String h=m.hF();String k=t.CB.PH(DB,j);String i=t.CB.dF(j);aB g;if((h==''&&i==null)||h==i)g=new aB(k,null);else if(h!=''||i!=null)g=new aB(k,h);else g=null;if(g!=null)t.DC(new GB.uX(this,g,updateDisplay:false));}void oU(TableElement m,n i){Element j=i.html();TableRowElement h;if(j is TableRowElement)h=j;else{h=new TableRowElement();TableCellElement g;int k;if(i is!jE){g=new TableCellElement();ButtonElement o=fL(i.DB,null);g.append(o);h.append(g);k=2;}else k=3;g=new TableCellElement();g.colSpan=k;g.append(j);h.append(g);dK(h,i);}m.append(h);}void dK(TableRowElement k,n g){TableCellElement j=new TableCellElement();j.classes.add('shrink');if(t.CB.nV().mD(DB,g.DB)){if(g.nextSibling==null||g.nextSibling.DB!=g.DB){if(g.firstChild!=null||g is!jE){ButtonElement h=new ButtonElement();h.attributes['type']='button';h.value='+';h.text='+';h.onClick.listen((Event m)=>rU(g));j.append(h);}}if((g.previousSibling!=null&&g.previousSibling.DB==g.DB)||(g.nextSibling!=null&&g.nextSibling.DB==g.DB)){ButtonElement i=new ButtonElement();i.attributes['type']='button';i.value='-';i.text='-';i.onClick.listen((Event m)=>t.eM(g));j.append(i);}}k.append(j);}void rU(n g){n h=ND.NF(g.DB);t.insertNode(h,new q(this,ZB(g)+1));}void JE([DD g]){if(g!=null)g();}void sD(){if(!TG){super.sD();return;}String g;if(firstChild!=null)g=firstChild.nodeValue;else g='';if(control.hF()!=g)control.jM(g);mM();}void BF(List<n> g){sD();}void mM(){if(parent is jE){TableRowElement g=pB();g.nodes.last.remove();(parent as jE).dK(g,this);}}void vI(){DivElement m=pB();TableElement o=querySelector("#${id}>table");int k=0;for(l h in IE){String i=t.CB.PH(DB,h);String g=getAttribute(i);String j=t.CB.dF(h);if(g==null){if(j!=null)g=j;else g='';}sH[i].jM(g);k++ ;}}bool RE(){return (tH.length!=0);}AB KF(sB h){if(tH.length==0)return (super.KF(h));l i=h.createElementNS(qB,nodeName);for(aB j in attributes)i.setAttributeNS(j.qB,j.name,j.value);i.jB(h.wG('\n'));for(n g=firstChild;g!=null;g=g.nextSibling){if(g.firstChild!=null||(g.attributes!=null&&g.attributes.length>0)){i.jB(g.KF(h));i.jB(h.wG('\n'));}}return (i);}static ButtonElement fL(final l i,final l j){ButtonElement g=new ButtonElement();g.attributes['type']='button';g.classes.add('help');g.value='?';g.text='?';if(j==null){String h=t.CB.wH(i);if(h!=null)g.title=h;g.onClick.listen((Event k)=>(new XG.VX(i)).show());}else{String h=t.CB.vG(i,j);if(h!=null)g.title=h;g.onClick.listen((Event k)=>(new XG.XX(j,i)).show());}return (g);}}class yI extends n{bB Mb;yI.GY(l g):super.wX(g){Mb=new bB(this,bB.CN);}yI.aY(AB g,n h):super.rX(g,h){Mb=new bB(this,bB.CN);}Element html(){Element g;g=new SpanElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Mb.html());return (g);}q QE(){return (null);}q SF(){return (null);}Element dD(){return (null);}}class zI extends n{NN Sb;String Tb;zI.NY(l g):super.wX(g){}zI.bY(AB g,n h):super.rX(g,h,createChildren:false){Tb=g.firstChild.nodeValue;}Element html(){Element g=new SpanElement();g.id="${id}";g.classes.add('dn');g.classes.add('special');g.text=Tb;return (g);}void JE([DD g]){Sb=new NN(Tb,okfct:(){Tb=Sb.cV();if(g!=null)g();});Sb.show();}q QE(){return (null);}q SF(){return (null);}AB KF(sB g){l h=g.createElementNS(qB,nodeName);h.jB(g.wG(Tb));return (h);}}class UI extends n{bB Mb;bB Nb;l Ub;UI.KY(l g):super.wX(g){yE();}UI.pY(AB g,n h):super.rX(g,h){yE();NG();}void yE(){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);List<l> g=t.CB.XC(DB);if(g.length>0)Ub=g[0];}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Mb.html());UListElement i=new UListElement();i.classes.add('list');n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}g.append(i);g.append(Nb.html());return (g);}Element dD(){return (pB().nodes[1]);}bool RE(){return (true);}bool RG(){return (true);}static void yT(q h){JH g;if(h.u is JH)g=h.u;else g=h.u.parent;JH i=ND.NF(g.DB);t.insertNode(i,new q(g.parent,g.parent.ZB(g)+1));IB.KD(new q(i,0));IB.LC();}}class AJ extends n{bB Mb;bB Nb;AJ.MY(l g):super.wX(g){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);}AJ.gY(AB g,n h):super.rX(g,h){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);}Element html(){SpanElement g=new SpanElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Mb.html());SpanElement i=new SpanElement();n h=firstChild;while(h!=null){i.append(h.html());h=h.nextSibling;}iM(i);g.append(i);g.append(Nb.html());return (g);}Element dD(){return (pB().nodes[1]);}}class YE extends zB{String Ob;YE.OY(l g):super.tY(g){Ob=t.CB.bC(DB,'styleAtt','style');}YE.hY(AB g,n h):super.vY(g,h){Ob=t.CB.bC(DB,'styleAtt','style');}Element html(){Element g=new SpanElement();g.id="${id}";g.classes.add('dn');if(firstChild!=null){SpanElement h=new SpanElement();n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}if(css!=null)h.setAttribute('style',css);g.append(h);}else{bB j=new bB(this,bB.ME);bB k=new bB(this,bB.iE);g.append(j.html());SpanElement h=new SpanElement();h.setAttribute('style',css);g.append(h);g.append(k.html());}return (g);}void set css(String g){setAttribute(Ob,g);}String get css{return (getAttribute(Ob));}void BF(List<n> g){super.sD();}Element dD(){if(firstChild!=null)return (pB().nodes.first);else return (pB().nodes[1]);}static l EQ(){return (t.CB.nO('stylespan'));}bool matches(zB g){if(g is YE){uD h=new uD(css);uD i=new uD(g.css);return (h.VV(i));}else{return (false);}}bool CH(String g,String h){if(css==null)return (false);uD i=new uD(css);return (i[g]==h);}bool LS(String g){if(css==null)return (false);uD h=new uD(css);return (h[g]!=null);}}class BJ extends n{SD control;BJ.TY(l g):super.wX(g){}BJ.eY(AB h,n k):super.rX(h,k,createChildren:false){if(h.childNodes!=null){n i=null;for(AB j in h.childNodes){n g;if(j.nodeType==AB.kE)g=new bG.cY(j,this);else g=ND.fH(j,this);if(i==null)firstChild=g;else i.nextSibling=g;i=g;}}}Element html(){Element g;g=new SpanElement();g.id="${id}";g.classes.add('dn');g.classes.add('simple_type');List<l> j=t.CB.fE(DB);if(j!=null&&j.length>0){ImageElement k=new ImageElement(src:'images/attributes.png',width:16,height:15);k.onClick.listen((MouseEvent h)=>JE());g.append(k);}String m=t.CB.OD(DB);g.append(new Text(m));String i;if(firstChild!=null)i=firstChild.nodeValue;else i='';control=new SD.oY(DB,i,valueChanged:()=>HV());g.append(control.html());g.onDoubleClick.listen((MouseEvent h){IB.selectNode(this);h.preventDefault();h.stopPropagation();});return (g);}void HV(){String h=control.hF();GB g=new GB.vX(LB.MB('form.text_edition'));if(firstChild is OB)g.TB(new GB.sX(firstChild,updateDisplay:false));if(h!='')g.TB(new GB.pX(new q(this,0),new bG(h),updateDisplay:false));t.DC(g);control.focus();}void sD(){String g;if(firstChild!=null)g=firstChild.nodeValue;else g='';if(control.hF()!=g)control.jM(g);}q QE(){return (null);}q SF(){return (null);}}class iC extends n{l Ub;String type;iC.VY(l g):super.wX(g){yE();}iC.qY(AB h,n i):super.rX(h,i){yE();NG();for(n g in childNodes){if(g is OB&&g.nodeValue.trim()==''){gC(g);}}}void yE(){Ub=cL(DB);type=t.CB.bC(DB,'type','ul');}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');Element h;if(type=='ul')h=new UListElement();else h=new OListElement();h.classes.add('wlist');n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}g.append(h);return (g);}q QE(){if(firstChild==null){return (null);}return (new q(firstChild,0));}q SF(){if(lastChild==null){return (null);}return (new q(lastChild,lastChild.PB));}Element dD(){return (pB().firstChild);}bool RE(){return (true);}bool RG(){return (true);}static l cL(l h){List<l> g=t.CB.XC(h);if(g.length>0)return (g[0]);return (null);}static void FQ(l QB){l qE=cL(QB);q BB=IB.vC();q NI=IB.GF();GB j=new GB.vX(t.CB.OD(QB));q SB;xD i=new xD.CY(qE);n m=BB.u;while(m!=null&&m is!iC){m=m.parent;}if(m is iC&&m.DB!=QB){SB=new q.hX(BB);iC v=new iC.VY(QB);for(n h=m.firstChild;h!=null;h=h.nextSibling){v.jB(new n.zX(h));}j.TB(new GB.pX(new q(m.parent,m.parent.ZB(m)),v));j.TB(new GB.sX(m));t.DC(j);IB.KD(SB);IB.LC();return;}n g=BB.u;while(g!=null&&g is!kB)g=g.parent;if(g is kB){for(n h=g.firstChild;h!=null;h=h.nextSibling)i.jB(new n.zX(h));if(g.previousSibling is iC&&g.nextSibling is iC){j.TB(new GB.pX(new q(g.previousSibling,g.previousSibling.PB),i));n MF=new n.zX(g.nextSibling);j.TB(t.LE(MF,new q(g.previousSibling,g.previousSibling.PB+1)));j.TB(new GB.sX(g.nextSibling));}else if(g.previousSibling is iC){j.TB(new GB.pX(new q(g.previousSibling,g.previousSibling.PB),i));}else if(g.nextSibling is iC){j.TB(new GB.pX(new q(g.nextSibling,0),i));}else{n v=new iC.VY(QB);v.jB(i);j.TB(new GB.pX(new q(g.parent,g.parent.ZB(g)),v));}j.TB(new GB.sX(g));SB=new q(i,i.PB);}else{n k=BB.u;int WG=BB.KB;while(k is OB||k is zB){WG=k.parent.ZB(k);k=k.parent;}int CC=WG;while(CC>0){n h=k.eB(CC-1);if((h is!OB&&!t.CB.fD(qE,h.DB))||h.RE())break;CC-- ;}q EB=new q(k,CC);n HB=BB.u;int cB=BB.KB;while(HB is OB||HB is zB){cB=HB.parent.ZB(HB)+1;HB=HB.parent;}assert(HB==k);while(cB<k.PB){n h=k.eB(cB);if((h is!OB&&!t.CB.fD(qE,h.DB))||h.RE())break;cB++ ;}q s=new q(k,cB);n IC;if(EB<s){IC=t.iI(EB,s);for(n h=IC.firstChild;h!=null;h=IC.firstChild){IC.gC(h);i.jB(h);}n QD=i.eB(0);if(QD is OB){String hB=QD.nodeValue.trimLeft();if(hB=='')i.gC(QD);else QD.nodeValue=hB;}n tD=i.eB(i.PB-1);if(tD is OB){String hB=tD.nodeValue.trimRight();if(hB=='')i.gC(tD);else tD.nodeValue=hB;}}n o;if(EB.KB>0)o=EB.u.eB(EB.KB-1);else o=null;n JB;if(s.KB<s.u.PB)JB=s.u.eB(s.KB);else JB=null;if(o is iC&&JB is iC){j.TB(new GB.pX(new q(o,o.PB),i));n MF=new n.zX(JB);j.TB(t.LE(MF,new q(o,o.PB+1)));j.TB(new GB.sX(JB));}else if(o is iC){j.TB(new GB.pX(new q(o,o.PB),i));}else if(JB is iC){j.TB(new GB.pX(new q(JB,0),i));}else{n v=new iC.VY(QB);v.jB(i);j.TB(new GB.pX(s,v));}if(EB<s)j.TB(t.GI(EB,s));SB=new q(i,i.PB);}t.DC(j);IB.KD(SB);IB.LC();}static void RN(){q SB=IB.vC();n g=SB.u;while(g!=null&&g is!xD)g=g.parent;if(g==null)return;GB i=new GB.vX(LB.MB('toolbar.lower_level'));xD s=g;iC j=s.parent;n v=null;if(s.nextSibling!=null){v=new iC.VY(j.DB);for(g=s.nextSibling;g!=null;g=g.nextSibling){v.jB(new n.zX(g));i.TB(new GB.sX(g));}}n h=new n.zX(s);q BB;if(j.parent is xD){xD JB=j.parent;iC QB=JB.parent;if(v!=null)h.jB(v);i.TB(new GB.pX(new q(QB,QB.ZB(JB)+1),h));BB=new q(h,h.PB);}else{q m=new q(j.parent,j.parent.ZB(j)+1);if(v!=null)i.TB(new GB.pX(m,v));if(t.ZC!=null&&t.CB.fF(j.parent.DB,t.ZC)!=null){l EB=t.CB.fF(j.parent.DB,t.ZC);if(h.firstChild!=null){n o=h.firstChild;n HB=null;kB k=null;while(o!=null){HB=o.nextSibling;if(o is OB||t.CB.fD(EB,o.DB)){if(k==null)k=new kB.XY(EB);h.gC(o);k.jB(o);h.insertBefore(k,HB);}else{k=null;}o=HB;}BB=m;i.TB(t.LE(h,m));}else{kB k=new kB.XY(EB);i.TB(new GB.pX(m,k));BB=new q(k,0);}}else{if(h.firstChild!=null){BB=m;i.TB(t.LE(h,m));}else{BB=m;}}}if(s.previousSibling!=null)i.TB(new GB.sX(s));else i.TB(new GB.sX(j));t.DC(i);IB.KD(BB);IB.LC();}static void GU(){q s=IB.vC();n g=s.u;while(g!=null&&g is!xD)g=g.parent;if(g==null)return;xD i=g;xD h=i.previousSibling;if(h==null)return;GB j=new GB.vX(LB.MB('toolbar.rise_level'));j.TB(new GB.sX(i));n k=new n.zX(i);if(h.lastChild is iC){iC m=h.lastChild;j.TB(new GB.pX(new q(m,m.PB),k));}else{n o=new iC.VY(i.parent.DB);o.jB(k);j.TB(new GB.pX(new q(h,h.PB),o));}t.DC(j);IB.KD(new q(k,k.PB));IB.LC();}static void HU(q k){xD g;n h=k.u;while(h!=null&&h is!xD)h=h.parent;assert(h!=null);if(h==null)return;g=h;q i=new q(g.parent,g.parent.ZB(g));q o=new q(g.parent,g.parent.ZB(g)+1);n s=t.IG(g,i,k);n m=t.IG(g,k,o);GB j=new GB.vX(LB.MB('undo.insert_text'));j.TB(new GB.pX(i,s));i=new q(g.parent,g.parent.ZB(g)+1);j.TB(new GB.pX(i,m));j.TB(new GB.sX(g));t.DC(j);IB.KD(new q(m,0));IB.LC();}static List<l> IU(){List<l> g=new List<l>();List<l> i=t.CB.yG('wlist');for(l h in i)if(t.CB.bC(h,'type','ul')=='ul')g.add(h);return (g);}static List<l> JU(){List<l> g=new List<l>();List<l> i=t.CB.yG('wlist');for(l h in i)if(t.CB.bC(h,'type','ul')=='ol')g.add(h);return (g);}}class bG extends OB{bG(String g):super(g){}bG.cY(AB g,n h):super.AY(g,h){}void sD(){parent.sD();}}class kB extends n{String Ob;kB.XY(l g):super.wX(g){Ob=t.CB.bC(DB,'styleAtt','style');}kB.mY(AB g,n h):super.rX(g,h){Ob=t.CB.bC(DB,'styleAtt','style');}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');g.classes.add('hiddenp');if(!valid)g.classes.add('invalid');if(css!=null)g.setAttribute('style',css);for(n h=firstChild;h!=null;){g.append(h.html());h=h.nextSibling;}return (g);}Element dD(){return (pB());}bool get FD{return (true);}bool RE(){return (true);}void set css(String g){setAttribute(Ob,g);}String get css{return (getAttribute(Ob));}bool CH(String g,String h){if(css==null)return (false);uD i=new uD(css);return (i[g]==h);}static void uT(String j){List<kB> g=dL();if(g.length==0)return;GB h=new GB.vX(LB.MB('style.remove_styles'));for(kB k in g){GB i=xT(k,j);if(i!=null)h.TB(i);}t.DC(h);IB.cursor.refresh();}static GB xT(kB g,String i){String k=g.css;if(k==null)return (null);uD h=new uD(g.css);if(h[i]!=null){h.remove(i);String m=h.toString();aB j=g.RM(g.Ob);j.value=m;return (new GB.tX(g,[j],updateDisplay:true));}return (null);}static void zT(String j,String k){List<kB> g=dL();if(g.length==0)return;GB h=new GB.vX(LB.MB('style.apply_style'));for(kB m in g){GB i=CU(m,j,k);if(i!=null)h.TB(i);}t.DC(h);IB.cursor.refresh();}static GB CU(kB g,String k,String m){uD i=new uD(g.css);i[k]=m;String j=i.toString();aB h=g.RM(g.Ob);if(h==null)h=new aB(g.Ob,j);else h.value=j;return (new GB.tX(g,[h],updateDisplay:true));}static List<kB> dL(){List<kB> j=new List<kB>();q h=IB.vC();q m=IB.GF();n i=h.u;while(i!=null&&i is!kB)i=i.parent;n g;if(i is kB)g=i;else if(h.u is OB)g=h.u.parent;else if(h.KB<h.u.PB)g=h.u.eB(h.KB);else if(h.u.PB==0)g=h.u;else g=h.u.lastChild.nextNode();if(g==null)return (j);if(g is kB)j.add(g);if(g.parent==null)return (j);q k=new q(g.parent,g.parent.ZB(g)+1);while(k<m){g=g.nextNode();if(g==null)break;if(g is kB)j.add(g);k=new q(g.parent,g.parent.ZB(g)+1);}return (j);}static bool DU(){q o=IB.vC();q k=IB.GF();n g=o.u;int SB=o.KB;while(g is OB||g is zB){SB=g.parent.ZB(g);g=g.parent;}if(g is kB){GB h=new GB.vX(LB.MB('undo.insert_text'));kB i=g;q IC=new q(i.parent,i.parent.ZB(i));q MF=new q(i,0);q QD=new q(i,i.PB);assert(k<=QD);n s=t.IG(i,MF,o);n j=t.IG(i,k,QD);h.TB(new GB.sX(i));h.TB(new GB.pX(IC,j));h.TB(new GB.pX(IC,s));t.DC(h);IB.KD(new q(j,0));IB.LC();return (true);}if(o.u!=k.u)return (false);if(g.DB==null)return (false);if(g is kB)return (false);l v=t.CB.fF(g.DB,t.ZC);if(v==null)return (false);if(!t.CB.WM(g,SB,SB,v))return (false);GB h=new GB.vX(LB.MB('undo.insert_text'));int EB=SB;while(EB>0){n HB=g.eB(EB-1);if(HB is!OB&&!t.CB.fD(v,HB.DB))break;EB-- ;}q JB=new q(g,EB);n s=null;if(JB<o)s=t.IG(g,JB,o);n m=k.u;int QB=k.KB;while(m is OB||m is zB){QB=m.parent.ZB(m)+1;m=m.parent;}assert(m==g);while(QB<g.PB){n HB=g.eB(QB);if(HB is!OB&&!t.CB.fD(v,HB.DB))break;QB++ ;}q cB=new q(g,QB);n j=null;if(cB>k){j=t.IG(g,k,cB);n hB=j.eB(j.PB-1);if(hB is OB){String BB=hB.nodeValue;if(BB.length>0&&BB[BB.length-1]=='\n'){if(BB.length==1)j.gC(hB);else hB.nodeValue=BB.substring(0,BB.length-1);}}}if(JB<cB){h.TB(t.GI(JB,cB));}int tD=EB;if(s!=null||g.PB==0){kB qE=ND.NF(v);h.TB(new GB.pX(JB,qE));if(s!=null)h.TB(t.LE(s,new q(qE,0)));tD++ ;}kB CC=ND.NF(v);h.TB(new GB.pX(new q(g,tD),CC));if(j!=null)h.TB(t.LE(j,new q(CC,0)));t.DC(h);IB.KD(new q(CC,0));IB.LC();return (true);}static void SN(n j,n i){if(t.ZC==null)return;n k;for(n g=i.firstChild;g!=null;g=k){k=g.nextSibling;if(g is kB&&!t.CB.fD(j.DB,g.DB)){n o;for(n m=g.firstChild;m!=null;m=o){o=m.nextSibling;g.gC(m);i.insertBefore(m,g);}i.gC(g);}}l h;if(j.DB!=null)h=t.CB.fF(j.DB,t.ZC);else h=null;if(h!=null){for(n g=i.firstChild;g!=null;g=k){k=g.nextSibling;if(g.DB!=h&&((g is OB&&!t.CB.PE(j.DB))||(!t.CB.fD(j.DB,g.DB)&&t.CB.fD(h,g.DB)))){i.gC(g);if(g.previousSibling!=null&&g.previousSibling.DB==h){g.previousSibling.jB(g);}else{kB s=new kB.XY(h);s.jB(g);i.insertBefore(s,k);}}}}}}class CJ extends n{bB Mb;bB Nb;CJ.WY(l g):super.wX(g){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);}CJ.lY(AB g,n h):super.rX(g,h){Mb=new bB(this,bB.ME);Nb=new bB(this,bB.iE);NG();}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Mb.html());DivElement h=new DivElement();h.classes.add('indent');n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}if(lastChild==null||lastChild.nodeType==n.nB)h.appendText('\n');iM(h);g.append(h);g.append(Nb.html());return (g);}void BF(List<n> i){super.BF(i);DivElement h=dD();if(h.nodes.length>0){Node g=h.nodes.first;while(g!=null){Node j=g.nextNode;if(g is Text||g is BRElement)g.remove();g=j;}}if(lastChild==null||lastChild.nodeType==n.nB)h.appendText('\n');}void vI(){Element g=pB().nodes[0];Mb=new bB(this,bB.ME,true);g.replaceWith(Mb.html());}Element dD(){return (pB().nodes[1]);}bool RE(){return (true);}bool RG(){return (true);}}class bL extends n{bB Mb;bB Nb;bL.ZY(l g):super.wX(g){Mb=new bB(this,bB.ME,true);Nb=new bB(this,bB.iE,true);}bL.nY(AB g,n h):super.rX(g,h){Mb=new bB(this,bB.ME,true);Nb=new bB(this,bB.iE,true);NG();}Element html(){DivElement g=new DivElement();g.id="${id}";g.classes.add('dn');if(!valid)g.classes.add('invalid');g.append(Mb.html());DivElement h=new DivElement();h.classes.add('indent');n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}if(lastChild==null||lastChild.nodeType==n.nB)h.appendText('\n');g.append(h);g.append(Nb.html());return (g);}void BF(List<n> i){super.BF(i);DivElement h=dD();if(h.nodes.length>0){Node g=h.nodes.first;while(g!=null){Node j=g.nextNode;if(g is Text||g is BRElement)g.remove();g=j;}}if(lastChild==null||lastChild.nodeType==n.nB)h.appendText('\n');}void vI(){Element g=pB().nodes[0];Mb=new bB(this,bB.ME,true);g.replaceWith(Mb.html());}Element dD(){return (pB().nodes[1]);}bool RE(){return (true);}bool RG(){return (true);}}class jH extends n{ImageElement Vb;String Wb;jH.iY(l g):super.wX(g){Wb=t.CB.bC(DB,'srcAtt','src');}jH.sY(AB g,n h):super.rX(g,h){Wb=t.CB.bC(DB,'srcAtt','src');}Element html(){assert(t.SH!=null);Vb=new ImageElement();Vb.id="${id}";Vb.classes.add('dn');String g='';String h=t.SH;int i=h.lastIndexOf('/');if(i!=-1)g=h.substring(0,i+1);String j="${g}${getAttribute(Wb)}";Vb.src=j;Vb.alt=getAttribute(Wb);Vb.onLoad.listen((Event k)=>tV());Vb.onClick.listen((MouseEvent k)=>JE());return (Vb);}void tV(){if(Vb.naturalWidth>500){Vb.width=500;}if(IB.vC()!=null&&IB.vC()>new q(this,0))IB.cursor.bH(false);}q QE(){return (null);}q SF(){return (null);}}class DJ extends n{ImageElement Vb;String Xb;String Yb;HN Sb;DJ.rY(l g):super.wX(g){Xb=t.CB.bC(DB,'texteAtt','src');oD.CQ();}DJ.wY(AB g,n h):super.rX(g,h,createChildren:false){Xb=t.CB.bC(DB,'texteAtt','src');if(g.firstChild!=null)Yb=g.firstChild.nodeValue.replaceAll('\n','');else Yb=null;oD.CQ();}Element html(){Vb=new ImageElement();Vb.attributes['id']="${id}";Vb.attributes['class']='dn';if(Yb!=null){String g="data:image/png;base64,${Yb}";Vb.attributes['src']=g;}Vb.onLoad.listen((Event h)=>oO());Vb.onClick.listen((MouseEvent h)=>JE());Vb.style.verticalAlign='middle';return (Vb);}void oO(){if(Vb.naturalWidth>500){Vb.width=500;}}q QE(){return (null);}q SF(){return (null);}void JE([DD h]){String g=getAttribute(Xb);if(g==null)g='';Sb=new HN(g,okfct:(){String g=Sb.fB();if(pB()!=null){aB i=new aB(Xb,g);GB j=new GB.uX(this,i,updateDisplay:false);t.DC(j);}else{setAttribute(Xb,g);}Yb=Sb.getData();if(Vb!=null){String k="data:image/png;base64,${Yb}";Vb.attributes['src']=k;}if(h!=null)h();Vb.onLoad.listen((Event m)=>IB.KD(new q(parent,parent.ZB(this)+1)));});Sb.show();}void vI(){IL();sD();}void IL(){String j=getAttribute(Xb);lB h=new lB(j);CanvasElement k=new CanvasElement(width:500,height:300);oD i=new oD(element:h.uK(),context:k.context2D);CanvasElement g=new CanvasElement(width:i.dB(),height:i.OC());oD m=new oD(element:h.uK(),context:g.context2D);m.GC(g.context2D);String o=g.toDataUrl('image/png');Yb=o.substring('data:image/png;base64,'.length);}AB KF(sB k){l h=k.createElementNS(qB,nodeName);for(aB i in attributes)h.setAttributeNS(i.qB,i.name,i.value);if(Yb!=null){StringBuffer j=new StringBuffer();String g=Yb;while(g!=''){if(g.length<=76){j.write(g);g='';}else{j.writeln(g.substring(0,76));g=g.substring(76);}}h.jB(k.wG(j.toString()));}return (h);}}class zB extends n{String Zb;zB.tY(l g):super.wX(g){Zb=t.CB.bC(g,'style',null);}zB.vY(AB g,n h):super.rX(g,h){Zb=t.CB.bC(DB,'style',null);}Element html(){Element g=new SpanElement();g.id="${id}";g.classes.add('dn');if(firstChild!=null){SpanElement h=new SpanElement();n i=firstChild;while(i!=null){h.append(i.html());i=i.nextSibling;}iM(h);g.append(h);}else{bB j=new bB(this,bB.ME);bB k=new bB(this,bB.iE);g.append(j.html());SpanElement h=new SpanElement();g.append(h);g.append(k.html());}return (g);}void BF(List<n> g){super.sD();}Element dD(){if(firstChild!=null)return (pB().nodes.first);else return (pB().nodes[1]);}bool get FD{return (true);}void set css(String g){assert(false);}String get css{return (null);}bool matches(zB g){if(g is YE)return (false);return (DB==g.DB);}bool CH(String g,String h){return (false);}bool LS(String g){return (false);}static sE GQ(q h,q i,[l BB,String hB]){h=new q.qX(h);i=new q.qX(i);IB.cursor.xG();h.zE();i.zE();assert(h!=i);GB o=new GB.vX(LB.MB('style.remove_styles'));n g=EU(h.u,i.u);n s=g.parent;while(s!=null){if(s is zB&&(BB==null||TN(s,BB,hB)))g=s;s=s.parent;}if(g is OB){q QB=new q.hX(h);q SB=new q.mX(i);sE cB=new sE(o,QB,SB);return (cB);}if(g is zB)g=g.parent;q j=new q(g,0);q EB=new q(g,g.PB);n k;if(j!=h)k=t.IG(g,j,h);else k=null;n v=t.IG(g,h,i);n m;if(EB!=i)m=t.IG(g,i,EB);else m=null;if(BB==null)HQ(v);else QN(v,BB,cssName:hB);int CC=new q.hX(j).HF;int HB;if(k!=null){HB=IQ(k);if(k.lastChild is OB&&v.firstChild is OB){HB-- ;}}else HB=0;q QB=new q.UX(CC+HB);int IC=new q.mX(EB).UF;int JB;if(m!=null){JB=IQ(m);if(m.firstChild is OB&&v.lastChild is OB){JB-- ;}}else JB=0;q SB=new q.aX(IC+JB);o.TB(t.GI(j,EB));if(m!=null)o.TB(t.LE(m,j,checkValidity:false));o.TB(t.LE(v,j,checkValidity:false));if(k!=null)o.TB(t.LE(k,j,checkValidity:false));sE cB=new sE(o,QB,SB);return (cB);}static n EU(n i,n j){n g=i;while(g!=null){n h=j;while(h!=null){if(g==h){return (g);}if(h.parent==null)break;h=h.parent;}if(g.parent==null)break;g=g.parent;}return (null);}static HQ(n h){for(n g=h.firstChild;g!=null;){if(g is zB){n j=g.firstChild;for(n i=g.firstChild;i!=null;){n k=i.nextSibling;h.insertBefore(i,g);i=k;}h.gC(g);g=j;}else{HQ(g);g=g.nextSibling;}}h.normalize();}static QN(n h,l j,{String cssName,String cssValue}){for(n g=h.firstChild;g!=null;){if((cssValue!=null&&UN(g,j,cssName,cssValue))||TN(g,j,cssName)){if(g is YE&&cssName!=null&&(new uD((g as YE).css)).keys.length>1){uD k=new uD((g as YE).css);k.remove(cssName);(g as YE).css=k.toString();}else{n m=g.firstChild;for(n i=g.firstChild;i!=null;){n o=i.nextSibling;h.insertBefore(i,g);i=o;}h.gC(g);g=m;}}else{QN(g,j,cssName:cssName,cssValue:cssValue);g=g.nextSibling;}}h.normalize();}static int IQ(n i){n k=i;int m=i.PB;int j=0;n g=i;int h=0;while(g!=k||h!=m){if(h==g.PB){h=g.parent.ZB(g)+1;g=g.parent;}else if(g is OB){h++ ;}else{g=g.eB(h);h=0;}j++ ;}return (j);}static GB FU(q o,[l k,String i]){n h=o.u;if(h is OB)h=h.parent;for(n g=h;g!=null;g=g.parent){if((k==null&&g is zB)||TN(g,k,i)){if(g is YE&&i!=null&&(new uD((g as YE).css)).keys.length>1){uD m=new uD((g as YE).css);m.remove(i);aB s=new aB((g as YE).Ob,m.toString());return (new GB.uX(g,s));}else{GB j=new GB.vX(LB.MB('undo.remove_element'));n v=new n.zX(g);q BB=new q(g.parent,g.parent.ZB(g)+1);j.TB(t.LE(v,BB,checkValidity:false));j.TB(new GB.sX(g));return (j);}}}return (null);}static void eL([l i,String j]){q g=IB.vC();q k=IB.GF();if(g==null)return;if(g==k){GB m=FU(g,i,j);if(m!=null)t.DC(m);IB.LC();}else{sE h=GQ(g,k,i,j);t.DC(h.xH);IB.cursor.gE(h.start,h.end);IB.LC();}}static bool TN(n g,l i,String h){if(g is!zB)return (false);if(g.DB!=i)return (false);if(h==null)return (true);if((g as zB).css==null)return (false);return ((g as zB).LS(h));}static bool UN(n g,l h,String i,String j){if(g is!zB)return (false);if(g.DB!=h)return (false);if((g as zB).css==null)return (true);return ((g as zB).CH(i,j));}static sE JQ(q k,q m,l o,{String cssName,String cssValue}){assert(k!=m);GB EB=new GB.vX(LB.MB('style.apply_style'));q HB=k;q s=new q.hX(k);q g=new q.qX(k);g.zE();if(g.u is OB&&g.KB==0){n h=g.u.previousSibling;if(h is zB&&UN(h,o,cssName,cssValue)){HB=new q(h.parent,h.parent.ZB(h));s=new q.hX(g);s.PG(-2);if(h.lastChild is OB)s.PG(-1);}}q v=m;q BB=new q.mX(m);q j=new q.qX(m);j.zE();if(j.u is OB&&j.KB==j.u.PB){n i=g.u.nextSibling;if(i is zB&&UN(i,o,cssName,cssValue)){v=new q(i.parent,i.parent.ZB(i)+1);BB=new q.mX(j);BB.PG(2);if(i.firstChild is OB)BB.PG(1);}}n JB=t.iI(HB,v);QN(JB,o,cssName:cssName,cssValue:cssValue);VN(JB,o,cssName,cssValue);EB.TB(t.LE(JB,v,checkValidity:false));EB.TB(t.GI(HB,v));return (new sE(EB,s,BB));}static void KQ(l i,{String cssName,String cssValue}){q g=IB.vC();q o=IB.GF();if(g==o){n h=g.u;if(h is OB)h=h.parent;n j=ND.NF(i,'element');if(cssName!=null&&cssValue!=null)(j as zB).css="${cssName}: ${cssValue}";bool s=false;if(t.ZC!=null){if(!t.CB.fD(h.DB,i)){l k=t.CB.fF(h.DB,t.ZC);if(k!=null&&t.CB.fD(k,i)){kB v=new kB.XY(k);v.jB(j);t.insertNode(v,g);s=true;}}}if(!s)t.insertNode(j,g);q BB=j.QE();if(BB!=null){IB.KD(BB);IB.LC();}return;}sE m=JQ(g,o,i,cssName:cssName,cssValue:cssValue);t.DC(m.xH);IB.cursor.gE(m.start,m.end);IB.LC();}static void VN(n i,l j,String k,String m){if(t.CB.fD(i.DB,j)){n h=null;for(n g=i.firstChild;g!=null;){if(g is OB||t.CB.fD(j,g.DB)){n o=g.nextSibling;i.gC(g);if(h==null){h=ND.NF(j,'element');if(k!=null&&m!=null)(h as zB).css="${k}: ${m}";}h.jB(g);g=o;}else{if(h!=null){i.insertBefore(h,g);h=null;}VN(g,j,k,m);g=g.nextSibling;}}if(h!=null)i.jB(h);}else{for(n g=i.firstChild;g!=null;g=g.nextSibling){if(g is!OB)VN(g,j,k,m);}}}static void KU(l g,String h,String k){q m=IB.vC();q o=IB.GF();if(m==o){zB.KQ(g,cssName:h,cssValue:k);}else{sE i=zB.GQ(m,o,g,h);t.DC(i.xH);sE j=JQ(i.start,i.end,g,cssName:h,cssValue:k);t.DC(j.xH);t.lK(LB.MB('style.apply_style'),2);IB.cursor.gE(j.start,j.end);IB.LC();}}static sE WN(q g){zB h=null,i=null;if(g.u is zB&&g.KB==g.u.PB)h=g.u;else if(g.u is OB&&g.KB==g.u.PB&&g.u.parent is zB&&g.u.parent.ZB(g.u)==g.u.parent.PB)h=g.u.parent;else if(g.u is!OB&&g.KB>0&&g.u.PB>0&&g.u.eB(g.KB-1) is zB)h=g.u.eB(g.KB-1);if(g.u is zB&&g.KB==0)i=g.u;else if(g.u is OB&&g.KB==0&&g.u.parent is zB&&g.u.parent.ZB(g.u)==0)i=g.u.parent;else if(g.u is!OB&&g.KB<g.u.PB&&g.u.PB>0&&g.u.eB(g.KB) is zB)i=g.u.eB(g.KB);if(h==null||i==null)return (null);if(!h.matches(i))return (null);q j;if(h.lastChild is OB&&i.firstChild is OB)j=new q(h.lastChild,h.lastChild.PB);else j=new q(h,h.PB);GB k=new GB.vX('merge');k.TB(new GB.sX(i));n m=new n.zX(i);k.TB(t.LE(m,new q(h,h.PB)));return (new sE(k,j,new q.qX(j)));}}class EJ extends n{ImageElement Vb;String Xb;String ab;String bb;String Yb;PN Sb;EJ.xY(l g):super.wX(g){Xb=t.CB.bC(DB,'texteAtt',null);ab=t.CB.bC(DB,'labelAtt',null);bb=t.CB.bC(DB,'serveur',null);}EJ.BZ(AB g,n h):super.rX(g,h,createChildren:false){Xb=t.CB.bC(DB,'texteAtt','texte');bb=t.CB.bC(DB,'serveur',null);if(g.firstChild!=null)Yb=g.firstChild.nodeValue;else Yb=null;}Element html(){Vb=new ImageElement();Vb.attributes['id']="${id}";Vb.attributes['class']='dn';if(Yb!=null){String g="data:image/png;base64,${Yb}";Vb.attributes['src']=g;}Vb.onLoad.listen((Event h)=>oO());Vb.onClick.listen((MouseEvent h)=>JE());Vb.style.verticalAlign='middle';return (Vb);}void oO(){if(Vb.naturalWidth>500){Vb.width=500;}}q QE(){return (null);}q SF(){return (null);}void JE([DD g]){String h=getAttribute(Xb);String i=getAttribute(ab);Sb=new PN(bb,h,labelName:ab,labelValue:i,okfct:()=>uU(g));Sb.show();}void uU(DD g){if(g!=null)g();String j=Sb.fB();String h=Sb.kR();if(g==null){List<aB> i=new List<aB>();i.add(new aB(Xb,j));if(ab!=null&&h!='')i.add(new aB(ab,h));GB k=new GB.tX(this,i,updateDisplay:false);t.DC(k);}else{setAttribute(Xb,j);if(ab!=null)setAttribute(ab,h);}IL();}void vI(){IL();}void IL(){String g=getAttribute(Xb);getData(g).then((String h){Yb=h;sD();IB.KD(new q(parent,parent.ZB(this)+1));},onError:(Object i){window.alert(i.toString());});}Future<String> getData(String g){if(g==null||g=='')g='?';Completer<String> h=new Completer<String>();String j="${bb}?${Uri.encodeComponent(g)}";HttpRequest.request(j,method:'GET',responseType:'arraybuffer').then((HttpRequest k){Object i=k.response;if(i is ByteBuffer){Uint8List m=new Uint8List.view(i);String o=JT.KT(m);h.complete(o);}else h.completeError(new CD('request response is not a ByteBuffer'));},onError:(Object s){h.completeError(new CD("Error getting the equation image from the server ${bb} : ${s}"));});return (h.future);}AB KF(sB i){l g=i.createElementNS(qB,nodeName);for(aB h in attributes)g.setAttributeNS(h.qB,h.name,h.value);if(Yb!=null)g.jB(i.wG(Yb));return (g);}}class cG extends n{String cb;String eb;String fb;l gb;l hb;l ib;String jb;String kb;String lb;String mb;String nb;String ob;bool header;cG.yY(l g):super.wX(g){yE();OV();}cG.AZ(AB h,n i):super.rX(h,i,createChildren:false){yE();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE&&g.nodeName==jb)pb(g);}for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE&&g.nodeName==kb)pb(g);}pb(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE&&g.nodeName==lb)pb(g);}if(firstChild!=null&&firstChild.firstChild is CG)header=true;}void pb(AB j){for(AB h=j.firstChild;h!=null;h=h.nextSibling){if(h.nodeType==AB.FE&&h.nodeName==cb){n i=new rE.DZ(h,this);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g.nodeType==AB.FE){if(g.nodeName==eb){n k=new NC.FZ(g,i);i.jB(k);}else if(g.nodeName==fb){n m=new CG.HZ(g,i);i.jB(m);}}}jB(i);}}}void yE(){nM=true;cb=t.CB.bC(DB,'trTag','tr');List<l> g=t.CB.nK(cb);gb=t.CB.fF(DB,g);eb=t.CB.bC(DB,'tdTag','td');List<l> h=t.CB.nK(eb);hb=t.CB.fF(gb,h);fb=t.CB.bC(DB,'thTag','th');List<l> i=t.CB.nK(fb);ib=t.CB.fF(gb,i);kb=t.CB.bC(DB,'tbodyTag','tbody');jb=t.CB.bC(DB,'theadTag','thead');lb=t.CB.bC(DB,'tfootTag','tfoot');mb=t.CB.bC(DB,'colspanAttr',null);nb=t.CB.bC(DB,'rowspanAttr',null);ob=t.CB.bC(DB,'alignAttr',null);header=false;}Element html(){DivElement j=new DivElement();j.id="${id}";j.classes.add('dn');j.classes.add('table');FormElement g=new FormElement();g.classes.add('table_buttons');ButtonElement v=new ButtonElement();v.attributes['type']='button';v.appendText(LB.MB("table.Table"));v.onClick.listen((MouseEvent h)=>JE());v.style.marginRight='1em';g.append(v);ButtonElement BB=new ButtonElement();BB.attributes['type']='button';BB.appendText(LB.MB("table.Row"));BB.onClick.listen((MouseEvent h)=>bW());BB.style.marginRight='0.2em';g.append(BB);ButtonElement EB=new ButtonElement();EB.attributes['type']='button';EB.appendText("+");EB.onClick.listen((MouseEvent h)=>insertRow());EB.style.marginRight='0.2em';g.append(EB);ButtonElement HB=new ButtonElement();HB.attributes['type']='button';HB.appendText("-");HB.onClick.listen((MouseEvent h)=>UW());HB.style.marginRight='1em';g.append(HB);g.appendText(LB.MB('table.Column'));ButtonElement JB=new ButtonElement();JB.attributes['type']='button';JB.appendText("+");JB.onClick.listen((MouseEvent h)=>vV());JB.style.marginRight='0.2em';g.append(JB);ButtonElement QB=new ButtonElement();QB.attributes['type']='button';QB.appendText("-");QB.onClick.listen((MouseEvent h)=>SW());QB.style.marginRight='1em';g.append(QB);ButtonElement SB=new ButtonElement();SB.attributes['type']='button';SB.appendText(LB.MB("table.Cell"));SB.onClick.listen((MouseEvent h)=>GV());SB.style.marginRight='1em';g.append(SB);CheckboxInputElement cB=new CheckboxInputElement();cB.id="header${id}";cB.checked=header;cB.onClick.listen((MouseEvent h)=>sW());g.append(cB);LabelElement hB=new LabelElement();hB.htmlFor="header${id}";hB.appendText(LB.MB('table.header'));hB.style.marginRight='1em';g.append(hB);ButtonElement k=new ButtonElement();k.attributes['type']='button';ImageElement i=new ImageElement();i.src='packages/daxe/images/mergeright.png';k.append(i);k.onClick.listen((MouseEvent h)=>FW());k.style.marginRight='0.2em';k.title=LB.MB('table.merge_right');g.append(k);ButtonElement m=new ButtonElement();m.attributes['type']='button';i=new ImageElement();i.src='packages/daxe/images/splitx.png';m.append(i);m.onClick.listen((MouseEvent h)=>cS());m.style.marginRight='0.2em';m.title=LB.MB('table.split_x');g.append(m);ButtonElement o=new ButtonElement();o.attributes['type']='button';i=new ImageElement();i.src='packages/daxe/images/mergebottom.png';o.append(i);o.onClick.listen((MouseEvent h)=>EW());o.style.marginRight='0.2em';o.title=LB.MB('table.merge_bottom');g.append(o);ButtonElement s=new ButtonElement();s.attributes['type']='button';i=new ImageElement();i.src='packages/daxe/images/splity.png';s.append(i);s.onClick.listen((MouseEvent h)=>ZP());s.style.marginRight='0.2em';s.title=LB.MB('table.split_y');g.append(s);j.append(g);TableElement IC=new TableElement();IC.classes.add('indent');n CC=firstChild;while(CC!=null){IC.append(CC.html());CC=CC.nextSibling;}j.append(IC);return (j);}q QE(){if(firstChild==null||firstChild.firstChild==null){return (null);}return (new q(firstChild.firstChild,0));}q SF(){if(lastChild==null||lastChild.lastChild==null){return (null);}return (new q(lastChild.lastChild,lastChild.lastChild.PB));}void OV(){int j=2;int k=2;for(int g=0;g<j;g++ ){rE h=new rE.CZ(gb);for(int i=0;i<k;i++ ){NC m=new NC.EZ(hb);h.jB(m);}jB(h);}}void bW(){rE g=sO();if(g==null)return;g.JE();}void insertRow(){rE h=sO();if(h==null)return;n g=new rE.CZ(gb);for(int i=0;i<eP();i++ ){NC j=new NC.EZ(hb);g.jB(j);}t.insertNode(g,new q(this,ZB(h)+1));IB.KD(g.QE());}void UW(){rE g=sO();if(g==null)return;GB h=new GB.vX(LB.MB('undo.remove'));for(NC i in g.childNodes){if(i.SG>1)ZP(i,h);}h.TB(new GB.sX(g));t.DC(h);}void vV(){NC g=oI();if(g==null)return;GB j=new GB.vX(LB.MB('undo.insert'));int m=lI(g);for(n h in childNodes){NC i;if(firstChild==h&&header)i=new CG.GZ(ib);else i=new NC.EZ(hb);int k=0;for(NC g=h.firstChild;g!=null&&m>=lI(g);g=g.nextSibling){k++ ;}j.TB(new GB.pX(new q(h,k),i));}t.DC(j);IB.KD(new q(g.nextSibling,0));}void SW(){NC g=oI();if(g==null)return;q h;if(g.nextSibling!=null)h=new q(g.nextSibling,0);else if(g.previousSibling!=null)h=new q(g.previousSibling,0);else h=null;GB j=new GB.vX(LB.MB('undo.remove'));int k=lI(g);int i=0;for(n m in childNodes){NC g=TM(k,i);while(g.JG>1){cS(g);g=TM(k,i);}j.TB(new GB.sX(g));i++ ;}t.DC(j);if(h!=null)IB.KD(h);}void GV(){NC g=oI();if(g==null)return;g.JE();}NC oI(){q h=IB.vC();n g=h.u;while(g!=null&&g is!NC)g=g.parent;return (g);}rE sO(){q h=IB.vC();n g=h.u;while(g!=null&&g is!rE)g=g.parent;return (g);}NC TM(int g,int h){return (grid()[g][h]);}int lI(NC j){List<List<NC>> h=grid();for(int g=0;g<h.length;g++ )for(int i=0;i<h[0].length;i++ )if(h[g][i]==j)return (g);assert(false);return (-1);}int pO(NC j){List<List<NC>> h=grid();for(int i=0;i<h.length;i++ )for(int g=0;g<h[0].length;g++ )if(h[i][g]==j)return (g);assert(false);return (-1);}List<List<NC>> grid(){int j=eP();int s=jS();List<List<NC>> h=new List<List<NC>>(j);for(int g=0;g<j;g++ )h[g]=new List<NC>(s);int k=0;for(rE v in childNodes){int g=0;for(NC i in v.childNodes){while(g<j&&h[g][k]!=null)g++ ;for(int m=0;m<i.JG;m++ ){for(int o=0;o<i.SG;o++ ){h[g+m][k+o]=i;}}g+= i.JG;}k++ ;}return (h);}int eP(){int g=0;for(rE i in childNodes){int h=0;for(NC j in i.childNodes){h+= j.JG;}g=max(g,h);}return (g);}int jS(){int g=0;for(rE h in childNodes){NC i=h.firstChild;g+= i.SG;}return (g);}void sW(){rE j=firstChild;if(j==null)return;n g=j.firstChild;while(g!=null){n s=g.nextSibling;if(header&&g is CG){NC k=new NC.EZ(hb);n h=g.firstChild;while(h!=null){n m=h.nextSibling;g.gC(h);k.jB(h);h=m;}for(aB i in g.attributes)k.setAttribute(i.name,i.value);g.replaceWith(k);}else if(!header&&g is NC&&g is!CG){CG o=new CG.GZ(ib);n h=g.firstChild;while(h!=null){n m=h.nextSibling;g.gC(h);o.jB(h);h=m;}for(aB i in g.attributes)o.setAttribute(i.name,i.value);g.replaceWith(o);}g=s;}header=!header;j.sD();}void FW([NC g]){if(g==null)g=oI();if(g==null)return;int m=lI(g);int o=pO(g);int j=m+g.JG;if(j>=eP())return;NC k=TM(j,o);if(k.parent!=g.parent)ZP(k);NC h=g.nextSibling;if(h==null)return;if(h.SG!=g.SG){return;}GB i=new GB.vX(LB.MB('table.merge'));i.TB(new GB.uX(g,new aB(mb,(g.JG+h.JG).toString())));i.TB(new GB.sX(h));t.DC(i);IB.KD(g.QE());IB.LC();}void EW([NC g]){if(g==null)g=oI();if(g==null)return;int k=lI(g);int m=pO(g);int j=m+g.SG;if(j>=jS())return;NC h=TM(k,j);if(h.JG!=g.JG){return;}GB i=new GB.vX(LB.MB('table.merge'));i.TB(new GB.uX(g,new aB(nb,(g.SG+h.SG).toString())));i.TB(new GB.sX(h));t.DC(i);IB.KD(g.QE());IB.LC();}void cS([NC g,GB i]){if(g==null)g=oI();if(g==null)return;if(g.JG<2)return;NC j;if(g is CG)j=new CG.GZ(ib);else j=new NC.EZ(hb);rE k=g.parent;GB h;if(i!=null)h=i;else h=new GB.vX(LB.MB('table.split'));h.TB(new GB.pX(new q(k,k.ZB(g)+1),j));h.TB(new GB.uX(g,new aB(mb,(g.JG-1).toString())));if(i==null)t.DC(h);}void ZP([NC g,GB i]){if(g==null)g=oI();if(g==null)return;if(g.SG<2)return;int m=lI(g);int o=pO(g);int s=o+g.SG-1;rE j=eB(s);if(j==null)return;int k=0;for(NC g=j.firstChild;g!=null&&m>lI(g);g=g.nextSibling){k++ ;}NC v=new NC.EZ(hb);GB h;if(i!=null)h=i;else h=new GB.vX(LB.MB('table.split'));h.TB(new GB.pX(new q(j,k),v));h.TB(new GB.uX(g,new aB(nb,(g.SG-1).toString())));if(i==null)t.DC(h);}bool RE(){return (true);}bool RG(){return (true);}}class NN{static final List<List<String>> VI=[["\u0393","\u0394","\u0398","\u039B","\u039E","\u03A0","\u03A3","\u03A5","\u03A6","\u03A7","\u03A8","\u03A9"],["\u03B1","\u03B2","\u03B3","\u03B4","\u03B5","\u03B6","\u03B7","\u03B8","\u03B9","\u03BA","\u03BB","\u03BC","\u03BD","\u03BE","\u03BF","\u03C0","\u03C1","\u03C2","\u03C3","\u03C4","\u03C5","\u03C6","\u03C7","\u03C8","\u03C9"],["\u03D1","\u03D5","\u03D6"],["\u00AC","\u00B1","\u00D7","\u2113","\u2102","\u2115","\u211A","\u211D","\u2124","\u212B","\u2190","\u2192","\u2194","\u21D0","\u21D2","\u21D4","\u2200","\u2202","\u2203","\u2205","\u2207","\u2208","\u2209","\u2211","\u221D","\u221E","\u2227","\u2228","\u2229","\u222A","\u222B","\u223C","\u2248","\u2260","\u2261","\u2264","\u2265","\u2282"],["\u{1D49C}","\u212C","\u{1D49E}","\u{1D49F}","\u2130","\u2131","\u{1D4A2}","\u210B","\u2110","\u{1D4A5}","\u{1D4A6}","\u2112","\u2133","\u{1D4A9}","\u{1D4AA}","\u{1D4AB}","\u{1D4AC}","\u211B","\u{1D4AE}","\u{1D4AF}","\u{1D4B0}","\u{1D4B1}","\u{1D4B2}","\u{1D4B3}","\u{1D4B4}","\u{1D4B5}"]];static final int ON=13;String RH;DD okfct;TableCellElement lG;NN(this.RH,{this.okfct}){}void show(){DivElement s=new DivElement();s.id='dlg1';s.classes.add('dlg1');DivElement HB=new DivElement();HB.classes.add('dlg2');DivElement JB=new DivElement();JB.classes.add('dlg3');FormElement QB=new FormElement();int cB=0;for(int g=0;g<VI.length;g++ )cB+= (VI[g].length/ON).ceil();TableElement h=new TableElement();h.classes.add('special_dlg');int i=0;for(int g=0;g<VI.length;g++ ){TableRowElement m=new TableRowElement();for(int o=0;o<VI[g].length;o++ ){TableCellElement v=new TableCellElement();v.text=VI[g][o];v.style.textAlign='center';if(RH==VI[g][o]){lG=v;lG.style.border='1px solid black';}m.append(v);i++ ;if(i>=ON){i=0;if(o<VI[g].length-1){h.append(m);m=new TableRowElement();}}}if(i!=0){for(int SB=i;SB<ON;SB++ )m.append(new TableCellElement());i=0;}h.append(m);}h.onClick.listen((MouseEvent j)=>select(j.target));h.onDoubleClick.listen((MouseEvent j){select(j.target);if(lG!=null)iF(null);});QB.append(h);DivElement BB=new DivElement();BB.classes.add('buttons');ButtonElement EB=new ButtonElement();EB.attributes['type']='button';EB.appendText(LB.MB("button.Cancel"));EB.onClick.listen((MouseEvent j)=>cancel());BB.append(EB);ButtonElement k=new ButtonElement();k.id='special_ok';if(RH==null)k.disabled=true;k.attributes['type']='submit';k.appendText(LB.MB("button.OK"));k.onClick.listen((MouseEvent j)=>iF(j));BB.append(k);QB.append(BB);JB.append(QB);HB.append(JB);s.append(HB);document.body.append(s);}void select(EventTarget h){if(h is!Node)return;Node g=h as Node;if(g is TableCellElement){if(lG!=null)lG.style.border='';lG=g;}else if(g.parent is TableCellElement){if(lG!=null)lG.style.border=null;lG=g.parent;}else return;lG.style.border='1px solid black';RH=lG.text;ButtonElement i=querySelector('button#special_ok');i.disabled=false;}void iF(MouseEvent g){querySelector('div#dlg1').remove();if(g!=null)g.preventDefault();if(okfct!=null)okfct();}void cancel(){querySelector('div#dlg1').remove();IB.AH();}String cV(){return (RH);}}class PN{String qb;String rb;String sb;DD tb;String bb;String Yb;PN(this.bb,String g,{String labelName,String labelValue,DD okfct}){qb=g;rb=labelName;sb=labelValue;tb=okfct;}void show(){DivElement i=new DivElement();i.id='dlg1';i.classes.add('dlg1');DivElement v=new DivElement();v.classes.add('dlg2');DivElement BB=new DivElement();BB.classes.add('dlg3');FormElement h=new FormElement();ImageElement EB=new ImageElement();EB.id='eqimg';EB.src=jR();h.append(EB);TextAreaElement g=new TextAreaElement();g.id='eqtext';if(qb!=null)g.value=qb;g.style.width='100%';g.style.height='4em';g.attributes['spellcheck']='false';g.onInput.listen((Event j)=>IV());h.append(g);if(rb!=null){DivElement k=new DivElement();SpanElement QB=new SpanElement();QB.text=rb;k.append(QB);k.appendText(' ');TextInputElement HB=new TextInputElement();HB.id='eqlabel';if(sb!=null)HB.value=sb;k.append(HB);h.append(k);}DivElement SB=new DivElement();ButtonElement JB=new ButtonElement();JB.appendText(LB.MB("equation.preview"));JB.onClick.listen((MouseEvent j)=>RW(j));SB.append(JB);h.append(SB);DivElement m=new DivElement();m.classes.add('buttons');ButtonElement o=new ButtonElement();o.attributes['type']='button';o.appendText(LB.MB("button.Cancel"));o.onClick.listen((MouseEvent j)=>i.remove());m.append(o);ButtonElement s=new ButtonElement();s.attributes['type']='submit';s.appendText(LB.MB("button.OK"));s.onClick.listen((MouseEvent j)=>iF(j));m.append(s);h.append(m);BB.append(h);v.append(BB);i.append(v);document.body.append(i);g.focus();}void iF(MouseEvent g){TextAreaElement h=querySelector('textarea#eqtext');qb=h.value;if(rb!=null){TextInputElement i=querySelector('input#eqlabel');sb=i.value;}querySelector('div#dlg1').remove();if(g!=null)g.preventDefault();if(tb!=null)tb();}String fB(){return (qb);}void IL(){if(qb=='')return (null);ImageElement g=querySelector('img#eqimg');CanvasElement h=new CanvasElement(width:g.width,height:g.height);CanvasRenderingContext2D i=h.context2D;i.drawImage(g,0,0);String j=h.toDataUrl('image/png');Yb=j.substring('data:image/png;base64,'.length);}String kR(){return (sb);}String jR(){String g=qb;if(g==null||g=='')g='?';return ("${bb}?${Uri.encodeComponent(g)}");}void vW(){ImageElement g=querySelector('img#eqimg');g.src=jR();}void RW(MouseEvent g){g.preventDefault();TextAreaElement h=querySelector('textarea#eqtext');qb=h.value;vW();}void IV(){TextAreaElement h=querySelector('textarea#eqtext');String g=h.value;if(g.length>0&&g.contains('\n')){h.value=g.replaceAll('\n','');iF(null);return;}}}class rE extends n{rE.CZ(l g):super.wX(g){dJ=true;nM=true;}rE.DZ(AB g,n h):super.rX(g,h,createChildren:false){dJ=true;nM=true;NG();}Element html(){TableRowElement g=new TableRowElement();g.attributes['id']="${id}";g.attributes['class']='dn';n h=firstChild;while(h!=null){g.append(h.html());h=h.nextSibling;}return (g);}q QE(){if(firstChild==null){return (null);}return (new q(firstChild,0));}q SF(){if(lastChild==null){return (null);}return (new q(lastChild,lastChild.PB));}bool RE(){return (true);}}class NC extends n{NC.EZ(l g):super.wX(g){dJ=true;}NC.FZ(AB g,n h):super.rX(g,h){dJ=true;NG();}Element html(){TableCellElement g=new TableCellElement();g.id="${id}";g.classes.add('dn');if(this is CG)g.classes.add('header');g.attributes['rowspan']=SG.toString();g.attributes['colspan']=JG.toString();if(align!='')g.attributes['align']=align;n h=firstChild;while(h!=null){g.append(h.html());h=h.nextSibling;}if(lastChild==null||!lastChild.eC)g.appendText(' ');return (g);}void BF(List<n> h){super.BF(h);TableCellElement g=pB();if(lastChild==null||!lastChild.eC){if(g.lastChild is!Text)g.appendText(' ');}else{if(g.lastChild is Text)g.lastChild.remove();}}int get SG{cG h=parent.parent;String g=getAttribute(h.nb);if(g==null||g=='')return (1);else return (int.parse(g,onError:(String i)=>1));}int get JG{cG h=parent.parent;String g=getAttribute(h.mb);if(g==null||g=='')return (1);else return (int.parse(g,onError:(String i)=>1));}String get align{cG h=parent.parent;String g=getAttribute(h.ob);if(g==null||g=='')return ('');else return (g);}}class sE{GB xH;q start;q end;sE(this.xH,this.start,this.end);}class CG extends NC{CG.GZ(l g):super.EZ(g){}CG.HZ(AB g,n h):super.FZ(g,h){NG();}}class gL implements XL{HashMap<String,String> ub;l vb;HashMap<String,l> wb;HashMap<l,String> xb;gL(l g,HashMap<String,String> h){vb=g;ub=h;yb();}l QM(final String g){return (wb[g]);}List<l> jO(final String g){return ([wb[g]]);}l iG(final l g,final l i){String h;if(g.EC==null)h=g.nodeName;else h=g.localName;return (QM(h));}String cD(final l g){return (xb[g]);}String kI(final l g){return (null);}String PM(final l g){return (null);}String hO(final l g){return (null);}List<String> pK(final l g){return (null);}List<String> lM(final l g){return (null);}bool kO(final l g,final String h){return (true);}List<String> FP(){return (null);}String kG(final String g){return (null);}String KE(){return (null);}List<l> JD(){return (new List.from(xb.keys));}List<l> II(){return (JD());}bool HI(final l g,final l h){return (false);}bool mD(final l g,final l h){return (true);}List<l> XC(final l j){final List<l> h=new List<l>();final List<AB> k=j.getElementsByTagName('SOUS-ELEMENT');for(int g=0;g<k.length;g++ ){final l v=k[g] as l;h.add(wb[v.getAttribute('element')]);}final List<AB> m=j.getElementsByTagName('SOUS-ENSEMBLE');for(int g=0;g<m.length;g++ ){final l BB=m[g] as l;final String EB=BB.getAttribute('ensemble');final List<AB> o=vb.getElementsByTagName('ENSEMBLE');for(int i=0;i<o.length;i++ ){final l s=o[i] as l;if(EB==s.getAttribute('nom'))h.addAll(XC(s));}}return (h);}String ZD(final l m,final bool k,final bool o){final List<l> j=XC(m);final StringBuffer g=new StringBuffer();final int i=j.length;for(int h=0;h<i;h++ ){if(h!=0)g.write('|');if(k)g.write(zb(j[h]));else g.write(cD(j[h]));if(!k)g.write(',');}if(i!=0){String i=g.toString();g.clear();g.write('(');g.write(i);g.write(')*');}return (g.toString());}List<l> fC(final l j){final List<l> i=new List<l>();if(j.nodeName=='ELEMENT'){final List<AB> k=vb.getElementsByTagName('SOUS-ELEMENT');for(int h=0;h<k.length;h++ ){final l m=k[h] as l;if(m.getAttribute('element')==j.getAttribute('nom')){final l g=m.parentNode as l;if(g.nodeName=='ELEMENT')i.add(g);else if(g.nodeName=='ENSEMBLE')i.addAll(fC(g));}}}else if(j.nodeName=='ENSEMBLE'){final String v=j.getAttribute('nom');final List<AB> o=vb.getElementsByTagName('SOUS-ENSEMBLE');for(int h=0;h<o.length;h++ ){final l s=o[h] as l;if(s.getAttribute('ensemble')==v){final l g=s.parentNode as l;if(g.nodeName=='ELEMENT')i.add(g);else if(g.nodeName=='ENSEMBLE')i.addAll(fC(g));}}}return (i);}List<l> fE(final l h){final List<AB> i=h.getElementsByTagName('ATTRIBUT');final List<l> g=new List<l>();for(AB j in i)g.add(j as l);return (g);}String attributeName(final l g){return (g.getAttribute('nom'));}String attributeNamespace(final l g){return (null);}String vG(final l g){return (null);}String eK(final String g){return (null);}bool VO(final l i,final l g){final String h=g.getAttribute('presence');return (h=='obligatoire');}List<String> hI(final l j){final List<AB> g=j.getElementsByTagName('VALEUR');if(g.length==0)return (null);final List<String> i=new List<String>();for(int h=0;h<g.length;h++ ){final l k=g[h] as l;final String m=k.firstChild.nodeValue.trim();i.add(m);}return (i);}List<String> aP(final l g){return (null);}String dF(final l g){return (null);}WO(final l h,final String g){final String j=h.getAttribute('presence');bool k=(j=='obligatoire');if((g==null||g=='')&&k)return (false);final List<String> i=hI(h);if(i!=null)return (i.contains(g));return (true);}bool PE(final l g){final String h=g.getAttribute('texte');return (h=='autorise');}void yb(){wb=new HashMap<String,l>();xb=new HashMap<l,String>();final List<AB> i=vb.getElementsByTagName('ELEMENT');for(int g=0;g<i.length;g++ ){final l h=i[g] as l;final String j=h.getAttribute('nom');wb[j]=h;xb[h]=j;}}String zb(final l h){String g=xb[h];if(ub[g]!=null)return (ub[g]);else return (g);}}class LB{static String LQ="packages/daxe/LocalStrings";static HashMap<String,String> XN=null;static String hL;static const LU='en';static Future<bool> MU(){Completer<bool> i=new Completer<bool>();bQ().then((String k){if(k!=null)hL=k;else hL=LU;String m=hL.split('_')[0];String o="${LQ}_${m}.properties";HttpRequest g=new HttpRequest();g.open("GET",o);g.onLoad.listen((ProgressEvent s){String v=g.responseText;XN=new HashMap<String,String>();List<String> BB=v.split("\n");for(String h in BB){if(h.startsWith('#'))continue;int j=h.indexOf('=');if(j==-1)continue;String EB=h.substring(0,j).trim();String HB=h.substring(j+1).trim();XN[EB]=HB;}i.complete(true);});g.onError.listen((ProgressEvent s){i.completeError("Error when reading the strings in ${LQ}");});g.send();});return (i.future);}static String MB(String g){return (XN[g]);}}class YN implements vB{List<uJ> Ac;YN(final l h){Ac=new List<uJ>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="documentation"){Ac.add(new uJ(g as l));break;}}}String sK(){if(Ac==null)return (null);StringBuffer g=new StringBuffer();for(uJ h in Ac){if(h.hF()!=null)g.write(h.hF());}return (g.toString());}}class rF implements Exception{final String message;final Exception parentException;const rF([this.message,this.parentException]);String toString(){String g;if(message==null)g='WXSException';else g=message;if(parentException!=null)g="${g} (parent exception: ${parentException})";return (g);}}class lD extends DE implements sC{List<vB> Bc;String Cc=null;String Dc=null;lD Ec=null;l Fc;sC Gc;YB Hc;lD(final l h,final sC j,final YB i){Ic(h);Bc=new List<vB>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="attribute")Bc.add(new iB(g as l,this,i));else if(g.localName=="attributeGroup")Bc.add(new lD(g as l,this,i));}}if(h.AC("name"))Cc=h.getAttribute("name");if(h.AC("ref"))Dc=h.getAttribute("ref");Fc=h;this.Gc=j;this.Hc=i;}String gF(){return (Hc.KE());}sC getParent(){return (Gc);}void BC(final YB h,final vB j){for(vB g in Bc){if(g is iB)g.BC(h);else if(g is lD)g.BC(h,j);}if(Dc!=null){final String k=wB.aE(Dc);String i;if(k=="xml")i="http://www.w3.org/XML/1998/namespace";else i=Fc.YD(k);Ec=h.YW(wB.ZE(Dc),i,j);}}String getName(){if(Cc==null&&Ec!=null)return (Ec.getName());return (Cc);}List<FB> fC(){if(Gc!=null)return (Gc.fC());return (new List<FB>());}List<iB> attributes(){if(Ec!=null)return (Ec.attributes());final List<iB> h=new List<iB>();for(vB g in Bc){if(g is iB)h.add(g);else if(g is lD)h.addAll(g.attributes());}return (h);}}class iB extends DE{jC Jc=null;String Cc=null;String Dc=null;String Kc=null;String Lc=null;String Mc=null;String Nc=null;String Oc=null;iB Ec=null;l Fc;sC Gc;YB Hc;iB(final l g,final sC j,final YB i){Ic(g);for(AB h=g.firstChild;h!=null;h=h.nextSibling){if(h is l&&h.localName=="simpleType"){Jc=new jC(h as l,null,i);break;}}if(g.AC("name"))Cc=g.getAttribute("name");if(g.AC("ref"))Dc=g.getAttribute("ref");if(g.AC("type"))Kc=g.getAttribute("type");if(g.AC("use"))Lc=g.getAttribute("use");if(g.AC("default"))Mc=g.getAttribute("default");if(g.AC("fixed"))Nc=g.getAttribute("fixed");if(g.AC("form"))Oc=g.getAttribute("form");Fc=g;this.Gc=j;this.Hc=i;}void BC(final YB h){if(Jc!=null)Jc.BC(h,null);if(Dc!=null){final String i=wB.aE(Dc);String g;if(i=="xml")g="http://www.w3.org/XML/1998/namespace";else g=Fc.YD(i);Ec=h.ZW(wB.ZE(Dc),g);if(Ec==null)print("WXSAttribute: Référence d'attribut introuvable : ${Dc}");}if(Jc==null&&Kc!=null){final String g=Fc.YD(wB.aE(Kc));if(g==null||g!=Fc.qB||h.KE()==null||h.KE()==Fc.qB){final dG j=h.XJ(wB.ZE(Kc),g,null);if(j is jC)Jc=j;}}if(Jc==null&&Ec!=null)Jc=Ec.Jc;}String getName(){if(Cc==null&&Ec!=null)return (Ec.getName());return (Cc);}String yR(){return (Lc);}l OG(){return (Fc);}String gF(){if(Dc!=null){final String h=wB.aE(Dc);if(h!=null){final String i=Fc.YD(h);if(i!=null)return (i);if(h=="xml")return ("http://www.w3.org/XML/1998/namespace");return (null);}}bool g;if(Hc.rV().contains(this))g=true;else if(Oc!=null)g=(Oc=="qualified");else g=(Hc.ZV()=="qualified");if(g){final String j=Hc.KE();if(j=="")return (null);else return (j);}else return (null);}List<FB> fC(){if(Gc!=null)return (Gc.fC());return (new List<FB>());}List<String> hD(){if(Nc!=null){final List<String> g=new List<String>();g.add(Nc);return (g);}if(Hc.KE()!=null&&Hc.KE()==Fc.qB&&wB.ZE(Kc)=="bool")return (wB.sG(Kc,Fc));if(Jc!=null)return (Jc.hD());else if(Kc!=null)return (wB.sG(Kc,Fc));return (null);}List<String> LD(){if(Nc!=null){final List<String> g=new List<String>();g.add(Nc);return (g);}if(Hc.KE()!=null&&Hc.KE()==Fc.qB&&wB.ZE(Kc)=="bool")return (wB.sG(Kc,Fc));if(Jc!=null)return (Jc.LD());else if(Kc!=null)return (wB.sG(Kc,Fc));return (null);}String defaultValue(){if(Mc!=null)return (Mc);else if(Nc!=null)return (Nc);else if(Ec!=null)return (Ec.defaultValue());return (null);}bool GD(final String g){if(Nc!=null)return (Nc==g);if((g==null||g=="")&&Lc=="required")return (false);if(Jc!=null)return (Jc.GD(g));if(Kc!=null){final String h=Fc.YD(wB.aE(Kc));if(h!=null&&h==Fc.qB)return (jC.xJ(wB.ZE(Kc),g));}if(Ec!=null)return (Ec.GD(g));if(Kc==null)return (true);return (false);}}class qG extends DE implements TD,sC{jC Jc=null;List<DF> Pc;TD Qc=null;List<vB> Bc;String Rc=null;dG Sc=null;l Fc;DG Gc;qG(final l j,final DG k,final YB i){Ic(j);Pc=new List<DF>();Bc=new List<vB>();for(AB g=j.firstChild;g!=null;g=g.nextSibling){if(g is l){String h=g.localName;if(h=="simpleType")Jc=new jC(g as l,this,i);else if(h=="minExclusive")Pc.add(new DF(g as l));else if(h=="minInclusive")Pc.add(new DF(g as l));else if(h=="maxExclusive")Pc.add(new DF(g as l));else if(h=="maxInclusive")Pc.add(new DF(g as l));else if(h=="totalDigits")Pc.add(new DF(g as l));else if(h=="fractionDigits")Pc.add(new DF(g as l));else if(h=="length")Pc.add(new DF(g as l));else if(h=="minLength")Pc.add(new DF(g as l));else if(h=="maxLength")Pc.add(new DF(g as l));else if(h=="enumeration")Pc.add(new DF(g as l));else if(h=="pattern")Pc.add(new DF(g as l));else if(h=="group")Qc=new EE(g as l,this,i);else if(h=="all")Qc=new vJ(g as l,this,i);else if(h=="choice")Qc=new WI(g as l,this,i);else if(h=="sequence")Qc=new XI(g as l,this,i);else if(h=="attribute")Bc.add(new iB(g as l,this,i));else if(h=="attributeGroup")Bc.add(new lD(g as l,this,i));}}if(j.AC("base"))Rc=j.getAttribute("base");Fc=j;this.Gc=k;}void BC(final YB g,final vB h){if(Jc!=null)Jc.BC(g,h);if(Qc!=null)Qc.BC(g,h);for(vB i in Bc){if(i is iB)i.BC(g);else if(i is lD)i.BC(g,h);}if(Rc!=null){final String j=Fc.YD(wB.aE(Rc));Sc=g.XJ(wB.ZE(Rc),j,h);}}List<FB> JD(){final List<FB> g=new List<FB>();if(Qc!=null)g.addAll(Qc.JD());return (g);}List<FB> XC(){final List<FB> g=new List<FB>();if(Qc!=null)g.addAll(Qc.XC());return (g);}List<FB> fC(){if(Gc is DG)return (Gc.fC());else return (new List<FB>());}String ZD(){if(Qc!=null)return (Qc.ZD());return (null);}bool TE(final FB g){if(Qc!=null)return (Qc.TE(g));return (null);}bool mD(final FB g){if(Qc!=null)return (Qc.mD(g));return (null);}List<String> hD(){List<String> g=null;for(DF h in Pc){if(h.rO()=="enumeration"){if(g==null)g=new List<String>();g.add(h.hF());}}return (g);}List<String> LD(){return (hD());}List<iB> attributes(){final List<iB> h=new List<iB>();for(vB i in Bc){if(i is iB)h.add(i);else if(i is lD)h.addAll(i.attributes());}if(Sc is kC){final List<iB> g=(Sc as kC).attributes();final List<iB> m=new List<iB>();for(iB j in h){final String o=j.getName();final bool s=j.yR()=="prohibited";for(iB k in g)if(o==k.getName()){if(s)m.add(k);else g[g.indexOf(k)]=j;break;}}for(iB v in m)g.remove(v);return (g);}return (h);}int VE(final List<FB> h,final int g,final bool i){if(Qc==null)return (g);return (Qc.VE(h,g,i));}bool eD(){if(Qc!=null)return (Qc.eD());return (true);}bool GD(final String h){if(Sc!=null){if(!Sc.GD(h))return (false);}bool i=false;for(final DF g in Pc){if(g.rO()=="enumeration"){if(g.GD(h))return (true);i=true;}else if(g.rO()=="pattern"){if(g.GD(h))return (true);i=true;}else if(!g.GD(h))return (false);}if(i)return (false);return (true);}}class tJ extends DE{String Tc=null;YB Uc=null;tJ(final l g,final YB h){Ic(g);if(g.AC("schemaLocation"))Tc=g.getAttribute("schemaLocation");}Future Vc(final YB g){Completer h=new Completer();g.HP(Tc,null,g).then((YB g){Uc=g;h.complete();},onError:(rF i){h.completeError(i);});return (h.future);}}abstract class DE implements vB{YN Wc=null;void Ic(final l h){for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="annotation"){Wc=new YN(g as l);break;}}}String sK(){if(Wc==null)return (null);return (Wc.sK());}}class vJ extends DE implements TD,sC{List<FB> Xc;int Yc=1;int Zc=1;sC Gc;vJ(final l h,final sC i,final YB j){Ic(h);Xc=new List<FB>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="element")Xc.add(new FB(g as l,this,j));}try {if(h.AC("minOccurs"))Yc=int.parse(h.getAttribute("minOccurs"));}on FormatException {}this.Gc=i;}void BC(final YB g,final vB h){for(FB i in Xc)i.BC(g,h);}List<FB> JD(){final List<FB> g=new List<FB>();for(FB h in Xc)g.addAll(h.JD());return (g);}List<FB> XC(){final List<FB> g=new List<FB>();for(FB h in Xc)g.addAll(h.DH());return (g);}List<FB> fC(){if(Gc!=null)return (Gc.fC());return (new List<FB>());}String ZD(){final StringBuffer g=new StringBuffer();g.write('(');bool h=true;for(FB j in Xc){final String i=j.ZD();if(i!=null){if(!h)g.write(" & ");h=false;g.write(i);}}g.write(')');if(Yc==0)g.write('?');return (g.toString());}bool TE(final FB h){for(FB g in Xc)for(FB i in g.DH())if(i==h)return (Yc>0&&g.sR()>0);return (null);}bool mD(final FB g){for(FB h in Xc)for(FB i in h.DH())if(i==g)return (false);return (null);}int VE(final List<FB> k,final int h,final bool s){if(Xc.length==0)return (h);List<int> i=new List<int>(Xc.length);for(int g=0;g<Xc.length;g++ )i[g]=0;int m=0;for(int g=h;g<k.length;g++ ){final FB v=k[g];bool o=false;for(int j=0;j<Xc.length;j++ ){if(v==Xc[j]){o=true;i[j]++;break;}}if(!o)break;m++ ;}for(int g=0;g<Xc.length;g++ )if(i[g]>1)return (h);if(!s){for(int g=0;g<Xc.length;g++ )if(i[g]==0&&!Xc[g].eD())return (h);}return (h+m);}bool eD(){if(Xc.length==0)return (true);if(Yc==0)return (true);for(FB g in Xc){if(!g.eD())return (false);}return (true);}}class WI extends lL{WI(final l g,final sC h,final YB i){ac(g,h,i);}int VE(final List<FB> k,final int m,final bool i){int j=0;for(int g=m;g<k.length;){if(j>=Zc)return (g);int h=g;int o=g;for(TD s in bc){h=s.VE(k,g,i);if(i){if(h>o)o=h;}else{if(h>g)break;}}if(i)h=o;if(h==g){if(!i&&j<Yc)return (m);return (g);}g=h;j++ ;}if(!i&&j<Yc)return (m);return (k.length);}bool eD(){if(bc.length==0)return (true);if(Yc==0)return (true);for(TD g in bc){if(g.eD())return (true);}return (false);}}class jC extends DE implements dG{qG cc=null;cN dc=null;bN ec=null;String Cc=null;sC Gc;YB Hc;jC(final l h,final sC j,final YB i){Ic(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="restriction")cc=new qG(g as l,null,i);else if(g.localName=="list")dc=new cN(g as l,i);else if(g.localName=="union")ec=new bN(g as l,i);}}if(h.AC("name"))Cc=h.getAttribute("name");this.Gc=j;this.Hc=i;}String getName(){return (Cc);}String gF(){return (Hc.KE());}sC getParent(){return (Gc);}void BC(final YB g,final vB h){if(cc!=null)cc.BC(g,h);if(dc!=null)dc.BC(g,h);if(ec!=null)ec.BC(g,h);}List<String> hD(){if(cc!=null)return (cc.hD());if(ec!=null)return (ec.hD());return (null);}List<String> LD(){if(cc!=null)return (cc.LD());if(ec!=null)return (ec.LD());return (null);}bool GD(final String g){if(cc!=null)return (cc.GD(g));if(dc!=null)return (dc.GD(g));if(ec!=null)return (ec.GD(g));return (false);}static bool xJ(final String h,final String g){if(h=="string")return (true);else if(h=="normalizedString")return (UC(g,"[^\\t\\r\\n]*"));else if(h=="token"){if(g.indexOf('\n')!=-1||g.indexOf('\r')!=-1||g.indexOf('\t')!=-1||g.indexOf("  ")!=-1)return (false);return (!g.startsWith(" ")&&!g.endsWith(" "));}else if(h=="base64Binary")return (UC(g,"(([a-zA-Z0-9+/=]\\s?){4})*"));else if(h=="hexBinary")return (UC(g,"(([0-9a-fA-F]){2})*"));else if(h=="integer")return (UC(g,"[+\\-]?\\d+"));else if(h=="positiveInteger")return (UC(g,"\\+?0*[1-9]\\d*"));else if(h=="negativeInteger")return (UC(g,"-0*[1-9]\\d*"));else if(h=="nonNegativeInteger")return (UC(g,"(-0+)|(\\+?\\d+)"));else if(h=="nonPositiveInteger")return (UC(g,"(\\+?0+)|(-\\d+)"));else if(h=="long"){if(!UC(g,"[+\\-]?\\d+"))return (false);try {final int m=int.parse(g);final int o=int.parse("9223372036854775807");final int v=int.parse("-9223372036854775808");if(m.compareTo(o)>0)return (false);if(m.compareTo(v)<0)return (false);return (true);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="unsignedLong"){if(!UC(g,"\\d+"))return (false);try {final int m=int.parse(g);final int o=int.parse("18446744073709551615");return (m.compareTo(o)<=0);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="int"){if(!UC(g,"[+\\-]?\\d+"))return (false);String k=g;if(k.startsWith("+"))k=k.substring(1);try {final int i=int.parse(k);return (i<=2147483647&&i>=-2147483648);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="unsignedInt"){if(!UC(g,"\\d+"))return (false);try {final int i=int.parse(g);return (i<=4294967295&&i>=0);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="short"){if(!UC(g,"[+\\-]?\\d+"))return (false);String k=g;if(k.startsWith("+"))k=k.substring(1);try {final int i=int.parse(k);return (i<=32767&&i>=-32768);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="unsignedShort"){if(!UC(g,"\\d+"))return (false);try {final int i=int.parse(g);return (i<=65535&&i>=0);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="byte"){if(!UC(g,"[+\\-]?\\d+"))return (false);String k=g;if(k.startsWith("+"))k=k.substring(1);try {final int i=int.parse(k);return (i<=127&&i>=-128);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="unsignedByte"){if(!UC(g,"\\d+"))return (false);try {final int i=int.parse(g);return (i<=255&&i>=0);}on FormatException catch (j){print("validerValeur(String, String) - FormatException ${j}");return (false);}}else if(h=="decimal"){return (UC(g,"[+\\-]?\\d+\\.?\\d*"));}else if(h=="float"){if(!UC(g,"(-?INF)|(NaN)|([+\\-]?\\d+\\.?\\d*([eE][+\\-]?\\d{1,3})?)"))return (false);if(g=="INF"||g=="-INF")return (true);try {double s=double.parse(g);if(log(s.abs())/LN2>127)return (false);if(log(s.abs())/LN2<-126)return (false);return (true);}on FormatException {return (false);}}else if(h=="double"){if(!UC(g,"(-?INF)|(NaN)|([+\\-]?\\d+\\.?\\d*([eE][+\\-]?\\d{1,3})?)"))return (false);if(g=="INF"||g=="-INF")return (true);try {double.parse(g);return (true);}on FormatException {return (false);}}else if(h=="boolean")return (UC(g,"(true)|(false)|1|0"));else if(h=="duration")return (UC(g,"-?P(\\d{1,4}Y)?(\\d{1,2}M)?(\\d{1,2}D)?(T(\\d{1,2}H)?(\\d{1,2}M)?(\\d{1,2}(\\.\\d+)?S)?)?"));else if(h=="dateTime")return (UC(g,"-?\\d{4}-[01]\\d-[0-3]\\dT[0-2]\\d:[0-5]\\d:[0-5]\\d(\\.\\d+)?(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="date")return (UC(g,"-?\\d{4}-[01]\\d-[0-3]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="time")return (UC(g,"[0-2]\\d:[0-5]\\d:[0-5]\\d(\\.\\d+)?(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gYear")return (UC(g,"-?\\d{4}(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gYearMonth")return (UC(g,"-?\\d{4}-[01]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gMonth")return (UC(g,"--[01]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gMonthDay")return (UC(g,"--[01]\\d-[0-3]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="gDay")return (UC(g,"---[0-3]\\d(([+\\-][01]\\d:\\d{2})|Z)?"));else if(h=="Name")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s][^<>&#!/?'\",\\s]*"));else if(h=="QName")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s][^<>&#!/?'\",\\s]*"));else if(h=="NCName")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:\\s]*"));else if(h=="anyURI")return (true);else if(h=="language")return (UC(g,"[a-zA-Z]{1,8}(-[a-zA-Z0-9]{1,8})*"));else if(h=="ID")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:\\s]*"));else if(h=="IDREF")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:\\s]*"));else if(h=="IDREFS")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:]*"));else if(h=="ENTITY")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:\\s]*"));else if(h=="ENTITIES")return (UC(g,"[^<>&#!/?'\",0-9.\\-\\s:][^<>&#!/?'\",:]*"));else if(h=="NOTATION")return (UC(g,"[^0-9.\\-\\s][^\\s]*(\\s[^0-9.\\-\\s][^\\s]*)*"));else if(h=="NMTOKEN")return (UC(g,"[^<>&#!/?'\",\\s]+"));else if(h=="NMTOKENS")return (UC(g,"[^<>&#!/?'\",]+"));else return (true);}static bool UC(final String g,final String h){final RegExp i=new RegExp("^${h}\$");return (i.hasMatch(g));}}class jL extends DE implements TD{String fc="##any";String gc="strict";int Yc=1;int Zc=1;lL Gc;YB Hc;List<FB> Xc;jL(final l g,final lL h,final YB i){if(g.AC("namespace"))fc=g.getAttribute("namespace");if(g.AC("processContents"))gc=g.getAttribute("processContents");try {if(g.AC("minOccurs"))Yc=int.parse(g.getAttribute("minOccurs"));if(g.AC("maxOccurs")){if(g.getAttribute("maxOccurs")=="unbounded")Zc=9007199254740992;else Zc=int.parse(g.getAttribute("maxOccurs"));}}on FormatException {}this.Gc=h;this.Hc=i;Xc=null;}void BC(final YB g,final vB i){Xc=new List<FB>();Xc.addAll(g.xU(fc));for(FB h in Xc)h.NJ(this);}List<FB> JD(){return (new List<FB>());}List<FB> XC(){if(Xc==null)BC(Hc,null);return (Xc);}List<FB> fC(){return (Gc.fC());}String ZD(){if(Xc==null)BC(Hc,null);final StringBuffer g=new StringBuffer();g.write('(');for(int h=0;h<Xc.length;h++ ){g.write(Hc.OD(Xc[h]));if(h!=Xc.length-1)g.write('|');}g.write(')');if(Yc==0&&Zc==1)g.write('?');else if(Yc==0&&Zc>1)g.write('*');else if(Yc>0&&Zc>1)g.write('+');return (g.toString());}bool TE(final FB g){if(Xc==null)BC(Hc,null);if(Xc.contains(g))return (Yc>0&&Xc.length==1);else return (null);}bool mD(final FB g){if(Xc==null)BC(Hc,null);if(Xc.contains(g))return (Zc>1);else return (null);}int VE(final List<FB> i,final int h,final bool j){if(Xc==null)BC(Hc,null);if(!j&&i.length<Yc)return (h);for(int g=h;g<i.length;g++ ){if(g-h>=Zc)return (g);if(!Xc.contains(i[g])){if(!j&&g-h<Yc)return (h);return (g);}}return (i.length);}bool eD(){return (Yc==0);}}class MQ extends aN{MQ(final l g){ac(g);}}abstract class aN extends DE{ZN hc=null;List<iL> ic;String Cc=null;void ac(final l h){Ic(h);ic=new List<iL>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="selector")hc=new ZN(g as l);else if(g.localName=="field")ic.add(new iL(g as l));}}if(h.AC("name"))Cc=h.getAttribute("name");}}class OQ extends aN{OQ(final l g){ac(g);}}class NQ extends aN{String jc=null;NQ(final l g){ac(g);}}class ZN extends DE{String kc=null;ZN(final l g){if(g.AC("xpath"))kc=g.getAttribute("xpath");}}class iL extends DE{String kc=null;iL(final l g){if(g.AC("xpath"))kc=g.getAttribute("xpath");}}class kC extends DE implements dG,TD,sC{kL lc=null;TD Qc=null;List<vB> Bc;String Cc=null;bool mc=false;bool nc=false;sC Gc;YB Hc;List<FB> oc;List<sF> qc;kC(final l h,final sC j,final YB i){Ic(h);Bc=new List<vB>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="simpleContent")lc=new kL(g as l,i);else if(g.localName=="complexContent")Qc=new DG(g as l,this,i);else if(g.localName=="group")Qc=new EE(g as l,this,i);else if(g.localName=="all")Qc=new vJ(g as l,this,i);else if(g.localName=="choice")Qc=new WI(g as l,this,i);else if(g.localName=="sequence")Qc=new XI(g as l,this,i);else if(g.localName=="attribute")Bc.add(new iB(g as l,this,i));else if(g.localName=="attributeGroup")Bc.add(new lD(g as l,this,i));}}if(h.AC("name"))Cc=h.getAttribute("name");if(h.AC("mixed"))mc=h.getAttribute("mixed")=="true"||h.getAttribute("mixed")=="1";if(h.AC("abstract"))nc=h.getAttribute("abstract")=="true"||h.getAttribute("abstract")=="1";this.Gc=j;this.Hc=i;oc=null;qc=null;}kL pV(){return (lc);}String getName(){return (Cc);}bool jV(){return (mc);}String gF(){return (Hc.KE());}sC getParent(){return (Gc);}void BC(final YB g,final vB i){if(lc!=null)lc.BC(g,i);if(Qc!=null)Qc.BC(g,i);for(vB h in Bc){if(h is iB)h.BC(g);else if(h is lD)h.BC(g,i);}}void NJ(final FB g){if(oc==null)oc=new List<FB>();oc.add(g);}void qU(final sF g){if(qc==null)qc=new List<sF>();qc.add(g);}List<FB> JD(){if(Qc!=null)return (Qc.JD());return (new List<FB>());}List<FB> XC(){final List<FB> g=new List<FB>();if(Qc!=null)g.addAll(Qc.XC());return (g);}List<FB> fC(){final List<FB> g=new List<FB>();if(Gc is FB){if(!(Gc as FB).TH())g.add(Gc as FB);final List<FB> h=(Gc as FB).wR();if(h!=null)g.addAll(h);}if(oc!=null){for(FB i in oc){if(!i.TH())g.add(i);final List<FB> h=i.wR();if(h!=null)g.addAll(h);}}if(qc!=null){for(sF j in qc)g.addAll(j.fC());}return (g);}String ZD(){if(Qc!=null)return (Qc.ZD());return (null);}bool TE(final FB g){if(Qc!=null)return (Qc.TE(g));return (null);}bool mD(final FB g){if(Qc!=null)return (Qc.mD(g));return (null);}List<String> hD(){if(lc!=null)return (lc.hD());return (null);}List<String> LD(){if(lc!=null)return (lc.LD());return (null);}List<iB> attributes(){if(lc!=null)return (lc.attributes());else if(Qc is DG)return ((Qc as DG).attributes());final List<iB> h=new List<iB>();for(vB g in Bc){if(g is iB)h.add(g);else if(g is lD)h.addAll(g.attributes());}return (h);}int VE(final List<FB> h,final int g,final bool i){if(lc!=null)return (g);else if(Qc!=null)return (Qc.VE(h,g,i));return (g);}bool eD(){if(lc!=null)return (true);else if(Qc!=null)return (Qc.eD());return (true);}bool GD(final String g){if(lc!=null)return (lc.GD(g));return (g.trim()==''||QJ());}bool QJ(){if(Qc is DG){DG h=Qc as DG;dG g=null;if(h.Qc is sF){sF i=h.Qc as sF;if(i.Qc==null)g=i.Sc;}else{qG j=h.Qc as qG;if(j.Qc==null)g=j.Sc;}if(g is kC)return ((g as kC).QJ());}if(jV())return (true);if(pV()!=null)return (true);return (false);}}class sF extends DE implements TD,sC{TD Qc=null;List<vB> Bc;String Rc=null;dG Sc=null;l Fc;DG Gc;sF(final l i,final DG j,final YB h){Ic(i);Bc=new List<vB>();for(AB g=i.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="group")Qc=new EE(g as l,this,h);else if(g.localName=="all")Qc=new vJ(g as l,this,h);else if(g.localName=="choice")Qc=new WI(g as l,this,h);else if(g.localName=="sequence")Qc=new XI(g as l,this,h);else if(g.localName=="attribute")Bc.add(new iB(g as l,this,h));else if(g.localName=="attributeGroup")Bc.add(new lD(g as l,this,h));}}if(i.AC("base"))Rc=i.getAttribute("base");Fc=i;this.Gc=j;}void BC(final YB g,final vB i){if(Qc!=null)Qc.BC(g,i);for(vB h in Bc){if(h is iB)h.BC(g);else if(h is lD)h.BC(g,i);}if(Rc!=null){final String j=Fc.YD(wB.aE(Rc));Sc=g.XJ(wB.ZE(Rc),j,i);if(Sc is kC)(Sc as kC).qU(this);}}List<FB> JD(){final List<FB> g=new List<FB>();if(Qc!=null)g.addAll(Qc.JD());return (g);}List<FB> XC(){final List<FB> g=new List<FB>();if(Sc is kC)g.addAll((Sc as kC).XC());if(Qc!=null)g.addAll(Qc.XC());return (g);}List<FB> fC(){if(Gc!=null)return (Gc.fC());else return (new List<FB>());}String ZD(){String g;if(Sc is kC)g=(Sc as kC).ZD();else g=null;String h;if(Qc!=null)h=Qc.ZD();else h=null;if(g==null&&h==null)return ("");else if(g!=null&&h==null)return (g);else if(g==null&&h!=null)return (h);else return ("(${g}, ${h})");}bool TE(final FB i){bool g=null;if(Sc is kC)g=(Sc as kC).TE(i);if(g!=null&&g)return (g);bool h=null;if(Qc!=null)h=Qc.TE(i);if(h!=null&&h)return (h);return (g!=null?g:h);}bool mD(final FB h){bool g=null;if(Sc is kC)g=(Sc as kC).mD(h);if(g!=null&&g)return (g);bool i=null;if(Qc!=null)i=Qc.mD(h);return (g!=null?g:i);}List<String> hD(){if(Sc!=null)return (Sc.hD());else if(Rc!=null)return (wB.sG(Rc,Fc));return (null);}List<String> LD(){if(Sc!=null)return (Sc.LD());else if(Rc!=null)return (wB.sG(Rc,Fc));return (null);}List<iB> attributes(){final List<iB> g=new List<iB>();for(vB h in Bc){if(h is iB)g.add(h);else if(h is lD)g.addAll(h.attributes());}if(Sc is kC){final List<iB> i=(Sc as kC).attributes();final List<iB> j=new List<iB>();for(iB k in g){final String o=k.getName();bool m=false;for(iB s in i)if(o==s.getName()){m=true;break;}if(!m)j.add(k);}i.addAll(j);return (i);}return (g);}int VE(final List<FB> j,final int h,final bool i){int g=h;if(Sc is kC){g=(Sc as kC).VE(j,h,i);if(g==h&&!i&&!(Sc as kC).eD())return (h);}if(Qc!=null){int k=Qc.VE(j,g,i);if(k==g&&!i&&!Qc.eD())return (h);g=k;}return (g);}bool eD(){if(Sc is kC&&!(Sc as kC).eD())return (false);if(Qc!=null)return (Qc.eD());return (true);}bool GD(final String g){if(Sc!=null)return (Sc.GD(g));else if(Rc!=null)return (jC.xJ(wB.ZE(Rc),g));return (false);}}class EE extends DE implements TD,sC{TD rc=null;String Cc=null;String Dc=null;EE Ec=null;int Yc=1;int Zc=1;l Fc;sC Gc;YB Hc;List<EE> oc;EE(final l g,final sC j,final YB i){Ic(g);for(AB h=g.firstChild;h!=null;h=h.nextSibling){if(h is l){if(h.localName=="all")rc=new vJ(h as l,this,i);else if(h.localName=="choice")rc=new WI(h as l,this,i);else if(h.localName=="sequence")rc=new XI(h as l,this,i);}}if(g.AC("name"))Cc=g.getAttribute("name");if(g.AC("ref"))Dc=g.getAttribute("ref");try {if(g.AC("minOccurs"))Yc=int.parse(g.getAttribute("minOccurs"));if(g.AC("maxOccurs")){if(g.getAttribute("maxOccurs")=="unbounded")Zc=9007199254740992;else Zc=int.parse(g.getAttribute("maxOccurs"));}}on FormatException {}Fc=g;this.Gc=j;this.Hc=i;oc=null;}String getName(){if(Cc==null&&Ec!=null)return (Ec.getName());return (Cc);}String gF(){return (Hc.KE());}sC getParent(){return (Gc);}void BC(final YB g,final vB h){if(rc!=null)rc.BC(g,h);if(Dc!=null){final String i=Fc.YD(wB.aE(Dc));Ec=g.aW(wB.ZE(Dc),i,h);if(Ec!=null)Ec.NJ(this);else print("Référence de groupe introuvable : ${Dc}");}}void NJ(final EE g){if(oc==null)oc=new List<EE>();oc.add(g);}List<FB> JD(){if(rc!=null)return (rc.JD());return (new List<FB>());}List<FB> XC(){if(Ec!=null)return (Ec.XC());if(rc!=null)return (rc.XC());return (new List<FB>());}List<FB> fC(){final List<FB> g=new List<FB>();if(Gc!=null)g.addAll(Gc.fC());if(oc!=null){for(EE h in oc)g.addAll(h.fC());}return (g);}String ZD(){String g;if(Ec!=null)g=Ec.ZD();else if(rc!=null)g=rc.ZD();else g="()";if(Yc==0&&Zc==1)return ("${g}?");else if(Yc==0&&Zc>1)return ("${g}*");else if(Yc>0&&Zc>1)return ("${g}+");else return (g);}bool TE(final FB g){if(Ec!=null)return (Ec.TE(g));bool h=null;if(rc!=null)h=rc.TE(g);return (h);}bool mD(final FB g){if(Ec!=null)return (Ec.mD(g));bool h=null;if(rc!=null)h=rc.mD(g);return (h);}int VE(final List<FB> h,final int k,final bool j){if(!j&&h.length<Yc)return (k);int m=0;for(int g=k;g<h.length;){if(m>=Zc)return (g);int i=g;if(Ec!=null)i=Ec.VE(h,g,j);else if(rc!=null)i=rc.VE(h,g,j);if(i==g)return (g);g=i;m++ ;}return (h.length);}bool eD(){if(Yc==0)return (true);if(Ec!=null)return (Ec.eD());if(rc!=null)return (rc.eD());return (true);}}class uJ implements vB{String sc=null;String tc=null;String uc=null;uJ(final l g){if(g.AC("source"))sc=g.getAttribute("source");if(g.AC("xml:lang"))tc=g.getAttribute("xml:lang");if(g.firstChild!=null)uc=g.firstChild.nodeValue;}String hF(){return (uc);}}class DG extends DE implements TD,sC{TD Qc=null;bool mc=null;kC Gc;DG(final l h,final kC j,final YB i){Ic(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="restriction")Qc=new qG(g as l,this,i);else if(g.localName=="extension")Qc=new sF(g as l,this,i);}}if(h.AC("mixed"))mc=(h.getAttribute("mixed")=="true"||h.getAttribute("mixed")=="1");this.Gc=j;}void BC(final YB g,final vB h){if(Qc!=null)Qc.BC(g,h);}List<FB> JD(){if(Qc!=null)return (Qc.JD());return (new List<FB>());}List<FB> XC(){if(Qc!=null)return (Qc.XC());return (new List<FB>());}String ZD(){if(Qc!=null)return (Qc.ZD());return (null);}bool TE(final FB g){if(Qc!=null)return (Qc.TE(g));return (null);}bool mD(final FB g){if(Qc!=null)return (Qc.mD(g));return (null);}List<iB> attributes(){if(Qc is qG)return ((Qc as qG).attributes());else if(Qc is sF)return ((Qc as sF).attributes());return (new List<iB>());}List<FB> fC(){return (Gc.fC());}int VE(final List<FB> h,final int g,final bool i){if(Qc!=null)return (Qc.VE(h,g,i));return (g);}bool eD(){if(Qc!=null)return (Qc.eD());return (true);}}class kL extends DE{qG cc=null;sF vc=null;kL(final l h,final YB i){Ic(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="restriction")cc=new qG(g as l,null,i);else if(g.localName=="extension")vc=new sF(g as l,null,i);}}}void BC(final YB g,final vB h){if(cc!=null)cc.BC(g,h);else if(vc!=null)vc.BC(g,h);}List<String> hD(){if(cc!=null)return (cc.hD());else if(vc!=null)return (vc.hD());return (null);}List<String> LD(){if(cc!=null)return (cc.LD());else if(vc!=null)return (vc.LD());return (null);}List<iB> attributes(){if(cc!=null)return (cc.attributes());else if(vc!=null)return (vc.attributes());return (new List<iB>());}bool GD(final String g){if(cc!=null)return (cc.GD(g));if(vc!=null)return (vc.GD(g));return (false);}}class XI extends lL{XI(final l g,final sC h,final YB i){ac(g,h,i);}int VE(final List<FB> j,final int k,final bool m){int i=0;for(int g=k;g<j.length;){if(i>=Zc)return (g);int h=g;for(TD o in bc){int s=o.VE(j,h,m);if(s==h){if(!m&&!o.eD()){if(i<Yc)return (k);return (g);}}h=s;}if(h==g)return (g);g=h;i++ ;}if(!m&&i<Yc)return (k);return (j.length);}bool eD(){if(Yc==0)return (true);for(TD g in bc){if(!g.eD())return (false);}return (true);}}class DF extends DE{String wc;String uc=null;bool Nc=false;int xc=0;DF(final l h){Ic(h);wc=h.localName;if(h.AC("value")){uc=h.getAttribute("value");xc=int.parse(uc,onError:(String i)=>0);if(wc=="pattern"){uc=uc.replaceAll("\\i","[^<>&#!/?'\",0-9.\\-\\s]");uc=uc.replaceAll("\\I","[^a-zA-Z]");uc=uc.replaceAll("\\c","[^<>&#!/?'\",\\s]");uc=uc.replaceAll("\\C","\\W");uc=uc.replaceAll("\$","\\\$");for(int g=0;g<uc.length;g++ ){if(uc[g]=='^'&&(g==0||(uc[g-1]!='['||(g>1&&uc[g-2]=='\\')))){uc=uc.substring(0,g)+"\\^"+uc.substring(g+1);g++ ;}}}}if(h.AC("fixed"))Nc=h.getAttribute("fixed")=="true"||h.getAttribute("fixed")=="1";}String rO(){return (wc);}String hF(){return (uc);}bool GD(final String g){if(wc=="minExclusive"){try {final double i=double.parse(g);return (i>xc);}on FormatException {return (false);}}else if(wc=="minInclusive"){try {final double i=double.parse(g);return (i>=xc);}on FormatException {return (false);}}else if(wc=="maxExclusive"){try {final double i=double.parse(g);return (i<xc);}on FormatException {return (false);}}else if(wc=="maxInclusive"){try {final double i=double.parse(g);return (i<=xc);}on FormatException {return (false);}}else if(wc=="totalDigits"){int j=0;for(int h=0;h<g.length;h++ )if(g[h].compareTo('0')>=0&&g[h].compareTo('9')<=0)j++ ;return (j<=xc);}else if(wc=="fractionDigits"){int j=0;bool k=false;for(int h=0;h<g.length;h++ ){if(!k){if(g[h]=='.')k=true;}else if(g[h].compareTo('0')>=0&&g[h].compareTo('9')<=0)j++ ;}return (j<=xc);}else if(wc=="length")return (g.length==xc);else if(wc=="minLength")return (g.length>=xc);else if(wc=="maxLength")return (g.length<=xc);else if(wc=="enumeration"){return (uc!=null&&uc==g);}else if(wc=="whiteSpace"){return (true);}else if(wc=="pattern"){return (jC.UC(g,uc));}else return (true);}}class bN extends DE{List<jC> yc;List<String> zc=null;l Fc;List<jC> Ad;bN(final l h,final YB i){Ic(h);yc=new List<jC>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="simpleType")yc.add(new jC(g as l,null,i));}if(h.AC("memberTypes"))zc=(h.getAttribute("memberTypes")).split(new RegExp(r"\s+"));Fc=h;Ad=null;}void BC(final YB h,final vB i){for(jC o in yc)o.BC(h,i);if(zc!=null){Ad=new List<jC>(zc.length);for(int g=0;g<zc.length;g++ ){final String j=zc[g];final String k=Fc.YD(wB.aE(j));final dG m=h.XJ(wB.ZE(j),k,i);if(m is jC)Ad[g]=m;else{Ad[g]=null;final String s=Fc.qB;if(s!=k)zc[g]=null;}}}}List<String> hD(){final List<String> g=new List<String>();if(zc!=null){for(int h=0;h<zc.length;h++ ){if(Ad[h]!=null){final List<String> i=Ad[h].hD();if(i==null)return (null);g.addAll(i);}else{final String j=zc[h];final String m=Fc.YD(wB.aE(j));final String o=Fc.qB;if(o==m){final List<String> i=wB.sG(j,Fc);if(i==null)return (null);g.addAll(i);}}}}for(jC s in yc){final List<String> k=s.hD();if(k==null)return (null);g.addAll(k);}if(g.length==0)return (null);return (g);}List<String> LD(){final List<String> g=new List<String>();if(zc!=null){for(int h=0;h<zc.length;h++ ){if(Ad[h]!=null){final List<String> i=Ad[h].hD();if(i!=null)g.addAll(i);}else{final String j=zc[h];final String m=Fc.YD(wB.aE(j));final String o=Fc.qB;if(o==m){final List<String> i=wB.sG(j,Fc);if(i!=null)g.addAll(i);}}}}for(jC s in yc){final List<String> k=s.hD();if(k!=null)g.addAll(k);}if(g.length==0)return (null);return (g);}bool GD(final String h){if(zc!=null){for(int g=0;g<zc.length;g++ ){if(Ad[g]!=null){if(Ad[g].GD(h))return (true);}else if(zc[g]!=null){if(jC.xJ(wB.ZE(zc[g]),h))return (true);}}}for(final jC i in yc){if(i.GD(h))return (true);}return (false);}}class cN extends DE{jC Jc=null;String Bd=null;l Fc;cN(final l h,final YB i){Ic(h);for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l&&g.localName=="simpleType"){Jc=new jC(g as l,null,i);break;}}if(h.AC("itemType"))Bd=h.getAttribute("itemType");Fc=h;}void BC(final YB g,final vB h){if(Jc!=null)Jc.BC(g,h);if(Bd!=null&&Jc==null){final String i=Fc.YD(wB.aE(Bd));final dG j=g.XJ(wB.ZE(Bd),i,h);if(j is jC)Jc=j;else{final String k=Fc.qB;if(k!=i)Bd=null;}}}bool GD(final String g){if(Jc==null&&Bd==null)return (false);if(g==null)return (false);final List<String> i=g.trim().split(new RegExp(r"\s+"));for(String h in i){if(Jc!=null){if(!Jc.GD(h))return (false);}else{if(!jC.xJ(wB.ZE(Bd),h))return (false);}}return (true);}}class FB extends DE implements TD,sC{jC Jc=null;kC Cd=null;List<vB> Dd;String Cc=null;String Dc=null;String Kc=null;String Ed=null;int Yc=1;int Zc=1;String Mc=null;String Nc=null;bool nc=false;String Oc=null;FB Ec=null;FB Fd=null;l Fc;sC Gc;YB Hc;List<vB> oc;List<FB> Gd;List<FB> Hd;List<FB> Id;FB(final l g,final sC j,final YB i){Ic(g);Dd=new List<vB>();for(AB h=g.firstChild;h!=null;h=h.nextSibling){if(h is l){if(h.localName=="simpleType")Jc=new jC(h as l,this,i);else if(h.localName=="complexType")Cd=new kC(h as l,this,i);else if(h.localName=="unique")Dd.add(new MQ(h as l));else if(h.localName=="key")Dd.add(new OQ(h as l));else if(h.localName=="keyref")Dd.add(new NQ(h as l));}}if(g.AC("name"))Cc=g.getAttribute("name");if(g.AC("ref"))Dc=g.getAttribute("ref");if(g.AC("type"))Kc=g.getAttribute("type");if(g.AC("substitutionGroup"))Ed=g.getAttribute("substitutionGroup");try {if(g.AC("minOccurs"))Yc=int.parse(g.getAttribute("minOccurs"));if(g.AC("maxOccurs")){if(g.getAttribute("maxOccurs")=="unbounded")Zc=9007199254740992;else Zc=int.parse(g.getAttribute("maxOccurs"));}}on FormatException {}if(g.AC("default"))Mc=g.getAttribute("default");if(g.AC("fixed"))Nc=g.getAttribute("fixed");if(g.AC("abstract"))nc=g.getAttribute("abstract")=="true"||g.getAttribute("abstract")=="1";if(g.AC("form"))Oc=g.getAttribute("form");Fc=g;this.Gc=j;this.Hc=i;oc=null;Gd=null;Id=null;Hd=null;}String getName(){if(Cc==null&&Ec!=null)return (Ec.getName());return (Cc);}String AI(){return (Dc);}int sR(){return (Yc);}int iV(){return (Zc);}bool TH(){return (nc);}l OG(){return (Fc);}String gF(){bool g;if(Hc.tO().contains(this))g=true;else if(Oc!=null)g=Oc=="qualified";else g=Hc.dV()=="qualified";if(g)return (Hc.KE());else return (null);}sC getParent(){return (Gc);}void BC(final YB h,final vB j){if(Jc!=null)Jc.BC(h,null);if(Cd!=null)Cd.BC(h,j);if(Dc!=null){final String g=Fc.YD(wB.aE(Dc));Ec=h.XS(wB.ZE(Dc),g);if(Ec!=null)Ec.NJ(this);else print("Element reference not found : ${Dc} (namespace: ${g})");}if(Cd==null&&Jc==null&&Kc!=null){final String g=Fc.YD(wB.aE(Kc));final dG i=h.XJ(wB.ZE(Kc),g,j);if(i is kC){Cd=i;Cd.NJ(this);}else if(i is jC)Jc=i;}if(Ed!=null){final String g=Fc.YD(wB.aE(Ed));Fd=h.XS(wB.ZE(Ed),g);Fd.tU(this);}}void NJ(final vB g){if(oc==null)oc=new List<vB>();oc.add(g);}void tU(final FB g){if(Gd==null)Gd=new List<FB>();Gd.add(g);}List<FB> wR(){return (Gd);}List<FB> JD(){final List<FB> g=new List<FB>();g.add(this);if(Cd!=null)g.addAll(Cd.JD());return (g);}List<FB> DH(){if(Hd!=null)return (Hd);Hd=new List<FB>();if(!nc&&Cc!=null)Hd.add(this);if(Ec!=null)Hd.addAll(Ec.DH());if(Gd!=null)for(FB g in Gd)Hd.addAll(g.DH());return (Hd);}List<FB> XC(){if(Id!=null)return (Id);final LinkedHashSet<FB> g=new LinkedHashSet<FB>();if(Ec!=null)g.addAll(Ec.XC());else if(Cd!=null)g.addAll(Cd.XC());else if(Jc==null&&Kc==null&&Fd!=null)g.addAll(Fd.XC());Id=new List.from(g);return (Id);}List<FB> fC(){final LinkedHashSet<FB> g=new LinkedHashSet<FB>();if(Gc!=null)g.addAll(Gc.fC());if(oc!=null){for(vB h in oc){if(h is FB)g.addAll(h.fC());else if(h is jL)g.addAll(h.fC());}}if(Fd!=null)g.addAll(Fd.fC());return (new List.from(g));}String eR(){if(Cd==null&&Jc==null&&Kc==null&&Fd!=null)return (Fd.eR());if(Cd==null)return (null);return (Cd.ZD());}String ZD(){final List<FB> h=DH();if(h.length==0)return (null);final StringBuffer g=new StringBuffer();if(h.length>1)g.write('(');for(int i=0;i<h.length;i++ ){final FB j=h[i];g.write(Hc.OD(j));if(i!=h.length-1)g.write('|');}if(h.length>1)g.write(')');if(Yc==0&&Zc==1)g.write('?');else if(Yc==0&&Zc>1)g.write('*');else if(Yc>0&&Zc>1)g.write('+');return (g.toString());}bool TE(final FB g){if(Cd==null&&Jc==null&&Kc==null&&Fd!=null)return (Fd.TE(g));if(Cd==null)return (null);return (Cd.TE(g));}bool mD(final FB g){if(Cd==null&&Jc==null&&Kc==null&&Fd!=null)return (Fd.mD(g));if(Cd==null)return (null);return (Cd.mD(g));}List<String> hD(){if(Nc!=null){final List<String> g=new List<String>();g.add(Nc);return (g);}if(Jc!=null)return (Jc.hD());else if(Cd!=null)return (Cd.hD());else if(Kc!=null)return (wB.sG(Kc,Fc));else if(Jc==null&&Fd!=null)return (Fd.hD());return (null);}List<String> LD(){if(Nc!=null){final List<String> g=new List<String>();g.add(Nc);return (g);}if(Jc!=null)return (Jc.LD());else if(Cd!=null)return (Cd.LD());else if(Kc!=null)return (wB.sG(Kc,Fc));else if(Jc==null&&Fd!=null)return (Fd.LD());return (null);}List<iB> attributes(){if(Ec!=null)return (Ec.attributes());if(Cd!=null)return (Cd.attributes());else if(Jc==null&&Kc==null&&Fd!=null)return (Fd.attributes());return (new List<iB>());}bool QJ(){if(Kc!=null){final String h=Fc.YD(wB.aE(Kc));final String g=Fc.qB;if(g!=Hc.KE()&&g==h)return (true);}if(Cd!=null)return (Cd.QJ());if(Jc!=null)return (true);if(Cd==null&&Kc==null&&Fd!=null)return (Fd.QJ());return (false);}bool hS(final List<FB> g,final bool h){if(Cd==null){if(Jc==null&&Kc==null&&Fd!=null)return (Fd.hS(g,h));return (g.length==0);}if(g.length==0){if(h)return (true);if(Cd.eD())return (true);}final int i=Cd.VE(g,0,h);return (i>0&&i==g.length);}int VE(final List<FB> j,final int i,final bool k){int g=0;final List<FB> o=DH();for(int h=i;h<j.length;h++ ){if(g>=Zc)return (h);bool m=false;for(FB s in o)if(s==j[h])m=true;if(!m){if(!k&&g<Yc)return (i);return (h);}g++ ;}if(!k&&g<Yc)return (i);return (i+g);}bool eD(){return (Yc==0);}bool GD(final String g){if(Nc!=null)return (Nc==g);if(Jc!=null)return (Jc.GD(g));if(Cd!=null)return (Cd.GD(g));if(Kc!=null){final String h=Fc.YD(wB.aE(Kc));if(h!=null&&h==Fc.qB)return (jC.xJ(wB.ZE(Kc),g));return (false);}else return (true);}}class rG implements vB,sC{List<vB> Jd;String Tc=null;YB Uc=null;YB Hc;rG(final l i,final YB h){Jd=new List<vB>();for(AB g=i.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="simpleType")Jd.add(new jC(g as l,this,h));else if(g.localName=="complexType")Jd.add(new kC(g as l,this,h));else if(g.localName=="group")Jd.add(new EE(g as l,this,h));else if(g.localName=="attributeGroup")Jd.add(new lD(g as l,this,h));}}if(i.AC("schemaLocation"))Tc=i.getAttribute("schemaLocation");this.Hc=h;}Future Vc(final YB g){Completer h=new Completer();g.HP(Tc,null,g).then((YB g){Uc=g;h.complete();},onError:(rF i){h.completeError(i);});return (h.future);}List<vB> mV(){return (Jd);}List<FB> fC(){return (new List<FB>());}String gF(){return (Hc.KE());}}abstract class vB{}class YB implements vB{List<tJ> Kd;List<wJ> Ld;List<rG> Md;LinkedHashMap<String,jC> yc;LinkedHashMap<String,kC> Nd;LinkedHashMap<String,EE> Od;LinkedHashMap<String,lD> Pd;LinkedHashMap<String,FB> Xc;LinkedHashMap<String,iB> Qd;String Rd=null;String Sd=null;String Td=null;String Ud;wB Vd;List<YB> Wd;YB Xd;HashMap<String,String> Yd;YB(final l h,final String JB,final wB QB,final YB SB){this.Ud=JB;this.Vd=QB;this.Xd=SB;Kd=new List<tJ>();Ld=new List<wJ>();Md=new List<rG>();yc=new LinkedHashMap<String,jC>();Nd=new LinkedHashMap<String,kC>();Od=new LinkedHashMap<String,EE>();Pd=new LinkedHashMap<String,lD>();Xc=new LinkedHashMap<String,FB>();Qd=new LinkedHashMap<String,iB>();Wd=new List<YB>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){String i=g.localName;if(i=="include")Kd.add(new tJ(g as l,this));else if(i=="import")Ld.add(new wJ(g as l,this));else if(i=="redefine"){final rG BB=new rG(g as l,this);Md.add(BB);for(vB j in BB.mV()){if(j is jC){final jC k=j;yc[k.getName()]=k;}else if(j is kC){final kC m=j;Nd[m.getName()]=m;}else if(j is EE){final EE o=j;Od[o.getName()]=o;}else if(j is lD){final lD s=j;Pd[s.getName()]=s;}}}else if(i=="simpleType"){final jC k=new jC(g as l,null,this);yc[k.getName()]=k;}else if(i=="complexType"){final kC m=new kC(g as l,null,this);Nd[m.getName()]=m;}else if(i=="group"){final EE o=new EE(g as l,null,this);Od[o.getName()]=o;}else if(i=="attributeGroup"){final lD s=new lD(g as l,null,this);Pd[s.getName()]=s;}else if(i=="element"){final FB EB=new FB(g as l,null,this);Xc[EB.getName()]=EB;}else if(i=="attribute"){final iB HB=new iB(g as l,null,this);Qd[HB.getName()]=HB;}}}if(h.AC("targetNamespace")){Rd=h.getAttribute("targetNamespace");if(Rd=="")Rd=null;}if(h.AC("attributeFormDefault"))Sd=h.getAttribute("attributeFormDefault");if(h.AC("elementFormDefault"))Td=h.getAttribute("elementFormDefault");Yd=new HashMap<String,String>();if(h.attributes!=null){for(lC v in h.attributes.values){if(v.name.startsWith("xmlns:")){final String cB=v.name.substring(6);Yd[v.value]=cB;}}}}Future Vc(){List<Future> g=new List<Future>();for(tJ h in Kd)g.add(h.Vc(this));for(wJ i in Ld)g.add(i.Vc(this));for(rG j in Md)g.add(j.Vc(this));return (Future.wait(g));}Iterable<FB> tO(){return (Xc.values);}Iterable<iB> rV(){return (Qd.values);}String KE(){return (Rd);}String ZV(){return (Sd);}String dV(){return (Td);}String sV(){return (Ud);}Future<YB> HP(final String i,final String j,final YB k){Completer h=new Completer();Vd.Zd(Ud,i,j,k).then((YB g){if(g!=null&&!Wd.contains(g))Wd.add(g);h.complete(g);},onError:(rF m){h.completeError(m);});return (h.future);}void ad(){for(jC g in yc.values)g.BC(this,g.getParent() is rG?g:null);for(kC h in Nd.values)h.BC(this,h.getParent() is rG?h:null);for(EE i in Od.values)i.BC(this,i.getParent() is rG?i:null);for(lD j in Pd.values)j.BC(this,j.getParent() is rG?j:null);for(FB k in Xc.values)k.BC(this,null);for(iB m in Qd.values)m.BC(this);}String kG(final String g){return (Yd[g]);}String QW(final String g){if(g==null)return (null);for(String h in Yd.keys){if(g==Yd[h])return (h);}return (null);}List<FB> JD(){final List<FB> g=new List<FB>();for(kC h in Nd.values)g.addAll(h.JD());for(EE i in Od.values)g.addAll(i.JD());for(FB j in Xc.values)g.addAll(j.JD());return (g);}List<FB> xU(final String g){return (Vd.bd(g,Rd));}FB XS(final String g,final String h){return (cd(g,h,null,null,'WXSElement') as FB);}dG XJ(final String g,final String h,final vB i){return (cd(g,h,null,i,'WXSType') as dG);}EE aW(final String g,final String h,final vB i){return (cd(g,h,null,i,'WXSGroup') as EE);}lD YW(final String g,final String h,final vB i){return (cd(g,h,null,i,'WXSAttributeGroup') as lD);}iB ZW(final String g,final String h){return (cd(g,h,null,null,'WXSAttribute') as iB);}vB cd(final String i,final String m,final HashSet<YB> j,final vB o,final String k){if(i==null)return (null);HashSet<YB> h=null;if(Xd!=null&&(j==null||!j.contains(Xd))){if(h==null){if(j==null)h=new HashSet<YB>();else h=j;h.add(this);}final vB g=Xd.cd(i,m,h,o,k);if(g!=null)return (g);}if((m==null&&Rd==null)||(m!=null&&m==Rd)){vB g;if(k=='WXSElement')g=Xc[i];else if(k=='WXSType'){g=Nd[i];if(g!=null&&g!=o)return (g);g=yc[i];}else if(k=='WXSGroup')g=Od[i];else if(k=='WXSAttributeGroup')g=Pd[i];else if(k=='WXSAttribute')g=Qd[i];else g=null;if(g!=null&&g!=o)return (g);}for(YB s in Wd){if(j==null||!j.contains(s)){if(h==null){if(j==null)h=new HashSet<YB>();else h=j;h.add(this);}final vB g=s.cd(i,m,h,o,k);if(g!=null)return (g);}}return (null);}String OD(final FB g){return (Vd.dd(g));}}class wJ extends DE{String fc=null;String Tc=null;YB Uc=null;wJ(final l g,final YB h){if(g.AC("namespace"))fc=g.getAttribute("namespace");if(g.AC("schemaLocation"))Tc=g.getAttribute("schemaLocation");}Future Vc(final YB g){if(Tc==null)return (new Future.value(null));Completer h=new Completer();g.HP(Tc,fc,g).then((YB g){Uc=g;h.complete();},onError:(rF i){h.completeError(i);});return (h.future);}}abstract class dG{String getName();String gF();sC getParent();void BC(final YB g,final vB h);List<String> hD();List<String> LD();bool GD(final String g);}abstract class lL extends DE implements TD,sC{List<TD> bc;int Yc=1;int Zc=1;sC Gc;void ac(final l h,final sC j,final YB i){Ic(h);bc=new List<TD>();for(AB g=h.firstChild;g!=null;g=g.nextSibling){if(g is l){if(g.localName=="element")bc.add(new FB(g as l,this,i));else if(g.localName=="group")bc.add(new EE(g as l,this,i));else if(g.localName=="choice")bc.add(new WI(g as l,this,i));else if(g.localName=="sequence")bc.add(new XI(g as l,this,i));else if(g.localName=="any")bc.add(new jL(g as l,this,i));}}try {if(h.AC("minOccurs"))Yc=int.parse(h.getAttribute("minOccurs"));if(h.AC("maxOccurs")){if(h.getAttribute("maxOccurs")=="unbounded")Zc=9007199254740992;else Zc=int.parse(h.getAttribute("maxOccurs"));}}on FormatException {}this.Gc=j;}void BC(final YB h,final vB i){for(TD g in bc)if(!(g is jL))g.BC(h,i);}List<FB> JD(){final List<FB> g=new List<FB>();for(TD h in bc)g.addAll(h.JD());return (g);}List<FB> XC(){final List<FB> g=new List<FB>();for(TD h in bc){if(h is FB)g.addAll(h.DH());else g.addAll(h.XC());}return (g);}List<FB> fC(){if(Gc!=null)return (Gc.fC());return (new List<FB>());}String ZD(){if(bc.length==0)return (null);final String k=(this is WI)?"|":", ";StringBuffer g=new StringBuffer();if(bc.length>1||Yc!=1||Zc!=1)g.write('(');bool i=true;for(TD m in bc){final String j=m.ZD();if(j!=null){if(!i)g.write(k);i=false;g.write(j);}}if(bc.length>1||Yc!=1||Zc!=1)g.write(')');if(bc.length==1&&g.length>2){String h=g.toString();if(h.substring(0,2)=="(("&&h.substring(g.length-2,g.length)=="))"){g=new StringBuffer(h.substring(1,h.length-1));}}if(Yc==0&&Zc==1)g.write('?');else if(Yc==0&&Zc>1)g.write('*');else if(Yc>0&&Zc>1)g.write('+');return (g.toString());}bool TE(final FB h){for(TD g in bc){if(g is FB){for(FB j in g.DH())if(j==h)return ((this is XI||bc.length==1)&&Yc!=0&&g.sR()!=0);}else{bool i=g.TE(h);if(i!=null)return (i);}}return (null);}bool mD(final FB i){for(TD h in bc){if(h is FB){for(FB j in h.DH())if(j==i)return (h.iV()>1||Zc>1);}else{bool g=h.mD(i);if(g!=null&&!g&&Zc>1)g=true;if(g!=null)return (g);}}return (null);}}class wB implements XL{YB Hc;final HashMap<l,FB> ed=new HashMap<l,FB>();final HashMap<l,iB> fd=new HashMap<l,iB>();final HashMap<String,List<FB>> gd=new HashMap<String,List<FB>>();HashMap<String,String> Yd;final LinkedHashSet<FB> hd=new LinkedHashSet<FB>();Set<YB> Wd;HashMap<String,String> jd;wB(HashMap<String,String> g){this.jd=g;Wd=new HashSet<YB>();Yd=new HashMap<String,String>();}Future load(final String k){Completer i=new Completer();PQ(k).then((l s){Hc=new YB(s,k,this,null);kd(Hc,null,null);Wd.add(Hc);Hc.Vc().then((BB){for(final YB j in Wd)hd.addAll(j.JD());for(final YB j in Wd)j.ad();for(FB g in hd){ed[g.OG()]=g;if(g.getName()!=null&&g.AI()==null){List<FB> h=gd[g.getName()];if(h==null){h=new List<FB>();gd[g.getName()]=h;}h.add(g);}}for(FB g in hd){final List<iB> m=g.attributes();if(m!=null){for(iB o in m)fd[o.OG()]=o;}}i.complete();});},onError:(rF v){i.completeError(v);});return (i.future);}l QM(final String h){final List<FB> g=gd[h];if(g==null)return (null);return (g[0].OG());}List<l> jO(final String i){final List<FB> g=gd[i];if(g==null)return (null);List<l> h=new List<l>();for(FB j in g)h.add(j.OG());return (h);}l iG(final l g,final l j){if(j==null){String h;if(g.EC==null)h=g.nodeName;else h=g.localName;final String o=g.qB;for(final YB s in Wd){for(final FB i in s.tO()){if(i.AI()==null&&!i.TH()&&h==i.getName()&&o==i.gF())return (i.OG());}}print("DaxeWXS: elementReference: no matching root element in the schema for ${h}");return (null);}final FB m=ed[j];if(m==null){print("DaxeWXS: elementReference: unknown element reference: ${j}");return (null);}final List<FB> v=m.XC();final String h=g.localName;final String BB=g.qB;for(final FB k in v){if(k.getName()==h&&k.gF()==BB)return (k.OG());}return (null);}String cD(final l g){final FB h=ed[g];if(h==null){print("DaxeWXS: elementName: unknown element reference: ${g}");return (null);}return (h.getName());}String kI(final l h){final FB g=ed[h];if(g==null)return (null);return (g.gF());}String PM(final l h){final String g=kI(h);if(g==null)return (null);return (Yd[g]);}String hO(final l i){final FB g=ed[i];if(g==null)return (null);String h=g.sK();if(h!=null)return (h);if(g.Cd!=null)return (g.Cd.sK());return (null);}List<String> pK(final l h){final FB g=ed[h];if(g==null)return (null);return (g.hD());}List<String> lM(final l h){final FB g=ed[h];if(g==null)return (null);return (g.LD());}bool kO(final l h,final String i){final FB g=ed[h];if(g==null)return (false);return (g.GD(i));}List<String> FP(){final LinkedHashSet<String> g=new LinkedHashSet<String>();if(Hc.KE()!=null)g.add(Hc.KE());for(final String h in Yd.keys)g.add(h);return (new List.from(g));}String kG(final String g){return (Yd[g]);}String KE(){return (Hc.KE());}List<l> JD(){final List<l> h=new List<l>();for(final FB g in hd){if(g.getName()!=null&&g.AI()==null&&!g.TH())h.add(g.OG());}return (h);}List<l> II(){final List<l> h=new List<l>();for(final YB i in Wd){for(final FB g in i.tO()){if(g.getName()!=null&&g.AI()==null&&!g.TH())h.add(g.OG());}}return (h);}bool HI(final l g,final l h){final FB i=ed[g];if(i==null){print("DaxeWXS: requiredElement: unknown element reference: ${g}");return (false);}final FB j=ed[h];if(j==null){print("DaxeWXS: requiredElement: unknown element reference: ${h}");return (false);}bool k=i.TE(j);return (k!=null&&k);}bool mD(final l g,final l h){final FB i=ed[g];if(i==null){print("DaxeWXS: multipleChildren: unknown element reference: ${g}");return (false);}final FB j=ed[h];if(j==null){print("DaxeWXS: multipleChildren: unknown element reference: ${h}");return (false);}bool k=i.mD(j);return (k!=null&&k);}List<l> XC(final l g){assert(g!=null);final FB h=ed[g];if(h==null){print("DaxeWXS: subElements: unknown element reference: ${g}");return (null);}final List<FB> j=h.XC();final List<l> i=new List<l>();for(FB k in j)i.add(k.OG());return (i);}String ZD(final l g,final bool i,final bool j){final FB h=ed[g];if(h==null){print("DaxeWXS: regularExpression: unknown element reference: ${g}");return (null);}return (h.eR());}List<l> fC(final l g){final FB h=ed[g];if(h==null){print("DaxeWXS: parentElements: unknown element reference: ${g}");return (null);}final List<FB> j=h.fC();final List<l> i=new List<l>();for(FB k in j)i.add(k.OG());return (i);}List<l> fE(final l g){final FB h=ed[g];if(h==null){print("DaxeWXS: elementAttributes: unknown element reference: ${g}");return (null);}final List<iB> j=h.attributes();final List<l> i=new List<l>();for(iB k in j)i.add(k.OG());return (i);}String attributeName(final l g){final iB h=fd[g];if(h==null){print("DaxeWXS: attributeName: unknown attribute reference: ${g}");return (null);}return (h.getName());}String attributeNamespace(final l g){final iB h=fd[g];if(h==null){print("DaxeWXS: attributeNamespace: unknown attribute reference: ${g}");return (null);}return (h.gF());}String vG(final l g){final iB h=fd[g];if(h==null){print("DaxeWXS: attributeDocumentation: unknown attribute reference: ${g}");return (null);}return (h.sK());}String eK(final String h){if(h==null)return (null);final String g=aE(h);if(g==null)return (null);if(g=="xml")return ("http://www.w3.org/XML/1998/namespace");return (Hc.QW(g));}bool wV(final l g){final iB h=fd[g];if(h==null){print("DaxeWXS: isRequired: unknown attribute reference: ${g}");return (false);}return (h.yR()=="required");}bool VO(final l h,final l g){return (wV(g));}List<String> hI(final l g){final iB h=fd[g];if(h==null){print("DaxeWXS: attributeValues: unknown attribute reference: ${g}");return (null);}return (h.hD());}List<String> aP(final l g){final iB h=fd[g];if(h==null){print("DaxeWXS: suggestedAttributeValues: unknown attribute reference: ${g}");return (null);}return (h.LD());}String dF(final l g){final iB h=fd[g];if(h==null){print("DaxeWXS: defaultAttributeValue: unknown attribute reference: ${g}");return (null);}return (h.defaultValue());}bool WO(final l g,final String i){final iB h=fd[g];if(h==null){print("DaxeWXS: attributeIsValid: unknown attribute reference: ${g}");return (false);}return (h.GD(i));}bool PE(final l g){final FB h=ed[g];if(h==null){print("DaxeWXS: canContainText: unknown element reference: ${g}");return (false);}return (h.QJ());}bool gS(final l g,final List<l> k,final bool m){final FB h=ed[g];if(h==null){print("DaxeWXS: validElement: unknown element reference: ${g}");return (false);}final List<FB> i=new List<FB>();for(l o in k){final FB j=ed[o];if(j!=null)i.add(j);}return (h.hS(i,m));}Future<YB> Zd(final String v,final String h,final String s,final YB k){String g;if(h.startsWith("http"))g=h;else g="${NU(v)}/${h}";if(g==null)return (new Future.error(new rF("include/import : location not found : ${h}")));for(YB m in Wd){if(ld(m.sV())==ld(g)){kd(m,k,s);return (new Future.value(m));}}Completer<YB> i=new Completer<YB>();PQ(g).then((l BB){final YB j=new YB(BB,g,this,k);kd(j,k,s);Wd.add(j);j.Vc().then((EB){i.complete(j);},onError:(rF o){i.completeError(new rF("include/import: ${o}"));});},onError:(rF o){i.completeError(new rF("include/import: ${o}"));});return (i.future);}String ld(String g){int h=g.indexOf('/');if(h==-1)return (g);String j=g.substring(0,h);int i=g.substring(h+1).indexOf('/');if(i==-1)return (g);i+= h+1;String k=g.substring(h+1,i);if(j!='..'&&k=='..')return (ld(g.substring(i+1)));else return ("${g.substring(0,h+1)}${ld(g.substring(h+1))}");}void kd(final YB j,final YB k,final String h){if(h!=null&&Yd[h]==null){String g=j.kG(h);if(g!=null)Yd[h]=g;else if(k!=null){g=k.kG(h);if(g!=null)Yd[h]=g;}}final String i=j.KE();if(i!=null&&i!=""){final String g=j.kG(i);if(g!=null)Yd[i]=g;}}static Future<l> PQ(final String g){Completer<l> h=new Completer<l>();EG j=new EG();j.AL(g).then((sB k){h.complete(k.documentElement);},onError:(UD i){print("DaxeWXS: Error reading ${g}: ${i}");h.completeError(new rF("DaxeWXS: reading ${g}: ${i}"));});return (h.future);}static String NU(final String g){final int h=g.lastIndexOf("/");if(h==-1){return (null);}else{return (g.substring(0,h));}}List<FB> bd(final String j,final String m){final List<FB> k=new List<FB>();if(j==null||j==""||j=="##any"){for(final FB g in hd)if(g.getName()!=null&&g.AI()==null&&!g.TH())k.add(g);}else if(j=="##local"){for(final FB g in hd){if(g.getName()!=null&&g.AI()==null&&!g.TH()){final String h=g.gF();if(h==null||h==m)k.add(g);}}}else if(j=="##other"){for(final FB g in hd){if(g.getName()!=null&&g.AI()==null&&!g.TH()){final String h=g.gF();if(h!=null&&h!=m)k.add(g);}}}else{final HashSet<String> i=new HashSet.from(j.split(new RegExp(r"\s+")));if(i.contains("##targetNamespace")){i.remove("##targetNamespace");i.add(m);}if(i.contains("##local")){i.remove("##local");i.add("");}for(final FB g in hd){if(g.getName()!=null&&g.AI()==null&&!g.TH()){final String h=g.gF();if(h!=null&&i.contains(h))k.add(g);}}}return (k);}static String ZE(final String g){if(g==null)return (null);final int h=g.indexOf(':');if(h==-1)return (g);return (g.substring(h+1));}static String aE(final String g){if(g==null)return (null);final int h=g.indexOf(':');if(h==-1)return (null);else return (g.substring(0,h));}static List<String> sG(final String g,final l h){final String i=h.YD(aE(g));final String j=h.qB;if(ZE(g)=="boolean"&&j==i){final List<String> k=["true","false","1","0"];return (k);}return (null);}String dd(final FB g){if(jd[g.getName()]!=null)return (jd[g.getName()]);else return (g.getName());}}abstract class TD{void BC(final YB g,final vB h);List<FB> JD();List<FB> XC();String ZD();bool TE(final FB g);bool mD(final FB g);int VE(final List<FB> g,final int h,final bool i);bool eD();}abstract class sC{List<FB> fC();}abstract class lH extends AB{String name;String rI;String bJ;}abstract class pL extends AB{String target;String data;}class gN extends FG implements pL{String target;String data;gN(final sB i,final String g,final String h){this.target=g;this.data=h;nodeName=g;nodeValue=h;nodeType=AB.CK;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=i;qB=null;EC=null;localName=null;}String toString(){return ("<?${target} ${data}?>");}}abstract class mL extends zJ{}class hN extends FG implements mL{hN(final sB g,final String h){nodeName="#cdata-section";nodeValue=h;nodeType=AB.BK;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;qB=null;EC=null;localName=null;}String toString(){String g=nodeValue;if(g==null)g='';return ("<![CDATA[${g}]]>");}}abstract class FG implements AB{static const int mH=1;static const int lN=2;static const int VQ=6;static const int tF=9;static const int WQ=10;static const int XQ=11;static const int ZQ=12;String nodeName;String nodeValue;int nodeType;AB parentNode;List<AB> childNodes;AB firstChild;AB lastChild;AB previousSibling;AB nextSibling;LinkedHashMap<String,lC> attributes;sB ownerDocument;String qB;String EC;String localName;AB insertBefore(AB g,AB h){if(childNodes==null||!childNodes.contains(h))throw new UD("NOT_FOUND_ERR");md(g);if(nodeType==tF&&g.nodeType==mH&&(this as sB).documentElement!=null)throw new UD("HIERARCHY_REQUEST_ERR");if(childNodes==null)childNodes=new List<AB>();if(g.parentNode!=null)g.parentNode.gC(g);g.parentNode=this;if(nodeType==tF&&g.nodeType==mH)(this as sB).documentElement=g;if(firstChild==h)firstChild=g;g.nextSibling=h;g.previousSibling=h.previousSibling;return (g);}AB gC(AB g){if(childNodes==null||!childNodes.contains(g))throw new UD("NOT_FOUND_ERR");if(nodeType==tF&&g.nodeType==mH)(this as sB).documentElement=null;if(firstChild==g)firstChild=g.nextSibling;if(lastChild==g)lastChild=g.previousSibling;if(g.previousSibling!=null)g.previousSibling.nextSibling=g.nextSibling;if(g.nextSibling!=null)g.nextSibling.previousSibling=g.previousSibling;g.parentNode=null;childNodes.remove(g);return (g);}AB jB(AB g){md(g);if(nodeType==tF&&g.nodeType==mH&&(this as sB).documentElement!=null)throw new UD("HIERARCHY_REQUEST_ERR");if(childNodes==null)childNodes=new List<AB>();if(g.parentNode!=null)g.parentNode.gC(g);g.parentNode=this;if(nodeType==tF&&g.nodeType==mH)(this as sB).documentElement=g;g.nextSibling=null;if(firstChild==null){g.previousSibling=null;firstChild=g;lastChild=g;}else{lastChild.nextSibling=g;g.previousSibling=lastChild;lastChild=g;}childNodes.add(g);return (g);}bool hasChildNodes(){return (firstChild!=null);}String CP(String g){if(g==null||g==''){return (null);}switch (nodeType){case mH:return (nd(g));case tF:return (((this as sB).documentElement as eG).nd(g));case VQ:case ZQ:case XQ:case WQ:return (null);case lN:if((this as lC).WH!=null){return (((this as lC).WH as eG).nd(g));}return null;default:if(parentNode!=null){return ((parentNode as eG).nd(g));}return (null);}}nd(final String g){final RegExp i=new RegExp(r"/^xmlns:(.*)$/");if(g!=null&&this.qB==g&&EC!=null&&YD(EC)==g){return (EC);}if(attributes!=null){for(lC h in attributes.values){if(i.hasMatch(h.name)&&h.value==g&&YD(h.localName)==g){return (localName);}}}if(parentNode!=null){return ((parentNode as eG).nd(g));}return null;}String YD(String h){switch (nodeType){case mH:if(qB!=null&&this.EC==h){return (qB);}if(attributes!=null){for(lC g in attributes.values){if(g.EC=='xmlns'&&g.localName==h){if(g.value!=null&&g.value!=''){return (g.value);}return (null);}else if(g.localName=='xmlns'&&h==null){if(g.value!=null&&g.value!=''){return (g.value);}return (null);}}}if(parentNode!=null&&parentNode.nodeType!=tF){return parentNode.YD(h);}return null;case tF:return ((this as sB).documentElement.YD(h));case VQ:case ZQ:case WQ:case XQ:return (null);case lN:if(parentNode!=null)return (parentNode.YD(h));return (null);default:if(parentNode!=null)return (parentNode.YD(h));return (null);}}md(AB g){if(nodeType!=tF&&ownerDocument!=g.ownerDocument)throw new UD("WRONG_DOCUMENT_ERR");if(nodeType==tF&&this!=g.ownerDocument)throw new UD("WRONG_DOCUMENT_ERR");if(nodeType!=mH&&nodeType!=tF)throw new UD("HIERARCHY_REQUEST_ERR");if(g.nodeType==tF)throw new UD("HIERARCHY_REQUEST_ERR");if(nodeType!=tF&&g.nodeType==lN)throw new UD("HIERARCHY_REQUEST_ERR");AB h=this;while(h!=null){if(g==h)throw new UD("HIERARCHY_REQUEST_ERR");h=h.parentNode;}}static String aQ(String g){g=g.replaceAll('&','&amp;');g=g.replaceAll('"','&quot;');g=g.replaceAll('<','&lt;');g=g.replaceAll('>','&gt;');return (g);}}abstract class zJ extends AB{}class oL extends FG implements zJ{oL(final sB g,final String h){nodeName="#text";nodeValue=h;nodeType=AB.kE;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;qB=null;EC=null;localName=null;}String toString(){return (FG.aQ(nodeValue));}}abstract class OU extends AB{}class eN extends FG implements OU{eN(final sB g,final String h){nodeName=h;nodeValue=null;nodeType=AB.TQ;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;qB=null;EC=null;localName=null;}String toString(){return ("&${nodeName};");}}abstract class nL extends AB{}class fN extends FG implements nL{fN(final sB g,final String h){nodeName="#comment";nodeValue=h;nodeType=AB.DK;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;qB=null;EC=null;localName=null;}String toString(){return ("<!--${nodeValue}-->");}}class JC{String id;String BE;List<JC> cC;Object data;int position;JC.KZ(this.id,this.BE,this.position);JC.NZ(this.id,this.cC,this.position);String toString(){StringBuffer g=new StringBuffer();g.write("[${id}");if(BE!=null)g.write(" ${BE}");else{for(JC h in cC){g.write(' ');g.write(h);}}g.write(']');return (g.toString());}}class QQ extends FG implements lH{String name;String rI;String bJ;QQ(final String g,final String h,final String i){name=g;this.rI=h;this.bJ=i;nodeName=g;nodeValue=null;nodeType=AB.qL;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=null;qB=null;EC=null;localName=null;}String toString(){if(rI==null&&bJ!=null)return ('<!DOCTYPE ${name} SYSTEM "${bJ}">');if(rI!=null&&bJ!=null)return ('<!DOCTYPE ${name} PUBLIC "${rI}" "${bJ}">');if(rI!=null)return ('<!DOCTYPE ${name} PUBLIC "${rI}">');return ('<!DOCTYPE ${name}>');}}class xC extends uE{String id;xC(this.id);QC KG(String g,int h){return (null);}QC LG(List<JC> g,int h){if(g[h].id==id)return (new QC.LZ(1,[g[h]]));else return (null);}}class fG extends uE{List<uE> items;fG(this.items);QC KG(String h,int i){for(uE j in items){QC g=j.KG(h,i);if(g!=null)return (g);}return (null);}QC LG(List<JC> h,int i){for(uE j in items){QC g=j.LG(h,i);if(g!=null)return (g);}return (null);}}class NE extends uE{static const int jN=0;static const int kN=1;static const int QU=2;int repeat;uE item;NE.MZ(this.item){repeat=jN;}NE.PZ(this.item){repeat=kN;}NE.RZ(this.item){repeat=QU;}QC KG(String j,int k){if(repeat==jN){QC g=item.KG(j,k);if(g==null)return (new QC.IZ(0,''));else return (g);}StringBuffer h=null;int i=k;while(i<j.length){QC g=item.KG(j,i);if(g==null)break;if(h==null)h=new StringBuffer();h.write(g.kK);i=i+g.QG;}int o=i-k;if(o>0||repeat==kN){String m;if(h!=null)m=h.toString();else m='';return (new QC.IZ(o,m));}else return (null);}QC LG(List<JC> i,int j){if(repeat==jN){QC g=item.LG(i,j);if(g==null)return (new QC.LZ(0,new List<JC>()));else return (g);}List<JC> k=new List<JC>();int h=j;while(h<i.length){QC g=item.LG(i,h);if(g==null)break;k.addAll(g.ZH);h=h+g.QG;}int m=h-j;if(m>0||repeat==kN)return (new QC.LZ(m,k));else return (null);}}class mC extends uE{String RH=null;bool HS=false;bool IS=false;bool xV=false;List<String> mO=null;mC(this.RH);mC.OZ(){HS=true;}mC.QZ(){IS=true;}mC.SZ(this.mO);QC KG(String i,int h){String g=i[h];if(RH!=null){if(g==RH)return (new QC.IZ(1,g));}else if(HS){if('0123456789'.contains(g)){return (new QC.IZ(1,g));}}else if(IS){if('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'.contains(g))return (new QC.IZ(1,g));}else if(xV){return (new QC.IZ(1,g));}else if(mO!=null){for(String j in mO){if(h+j.length<=i.length&&j==i.substring(h,h+j.length))return (null);}return (new QC.IZ(1,g));}return (null);}QC LG(List<JC> g,int h){return (null);}}class EG{Future<sB> AL(String g,{bool disableCache: true}){Completer<sB> i=new Completer<sB>();HttpRequest h=new HttpRequest();if(disableCache){if(!g.contains('.php?')){Random m=new Random();String j="random_workaround=${m.nextDouble()}";if(g.contains('?'))g="${g}&${j}";else g="${g}?${j}";}}h.open('GET',g);h.onLoad.listen((ProgressEvent o){if(h.status!=200){i.completeError(new UD("Error reading ${g}",errorCode:h.status));return;}sB k;if(h.responseText==null){i.completeError(new UD("Error reading ${g}"));return;}try {k=parseFromString(h.responseText);}on UD catch (s){i.completeError(new UD("Error reading ${g}: ${s.message}"));return;}i.complete(k);});h.onError.listen((ProgressEvent o){i.completeError(new UD("Error reading ${g}"));});h.send();return (i.future);}sB parseFromString(String g){mN h=new mN();try {return (h.LP(g));}on Exception catch (i){throw new UD(i.toString());}}}class pD{String name;bool value;pD(this.name,this.value);}abstract class uE{QC KG(String g,int h);QC LG(List<JC> g,int h);}class ED extends uE{List<uE> items;ED(this.items);ED.JZ(String h){items=new List<uE>();for(int g=0;g<h.length;g++ )items.add(new mC(h[g]));}QC KG(String k,int m){StringBuffer g=null;int h=m;for(uE o in items){if(h>=k.length)return (null);QC i=o.KG(k,h);if(i==null)return (null);if(g==null)g=new StringBuffer();g.write(i.kK);h=h+i.QG;}int s=h-m;String j;if(g!=null)j=g.toString();else j='';return (new QC.IZ(s,j));}QC LG(List<JC> i,int j){List<JC> k=new List<JC>();int g=j;for(uE m in items){if(g>=i.length)return (null);QC h=m.LG(i,g);if(h==null)return (null);k.addAll(h.ZH);g=g+h.QG;}int o=g-j;return (new QC.LZ(o,k));}}class tE{String name;bool value;tE(this.name,this.value);}abstract class lC extends AB{String name;String value;bool HL;l WH;bool yO;}class UD implements Exception{final String message;final int errorCode;const UD(this.message,{this.errorCode});String toString(){String g="DOMException";if(message!=null)g+= ": ${message}";if(errorCode!=null)g+= ": ${errorCode}";return (g);}}abstract class l extends AB{String tagName;String getAttribute(String g);void setAttribute(String g,String h);lC RM(String g);lC ZS(lC g);List<AB> getElementsByTagName(String g);String getAttributeNS(String g,String h);void setAttributeNS(String g,String h,String i);lC SM(String g,String h);bool AC(String g);}class QC{int QG;String kK;List<JC> ZH;QC.IZ(this.QG,this.kK);QC.LZ(this.QG,this.ZH);}abstract class iN extends AB{}class RQ extends FG implements iN{RQ(final sB g){nodeName="#document-fragment";nodeValue=null;nodeType=AB.RU;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;qB=null;EC=null;localName=null;}String toString(){StringBuffer g=new StringBuffer();for(AB h in childNodes){g.write(h.toString());}return (g.toString());}}class yJ implements kH{yJ();sB createDocument(String g,String h,lH i){return (new dN(this,g,h,i));}}abstract class kH{sB createDocument(String g,String h,lH i);}abstract class sB extends AB{kH implementation;l documentElement;String wO;String nF;bool iS;String VG;String aR;lH mK;l createElement(String g);iN createDocumentFragment();zJ wG(String g);nL YR(String g);mL XR(String g);pL ZR(String g,String h);List<AB> getElementsByTagName(String g);l createElementNS(String g,String h);AB adoptNode(AB g);}abstract class AB{static const int FE=1;static const int SQ=2;static const int kE=3;static const int BK=4;static const int TQ=5;static const int UQ=6;static const int CK=7;static const int DK=8;static const int FK=9;static const int qL=10;static const int RU=11;static const int YQ=12;String nodeName;String nodeValue;int nodeType;AB parentNode;List<AB> childNodes;AB firstChild;AB lastChild;AB previousSibling;AB nextSibling;LinkedHashMap<String,lC> attributes;sB ownerDocument;String qB;String EC;String localName;AB insertBefore(AB g,AB h);AB gC(AB g);AB jB(AB g);bool hasChildNodes();String CP(String g);String YD(String g);}class dN extends FG implements sB{kH implementation;l documentElement;String wO;String nF;bool iS;String VG;String aR;lH mK;HashMap<String,l> od;dN(final kH i,final String h,final String g,final lH j){this.implementation=i;wO=null;nF="UTF-8";iS=false;VG="1.0";aR=null;this.mK=j;od=new HashMap<String,l>();nodeName="#document";nodeValue=null;nodeType=AB.FK;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=null;this.qB=null;EC=null;localName=null;if(g!=null){if(h!=null)documentElement=new eG.UZ(this,h,g);else documentElement=new eG(this,g);documentElement.parentNode=this;}}l createElement(String g){return (new eG(this,g));}iN createDocumentFragment(){return (new RQ(this));}zJ wG(String g){return (new oL(this,g));}nL YR(String g){return (new fN(this,g));}mL XR(String g){return (new hN(this,g));}pL ZR(String g,String h){return (new gN(this,g,h));}List<AB> getElementsByTagName(String h){List<AB> i=new List<AB>();for(AB g in childNodes){if(h=='*'||g.nodeName==h)i.add(g);if(g is l)i.addAll(g.getElementsByTagName(h));}return (i);}l createElementNS(String g,String h){return (new eG.UZ(this,g,h));}AB adoptNode(AB g){if(g.nodeType==AB.FK||g.nodeType==AB.qL||g.nodeType==AB.UQ||g.nodeType==AB.YQ)throw new UD("NOT_SUPPORTED_ERR");if(g.parentNode!=null){g.parentNode.gC(g);}if(g is lC){lC h=g;h.WH=null;h.HL=true;}pd(g);return (g);}void pd(AB g){g.ownerDocument=this;if(g.attributes!=null){List<String> j=new List<String>();for(lC i in g.attributes.values){if(i.HL)i.ownerDocument=this;else j.add(i.name);}for(String k in j){g.attributes.remove(k);}}if(g.childNodes!=null){for(AB h in g.childNodes){if(h.nodeType!=AB.qL&&h.nodeType!=AB.UQ&&h.nodeType!=AB.YQ)pd(h);}}}String toString(){StringBuffer g=new StringBuffer();g.write("<?xml");if(VG!=null)g.write(' version="${VG}"');if(nF!=null)g.write(' encoding="${nF}"');g.writeln("?>");if(mK!=null)g.write(mK.toString());for(AB h in childNodes){g.write(h.toString());}return (g.toString());}}class eG extends FG implements l{String tagName;eG(final sB h,final String g){this.tagName=g;nodeName=g;nodeValue=null;nodeType=AB.FE;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=h;qB=null;EC=null;localName=null;}eG.UZ(final sB i,final String j,final String g){tagName=g;nodeName=g;nodeValue=null;nodeType=AB.FE;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=i;this.qB=j;int h=g.indexOf(":");if(h!=-1){EC=g.substring(0,h);localName=g.substring(h+1);}else{EC=null;localName=g;}}String getAttribute(String i){if(attributes==null)return ("");lC g=attributes[i];if(g==null)return ("");String h=g.nodeValue;if(h==null)return ("");return (h);}void setAttribute(String h,String i){if(attributes==null)attributes=new LinkedHashMap<String,lC>();lC g=attributes[h];if(g==null){g=new AK(ownerDocument,h);g.parentNode=this;g.WH=this;attributes[h]=g;}g.nodeValue=i;}lC RM(String g){if(attributes==null)return (null);return (attributes[g]);}lC ZS(lC g){if(ownerDocument!=g.ownerDocument)throw new UD("WRONG_DOCUMENT_ERR");if(attributes==null)attributes=new LinkedHashMap<String,lC>();g.parentNode=this;g.WH=this;attributes[g.name]=g;return (g);}List<AB> getElementsByTagName(String i){List<AB> g=new List<AB>();if(childNodes==null)return (g);for(AB h in childNodes){if(i=='*'||h.nodeName==i)g.add(h);if(h is l)g.addAll(h.getElementsByTagName(i));}return (g);}String getAttributeNS(String h,String i){if(attributes==null)return ("");for(lC g in attributes.values){if(g.qB==h&&g.localName==i){if(g.value==null)return ("");return (g.value);}}return ("");}void setAttributeNS(String m,String h,String o){if(attributes==null)attributes=new LinkedHashMap<String,lC>();String i,j;int k=h.indexOf(":");if(k!=-1){i=h.substring(0,k);j=h.substring(k+1);}else{i=null;j=h;}lC g=SM(m,j);if(g!=null){g.EC=i;g.nodeValue=o;return;}g=new AK.TZ(ownerDocument,m,h);g.parentNode=this;g.WH=this;g.nodeValue=o;attributes[h]=g;}lC SM(String h,String i){if(attributes==null)return (null);for(lC g in attributes.values){if(g.qB==h&&g.localName==i){return (g);}}return (null);}bool AC(String g){if(attributes==null)return (false);return (attributes[g]!=null);}String toString(){StringBuffer g=new StringBuffer();g.write("<${tagName}");if(attributes!=null){for(lC h in attributes.values){g.write(" ");g.write(h.toString());}}if(childNodes!=null&&childNodes.length>0){g.write(">");for(AB i in childNodes){g.write(i.toString());}g.write("</${tagName}>");}else{g.write("/>");}return (g.toString());}}typedef void PU(Token);class tB extends uE{String id;List<tE> conditions;List<pD> changes;uE content;bool ignore;PU action;EK qK;tB(this.id,this.content,{this.conditions: null,this.changes: null,this.ignore: false,this.action: null});QC KG(String m,int j){if(!qK.SR(this))return (null);QC g=content.KG(m,j);if(g==null)return (null);JC h=new JC.KZ(id,g.kK,j);if(action!=null)action(h);qK.QR(this);List<JC> i;if(ignore)i=new List<JC>();else i=[h];QC k=new QC.LZ(g.QG,i);if(!ignore)k.kK=h.BE;return (k);}QC LG(List<JC> j,int k){if(!qK.SR(this))return (null);QC g=content.LG(j,k);if(g==null)return (null);JC i=new JC.NZ(id,g.ZH,g.ZH[0].position);if(action!=null)action(i);qK.QR(this);List<JC> h;if(ignore)h=new List<JC>();else h=[i];QC m=new QC.LZ(g.QG,h);return (m);}String toString(){return (id);}}class AK extends FG implements lC{bool HL;l WH;bool yO;AK(final sB g,final String h){HL=true;WH=null;yO=false;nodeName=h;nodeValue=null;nodeType=AB.SQ;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=g;qB=null;EC=null;localName=null;}AK.TZ(final sB h,final String i,final String j){HL=true;WH=null;yO=false;nodeName=j;nodeValue=null;nodeType=AB.SQ;parentNode=null;childNodes=null;firstChild=null;lastChild=null;previousSibling=null;nextSibling=null;attributes=null;ownerDocument=h;this.qB=i;int g=name.indexOf(":");if(g!=-1){EC=name.substring(0,g);localName=name.substring(g+1);}else{EC=null;localName=name;}}String get name{return (nodeName);}void set name(String g){nodeName=g;}String get value{return (nodeValue);}void set value(String g){nodeValue=g;}String toString(){return ('${nodeName}="${FG.aQ(nodeValue)}"');}}class mN{List<tB> XD;List<tB> oF;sB nE;mN(){qd();}qd(){XD=new List<tB>();tE v=new tE('in_tag',true);XD.add(new tB('CDATA_SECTION_OPEN',new ED.JZ('<![CDATA['),conditions:[new tE('in_cdata_section',false)],changes:[new pD('in_cdata_section',true)]));XD.add(new tB('CDATA_SECTION_DATA',new NE.RZ(new mC.SZ([']]>'])),conditions:[new tE('in_cdata_section',true)]));XD.add(new tB('CDATA_SECTION_CLOSE',new ED.JZ(']]>'),conditions:[new tE('in_cdata_section',true)],changes:[new pD('in_cdata_section',false)]));XD.add(new tB('COMMENT_OPEN',new ED.JZ('<!--'),changes:[new pD('in_comment',true)]));XD.add(new tB('COMMENT_CLOSE',new ED.JZ('-->'),conditions:[new tE('in_comment',true)],changes:[new pD('in_comment',false)]));XD.add(new tB('COMMENT_DATA',new NE.RZ(new mC.SZ(['-->'])),conditions:[new tE('in_comment',true)]));XD.add(new tB('DOC_DECL_OPEN',new ED.JZ('<?xml'),changes:[new pD('in_tag',true),new pD('in_decl',true)]));XD.add(new tB('DOC_DECL_CLOSE',new ED.JZ('?>'),conditions:[new tE('in_decl',true)],changes:[new pD('in_tag',false),new pD('in_decl',false)]));XD.add(new tB('DOCTYPE_OPEN',new ED.JZ('<!DOCTYPE'),changes:[new pD('in_tag',true),new pD('in_doctype',true)]));XD.add(new tB('DOCTYPE_CLOSE',new ED.JZ('>'),conditions:[new tE('in_doctype',true)],changes:[new pD('in_tag',false),new pD('in_doctype',false)]));XD.add(new tB('PI_OPEN',new ED.JZ('<?'),changes:[new pD('in_pi',true)]));uE kS=new fG([new mC.QZ(),new mC('_'),new mC(':')]);uE tD=new fG([new mC.QZ(),new mC.OZ(),new mC('.'),new mC('-'),new mC('_'),new mC(':')]);XD.add(new tB('PI_TARGET',new ED([kS,new NE.PZ(tD)]),conditions:[new tE('in_pi',true),new tE('pi_after_target',false)],changes:[new pD('pi_after_target',true)]));XD.add(new tB('PI_DATA',new NE.RZ(new mC.SZ(['?>'])),conditions:[new tE('pi_after_target',true)]));XD.add(new tB('PI_CLOSE',new ED.JZ('?>'),conditions:[new tE('in_pi',true)],changes:[new pD('in_pi',false),new pD('pi_after_target',false)]));XD.add(new tB('TAG_END_OPEN',new ED.JZ('</'),changes:[new pD('in_tag',true)]));XD.add(new tB('TAG_START_OPEN',new mC('<'),changes:[new pD('in_tag',true)]));XD.add(new tB('TAG_CLOSE',new mC('>'),conditions:[v],changes:[new pD('in_tag',false)]));XD.add(new tB('TAG_EMPTY_CLOSE',new ED.JZ('/>'),conditions:[v],changes:[new pD('in_tag',false)]));XD.add(new tB('ATTR_EQ',new mC('='),conditions:[v]));tB EB=new tB('ENTITY_REF',new ED([new mC('&'),new NE.RZ(new fG([new mC('#'),new mC.OZ(),new mC.QZ()])),new mC(';')]),action:(JC g){String h=g.BE;h=h.substring(1,h.length-1);if(h.startsWith('#')){int JB;if(h[1]=='x'){h=h.substring(2);JB=int.parse(h,radix:16);}else{h=h.substring(1);JB=int.parse(h);}String k=new String.fromCharCode(JB);g.BE=new String.fromCharCode(JB);}else{String k=null;if(h=='amp')k='&';else if(h=='lt')k='<';else if(h=='gt')k='>';else if(h=='apos')k="'";else if(h=='quot')k='"';if(k!=null){g.BE=k;}else{}}});XD.add(EB);XD.add(new tB('ATTR_VALUE',new fG([new ED([new mC('"'),new NE.PZ(new fG([new mC.SZ(['"','&','<']),EB])),new mC('"')]),new ED([new mC("'"),new NE.PZ(new fG([new mC.SZ(["'",'&','<']),EB])),new mC("'")])]),conditions:[v]));XD.add(new tB('PCDATA',new NE.RZ(new mC.SZ(['<','&'])),conditions:[new tE('in_tag',false)]));XD.add(new tB('GENERIC_ID',new ED([kS,new NE.PZ(tD)]),conditions:[v]));XD.add(new tB('WHITE',new fG([new mC(' '),new mC('\n'),new mC('\r'),new mC('\t')]),conditions:[v],ignore:true));oF=new List<tB>();tB QB=new tB('ATTRIBUTE',new ED([new xC('GENERIC_ID'),new xC('ATTR_EQ'),new xC('ATTR_VALUE')]),action:(JC g){String m=g.cC[0].BE;String cB=g.cC[2].BE;cB=cB.substring(1,cB.length-1);lC j=new AK.TZ(nE,null,m);j.value=cB;g.data=j;});oF.add(new tB('DOC_DECL',new ED([new xC('DOC_DECL_OPEN'),new NE.PZ(QB),new xC('DOC_DECL_CLOSE')]),action:(JC g){int QD=g.cC.length-2;if(QD>0){for(int i=1;i<g.cC.length-1;i++ ){Object h=g.cC[i].data;if(h is lC){lC j=h;if(j.name=='version')nE.VG=j.value;else if(j.name=='encoding'){nE.nF=j.value;nE.wO=j.value;}}}}}));oF.add(new tB('DOCTYPE',new ED([new xC('DOCTYPE_OPEN'),new NE.RZ(new fG([new xC('GENERIC_ID'),new xC('ATTR_VALUE')])),new xC('DOCTYPE_CLOSE')]),action:(JC g){String m=g.cC[1].BE;String SB=null;String BB=null;for(int i=2;i<g.cC.length-1;i++ ){if(g.cC[i].id=='GENERIC_ID'&&g.cC[i].BE=='PUBLIC'&&i<g.cC.length-2&&g.cC[i+1].id=='ATTR_VALUE'){SB=g.cC[i+1].BE;SB=SB.substring(1,BB.length-1);}else if(g.cC[i].id=='GENERIC_ID'&&g.cC[i].BE=='SYSTEM'&&i<g.cC.length-2&&g.cC[i+1].id=='ATTR_VALUE'){BB=g.cC[i+1].BE;BB=BB.substring(1,BB.length-1);}}lH qE=new QQ(m,SB,BB);qE.ownerDocument=nE;g.data=qE;}));oF.add(new tB('OUTSIDE_ROOT',new xC('PCDATA'),ignore:true));tB MF=new tB('START_TAG',new ED([new xC('TAG_START_OPEN'),new xC('GENERIC_ID'),new NE.PZ(QB),new xC('TAG_CLOSE')]));tB WG=new tB('END_TAG',new ED([new xC('TAG_END_OPEN'),new xC('GENERIC_ID'),new xC('TAG_CLOSE')]));tB NI=new tB('EMPTY_ELEMENT',new ED([new xC('TAG_START_OPEN'),new xC('GENERIC_ID'),new NE.PZ(QB),new xC('TAG_EMPTY_CLOSE')]));tB eJ=new tB('COMMENT',new ED([new xC('COMMENT_OPEN'),new NE.MZ(new xC('COMMENT_DATA')),new xC('COMMENT_CLOSE')]),action:(JC g){String h;if(g.cC.length==3)h=g.cC[1].BE;else h='';g.data=new fN(nE,h);});tB fJ=new tB('ENTITY_REF',new ED([new xC('ENTITY_REF')]),action:(JC g){String h=g.cC[0].BE;if(h.startsWith('&')&&h.length>1){h=h.substring(1,h.length-1);eN EB=new eN(nE,h);g.data=EB;}else{g.data=new oL(nE,h);}});tB ML=new tB('CDATA',new ED([new xC('CDATA_SECTION_OPEN'),new NE.MZ(new xC('CDATA_SECTION_DATA')),new xC('CDATA_SECTION_CLOSE')]),action:(JC g){String h;if(g.cC.length==3)h=g.cC[1].BE;else h='';g.data=new hN(nE,h);});tB lS=new tB('PI',new ED([new xC('PI_OPEN'),new xC('PI_TARGET'),new NE.MZ(new xC('PI_DATA')),new xC('PI_CLOSE')]),action:(JC g){String yW=g.cC[1].BE;String h;if(g.cC.length==4)h=g.cC[2].BE.replaceAll(new RegExp(r"^\s+"),'');else h='';g.data=new gN(nE,yW,h);});tB CC=new tB('ELEMENT',null,action:(JC g){bool mS=(g.cC[0].id=='EMPTY_ELEMENT');JC hB=g.cC[0];String m=hB.cC[1].BE;if(!mS){JC zW=g.cC[g.cC.length-1];String nS=zW.cC[1].BE;if(nS!=m)throw new Exception("End tag not matching start tag: ${nS} != ${m}");}l s=new eG.UZ(nE,null,m);int QD=hB.cC.length-3;if(QD>0){for(int i=2;i<hB.cC.length-1;i++ ){Object h=hB.cC[i].data;if(h is lC)s.ZS(h);}}if(!mS){int AX=g.cC.length-2;if(AX>0){for(int i=1;i<g.cC.length-1;i++ ){JC IC=g.cC[i];if(IC.id=='PCDATA'){zJ BX=new oL(nE,IC.BE);s.jB(BX);}else{Object h=IC.data;if(h is AB)s.jB(h);}}for(AB o=s.firstChild;o!=null;o=o.nextSibling){if(o.nodeType==AB.kE){AB HB=o.nextSibling;while(HB!=null&&HB.nodeType==AB.kE){o.nodeValue+= HB.nodeValue;s.gC(HB);HB=o.nextSibling;}}}}}g.data=s;});CC.content=new fG([new ED([MF,new NE.PZ(new fG([CC,eJ,new xC('PCDATA'),fJ,ML,lS])),WG]),NI]);oF.add(CC);oF.add(QB);oF.add(MF);oF.add(WG);oF.add(NI);oF.add(eJ);oF.add(fJ);oF.add(ML);oF.add(lS);}sB LP(String h){h=h.replaceAll('\r\n','\n');kH k=new yJ();nE=new dN(k,null,null,null);EK i=new EK(XD);List<JC> j=i.LP(h);i=new EK(oF);j=i.OW(j);for(JC m in j){Object g=m.data;if(g is lH)nE.mK=g;else if(g is AB)nE.jB(g);}if(nE.documentElement!=null)rd(nE.documentElement);return (nE);}void rd(l g){if(g.attributes!=null){for(lC i in g.attributes.values){if(i.name=='xmlns'||(i.EC=='xmlns'&&i.localName==g.EC)){g.qB=i.value;break;}}}if(g.qB==null&&g.parentNode!=null)g.qB=g.parentNode.YD(g.EC);for(AB h=g.firstChild;h!=null;h=h.nextSibling){if(h is l)rd(h as l);}}}class EK{List<tB> rules;HashMap<String,bool> kM;EK(this.rules){for(tB g in rules)g.qK=this;}List<JC> LP(String i){List<JC> j=new List<JC>();kM=new HashMap<String,bool>();int g=0;while(g<i.length){int k=g;for(tB m in rules){QC h=m.KG(i,g);if(h==null)continue;g+= h.QG;if(h.ZH.length>0){assert(h.QG!=0);j.addAll(h.ZH);break;}}if(k==g){throw new UD("parser blocking at character ${g}: ${i.substring(g,min(g+10,i.length))}");}}return (j);}List<JC> OW(List<JC> i){List<JC> j=new List<JC>();kM=new HashMap<String,bool>();int g=0;while(g<i.length){int k=g;for(tB m in rules){QC h=m.LG(i,g);if(h==null)continue;g+= h.QG;if(h.ZH.length>0){assert(h.QG!=0);j.addAll(h.ZH);break;}}if(k==g){throw new UD("parser blocking at character ${i[g].position}");}}return (j);}bool SR(tB h){if(h.conditions==null)return (true);bool j=false;for(tE i in h.conditions){bool g=kM[i.name];if(g==null)g=false;if(g!=i.value)return (false);}return (true);}void QR(tB g){if(g.changes==null)return;for(pD h in g.changes){kM[h.name]=h.value;}}}class nN{static String oN;static String pN='en_US';static String SU(String g){if(g==null)return TU();if(g=="C")return "en_ISO";if(g.length<5)return g;if(g[2]!='-'&&(g[2]!='_'))return g;var h=g.substring(3);if(h.length<=3)h=h.toUpperCase();return '${g[0]}${g[1]}_${h}';}static String TU(){if(oN==null)oN=pN;return oN;}}Future<String> bQ(){nN.pN=nN.SU(window.navigator.language);return new Future.value(nN.pN);}